<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="referrer" content="no-referrer-when-downgrade">
    

    <title>bustub数据库 | 记录每个瞬间</title>
    <meta property="og:title" content="bustub数据库 - 记录每个瞬间">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2023-03-20T14:32:19&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2023-03-20T14:32:19&#43;08:00'>
        
    <meta name="Keywords" content="">
    <meta name="description" content="bustub数据库">
        <meta name="author" content="隔壁老王">
        
    <meta property="og:url" content="https://code0xff.org/post/2023/03/bustub%E6%95%B0%E6%8D%AE%E5%BA%93/">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    
    
        <link href="https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" rel="stylesheet">
    
    
    
    
</head>


<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://code0xff.org/">
                        记录每个瞬间
                    </a>
                
                
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="https://code0xff.org/">首页</a>
                    
                    <a  href="https://code0xff.org/linked/" title="链接">链接</a>
                    
                    <a  href="https://code0xff.org/archives/" title="归档">归档</a>
                    
                    <a  href="https://code0xff.org/about/" title="关于">关于</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    
    <article class="post">
        <header>
            <h1 class="post-title">bustub数据库</h1>
        </header>
        <date class="post-meta meta-date">
            2023年3月20日
        </date>
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#环境搭建">环境搭建</a></li>
        <li><a href="#buffer-pool">buffer pool</a></li>
        <li><a href="#b树">B+树</a></li>
        <li><a href="#查询执行">查询执行</a></li>
        <li><a href="#并发控制">并发控制</a></li>
        <li><a href="#参考">参考</a></li>
      </ul>
    </li>
  </ul>
</nav>
        
        <div class="post-meta">
            
            <span class="post-meta meta-tags">
                <ul class="clearfix">
                    <a href='/categories/%E6%95%B0%E6%8D%AE%E5%BA%93'>数据库</a>
                </ul>
            </span>
            
        </div>
        
        
        <div class="post-meta">
            <span id="busuanzi_container_page_pv">|<span id="busuanzi_value_page_pv"></span><span>
                    阅读</span></span>
        </div>
        
        
        <div class="post-content">
            <blockquote>
<p>地址   <br>
<a href="https://15445.courses.cs.cmu.edu/fall2022/assignments.html">https://15445.courses.cs.cmu.edu/fall2022/assignments.html</a></p>
</blockquote>
<h2 id="环境搭建">环境搭建</h2>
<p>卡耐基梅隆数据库课程，还附带了一个实现环境，算是这门课的亮点<br>
一款教学性质的数据库：<code>bustub</code>   <br>
虽然是教学性质的，不过有些 Lab 还是比较有意思，比如完整的实现 一颗<code>B+树</code>，这就很有挑战了<br>
另外还有并发控制，查询执行的各种算子，基本上做完这个迷你数据库之后，对整个数据库的运行原理，应该是很清晰了。</p>
<p>一些信息</p>
<ul>
<li><a href="https://www.gradescope.com/courses/425272">在线评测地址</a></li>
<li>学校和邀请码，<a href="https://15445.courses.cs.cmu.edu/fall2022/faq.html">参见 FAQ</a></li>
</ul>
<p>环境</p>
<ul>
<li>我用的是<code>ubuntu 20.x</code></li>
<li>编译器是<code>GCC 9.4.0</code></li>
<li>使用的是 Windows，然后装了 vs-code</li>
<li>本地装了一个虚拟机，装了 ubuntu，这样就可以远程开发了</li>
</ul>
<p>我做的是 2022 年的课程，而最新的代码是 2023 年的，直接用最新的代码跑 2022 年的是没法弄的<br>
很多代码，测试用例都对不上了，所以要找到 2022 年的提交，然后在对应的时间点上 打个分支，从那个分支上开始做</p>
<p><code>5</code>个 Lab</p>
<ul>
<li>C++ Primer，这个不算是真正的实验，只是检查 C++ 的语法，使用什么的是否达标</li>
<li>Buffer Pool Manager，需要做一个 可扩展的hash表、一个 LRU-k 缓存，以及将前两者整合起来，变成 buffer pool</li>
<li>B+Tree Index，实现 B+ 树的 点查询、范围查询、插入、删除、以及并发控制</li>
<li>Query Execution，实现scan、insert、delete、index-scan、agg、nested-loop-join、nested-index-join、sort、limit、topN、以及几个优化算法</li>
<li>Concurrency Control，实现锁管理、死锁检测、并发的查询执行</li>
</ul>
<p>编译命令：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#6272a4"># 编译项目</span>
</span></span><span style="display:flex;"><span>mkdir build
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">cd</span> build
</span></span><span style="display:flex;"><span>cmake ..
</span></span><span style="display:flex;"><span>make
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 带 debug 的编译</span>
</span></span><span style="display:flex;"><span>cmake -DCMAKE_BUILD_TYPE<span style="color:#ff79c6">=</span>Debug ..;  make -j<span style="color:#f1fa8c">`</span>nproc<span style="color:#f1fa8c">`</span>; 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 检查语法</span>
</span></span><span style="display:flex;"><span>clear; make check-format; make check-lint; make check-clang-tidy-p3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 编译 P0 的测试</span>
</span></span><span style="display:flex;"><span>make starter_trie_test
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># p1、p2的</span>
</span></span><span style="display:flex;"><span>make extendible_hash_table_test -j<span style="color:#ff79c6">$(</span>nproc<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>make lru_k_replacer_test -j<span style="color:#ff79c6">$(</span>nproc<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>make buffer_pool_manager_instance_test -j<span style="color:#ff79c6">$(</span>nproc<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>make -j<span style="color:#f1fa8c">`</span>nproc<span style="color:#f1fa8c">`</span>;  make b_plus_tree_insert_test -j<span style="color:#ff79c6">$(</span>nproc<span style="color:#ff79c6">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="buffer-pool">buffer pool</h2>
<p>参考了 <a href="https://blog.eleven.wiki/posts/cmu15-445-project1-buffer-pool-manager/">这篇博客</a>   <br>
<strong>Extendible Hash Table</strong><br>
由一个 directory 和多个 bucket 组成</p>
<ul>
<li>directory，存放指向 bucket 的指针，是一个数组，用于寻找 key 对应 value 所在的 bucket</li>
<li>bucket，存放 value，是一个链表。一个 bucket 可以至多存放指定数量的 value</li>
</ul>
<p>Extendible Hash Table 与 Chained Hash Table 最大的区别是，Extendible Hash 中，不同的指针可以指向同一个 bucket，而 Chained Hash 中每个指针对应一个 bucket<br>
发生冲突时，Chained Hash 简单地将新的 value 追加到其 key 对应 bucket 链表的最后，也就是说 Chained Hash 的 bucket 没有容量上限。而 Extendible Hash 中，如果 bucket 到达容量上限，则对桶会进行一次 split 操作</p>
<p>假设 bucket = 2，现在已经有0、1两个值了，再插入就要 split了</p>
<ul>
<li>global depth++</li>
<li>directory 容量翻倍</li>
<li>创建一个新的 bucket</li>
<li>重新安排指针</li>
<li>重新分配 KV 对

        <a data-fancybox="gallery" href="https://woquhaha.gitee.io/pic_tech_1/post/2023/03/bustub%E6%95%B0%E6%8D%AE%E5%BA%93/p1-1.png">
            <img class="mx-auto" alt="" src="https://woquhaha.gitee.io/pic_tech_1/post/2023/03/bustub%E6%95%B0%E6%8D%AE%E5%BA%93/p1-1.png" />
        </a>
    </li>
</ul>
<p>这里还需要引入一个 local的 depth，只要发生分裂，local-depth++<br>
全局扩容时，容量翻倍，directory 中的指针，比如原先是0、1、2、3，扩容后就多了4、5、6、7<br>
如果观察 其二进制</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">&gt;&gt;&gt;</span> <span style="color:#8be9fd;font-style:italic">bin</span>(<span style="color:#bd93f9">5</span>),<span style="color:#8be9fd;font-style:italic">bin</span>(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#f1fa8c">&#39;0b101&#39;</span>, <span style="color:#f1fa8c">&#39;0b1&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">&gt;&gt;&gt;</span> <span style="color:#8be9fd;font-style:italic">bin</span>(<span style="color:#bd93f9">6</span>),<span style="color:#8be9fd;font-style:italic">bin</span>(<span style="color:#bd93f9">2</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#f1fa8c">&#39;0b110&#39;</span>, <span style="color:#f1fa8c">&#39;0b10&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">&gt;&gt;&gt;</span> <span style="color:#8be9fd;font-style:italic">bin</span>(<span style="color:#bd93f9">7</span>),<span style="color:#8be9fd;font-style:italic">bin</span>(<span style="color:#bd93f9">3</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#f1fa8c">&#39;0b111&#39;</span>, <span style="color:#f1fa8c">&#39;0b11&#39;</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>会发现，4、5、6、7其 低位部分，正好对应了 0、1、2、3<br>
所以扩容时，直接将原先 directory 的指针复制一遍就行了<br>
然后再将 value 插入对应的位置
扩容后，可能会有多个 directory指向同一个 bucket<br>

        <a data-fancybox="gallery" href="https://woquhaha.gitee.io/pic_tech_1/post/2023/03/bustub%E6%95%B0%E6%8D%AE%E5%BA%93/p1-2.png">
            <img class="mx-auto" alt="" src="https://woquhaha.gitee.io/pic_tech_1/post/2023/03/bustub%E6%95%B0%E6%8D%AE%E5%BA%93/p1-2.png" />
        </a>
    </p>
<p><strong>LRU-k</strong></p>
<ul>
<li>在 LRU-K 中，我们需要记录 page 最近 K 次被引用的时间</li>
<li>假如 list 中所有 page 都被引用了大于等于 K 次，则比较最近第 K 次被引用的时间，驱逐最早的</li>
<li>假如 list 中存在引用次数少于 K 次的 page，则将这些 page 挑选出来，用普通的 LRU 来比较这些 page 第一次被引用的时间，驱逐最早的

        <a data-fancybox="gallery" href="https://woquhaha.gitee.io/pic_tech_1/post/2023/03/bustub%E6%95%B0%E6%8D%AE%E5%BA%93/p1-3.png">
            <img class="mx-auto" alt="" src="https://woquhaha.gitee.io/pic_tech_1/post/2023/03/bustub%E6%95%B0%E6%8D%AE%E5%BA%93/p1-3.png" />
        </a>
     <br>
另外还需要注意一点，LRU-K Replacer 中的 page 有一个 evictable 属性，当一个 page 的 evicitable 为 false 时，上述算法跳过此 page 即可</li>
</ul>
<p><strong>Buffer Pool Manager</strong><br>
几个重要的变量</p>
<ul>
<li>pages：buffer pool 中缓存 pages 的指针数组</li>
<li>disk_manager：框架提供，可以用来读取 disk 上指定 page id 的 page 数据，或者向 disk 上给定 page id 对应的 page 里写入数据</li>
<li>page_table：刚才实现的 Extendible Hash Table，用来将 page id 映射到 frame id，即 page 在 buffer pool 中的位置</li>
<li>replacer：刚才实现的 LRU-K Replacer，在需要驱逐 page 腾出空间时，告诉我们应该驱逐哪个 page</li>
<li>free_list：空闲的 frame 列表</li>
</ul>
<p>NewPage</p>
<ul>
<li>如果所有page都是 unevictable，返回</li>
<li>如果 buffer pool中有空闲的，创建一个空的 page在 frame 中</li>
<li>如果 buffer pool中没有空闲的 frame，但有可以驱逐的page，调用 LRU-k 的替换策略</li>
<li>获取可以驱逐的 page的frame_id，将frame中的page驱逐，并创建新的page放在此frame中</li>
<li>如果驱逐的frame是脏的，则将page写入disk，并清空frame数据；非脏页就直接清空，再删除 LRU-k中的引用</li>
<li>放置新的page后，LRU-k中的frame设置驱逐为false</li>
</ul>
<p>整体结构如下：<br>

        <a data-fancybox="gallery" href="https://woquhaha.gitee.io/pic_tech_1/post/2023/03/bustub%E6%95%B0%E6%8D%AE%E5%BA%93/p1-4.png">
            <img class="mx-auto" alt="" src="https://woquhaha.gitee.io/pic_tech_1/post/2023/03/bustub%E6%95%B0%E6%8D%AE%E5%BA%93/p1-4.png" />
        </a>
    </p>
<h2 id="b树">B+树</h2>
<p>参考了，<a href="https://blog.eleven.wiki/posts/cmu15-445-project2-b+tree-index/">这篇博客</a><br>
课程附带的，在线B+树演示，<a href="https://15445.courses.cs.cmu.edu/fall2022/bpt-printer/">这里</a></p>
<p><strong>task-1</strong><br>
这里包含几个核心类</p>
<ul>
<li>B+Tree Parent Page，这是父类</li>
<li>B+Tree Internal Page，内部节点</li>
<li>B+Tree Leaf Page，叶子节点</li>
</ul>
<p>利用 flexible array 的特性来自动填充 page data 4KB 减掉 header 24byte 后剩余的内存。剩下的这些内存用来存放 KV 对<br>

        <a data-fancybox="gallery" href="https://woquhaha.gitee.io/pic_tech_1/post/2023/03/bustub%E6%95%B0%E6%8D%AE%E5%BA%93/p2-1.png">
            <img class="mx-auto" alt="" src="https://woquhaha.gitee.io/pic_tech_1/post/2023/03/bustub%E6%95%B0%E6%8D%AE%E5%BA%93/p2-1.png" />
        </a>
    </p>
<p>internal page 中，第一个 key，默认为空<br>
key 就是数据的key，value是 子节点的page_id<br>
除了 第一个 key是 &lt; key1 这种比较方式，后面的都是 &gt;=<br>

        <a data-fancybox="gallery" href="https://woquhaha.gitee.io/pic_tech_1/post/2023/03/bustub%E6%95%B0%E6%8D%AE%E5%BA%93/p2-2.png">
            <img class="mx-auto" alt="" src="https://woquhaha.gitee.io/pic_tech_1/post/2023/03/bustub%E6%95%B0%E6%8D%AE%E5%BA%93/p2-2.png" />
        </a>
    </p>
<p><strong>task-2</strong><br>
查找</p>
<ul>
<li>这个直接递归找就行了，后面插入、删除也会复用这个功能</li>
<li>封装成一个 Findleaf 函数</li>
<li>由于叶节点数据是有序的，可以用 二分</li>
<li>获取的时候，使用  buffer pool的 fetch-page，使用完后，需要将这个 page，unpin掉</li>
</ul>
<p>插入</p>
<ol>
<li>新建一个空的page</li>
<li>将原page的一半 move 到新page中</li>
<li>更新原page 和新page的 next_page_id</li>
<li>获取 parent-page，将用于区分原page和新page的 key插入父节点中</li>
<li>更新parent-page所有子节点的父节点指针</li>
<li>由于会递归的分裂，需要字底向上不断递归执行</li>
</ol>
<p>删除</p>
<ol>
<li>找到叶子节点数据，删除</li>
<li>检查左右兄弟节点(必须是同一个父节点的)，是否有空闲的，如果有则从兄弟节点偷一个</li>
<li>左边偷的时候偷最右边的，插入当前第一个(用当前key更新父节点)；右边偷第一个，插入当前最后一个(用右边节点key更新父节点)</li>
<li>如果是中间节点偷，偷左边(父节点key下移到当前，左节点最右key移动到当前)，偷右边(父节点key下移到右节点，右节点最左key移到当前)</li>
<li>否则跟兄弟节点合并，这里可以做个统一，做兄弟-当前合并(当前节点数据move到左节点)，当前节点-右节点合并(右节点move到当前)</li>
<li>再递归的从父节点中删除key</li>
</ol>
<p><strong>task-3</strong><br>
对叶子节点做迭代<br>
当迭代到末尾时检查当前的 next_page_id 是否为空，不空则要获取下一个page，继续迭代<br>
由于是从上往下先获取到某个叶子节点，然后从左到右节点的，理论上会跟 插入、删除产生冲突，出现死锁<br>
不过这块 课程说可以不用处理</p>
<p><strong>task-4</strong>
锁流程</p>
<ul>
<li>先锁住 parent page，</li>
<li>再锁住 child page，</li>
<li>假设 child page 是安全的，则释放 parent page 的锁</li>
<li>安全指当前 page 在当前操作下一定不会发生 split/steal/merge</li>
<li>同时，安全对不同操作的定义是不同的</li>
<li>Search 时，任何节点都安全</li>
<li>Insert 时，判断 max size</li>
<li>Delete 时，判断 min size</li>
<li>这里需要将遍历的page都放到 deque中，如果当前节点时安全的，则一次性释放所有的page锁</li>
</ul>
<h2 id="查询执行">查询执行</h2>
<p>官网给出的整体架构<br>

        <a data-fancybox="gallery" href="https://15445.courses.cs.cmu.edu/fall2022/project3/img/project-structure.svg">
            <img class="mx-auto" alt="" src="https://15445.courses.cs.cmu.edu/fall2022/project3/img/project-structure.svg" />
        </a>
    </p>
<blockquote>
<p>在线的 shell<br>
<a href="https://15445.courses.cs.cmu.edu/fall2022/bustub/">https://15445.courses.cs.cmu.edu/fall2022/bustub/</a></p>
</blockquote>
<p>内置了一些 mock 表</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>bustub<span style="color:#ff79c6">&gt;</span> \dt
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+</span><span style="color:#6272a4">-----+----------------+------------------------------+
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">|</span> oid <span style="color:#ff79c6">|</span> name           <span style="color:#ff79c6">|</span> cols                         <span style="color:#ff79c6">|</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+</span><span style="color:#6272a4">-----+----------------+------------------------------+
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">|</span> <span style="color:#bd93f9">0</span>   <span style="color:#ff79c6">|</span> __mock_table_1 <span style="color:#ff79c6">|</span> (colA:<span style="color:#8be9fd;font-style:italic">INTEGER</span>, colB:<span style="color:#8be9fd;font-style:italic">INTEGER</span>) <span style="color:#ff79c6">|</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">|</span> <span style="color:#bd93f9">1</span>   <span style="color:#ff79c6">|</span> __mock_table_2 <span style="color:#ff79c6">|</span> (colC:<span style="color:#8be9fd;font-style:italic">VARCHAR</span>, colD:<span style="color:#8be9fd;font-style:italic">VARCHAR</span>) <span style="color:#ff79c6">|</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">|</span> <span style="color:#bd93f9">2</span>   <span style="color:#ff79c6">|</span> __mock_table_3 <span style="color:#ff79c6">|</span> (colE:<span style="color:#8be9fd;font-style:italic">INTEGER</span>, colF:<span style="color:#8be9fd;font-style:italic">VARCHAR</span>) <span style="color:#ff79c6">|</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">|</span> ... <span style="color:#ff79c6">|</span> ...            <span style="color:#ff79c6">|</span> ...                          <span style="color:#ff79c6">|</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+</span><span style="color:#6272a4">-----+----------------+------------------------------+
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>单个<code>SQL</code>的执行过程<br>

        <a data-fancybox="gallery" href="https://woquhaha.gitee.io/pic_tech_1/post/2023/03/bustub%E6%95%B0%E6%8D%AE%E5%BA%93/p3-1.jpg">
            <img class="mx-auto" alt="" src="https://woquhaha.gitee.io/pic_tech_1/post/2023/03/bustub%E6%95%B0%E6%8D%AE%E5%BA%93/p3-1.jpg" />
        </a>
    </p>
<p>目前支持的算子：<br>

        <a data-fancybox="gallery" href="https://woquhaha.gitee.io/pic_tech_1/post/2023/03/bustub%E6%95%B0%E6%8D%AE%E5%BA%93/p3-2.jpg">
            <img class="mx-auto" alt="" src="https://woquhaha.gitee.io/pic_tech_1/post/2023/03/bustub%E6%95%B0%E6%8D%AE%E5%BA%93/p3-2.jpg" />
        </a>
    </p>
<p>explain</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>bustub<span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">explain</span> <span style="color:#ff79c6">select</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">from</span> __mock_t7;
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">===</span> BINDER <span style="color:#ff79c6">===</span>
</span></span><span style="display:flex;"><span>BoundSelect {
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">table</span><span style="color:#ff79c6">=</span>BoundBaseTableRef { <span style="color:#ff79c6">table</span><span style="color:#ff79c6">=</span>__mock_t7, oid<span style="color:#ff79c6">=</span><span style="color:#bd93f9">15</span> },
</span></span><span style="display:flex;"><span>  columns<span style="color:#ff79c6">=</span>[__mock_t7.v, __mock_t7.v1, __mock_t7.v2],
</span></span><span style="display:flex;"><span>  groupBy<span style="color:#ff79c6">=</span>[],
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">having</span><span style="color:#ff79c6">=</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">where</span><span style="color:#ff79c6">=</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">limit</span><span style="color:#ff79c6">=</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">offset</span><span style="color:#ff79c6">=</span>,
</span></span><span style="display:flex;"><span>  order_by<span style="color:#ff79c6">=</span>[],
</span></span><span style="display:flex;"><span>  is_distinct<span style="color:#ff79c6">=</span><span style="color:#ff79c6">false</span>,
</span></span><span style="display:flex;"><span>  ctes<span style="color:#ff79c6">=</span>,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">===</span> PLANNER <span style="color:#ff79c6">===</span>
</span></span><span style="display:flex;"><span>Projection { exprs<span style="color:#ff79c6">=</span>[<span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span>.<span style="color:#bd93f9">0</span>, <span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span>.<span style="color:#bd93f9">1</span>, <span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span>.<span style="color:#bd93f9">2</span>] } <span style="color:#ff79c6">|</span> (__mock_t7.v:<span style="color:#8be9fd;font-style:italic">INTEGER</span>, __mock_t7.v1:<span style="color:#8be9fd;font-style:italic">INTEGER</span>, __mock_t7.v2:<span style="color:#8be9fd;font-style:italic">INTEGER</span>)
</span></span><span style="display:flex;"><span>  MockScan { <span style="color:#ff79c6">table</span><span style="color:#ff79c6">=</span>__mock_t7 } <span style="color:#ff79c6">|</span> (__mock_t7.v:<span style="color:#8be9fd;font-style:italic">INTEGER</span>, __mock_t7.v1:<span style="color:#8be9fd;font-style:italic">INTEGER</span>, __mock_t7.v2:<span style="color:#8be9fd;font-style:italic">INTEGER</span>)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">===</span> OPTIMIZER <span style="color:#ff79c6">===</span>
</span></span><span style="display:flex;"><span>MockScan { <span style="color:#ff79c6">table</span><span style="color:#ff79c6">=</span>__mock_t7 } <span style="color:#ff79c6">|</span> (__mock_t7.v:<span style="color:#8be9fd;font-style:italic">INTEGER</span>, __mock_t7.v1:<span style="color:#8be9fd;font-style:italic">INTEGER</span>, __mock_t7.v2:<span style="color:#8be9fd;font-style:italic">INTEGER</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>P3 支持 SQL，可以用 SQL来执行，并检查结果</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>.<span style="color:#ff79c6">/</span>bin<span style="color:#ff79c6">/</span>bustub<span style="color:#ff79c6">-</span>sqllogictest ..<span style="color:#ff79c6">/</span>test<span style="color:#ff79c6">/</span><span style="color:#ff79c6">sql</span><span style="color:#ff79c6">/</span>p3.<span style="color:#bd93f9">06</span><span style="color:#ff79c6">-</span><span style="color:#ff79c6">simple</span><span style="color:#ff79c6">-</span>agg.slt <span style="color:#6272a4">--verbose
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>seq_scan_executor</strong><br>
这个没有 child，就是叶子节点，直接扫描 table 就行了</p>
<p><strong>insert_executor</strong><br>
这个有一个 子节点 是 values_executor，也就是 insert 时可以带多个 VALUES<br>
先拿到 一个 values，然后返回，再调用 table 插入到表中<br>
之后再更新 索引</p>
<p><strong>delete_executor</strong><br>
这个下面会跟一个 FilterExecutor，如果有 where 条件的话<br>
再往下就是 SeqScanExecutor，这个就是叶子节点了<br>
所以执行过程是，先 scan然后返回，filter判断是否满足条件，满足的话返回tuple，delete算子将这个 tuple插入到表中<br>
最后再更新 索引</p>
<p><strong>index_scan_executor</strong><br>
下面这个 SQL 经过优化后，会变成 index scan</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">EXPLAIN</span>  <span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> t2 <span style="color:#ff79c6">ORDER</span> <span style="color:#ff79c6">BY</span> v3;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">-- 优化后
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">===</span> PLANNER <span style="color:#ff79c6">===</span>
</span></span><span style="display:flex;"><span>Sort { order_bys<span style="color:#ff79c6">=</span>[(<span style="color:#ff79c6">Default</span>, <span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span>.<span style="color:#bd93f9">0</span>)] } <span style="color:#ff79c6">|</span> (t2.v3:<span style="color:#8be9fd;font-style:italic">INTEGER</span>, t2.v4:<span style="color:#8be9fd;font-style:italic">INTEGER</span>)
</span></span><span style="display:flex;"><span>  Projection { exprs<span style="color:#ff79c6">=</span>[<span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span>.<span style="color:#bd93f9">0</span>, <span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span>.<span style="color:#bd93f9">1</span>] } <span style="color:#ff79c6">|</span> (t2.v3:<span style="color:#8be9fd;font-style:italic">INTEGER</span>, t2.v4:<span style="color:#8be9fd;font-style:italic">INTEGER</span>)
</span></span><span style="display:flex;"><span>    SeqScan { <span style="color:#ff79c6">table</span><span style="color:#ff79c6">=</span>t2 } <span style="color:#ff79c6">|</span> (t2.v3:<span style="color:#8be9fd;font-style:italic">INTEGER</span>, t2.v4:<span style="color:#8be9fd;font-style:italic">INTEGER</span>)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">===</span> OPTIMIZER <span style="color:#ff79c6">===</span>
</span></span><span style="display:flex;"><span>IndexScan { index_oid<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0</span> } <span style="color:#ff79c6">|</span> (t2.v3:<span style="color:#8be9fd;font-style:italic">INTEGER</span>, t2.v4:<span style="color:#8be9fd;font-style:italic">INTEGER</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>这个就是 扫描 B+树 索引，拿到 RID，然后去 table-heap 里面查找对应的值</p>
<hr>
<p><strong>aggregation_executor</strong><br>
对于这种SQL</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">explain</span> <span style="color:#ff79c6">select</span> <span style="color:#ff79c6">max</span>(test_1.colC), <span style="color:#ff79c6">min</span>(test_1.colD), <span style="color:#ff79c6">count</span>(test_1.colA) <span style="color:#ff79c6">from</span> test_1 <span style="color:#ff79c6">group</span> <span style="color:#ff79c6">by</span> test_1.colA, test_1.colB;
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>其group by是：colA、colB</li>
<li>聚合字段是：colC、colD、colA</li>
<li>聚合规则为：max、min、count</li>
</ul>
<p>比如有这么一张表</p>
<table>
<thead>
<tr>
<th>&ndash;</th>
<th>&ndash;</th>
</tr>
</thead>
<tbody>
<tr>
<td>a1</td>
<td>x1</td>
</tr>
<tr>
<td>a1</td>
<td>x2</td>
</tr>
<tr>
<td>a1</td>
<td>x3</td>
</tr>
<tr>
<td>a2</td>
<td>x1</td>
</tr>
<tr>
<td>a2</td>
<td>y1</td>
</tr>
<tr>
<td>a3</td>
<td>x3</td>
</tr>
<tr>
<td>a1</td>
<td>y2</td>
</tr>
</tbody>
</table>
<p>a1：x1、x2、x3  <br>
a2：x1、y1<br>
a3：x3、y2</p>
<p>对于上面的SQL</p>
<ul>
<li>在 init阶段，从子节点返回tuple，封装key 和value</li>
<li>以(colA、colB)作为map的key</li>
<li>value是(colC、colD、colA)，也是一个联合的value</li>
<li>然后将 (colA、colB)对应的value，(colC、colD、colA)做聚合处理</li>
<li>value[0]累加max(colC)，value[1]累加min(colD)，value[2]累加count(colA)</li>
</ul>
<p><strong>nested_loop_join_executor</strong><br>
比如这个SQL，当然优化后会变成 hash-join</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> __mock_table_1, __mock_table_3 <span style="color:#ff79c6">WHERE</span> colA <span style="color:#ff79c6">=</span> colE;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">===</span> PLANNER <span style="color:#ff79c6">===</span>
</span></span><span style="display:flex;"><span>Projection { exprs<span style="color:#ff79c6">=</span>[<span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span>.<span style="color:#bd93f9">0</span>, <span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span>.<span style="color:#bd93f9">1</span>, <span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span>.<span style="color:#bd93f9">2</span>, <span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span>.<span style="color:#bd93f9">3</span>] } <span style="color:#ff79c6">|</span> (__mock_table_1.colA:<span style="color:#8be9fd;font-style:italic">INTEGER</span>, __mock_table_1.colB:<span style="color:#8be9fd;font-style:italic">INTEGER</span>, __mock_table_3.colE:<span style="color:#8be9fd;font-style:italic">INTEGER</span>, __mock_table_3.colF:<span style="color:#8be9fd;font-style:italic">VARCHAR</span>)
</span></span><span style="display:flex;"><span>  Filter { predicate<span style="color:#ff79c6">=</span>(<span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span>.<span style="color:#bd93f9">0</span><span style="color:#ff79c6">=#</span><span style="color:#bd93f9">0</span>.<span style="color:#bd93f9">2</span>) } <span style="color:#ff79c6">|</span> (__mock_table_1.colA:<span style="color:#8be9fd;font-style:italic">INTEGER</span>, __mock_table_1.colB:<span style="color:#8be9fd;font-style:italic">INTEGER</span>, __mock_table_3.colE:<span style="color:#8be9fd;font-style:italic">INTEGER</span>, __mock_table_3.colF:<span style="color:#8be9fd;font-style:italic">VARCHAR</span>)
</span></span><span style="display:flex;"><span>    NestedLoopJoin { <span style="color:#ff79c6">type</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">Inner</span>, predicate<span style="color:#ff79c6">=</span><span style="color:#ff79c6">true</span> } <span style="color:#ff79c6">|</span> (__mock_table_1.colA:<span style="color:#8be9fd;font-style:italic">INTEGER</span>, __mock_table_1.colB:<span style="color:#8be9fd;font-style:italic">INTEGER</span>, __mock_table_3.colE:<span style="color:#8be9fd;font-style:italic">INTEGER</span>, __mock_table_3.colF:<span style="color:#8be9fd;font-style:italic">VARCHAR</span>)
</span></span><span style="display:flex;"><span>      MockScan { <span style="color:#ff79c6">table</span><span style="color:#ff79c6">=</span>__mock_table_1 } <span style="color:#ff79c6">|</span> (__mock_table_1.colA:<span style="color:#8be9fd;font-style:italic">INTEGER</span>, __mock_table_1.colB:<span style="color:#8be9fd;font-style:italic">INTEGER</span>)
</span></span><span style="display:flex;"><span>      MockScan { <span style="color:#ff79c6">table</span><span style="color:#ff79c6">=</span>__mock_table_3 } <span style="color:#ff79c6">|</span> (__mock_table_3.colE:<span style="color:#8be9fd;font-style:italic">INTEGER</span>, __mock_table_3.colF:<span style="color:#8be9fd;font-style:italic">VARCHAR</span>)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">===</span> OPTIMIZER <span style="color:#ff79c6">===</span>
</span></span><span style="display:flex;"><span>HashJoin { <span style="color:#ff79c6">type</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">Inner</span>, left_key<span style="color:#ff79c6">=#</span><span style="color:#bd93f9">0</span>.<span style="color:#bd93f9">0</span>, right_key<span style="color:#ff79c6">=#</span><span style="color:#bd93f9">0</span>.<span style="color:#bd93f9">0</span> } <span style="color:#ff79c6">|</span> (__mock_table_1.colA:<span style="color:#8be9fd;font-style:italic">INTEGER</span>, __mock_table_1.colB:<span style="color:#8be9fd;font-style:italic">INTEGER</span>, __mock_table_3.colE:<span style="color:#8be9fd;font-style:italic">INTEGER</span>, __mock_table_3.colF:<span style="color:#8be9fd;font-style:italic">VARCHAR</span>)
</span></span><span style="display:flex;"><span>  MockScan { <span style="color:#ff79c6">table</span><span style="color:#ff79c6">=</span>__mock_table_1 } <span style="color:#ff79c6">|</span> (__mock_table_1.colA:<span style="color:#8be9fd;font-style:italic">INTEGER</span>, __mock_table_1.colB:<span style="color:#8be9fd;font-style:italic">INTEGER</span>)
</span></span><span style="display:flex;"><span>  MockScan { <span style="color:#ff79c6">table</span><span style="color:#ff79c6">=</span>__mock_table_3 } <span style="color:#ff79c6">|</span> (__mock_table_3.colE:<span style="color:#8be9fd;font-style:italic">INTEGER</span>, __mock_table_3.colF:<span style="color:#8be9fd;font-style:italic">VARCHAR</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>调用左子树，拿到结果，拿到 tuple，再 for 遍历右边，再拿一个tuple</li>
<li>对比两个tuple是否相等</li>
<li>如果相等，则将左表、右表的value封装成tuple返回</li>
<li>如果不等，并且join类型是 LEFT，则返回左表的value，右表对应的设置为空</li>
<li>需要注意保存 left、right的遍历位置</li>
</ul>
<p><strong>nested_index_join_executor</strong><br>
下面这个 SQL 优化后就变成这样：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> t1 <span style="color:#ff79c6">INNER</span> <span style="color:#ff79c6">JOIN</span> t2 <span style="color:#ff79c6">ON</span> v1 <span style="color:#ff79c6">=</span> v3;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NestedIndexJoin { <span style="color:#ff79c6">type</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">Inner</span>, key_predicate<span style="color:#ff79c6">=#</span><span style="color:#bd93f9">0</span>.<span style="color:#bd93f9">0</span>, <span style="color:#ff79c6">index</span><span style="color:#ff79c6">=</span>t2v3, index_table<span style="color:#ff79c6">=</span>t2 } <span style="color:#ff79c6">|</span> (t1.v1:<span style="color:#8be9fd;font-style:italic">INTEGER</span>, t1.v2:<span style="color:#8be9fd;font-style:italic">INTEGER</span>, t2.v3:<span style="color:#8be9fd;font-style:italic">INTEGER</span>, t2.v4:<span style="color:#8be9fd;font-style:italic">INTEGER</span>)
</span></span><span style="display:flex;"><span>  SeqScan { <span style="color:#ff79c6">table</span><span style="color:#ff79c6">=</span>t1 } <span style="color:#ff79c6">|</span> (t1.v1:<span style="color:#8be9fd;font-style:italic">INTEGER</span>, t1.v2:<span style="color:#8be9fd;font-style:italic">INTEGER</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>根据查询计划，创建出 左表，以及右表的 index</li>
<li>遍历左表，获取一个 value，然后 B+树(右表的)扫描这个 value</li>
<li>如果返回的 rid不为空，就拿这个 rid 去 table-heap中查询</li>
<li>并将 左、右表返回的 value 封装为tuple返回</li>
<li>如果右表的rid返回空，join类型为LEFT，只返回左表的tuple，右表的全部设置空</li>
</ul>
<hr>
<p><strong>sort</strong><br>
SQL如下</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> __mock_table_1 <span style="color:#ff79c6">ORDER</span> <span style="color:#ff79c6">BY</span> colA <span style="color:#ff79c6">ASC</span>, colB <span style="color:#ff79c6">DESC</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">===</span> OPTIMIZER <span style="color:#ff79c6">===</span>
</span></span><span style="display:flex;"><span>Sort { order_bys<span style="color:#ff79c6">=</span>[(Ascending, <span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span>.<span style="color:#bd93f9">0</span>), (Descending, <span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span>.<span style="color:#bd93f9">1</span>)] } <span style="color:#ff79c6">|</span> (__mock_table_1.colA:<span style="color:#8be9fd;font-style:italic">INTEGER</span>, __mock_table_1.colB:<span style="color:#8be9fd;font-style:italic">INTEGER</span>)
</span></span><span style="display:flex;"><span>  MockScan { <span style="color:#ff79c6">table</span><span style="color:#ff79c6">=</span>__mock_table_1 } <span style="color:#ff79c6">|</span> (__mock_table_1.colA:<span style="color:#8be9fd;font-style:italic">INTEGER</span>, __mock_table_1.colB:<span style="color:#8be9fd;font-style:italic">INTEGER</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>可以在<code>init</code>的时候，将整个子节点全部加载到内存中</li>
<li>然后用<code>std::sort</code>做排序，然后一个<code>for</code>循环处理所有的<code>order by</code>列表</li>
<li>在<code>std::sort</code>的<code>lambda</code>中，按照字段顺序做 asc、desc</li>
<li>在 next中，只需要遍历获取值就可以了</li>
</ul>
<p><strong>limit</strong><br>
SQL</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> __mock_table_1 <span style="color:#ff79c6">LIMIT</span> <span style="color:#bd93f9">10</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">===</span> OPTIMIZER <span style="color:#ff79c6">===</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">Limit</span> { <span style="color:#ff79c6">limit</span><span style="color:#ff79c6">=</span><span style="color:#bd93f9">10</span> } <span style="color:#ff79c6">|</span> (__mock_table_1.colA:<span style="color:#8be9fd;font-style:italic">INTEGER</span>, __mock_table_1.colB:<span style="color:#8be9fd;font-style:italic">INTEGER</span>)
</span></span><span style="display:flex;"><span>  MockScan { <span style="color:#ff79c6">table</span><span style="color:#ff79c6">=</span>__mock_table_1 } <span style="color:#ff79c6">|</span> (__mock_table_1.colA:<span style="color:#8be9fd;font-style:italic">INTEGER</span>, __mock_table_1.colB:<span style="color:#8be9fd;font-style:italic">INTEGER</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>init的时候只需要初始化子节点</li>
<li>next的时候设置一个 count，然后获取子节点再 count++</li>
<li>当 count 达到 limit的数量时，返回false</li>
</ul>
<p><strong>topN</strong><br>
比如 sort + limit 就会被优化为 topN</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">EXPLAIN</span> <span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> __mock_table_1 <span style="color:#ff79c6">ORDER</span> <span style="color:#ff79c6">BY</span> colA <span style="color:#ff79c6">LIMIT</span> <span style="color:#bd93f9">10</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">===</span> PLANNER <span style="color:#ff79c6">===</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">Limit</span> { <span style="color:#ff79c6">limit</span><span style="color:#ff79c6">=</span><span style="color:#bd93f9">10</span> } <span style="color:#ff79c6">|</span> (__mock_table_1.colA:<span style="color:#8be9fd;font-style:italic">INTEGER</span>, __mock_table_1.colB:<span style="color:#8be9fd;font-style:italic">INTEGER</span>)
</span></span><span style="display:flex;"><span>  Sort { order_bys<span style="color:#ff79c6">=</span>[(<span style="color:#ff79c6">Default</span>, <span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span>.<span style="color:#bd93f9">0</span>)] } <span style="color:#ff79c6">|</span> (__mock_table_1.colA:<span style="color:#8be9fd;font-style:italic">INTEGER</span>, __mock_table_1.colB:<span style="color:#8be9fd;font-style:italic">INTEGER</span>)
</span></span><span style="display:flex;"><span>    Projection { exprs<span style="color:#ff79c6">=</span>[<span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span>.<span style="color:#bd93f9">0</span>, <span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span>.<span style="color:#bd93f9">1</span>] } <span style="color:#ff79c6">|</span> (__mock_table_1.colA:<span style="color:#8be9fd;font-style:italic">INTEGER</span>, __mock_table_1.colB:<span style="color:#8be9fd;font-style:italic">INTEGER</span>)
</span></span><span style="display:flex;"><span>      MockScan { <span style="color:#ff79c6">table</span><span style="color:#ff79c6">=</span>__mock_table_1 } <span style="color:#ff79c6">|</span> (__mock_table_1.colA:<span style="color:#8be9fd;font-style:italic">INTEGER</span>, __mock_table_1.colB:<span style="color:#8be9fd;font-style:italic">INTEGER</span>)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">===</span> OPTIMIZER <span style="color:#ff79c6">===</span>
</span></span><span style="display:flex;"><span>TopN { n<span style="color:#ff79c6">=</span><span style="color:#bd93f9">10</span>, order_bys<span style="color:#ff79c6">=</span>[(<span style="color:#ff79c6">Default</span>, <span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span>.<span style="color:#bd93f9">0</span>)]} <span style="color:#ff79c6">|</span> (__mock_table_1.colA:<span style="color:#8be9fd;font-style:italic">INTEGER</span>, __mock_table_1.colB:<span style="color:#8be9fd;font-style:italic">INTEGER</span>)
</span></span><span style="display:flex;"><span>  MockScan { <span style="color:#ff79c6">table</span><span style="color:#ff79c6">=</span>__mock_table_1 } <span style="color:#ff79c6">|</span> (__mock_table_1.colA:<span style="color:#8be9fd;font-style:italic">INTEGER</span>, __mock_table_1.colB:<span style="color:#8be9fd;font-style:italic">INTEGER</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>init的时候直接把子节点的数据读进来，排序的方式跟 order by类似</li>
<li>根据 asc、desc做排序，需要使用<code>std::priority_queue</code>，然后自定义一个排序规则</li>
<li>排序规则跟 order by的类似，priority_queue 保持住 limit个元素</li>
<li>next 阶段就直接从迭代器中获取</li>
<li>为了实现 topN，还需要实现一个优化规则，当检查到 plan是 limit(做一个cast转换)，并且子节点是order by(做一个cast转换)</li>
<li>就将 limit和order by 的 plan信息取出，创建出新的 topN plan，topN plan的子节点指向 order by的子节点</li>
<li>还需用递归，处理多种 limit+order by的情况</li>
</ul>
<hr>
<p>优化<br>
<strong>Query 1: Where&rsquo;s the Index?</strong></p>
<ul>
<li>优化规则，将 NLJ 转换为 HJ</li>
<li>检查当前的<code>plan</code>为<code>NLJ</code>，并检查 谓词是 等值判断</li>
<li>将左右节点取出，转换为<code>HJ</code></li>
<li>hash join的执行，init 部分，将左表取出，放到 hash 表中</li>
<li>next时，去probe右表的内容，检查是否匹配，hash-join的前提是必须是 等值的</li>
<li>join reorder，根据<code>EstimatedCardinality</code>调整顺序，不过这个函数都是 mock的数据，只能用于mock表</li>
<li>NLJAsIndexJoin 的规则是左表有index，右表是table/mock-table，这里也可以优化一下，反过来也成立</li>
</ul>
<p><strong>Query 2: Too Many Joins!</strong></p>
<ul>
<li>NLJ套NLJ，左节点必须也是NLJ，同时左节点的两个节点，以及右节点必须有一个是scan</li>
</ul>
<p><strong>Query 3: The Mad Data Scientist</strong></p>
<ul>
<li>列裁剪，两个project的node做合并，以上面的为准</li>
<li>project套agg时，将agg中多余的express去掉</li>
</ul>
<h2 id="并发控制">并发控制</h2>
<p><strong>task 1</strong></p>
<ul>
<li>表锁的申请和释放</li>
<li>行锁的申请和释放</li>
</ul>
<p>LockTable 执行流程</p>
<ol>
<li>txn状态检查</li>
</ol>
<ul>
<li>READ_UNCOMMITTED，只允许X、IX锁，并且只能在GROWING阶段</li>
<li>READ_COMMITTED，允许所有的锁，只有IS、S锁允许出现在SHRINKING阶段</li>
<li>REPEATABLE_READ，允许所有的锁，所有锁只能出现在GROWING阶段，不允许出现在SHRINKING阶段</li>
</ul>
<ol start="2">
<li>获取锁</li>
</ol>
<ul>
<li>根据 oid 从table_map中找到request_queue</li>
<li>如果队列不存在 则创建一个，锁住队列，释放table_lock_map</li>
</ul>
<ol start="3">
<li>检查锁升级</li>
</ol>
<ul>
<li>请求队列中 tid 等于当前事务id</li>
<li>不允许多个并发对相同资源升级锁</li>
<li>判断 锁更新模式的兼容性</li>
<li>兼容性：IS -&gt; [S, X, IX, SIX]、S -&gt; [X, SIX]、IX -&gt; [X, SIX]、SIX -&gt; <input checked="" disabled="" type="checkbox"> </li>
<li>从原队列中删除LockRequest，创建一个新的锁升级后的LockRequest，找到第一个没有获得锁的 LockRequest，插在它前面</li>
<li>获得锁授权，即检查S、X、IS、IX、SIX的彼此兼容性，不兼容则用 std::condition_variable 等待</li>
<li>如果唤醒后发现是 aborted状态则返回(死锁检查时，某个事务会终止，醒来后需要判断)</li>
<li>否则将锁升级置空，设置granted，插入到事务记录中，并唤醒此队列上的其他线程(非X模式下)</li>
</ul>
<ol start="4">
<li>锁请求入队列</li>
</ol>
<ul>
<li>先插入到队列尾部，之后跟锁升级情况类似</li>
<li>锁授权，兼容性检查，不满足则等待</li>
<li>满足则唤醒队列中其他线程(非X模式下)，返回返回</li>
</ul>
<p>table_lock_map_ 的结构如下：<br>

        <a data-fancybox="gallery" href="https://woquhaha.gitee.io/pic_tech_1/post/2023/03/bustub%E6%95%B0%E6%8D%AE%E5%BA%93/p4-1.jpg">
            <img class="mx-auto" alt="" src="https://woquhaha.gitee.io/pic_tech_1/post/2023/03/bustub%E6%95%B0%E6%8D%AE%E5%BA%93/p4-1.jpg" />
        </a>
    </p>
<p>锁升级：<br>

        <a data-fancybox="gallery" href="https://woquhaha.gitee.io/pic_tech_1/post/2023/03/bustub%E6%95%B0%E6%8D%AE%E5%BA%93/p4-2.jpg">
            <img class="mx-auto" alt="" src="https://woquhaha.gitee.io/pic_tech_1/post/2023/03/bustub%E6%95%B0%E6%8D%AE%E5%BA%93/p4-2.jpg" />
        </a>
    </p>
<p>更新事务的加锁集合</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#6272a4">// 等待在条件变量上
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">while</span>(<span style="color:#ff79c6">!</span>checkCompability()){
</span></span><span style="display:flex;"><span>    que<span style="color:#ff79c6">-&gt;</span>cv_.wait(lock)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// 另一种写法
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>que<span style="color:#ff79c6">-&gt;</span>cv_.wait(lock,[<span style="color:#ff79c6">&amp;</span>](){
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#50fa7b">checkCompability</span>();
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></td></tr></table>
</div>
</div><p>LockRow 执行流程<br>
总体上跟 LockTable差不多，但有些不同点</p>
<ul>
<li>IS、IX、SIX这几种不支持行锁</li>
<li>锁的GROWING、SHRINKING检查都是一样的</li>
<li>如果锁模式为 X，检查对应的表锁中是否存在 X、IX、SIX</li>
<li>只有跟 LockTable差不多，获取队列(为空则创建)，检查锁升级，锁升级兼容性检查，</li>
<li>同上，再从队列中删除，创建新的升级锁插入到合适位置，然后锁授权检查，不兼容则wait</li>
<li>否则，插入队列，锁授权检查，不兼容wait，兼容则唤醒队列其他线程(非X模式下)，并返回</li>
</ul>
<p>UnlockTable<br>
相关LockTable要简单很多</p>
<ul>
<li>首先检查 table_lock_map_ 是否有对应的表 oid，没有则终止</li>
<li>检查事务关联的 S的row_set、X的row_set是否已经被释放，没有则终止</li>
<li>获取对应的 队列，遍历队列，如果事务是granted_ ，则从队列中删除，唤醒其他线程</li>
<li>更新事务状态，如果是 READ_UNCOMMITTED &amp;&amp; X模式、READ_COMMITTED &amp;&amp; X模式、 REPEATABLE_READ &amp;&amp; (S || X 模式)</li>
<li>且当前事务非 commit、或者非 aborted，设置状态为SHRINKING</li>
<li>从事务管理的集合中删除LockRequest</li>
<li>如果队列中没找到，则抛出异常 ATTEMPTED_UNLOCK_BUT_NO_LOCK_HELD</li>
</ul>
<p>UnlockRow的总体流程跟 UnlockTable类似</p>
<p><strong>task 2</strong><br>
触发的入口是<code>RunCycleDetection</code>函数，这个函数在后台定期运行<br>
事务1 -&gt; 事务2 的关系，放到 waits_for_中，几个重要的变量</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#6272a4">// 表示事务等待的图拓扑
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>std<span style="color:#ff79c6">::</span>unordered_map<span style="color:#ff79c6">&lt;</span>txn_id_t, std<span style="color:#ff79c6">::</span>vector<span style="color:#ff79c6">&lt;</span>txn_id_t<span style="color:#ff79c6">&gt;&gt;</span> waits_for_;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// 放到这里的 事务id都是安全的
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>std<span style="color:#ff79c6">::</span>set<span style="color:#ff79c6">&lt;</span>txn_id_t<span style="color:#ff79c6">&gt;</span> safe_set_;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// 等待的事务 id 集合
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>std<span style="color:#ff79c6">::</span>set<span style="color:#ff79c6">&lt;</span>txn_id_t<span style="color:#ff79c6">&gt;</span> txn_set_;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// 活跃事务 id 集合
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>std<span style="color:#ff79c6">::</span>unordered_set<span style="color:#ff79c6">&lt;</span>txn_id_t<span style="color:#ff79c6">&gt;</span> active_set_;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// 事务id -&gt; row id 的map
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>std<span style="color:#ff79c6">::</span>unordered_map<span style="color:#ff79c6">&lt;</span>txn_id_t, RID<span style="color:#ff79c6">&gt;</span> map_txn_rid_;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// 事务id -&gt; table id的map
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>std<span style="color:#ff79c6">::</span>unordered_map<span style="color:#ff79c6">&lt;</span>txn_id_t, table_oid_t<span style="color:#ff79c6">&gt;</span> map_txn_oid_;
</span></span></code></pre></td></tr></table>
</div>
</div><p>同时也将 事务1、事务2的 tid 保存起来<br>
流程</p>
<ol>
<li>遍历table_lock_map_，获取table_oid_t对应的队列，遍历队列</li>
<li>如果队列中的granted_为true，则假如到 granted_set中</li>
<li>否则加入到等待图中，也就是调用 AddEdge，并将事务id放到 txn_set_中</li>
<li>对于 row_lock_map_ 也按照同样逻辑走一遍</li>
<li>调用 HasCycle，判断是否有死锁，这里需要while判断</li>
<li>如果有死锁，则将这个事务终止，从waits_for_中删除，并调用 RemoveEdge，删除图中的边</li>
<li>调用table_lock_map_的cv唤醒table上的等待线程(如果有的话)，同理唤醒row上的等待线程</li>
</ol>
<p>HasCycle流程</p>
<ol>
<li>遍历 txn_set_，然后调用 DFS不断检查每个事务id</li>
<li>DFS中将其加入到 active_set_ 中</li>
<li>从waits_for_中找到这个事务id 指向的下一个节点集合</li>
<li>对这个集合做排序</li>
<li>下一个节点不为空，并且存在于活跃事务中，说明出现环了，返回</li>
<li>否则继续做深度遍历</li>
<li>DFS遍历完没有发现环，返回 false</li>
<li>如果发现了环，则从活跃事务集合中，找到max，也就是最新的那个</li>
<li>之后RunCycleDetection中就使用这个事务id，打破循环</li>
</ol>
<p>table_lock_map_ 中的队列，以及事务的依赖<br>
这里 txn6同时等待 t1、t2<br>
t6同时被 t1、t4等待<br>

        <a data-fancybox="gallery" href="https://woquhaha.gitee.io/pic_tech_1/post/2023/03/bustub%E6%95%B0%E6%8D%AE%E5%BA%93/p4-3.jpg">
            <img class="mx-auto" alt="" src="https://woquhaha.gitee.io/pic_tech_1/post/2023/03/bustub%E6%95%B0%E6%8D%AE%E5%BA%93/p4-3.jpg" />
        </a>
    </p>
<p>所以 t6 和 t1之间出现环，t6最新所以要终止<br>

        <a data-fancybox="gallery" href="https://woquhaha.gitee.io/pic_tech_1/post/2023/03/bustub%E6%95%B0%E6%8D%AE%E5%BA%93/p4-4.jpg">
            <img class="mx-auto" alt="" src="https://woquhaha.gitee.io/pic_tech_1/post/2023/03/bustub%E6%95%B0%E6%8D%AE%E5%BA%93/p4-4.jpg" />
        </a>
    </p>
<p><strong>task 3</strong><br>
SeqScanExecutor</p>
<ul>
<li>init的时候，非 READ_UNCOMMITTED模式，要锁住表，用 IS 模式</li>
<li>next时，如果结束了，对于READ_COMMITTED要释放所有行所，再释放表锁，REPEATABLE_READ不用管会统一释放</li>
<li>next时，非READ_UNCOMMITTED模式下，锁住行</li>
</ul>
<p>InsertExecutor</p>
<ul>
<li>init时，使用 IX模式，锁住表</li>
<li>next时候，获取子节点的tuple，插入table-heap中，然后执行 X模式的行所，将这个记录插入到tuple关联的所有index中</li>
</ul>
<p>DeleteExecutor</p>
<ul>
<li>跟插入基本一样，init时用 IX锁住表</li>
<li>next时候拿到子节点的tuple，锁住行，删除table-heap中的行，再更新tuple关联的所有index</li>
</ul>
<p>优化部分参考 <a href="https://zhuanlan.zhihu.com/p/592700870">这里</a></p>
<h2 id="参考">参考</h2>
<ul>
<li><a href="https://github.com/cmu-db/bustub">github</a></li>
<li><a href="https://blog.csdn.net/altair_alpha/category_12074227.html">CSDN博客，详细介绍具体实现</a></li>
<li><a href="https://www.zhihu.com/column/c_1332789616266084352">知乎-CMU15-445数据库Lab</a></li>
<li><a href="https://www.zhihu.com/column/c_1605901992903004160">CMU15-445 22Fall通关记录</a></li>
<li><a href="https://github.com/ejunjsh/bustub">bustub实现</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/570917775">BusTub 养成记：从课程项目到 SQL 数据库</a></li>
<li><a href="https://www.zhihu.com/column/c_1612944787874721792">CMU 15445记录</a></li>
<li><a href="https://jameywoo.github.io/post/cmu15-445/bushub%E6%BA%90%E7%A0%81%E6%95%B4%E4%BD%93%E6%80%A7%E5%88%86%E6%9E%90/">CMU 15-445: BusHub整体分析</a></li>
</ul>

			<script type="text/javascript"
        async
        src="https://cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[\[','\]\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});

MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<style>
code.has-jax {
    font: inherit;
    font-size: 100%;
    background: inherit;
    border: inherit;
    color: #515151;
}
</style>
        </div>

        


        

<div class="post-archive">
    <h2>相关文章</h2>
    <ul class="listing">
        
        <li><a href="/post/2023/01/advanced-database-systems-query-execution-and-processing/">Advanced Database Systems: Query Execution &amp; Processing</a></li>
        
        <li><a href="/post/2022/11/cmu%E6%95%B0%E6%8D%AE%E5%BA%93%E6%80%BB%E7%BB%93/">CMU数据库总结</a></li>
        
        <li><a href="/post/2022/07/cmu%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AF%BE%E7%A8%8B/">卡内基梅隆的数据库课程-1</a></li>
        
        <li><a href="/post/2022/07/cmu%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AF%BE%E7%A8%8B-2/">卡内基梅隆的数据库课程-2</a></li>
        
        <li><a href="/post/2022/07/cmu%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AF%BE%E7%A8%8B-3/">卡内基梅隆的数据库课程-3</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='/tags/cmu-database'>CMU-Database</a></li>
                
            </ul>
            
        </div>
    </article>
    
    

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "himichael/hugoblogtalks"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
</div>


                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='https://code0xff.org/search/' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://code0xff.org/">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://code0xff.org/post/2023/05/column-stores_vs_row-stores_how_different_are_they_really/" title="Column-Stores vs. Row-Stores: How Different Are They Really?">Column-Stores vs. Row-Stores: How Different Are They Really?</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2023/05/lakehouse-a-new-generation-of-open-platforms-that-unify/" title="Lakehouse A New Generation of Open Platforms that Unify Data Warehousing and Advanced Analytics">Lakehouse A New Generation of Open Platforms that Unify Data Warehousing and Advanced Analytics</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2023/05/building-an-elastic-query-engine-on-disaggregated-storage/" title="Building An Elastic Query Engine on Disaggregated Storage">Building An Elastic Query Engine on Disaggregated Storage</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2023/05/what-goes-around-comes-around/" title="What Goes Around Comes Around">What Goes Around Comes Around</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2023/04/levedb-%E5%A4%9A%E7%89%88%E6%9C%AC%E5%92%8C%E5%8E%8B%E7%BC%A9/" title="LevelDB 多版本和压缩">LevelDB 多版本和压缩</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2023/04/levedb-%E5%B7%A5%E5%85%B7%E7%B1%BB/" title="LevelDB 辅助工具类">LevelDB 辅助工具类</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2023/04/levedb-sstable%E6%A8%A1%E5%9D%97/" title="LevelDB SSTable模块">LevelDB SSTable模块</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2023/04/levedb-memtable%E6%A8%A1%E5%9D%97/" title="LevelDB MemTable模块">LevelDB MemTable模块</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2023/04/levedb-log%E6%A8%A1%E5%9D%97/" title="LevelDB Log模块">LevelDB Log模块</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2023/03/levedb-%E5%85%AC%E5%BC%80%E6%8E%A5%E5%8F%A3/" title="LevelDB 公开的接口">LevelDB 公开的接口</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories/'>分类</a></h3>
<ul class="widget-list">
    
    <li><a href="https://code0xff.org/categories/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式 (6)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/">原理分析 (13)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E5%95%86%E4%B8%9A/">商业 (3)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据 (22)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库 (25)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E6%96%87%E5%AD%A6%E5%92%8C%E8%89%BA%E6%9C%AF/">文学和艺术 (2)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E6%97%85%E8%A1%8C/">旅行 (10)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E6%9E%B6%E6%9E%84/">架构 (2)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E7%AE%97%E6%B3%95/">算法 (8)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E7%B3%BB%E7%BB%9F/">系统 (5)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/">编程语言 (2)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E8%A1%8C%E4%B8%9A%E8%A7%82%E5%AF%9F/">行业观察 (1)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">读书笔记 (11)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E9%9A%8F%E4%BE%BF%E5%86%99%E5%86%99/">随便写写 (3)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title">归档</a></h3>
<ul class="widget-list">
    
    <li><a href="https://code0xff.org/years/2021%E5%B9%B4/">2021年 (31)</a></li>
    
    <li><a href="https://code0xff.org/years/2022%E5%B9%B4/">2022年 (55)</a></li>
    
    <li><a href="https://code0xff.org/years/2023%E5%B9%B4/">2023年 (27)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags/'>标签</a></h3>
<div class="tagcloud">
    
    <a href="https://code0xff.org/tags/b%E6%A0%91/">B树 </a>
    
    <a href="https://code0xff.org/tags/cmu-database/">CMU-Database </a>
    
    <a href="https://code0xff.org/tags/flink/">flink </a>
    
    <a href="https://code0xff.org/tags/hive/">Hive </a>
    
    <a href="https://code0xff.org/tags/k8s/">k8s </a>
    
    <a href="https://code0xff.org/tags/kudu/">kudu </a>
    
    <a href="https://code0xff.org/tags/kyuubi/">Kyuubi </a>
    
    <a href="https://code0xff.org/tags/lakehouse/">Lakehouse </a>
    
    <a href="https://code0xff.org/tags/leveldb/">LevelDB </a>
    
    <a href="https://code0xff.org/tags/llvm/">LLVM </a>
    
    <a href="https://code0xff.org/tags/manacher/">Manacher </a>
    
    <a href="https://code0xff.org/tags/mapreduce/">MapReduce </a>
    
    <a href="https://code0xff.org/tags/mysql/">MySQL </a>
    
    <a href="https://code0xff.org/tags/newsql/">NewSQL </a>
    
    <a href="https://code0xff.org/tags/oceanbase/">OceanBase </a>
    
    <a href="https://code0xff.org/tags/paxos/">paxos </a>
    
    <a href="https://code0xff.org/tags/raft/">raft </a>
    
    <a href="https://code0xff.org/tags/scala/">scala </a>
    
    <a href="https://code0xff.org/tags/simd/">SIMD </a>
    
    <a href="https://code0xff.org/tags/snowflake/">snowflake </a>
    
    <a href="https://code0xff.org/tags/spark/">spark </a>
    
    <a href="https://code0xff.org/tags/unix/">unix </a>
    
    <a href="https://code0xff.org/tags/%E4%BA%8C%E5%88%86%E6%9F%A5%E6%89%BE/">二分查找 </a>
    
    <a href="https://code0xff.org/tags/%E4%BA%8C%E5%8F%89%E6%A0%91%E9%81%8D%E5%8E%86/">二叉树遍历 </a>
    
    <a href="https://code0xff.org/tags/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式 </a>
    
    <a href="https://code0xff.org/tags/%E5%88%97%E5%AD%98/">列存 </a>
    
    <a href="https://code0xff.org/tags/%E5%8A%A8%E6%80%81%E6%B3%A8%E5%85%A5/">动态注入 </a>
    
    <a href="https://code0xff.org/tags/%E5%8E%86%E5%8F%B2/">历史 </a>
    
    <a href="https://code0xff.org/tags/%E5%90%91%E9%87%8F%E5%8C%96/">向量化 </a>
    
    <a href="https://code0xff.org/tags/%E5%9B%9E%E6%BA%AF/">回溯 </a>
    
    <a href="https://code0xff.org/tags/%E5%9B%BD%E5%86%85%E6%97%85%E8%A1%8C/">国内旅行 </a>
    
    <a href="https://code0xff.org/tags/%E5%9B%BD%E5%A4%96%E6%97%85%E8%A1%8C/">国外旅行 </a>
    
    <a href="https://code0xff.org/tags/%E5%A4%9A%E7%A7%9F%E6%88%B7/">多租户 </a>
    
    <a href="https://code0xff.org/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据 </a>
    
    <a href="https://code0xff.org/tags/%E5%AD%98%E5%82%A8/">存储 </a>
    
    <a href="https://code0xff.org/tags/%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95/">工作记录 </a>
    
    <a href="https://code0xff.org/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务 </a>
    
    <a href="https://code0xff.org/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库 </a>
    
    <a href="https://code0xff.org/tags/%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B/">数据模型 </a>
    
    <a href="https://code0xff.org/tags/%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96/">查询优化 </a>
    
    <a href="https://code0xff.org/tags/%E6%9F%A5%E8%AF%A2%E7%BC%96%E8%AF%91/">查询编译 </a>
    
    <a href="https://code0xff.org/tags/%E6%B1%87%E7%BC%96/">汇编 </a>
    
    <a href="https://code0xff.org/tags/%E6%B5%8B%E8%AF%95/">测试 </a>
    
    <a href="https://code0xff.org/tags/%E6%B9%96%E4%BB%93%E4%B8%80%E4%BD%93/">湖仓一体 </a>
    
    <a href="https://code0xff.org/tags/%E7%94%9F%E6%B4%BB/">生活 </a>
    
    <a href="https://code0xff.org/tags/%E7%94%B5%E5%BD%B1/">电影 </a>
    
    <a href="https://code0xff.org/tags/%E7%AE%97%E6%B3%95/">算法 </a>
    
    <a href="https://code0xff.org/tags/%E7%BB%8F%E6%B5%8E/">经济 </a>
    
    <a href="https://code0xff.org/tags/%E7%BC%93%E5%AD%98/">缓存 </a>
    
    <a href="https://code0xff.org/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/">编译原理 </a>
    
    <a href="https://code0xff.org/tags/%E7%BD%91%E7%BB%9C/">网络 </a>
    
    <a href="https://code0xff.org/tags/%E8%AE%A1%E7%AE%97%E6%A1%86%E6%9E%B6/">计算框架 </a>
    
    <a href="https://code0xff.org/tags/%E8%AE%BA%E6%96%87/">论文 </a>
    
    <a href="https://code0xff.org/tags/%E8%AF%BB%E4%B9%A6/">读书 </a>
    
    <a href="https://code0xff.org/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">读书笔记 </a>
    
</div>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">RSS</h3>
        <ul class="widget-list">
            <li><a href="https://code0xff.org/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
    <footer id="footer">
    <div>
        &copy; 2023 <a href="https://code0xff.org/">记录每个瞬间 By 老王</a>
        
    </div>
    <br />
    <div>
        <div class="github-badge">
            <a href="https://gohugo.io/" target="_black" rel="nofollow"><span class="badge-subject">Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
        </div>
        <div class="github-badge">
            <a href="https://github.com/flysnow-org/maupassant-hugo" target="_black"><span class="badge-subject">Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
        </div>
    </div>
</footer>


    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script><script src="https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'GA ID', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



    <script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>




</body>

</html>