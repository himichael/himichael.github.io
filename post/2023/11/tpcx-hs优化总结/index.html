<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="referrer" content="no-referrer-when-downgrade">
    

    <title>TPCx-HS优化总结 | 记录每个瞬间</title>
    <meta property="og:title" content="TPCx-HS优化总结 - 记录每个瞬间">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2023-11-09T09:13:07&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2023-11-09T09:13:07&#43;08:00'>
        
    <meta name="Keywords" content="">
    <meta name="description" content="TPCx-HS优化总结">
        <meta name="author" content="隔壁老王">
        
    <meta property="og:url" content="https://code0xff.org/post/2023/11/tpcx-hs%E4%BC%98%E5%8C%96%E6%80%BB%E7%BB%93/">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    
    
        <link href="https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" rel="stylesheet">
    
    
    
    
</head>


<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://code0xff.org/">
                        记录每个瞬间
                    </a>
                
                
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="https://code0xff.org/">首页</a>
                    
                    <a  href="https://code0xff.org/linked/" title="链接">链接</a>
                    
                    <a  href="https://code0xff.org/archives/" title="归档">归档</a>
                    
                    <a  href="https://code0xff.org/about/" title="关于">关于</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    
    <article class="post">
        <header>
            <h1 class="post-title">TPCx-HS优化总结</h1>
        </header>
        <date class="post-meta meta-date">
            2023年11月9日
        </date>
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#背景介绍">背景介绍</a></li>
        <li><a href="#优化思路">优化思路</a>
          <ul>
            <li><a href="#机器配置">机器配置</a></li>
            <li><a href="#整体流程分析">整体流程分析</a></li>
            <li><a href="#spark版本升级">Spark版本升级</a></li>
            <li><a href="#增加批量写入功能">增加批量写入功能</a></li>
            <li><a href="#排序优化">排序优化</a></li>
            <li><a href="#spark参数优化">Spark参数优化</a></li>
            <li><a href="#os层面优化">OS层面优化</a></li>
            <li><a href="#单机版本对比">单机版本对比</a></li>
            <li><a href="#参考">参考</a></li>
          </ul>
        </li>
        <li><a href="#jvm优化">JVM优化</a>
          <ul>
            <li><a href="#gc调优">GC调优</a></li>
            <li><a href="#g1调优">G1调优</a></li>
            <li><a href="#zgc调优">ZGC调优</a></li>
            <li><a href="#采样分析">采样分析</a></li>
            <li><a href="#参考-1">参考</a></li>
          </ul>
        </li>
        <li><a href="#一些优化思路记录">一些优化思路记录</a>
          <ul>
            <li><a href="#hdfs缓存">HDFS缓存</a></li>
            <li><a href="#预启动优化">预启动优化</a></li>
            <li><a href="#向量化">向量化</a></li>
            <li><a href="#参考-2">参考</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
        
        <div class="post-meta">
            
            <span class="post-meta meta-tags">
                <ul class="clearfix">
                    <a href='/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE'>大数据</a>
                </ul>
            </span>
            
        </div>
        
        
        <div class="post-meta">
            <span id="busuanzi_container_page_pv">|<span id="busuanzi_value_page_pv"></span><span>
                    阅读</span></span>
        </div>
        
        
        <div class="post-content">
            <h2 id="背景介绍">背景介绍</h2>
<p>TPCx-HS是TPC组织提供的性能测试基准工具    （http://www.tpc.org/tpcx-hs/default.asp），主要目标是评估Hadoop集群的性能和可扩展性。<br>
通过模拟大规模数据处理场景，测试集群在不同负载下的实际性能，包括吞吐量、响应时间、资源利用率等指标。<br>
测试结果可以为用户提供有关Hadoop集群的性能和可扩展性方面的参考数据，以帮助用户做出更好的决策。<br>
TPCx-HS本质上是Hadoop的TeraSort    benchmark，通过对TB级数据进行排序，来测试HDFS和MapReduce框架对大规模数据的处理性能。<br>
TPCx HS由以下三个任务组成：</p>
<ul>
<li>HSGen：生成大量用于排序的数据并存储于HDFS，数据量可以选择1TB~10000TB，典型测试数据量为1TB、3TB、10TB、30TB</li>
<li>HSSort：从HDFS上读取TeraGen生成的数据，用MapReduce框架进行排序，并将排序结果结果存储在HDFS中。</li>
<li>HValidate：排序结果验证，负责对HSSort的排序结果文件进行正确性校验，确认所有数据都按排序键正确排序。</li>
</ul>
<p>TPCx-HS提供标准测试工具和脚本，仅允许配置执行引擎（MR/Spark）、数据量大小等少量参数。整个测试流程需要按顺序完成两轮（Run1/Run2）完整测试，每轮测试都需要按顺序执行三个任务。两轮测试完成，取较低成绩为最终测试结果。</p>
<h2 id="优化思路">优化思路</h2>
<h3 id="机器配置">机器配置</h3>
<p>通过对TPCx-HS现有1TB榜单前两两名，以及准备参与的两个企业的硬件配置做一个比较<br>

        <a data-fancybox="gallery" href="https://woquhaha.gitee.io/pic_tech_1/post/2023/11/TPCx-HS/machine.jpg">
            <img class="mx-auto" alt="" src="https://woquhaha.gitee.io/pic_tech_1/post/2023/11/TPCx-HS/machine.jpg" />
        </a>
    </p>
<h3 id="整体流程分析">整体流程分析</h3>
<p>通过对TPCx-HS的流程代码分析，及实际测试，对不同测试阶段的资源占用进行如下分析。可以看出在不同任务阶段，对系统资源要求有所差异，评测结果受硬件性能影响很大。因此需要分别从CPU、网络、磁盘对整个测试系统进行有针对性的优化。<br>

        <a data-fancybox="gallery" href="https://woquhaha.gitee.io/pic_tech_1/post/2023/11/TPCx-HS/TPCx-HS.jpg">
            <img class="mx-auto" alt="" src="https://woquhaha.gitee.io/pic_tech_1/post/2023/11/TPCx-HS/TPCx-HS.jpg" />
        </a>
    </p>
<p>针对此次测试做的主要优化</p>
<ul>
<li>Spark编译适配JDK22，可以用到 ZGC（优化三个阶段的整体吞吐量）</li>
<li>优化批量写入（优化HSGen和HSSort的磁盘I/O）</li>
<li>编译scala将排序部分做成并行化（优化HSSort部分）</li>
<li>调整Spark参数（优化三个阶段的执行速度）</li>
</ul>
<p>一共5台机器，每台机器的角色如下</p>
<table>
<thead>
<tr>
<th>机器编号</th>
<th>namenode</th>
<th>datanode</th>
<th>Spark-master</th>
<th>Spark-slaver</th>
</tr>
</thead>
<tbody>
<tr>
<td>10</td>
<td>Y</td>
<td>y</td>
<td></td>
<td>Y</td>
</tr>
<tr>
<td>11</td>
<td></td>
<td>Y</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td>12</td>
<td></td>
<td>Y</td>
<td></td>
<td>Y</td>
</tr>
<tr>
<td>13</td>
<td></td>
<td>Y</td>
<td></td>
<td>Y</td>
</tr>
<tr>
<td>14</td>
<td></td>
<td>Y</td>
<td></td>
<td>Y</td>
</tr>
</tbody>
</table>
<p>不需要大数据平台组件，全部手动安装，不需要高可用<br>
每个datanode使用 8块盘，读写速度约为 4G/s</p>
<p>检查网络、磁盘，内存读写</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#6272a4"># 检查磁盘写入</span>
</span></span><span style="display:flex;"><span>dd <span style="color:#ff79c6">if</span><span style="color:#ff79c6">=</span>/dev/zero <span style="color:#8be9fd;font-style:italic">of</span><span style="color:#ff79c6">=</span>/data3/10G_file <span style="color:#8be9fd;font-style:italic">bs</span><span style="color:#ff79c6">=</span>1M <span style="color:#8be9fd;font-style:italic">count</span><span style="color:#ff79c6">=</span><span style="color:#bd93f9">10240</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">time</span> cp /data3/10G_file  /data/10G_file
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 检查内存</span>
</span></span><span style="display:flex;"><span>mount -t tmpfs -o <span style="color:#8be9fd;font-style:italic">size</span><span style="color:#ff79c6">=</span>20G tmpfs /data4/mytmpfs
</span></span><span style="display:flex;"><span>mount -t tmpfs -o <span style="color:#8be9fd;font-style:italic">size</span><span style="color:#ff79c6">=</span>20G tmpfs /data5/mytmpfs
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dd <span style="color:#ff79c6">if</span><span style="color:#ff79c6">=</span>/dev/zero <span style="color:#8be9fd;font-style:italic">of</span><span style="color:#ff79c6">=</span>/data4/mytmpfs /10G_file <span style="color:#8be9fd;font-style:italic">bs</span><span style="color:#ff79c6">=</span>1M <span style="color:#8be9fd;font-style:italic">count</span><span style="color:#ff79c6">=</span><span style="color:#bd93f9">10240</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">time</span> cp /data4/mytmpfs /10G_file /data5/mytmpfs /10G_file
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 检查网络</span>
</span></span><span style="display:flex;"><span>iperf -s
</span></span><span style="display:flex;"><span>iperf -c 服务端IP
</span></span></code></pre></td></tr></table>
</div>
</div><p>scp 传输检查各节点之间的网络传输速度，确保各个节点网络都正常</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">time</span> scp 100GB_file root@目标IP:/data
</span></span></code></pre></td></tr></table>
</div>
</div><p>整体目标</p>
<ul>
<li>尽可能让每个节点处理的任务量相差不大</li>
<li>尽可能让每个节点的资源，如CPU、内存、I/O等都处理满负荷状态</li>
<li>磁盘和网络配比约为 10：7，或者10：8，低于或者高于这个值，可能会出现硬件瓶颈</li>
<li>内存尽量多，可以启动更多executor，也可以用于更多的文件系统缓存</li>
<li>CPU也尽可能多，用于排序的并行计算</li>
</ul>
<h3 id="spark版本升级">Spark版本升级</h3>
<p>评测脚本是基于Spark 2.x + Scala<br>
2.11.x编译的，所以此次选用的Spark版本为2.4.8<br>
该版本的Spark从官网获取的信息，以及实际测试只支持JDK 1.8，因此需要使用高版本JDK重新编译 <br>
在实际中，我们选择了OpenJDK最新版本JDK    22，因为Spark2.x版本使用的部分JVM函数与新版本JDK不兼容，所以整个编译过程需要根据错误信息进行修改</p>
<h3 id="增加批量写入功能">增加批量写入功能</h3>
<p>TPCx-HS代码中，HSGen和HSSort有两个类</p>
<ul>
<li>HSOutputFormat</li>
<li>HadoopHSOutputFormat</li>
</ul>
<p>分别实现了HadoopRecordWriter接口的write方法<br>
该方法最终会被Spark调用，将数据写入HDFS文件。调用链示意图见下<br>

        <a data-fancybox="gallery" href="https://woquhaha.gitee.io/pic_tech_1/post/2023/11/TPCx-HS/spark_batch_write.jpg">
            <img class="mx-auto" alt="" src="https://woquhaha.gitee.io/pic_tech_1/post/2023/11/TPCx-HS/spark_batch_write.jpg" />
        </a>
    </p>
<p>该方法每被调用一次，则写入一行数据，尽管有IO    Cache保证写盘效率，但1T测试数据有100亿行，需要调用Java虚函数100亿次<br>
因此需要为Hadoop/Spark以及TPCx-HS增加BatchWrite能力</p>
<p>Hadoop主要增加新接口</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">abstract</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">RecordWriter</span><span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span> V<span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>  	<span style="color:#ff79c6">......</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">abstract</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">batchWrite</span><span style="color:#ff79c6">(</span>List<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">&gt;</span> keys<span style="color:#ff79c6">,</span> List<span style="color:#ff79c6">&lt;</span>V<span style="color:#ff79c6">&gt;</span> values<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">throws</span> IOException<span style="color:#ff79c6">,</span> InterruptedException<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">......</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Spark主要增加以下方法</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">def</span> batchWrite<span style="color:#ff79c6">[</span><span style="color:#8be9fd">K</span>, <span style="color:#8be9fd">V:</span> <span style="color:#8be9fd">ClassTag</span><span style="color:#ff79c6">](</span>rdd<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">RDD</span><span style="color:#ff79c6">[(</span><span style="color:#8be9fd">K</span>, <span style="color:#8be9fd">V</span><span style="color:#ff79c6">)],</span>
</span></span><span style="display:flex;"><span>                            config<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">HadoopWriteConfigUtil</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">K</span>, <span style="color:#8be9fd">V</span><span style="color:#ff79c6">],</span>
</span></span><span style="display:flex;"><span>                            batchSize<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Int</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Unit</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>       <span style="color:#ff79c6">......</span>
</span></span><span style="display:flex;"><span>        executeBatchTask<span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span>          context <span style="color:#ff79c6">=</span> context<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span>          config <span style="color:#ff79c6">=</span> config<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span>          jobTrackerId <span style="color:#ff79c6">=</span> jobTrackerId<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span>          commitJobId <span style="color:#ff79c6">=</span> commitJobId<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span>          sparkPartitionId <span style="color:#ff79c6">=</span> context<span style="color:#ff79c6">.</span>partitionId<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span>          sparkAttemptNumber <span style="color:#ff79c6">=</span> attemptId<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span>          committer <span style="color:#ff79c6">=</span> committer<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span>          iterator <span style="color:#ff79c6">=</span> iter<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span>          batchSize<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">})</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">......</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">private</span> <span style="color:#ff79c6">def</span> executeBatchTask<span style="color:#ff79c6">[</span><span style="color:#8be9fd">K</span>, <span style="color:#8be9fd">V:</span> <span style="color:#8be9fd">ClassTag</span><span style="color:#ff79c6">](</span>
</span></span><span style="display:flex;"><span>      context<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">TaskContext</span><span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span>      config<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">HadoopWriteConfigUtil</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">K</span>, <span style="color:#8be9fd">V</span><span style="color:#ff79c6">],</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">......,</span>
</span></span><span style="display:flex;"><span>      batchSize<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Int</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">TaskCommitMessage</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">......</span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">while</span> <span style="color:#ff79c6">(</span>iterator<span style="color:#ff79c6">.</span>hasNext<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">val</span> pair <span style="color:#ff79c6">=</span> iterator<span style="color:#ff79c6">.</span>next<span style="color:#ff79c6">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          keys <span style="color:#ff79c6">+=</span> pair<span style="color:#ff79c6">.</span>_1
</span></span><span style="display:flex;"><span>          values <span style="color:#ff79c6">+=</span> pair<span style="color:#ff79c6">.</span>_2
</span></span><span style="display:flex;"><span>          len <span style="color:#ff79c6">+=</span> <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>len <span style="color:#ff79c6">&gt;=</span> batchSize<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            config<span style="color:#ff79c6">.</span>batchWrite<span style="color:#ff79c6">(</span>keys<span style="color:#ff79c6">.</span>toList<span style="color:#ff79c6">,</span> values<span style="color:#ff79c6">.</span>toList<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>            keys<span style="color:#ff79c6">.</span>clear<span style="color:#ff79c6">()</span>
</span></span><span style="display:flex;"><span>            values<span style="color:#ff79c6">.</span>clear<span style="color:#ff79c6">()</span>
</span></span><span style="display:flex;"><span>            len <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        config<span style="color:#ff79c6">.</span>batchWrite<span style="color:#ff79c6">(</span>keys<span style="color:#ff79c6">.</span>toList<span style="color:#ff79c6">,</span> values<span style="color:#ff79c6">.</span>toList<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>        logInfo<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">s&#34;complete batchWrite&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">......</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>TPCx-HS需要增加BatchWrite调用，并实现接口BatchWrite接口</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>方法调用     
</span></span><span style="display:flex;"><span> <span style="color:#50fa7b">if</span> <span style="color:#ff79c6">(</span>mode<span style="color:#ff79c6">.</span><span style="color:#50fa7b">equalsIgnoreCase</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;batch&#34;</span><span style="color:#ff79c6">))</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    dataset<span style="color:#ff79c6">.</span><span style="color:#50fa7b">batchSaveAsNewAPIHadoopFile</span><span style="color:#ff79c6">[</span>HSOutputFormat<span style="color:#ff79c6">](</span>outputFile<span style="color:#ff79c6">,</span> Integer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">parseInt</span><span style="color:#ff79c6">(</span>batchSize<span style="color:#ff79c6">))</span>
</span></span><span style="display:flex;"><span> <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    dataset<span style="color:#ff79c6">.</span><span style="color:#50fa7b">saveAsNewAPIHadoopFile</span><span style="color:#ff79c6">[</span>HSOutputFormat<span style="color:#ff79c6">](</span>outputFile<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span> <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>接口实现
</span></span><span style="display:flex;"><span>    override def <span style="color:#50fa7b">batchWrite</span><span style="color:#ff79c6">(</span>keys<span style="color:#ff79c6">:</span> util<span style="color:#ff79c6">.</span><span style="color:#50fa7b">List</span><span style="color:#ff79c6">[</span>Array<span style="color:#ff79c6">[</span>Byte<span style="color:#ff79c6">]],</span> values<span style="color:#ff79c6">:</span> util<span style="color:#ff79c6">.</span><span style="color:#50fa7b">List</span><span style="color:#ff79c6">[</span>Array<span style="color:#ff79c6">[</span>Byte<span style="color:#ff79c6">]])</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">synchronized</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span>i <span style="color:#ff79c6">&lt;-</span> 0 until keys<span style="color:#ff79c6">.</span><span style="color:#50fa7b">size</span><span style="color:#ff79c6">())</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>          out<span style="color:#ff79c6">.</span><span style="color:#50fa7b">write</span><span style="color:#ff79c6">(</span>keys<span style="color:#ff79c6">.</span><span style="color:#50fa7b">get</span><span style="color:#ff79c6">(</span>i<span style="color:#ff79c6">),</span> 0<span style="color:#ff79c6">,</span> keys<span style="color:#ff79c6">.</span><span style="color:#50fa7b">get</span><span style="color:#ff79c6">(</span>i<span style="color:#ff79c6">).</span><span style="color:#50fa7b">length</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>          out<span style="color:#ff79c6">.</span><span style="color:#50fa7b">write</span><span style="color:#ff79c6">(</span>values<span style="color:#ff79c6">.</span><span style="color:#50fa7b">get</span><span style="color:#ff79c6">(</span>i<span style="color:#ff79c6">),</span> 0<span style="color:#ff79c6">,</span> values<span style="color:#ff79c6">.</span><span style="color:#50fa7b">get</span><span style="color:#ff79c6">(</span>i<span style="color:#ff79c6">).</span><span style="color:#50fa7b">length</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="排序优化">排序优化</h3>
<p>创建三个自定义的类</p>
<ul>
<li>MyArrays，拷贝自java.util.Arrays，增加一些自定义的函数</li>
<li>MyTimSort，拷贝自java.util.TimSort</li>
<li>MyArraysParallelSortHelpers，拷贝自java.util. ArraysParallelSortHelpers</li>
</ul>
<p>MyArrays中增加的函数为：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#ff79c6">&lt;</span>T <span style="color:#8be9fd;font-style:italic">extends</span> Comparable<span style="color:#ff79c6">&lt;?</span> <span style="color:#8be9fd;font-style:italic">super</span> T<span style="color:#ff79c6">&gt;&gt;</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">parallelSortWithArgument</span><span style="color:#ff79c6">(</span>T<span style="color:#ff79c6">[]</span> a<span style="color:#ff79c6">,</span> <span style="color:#8be9fd">int</span> parallelism<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">int</span> n <span style="color:#ff79c6">=</span> a<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span><span style="color:#ff79c6">,</span> p<span style="color:#ff79c6">,</span> g<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>n <span style="color:#ff79c6">&lt;=</span> MIN_ARRAY_SORT_GRAN <span style="color:#ff79c6">||</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">(</span>p <span style="color:#ff79c6">=</span> parallelism<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">==</span> 1<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>            MyTimSort<span style="color:#ff79c6">.</span><span style="color:#50fa7b">sort</span><span style="color:#ff79c6">(</span>a<span style="color:#ff79c6">,</span> 0<span style="color:#ff79c6">,</span> n<span style="color:#ff79c6">,</span> NaturalOrder<span style="color:#ff79c6">.</span><span style="color:#50fa7b">INSTANCE</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">,</span> 0<span style="color:#ff79c6">,</span> 0<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">else</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">new</span> MyArraysParallelSortHelpers<span style="color:#ff79c6">.</span><span style="color:#50fa7b">FJObject</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">Sorter</span><span style="color:#ff79c6">&lt;&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#ff79c6">(</span><span style="color:#ff79c6">null</span><span style="color:#ff79c6">,</span> a<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#ff79c6">(</span>T<span style="color:#ff79c6">[])</span> Array<span style="color:#ff79c6">.</span><span style="color:#50fa7b">newInstance</span><span style="color:#ff79c6">(</span>a<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getClass</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">getComponentType</span><span style="color:#ff79c6">(),</span> n<span style="color:#ff79c6">),</span>
</span></span><span style="display:flex;"><span>                            0<span style="color:#ff79c6">,</span> n<span style="color:#ff79c6">,</span> 0<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">((</span>g <span style="color:#ff79c6">=</span> n <span style="color:#ff79c6">/</span> <span style="color:#ff79c6">(</span>p <span style="color:#ff79c6">&lt;&lt;</span> 2<span style="color:#ff79c6">))</span> <span style="color:#ff79c6">&lt;=</span> MIN_ARRAY_SORT_GRAN<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">?</span>
</span></span><span style="display:flex;"><span>                            MIN_ARRAY_SORT_GRAN <span style="color:#ff79c6">:</span> g<span style="color:#ff79c6">,</span> NaturalOrder<span style="color:#ff79c6">.</span><span style="color:#50fa7b">INSTANCE</span><span style="color:#ff79c6">).</span><span style="color:#50fa7b">invoke</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>类似这样的函数还有三个，其内容跟原生的类似，只是增加了一个参数，这样就可以设置自定义的并行度了<br>
由于这几个类不依赖任何第三方库，直接用 javac编译，jar命令打成mysort.jar包即可<br>
将mysort.jar 放到$JAVA_HOME/jar/lib/ext 目录下</p>
<p>下载scala源码，代码checkout到 2.11.x，https://github.com/scala/scala/tree/2.11.x<br>
修改 src/library/scala/collection下的 SeqLike.scala，修改sorted函数</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">def</span> sorted<span style="color:#ff79c6">[</span><span style="color:#8be9fd">B</span> <span style="color:#ff79c6">&gt;:</span> <span style="color:#8be9fd">A</span><span style="color:#ff79c6">](</span><span style="color:#ff79c6">implicit</span> ord<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Ordering</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">B</span><span style="color:#ff79c6">])</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Repr</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">val</span> <span style="color:#50fa7b">MY_SORT_NUMS</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">String</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;com_my_sort_nums&#34;</span>
</span></span><span style="display:flex;"><span>。。。。。。
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">val</span> paralelismNums<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">String</span> <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">System</span><span style="color:#ff79c6">.</span>getProperty<span style="color:#ff79c6">(</span><span style="color:#50fa7b">MY_SORT_NUMS</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>paralelismNums <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#ff79c6">!</span><span style="color:#f1fa8c">&#34;&#34;</span><span style="color:#ff79c6">.</span>equals<span style="color:#ff79c6">(</span>paralelismNums<span style="color:#ff79c6">))</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">val</span> numSize <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">Integer</span><span style="color:#ff79c6">.</span>parseInt<span style="color:#ff79c6">(</span>paralelismNums<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>        com<span style="color:#ff79c6">.</span>mysort<span style="color:#ff79c6">.</span><span style="color:#50fa7b">MyArrays</span><span style="color:#ff79c6">.</span>parallelSortWithArgument<span style="color:#ff79c6">(</span>arr<span style="color:#ff79c6">,</span> ord<span style="color:#ff79c6">.</span>asInstanceOf<span style="color:#ff79c6">[</span><span style="color:#8be9fd">Ordering</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Object</span><span style="color:#ff79c6">]],</span> numSize<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        java<span style="color:#ff79c6">.</span>util<span style="color:#ff79c6">.</span><span style="color:#50fa7b">Arrays</span><span style="color:#ff79c6">.</span>sort<span style="color:#ff79c6">(</span>arr<span style="color:#ff79c6">,</span> ord<span style="color:#ff79c6">.</span>asInstanceOf<span style="color:#ff79c6">[</span><span style="color:#8be9fd">Ordering</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Object</span><span style="color:#ff79c6">]])</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>。。。。。。
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>根据环境变量 com_my_sort_nums 判断，是否需要调用 MyArrays类<br>
Scala源码编译命令</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sbt compile
</span></span><span style="display:flex;"><span>sbt publishLocal
</span></span><span style="display:flex;"><span>sbt dist/mkBin
</span></span><span style="display:flex;"><span>sbt dist/mkPack
</span></span></code></pre></td></tr></table>
</div>
</div><p>最后结果在  $scala_home/build/pack  目录下，包含bin，lib目录<br>
将spark/jars目录下的 scala-library-2.11.12.jar删除，将bulic/pack/lib 目录下的 scala-library.jar    拷贝过去，将mysort.jar也拷贝过去</p>
<p>使用方式，在spark-defaults.conf 中增加一段：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>spark.executor.extraJavaOptions --add-opens java.base/java.nio<span style="color:#ff79c6">=</span>ALL-UNNAMED <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>--add-opens<span style="color:#ff79c6">=</span>java.base/sun.nio.ch<span style="color:#ff79c6">=</span>ALL-UNNAMED --add-opens<span style="color:#ff79c6">=</span>java.base/java.util<span style="color:#ff79c6">=</span>ALL-UNNAMED <span style="color:#f1fa8c">\
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"></span>--add-opens<span style="color:#ff79c6">=</span>java.base/java.lang.invoke<span style="color:#ff79c6">=</span>ALL-UNNAMED --add-opens<span style="color:#ff79c6">=</span>java.base/java.lang<span style="color:#ff79c6">=</span>ALL-UNNAMED <span style="color:#f1fa8c">\ </span>
</span></span><span style="display:flex;"><span>--add-opens<span style="color:#ff79c6">=</span>java.base/java.util.concurrent<span style="color:#ff79c6">=</span>ALL-UNNAMED -Dcom_my_sort_nums<span style="color:#ff79c6">=</span><span style="color:#bd93f9">8</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>通过环境变量设置上即可</p>
<h3 id="spark参数优化">Spark参数优化</h3>
<p>主要的调整参数</p>
<ul>
<li>修改序列化实现类</li>
<li>Shuffle写数据到内存上</li>
<li>Shuffle数据压缩、内存buffer，写盘buffer、线程数、队列大小</li>
<li>数据本地性等待时间</li>
<li>map输出缓冲区大小、reduce端读取缓冲区大小</li>
<li>计算内存大小</li>
<li>任务并行度</li>
</ul>
<p>spark-defaults.conf 主要参数调整</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>spark<span style="color:#ff79c6">.</span><span style="color:#50fa7b">io</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">compression</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">codec</span> snappy
</span></span><span style="display:flex;"><span>spark<span style="color:#ff79c6">.</span><span style="color:#50fa7b">io</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">compression</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">snappy</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">blockSize</span> 64kb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>spark<span style="color:#ff79c6">.</span><span style="color:#50fa7b">serializer</span><span style="color:#ff79c6">=</span>org<span style="color:#ff79c6">.</span><span style="color:#50fa7b">apache</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">spark</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">serializer</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">KryoSerializer</span>
</span></span><span style="display:flex;"><span>spark<span style="color:#ff79c6">.</span><span style="color:#50fa7b">kryo</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">classesToRegister</span><span style="color:#ff79c6">=</span>org<span style="color:#ff79c6">.</span><span style="color:#50fa7b">apache</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">spark</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">sql</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">types</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">Decimal</span><span style="color:#ff79c6">,</span>scala<span style="color:#ff79c6">.</span><span style="color:#50fa7b">collection</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">immutable</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">Vector</span><span style="color:#ff79c6">,</span>scala<span style="color:#ff79c6">.</span><span style="color:#50fa7b">collection</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">Iterator</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>spark<span style="color:#ff79c6">.</span><span style="color:#50fa7b">shuffle</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">file</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">buffer</span> 8m
</span></span><span style="display:flex;"><span>spark<span style="color:#ff79c6">.</span><span style="color:#50fa7b">shuffle</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">io</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">backLog</span> 81920
</span></span><span style="display:flex;"><span>spark<span style="color:#ff79c6">.</span><span style="color:#50fa7b">shuffle</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">io</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">serverThreads</span> 1280
</span></span><span style="display:flex;"><span>spark<span style="color:#ff79c6">.</span><span style="color:#50fa7b">shuffle</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">service</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">enabled</span> <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>spark<span style="color:#ff79c6">.</span><span style="color:#50fa7b">shuffle</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">unsafe</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">file</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">output</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">buffer</span> 32m
</span></span><span style="display:flex;"><span>spark<span style="color:#ff79c6">.</span><span style="color:#50fa7b">shuffle</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">mapStatus</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">compression</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">codec</span> snappy
</span></span><span style="display:flex;"><span>spark<span style="color:#ff79c6">.</span><span style="color:#50fa7b">shuffle</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">sort</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">initialBufferSize</span> 65536
</span></span><span style="display:flex;"><span>spark<span style="color:#ff79c6">.</span><span style="color:#50fa7b">shuffle</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">spill</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">diskWriteBufferSize</span><span style="color:#ff79c6">=</span>64m
</span></span><span style="display:flex;"><span>spark<span style="color:#ff79c6">.</span><span style="color:#50fa7b">shuffle</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">spill</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">initialMemoryThreshold</span><span style="color:#ff79c6">=</span>256m
</span></span><span style="display:flex;"><span>spark<span style="color:#ff79c6">.</span><span style="color:#50fa7b">shuffle</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">spill</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">batchSize</span><span style="color:#ff79c6">=</span>1000000
</span></span><span style="display:flex;"><span>spark<span style="color:#ff79c6">.</span><span style="color:#50fa7b">shuffle</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">compress</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>spark<span style="color:#ff79c6">.</span><span style="color:#50fa7b">storage</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">memoryMapThreshold</span> 1m
</span></span><span style="display:flex;"><span>spark<span style="color:#ff79c6">.</span><span style="color:#50fa7b">storage</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">replication</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">policy</span> org<span style="color:#ff79c6">.</span><span style="color:#50fa7b">apache</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">spark</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">storage</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">BasicBlockReplicationPolicy</span>
</span></span><span style="display:flex;"><span>spark<span style="color:#ff79c6">.</span><span style="color:#50fa7b">network</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">timeout</span> 360
</span></span><span style="display:flex;"><span>spark<span style="color:#ff79c6">.</span><span style="color:#50fa7b">reducer</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">maxSizeInFlight</span> 384M
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>spark<span style="color:#ff79c6">.</span><span style="color:#50fa7b">locality</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">wait</span><span style="color:#ff79c6">=</span>1s
</span></span><span style="display:flex;"><span>spark<span style="color:#ff79c6">.</span><span style="color:#50fa7b">unsafe</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">sorter</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">spill</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">reader</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">buffer</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">size</span> 32m
</span></span><span style="display:flex;"><span>spark<span style="color:#ff79c6">.</span><span style="color:#50fa7b">files</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">openCostInBytes</span>  8388608
</span></span><span style="display:flex;"><span>spark<span style="color:#ff79c6">.</span><span style="color:#50fa7b">files</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">maxPartitionByte</span> 268435456
</span></span><span style="display:flex;"><span>spark<span style="color:#ff79c6">.</span><span style="color:#50fa7b">buffer</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">write</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">chunkSize</span> 33554432
</span></span><span style="display:flex;"><span>spark<span style="color:#ff79c6">.</span><span style="color:#50fa7b">task</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">maxDirectResultSize</span> 2097052
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>spark<span style="color:#ff79c6">.</span><span style="color:#50fa7b">local</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">dir</span><span style="color:#ff79c6">=/</span>run<span style="color:#ff79c6">/</span>shuffle
</span></span><span style="display:flex;"><span>spark<span style="color:#ff79c6">.</span><span style="color:#50fa7b">memory</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">fraction</span><span style="color:#ff79c6">=</span>0<span style="color:#ff79c6">.</span><span style="color:#50fa7b">85</span>
</span></span><span style="display:flex;"><span>spark<span style="color:#ff79c6">.</span><span style="color:#50fa7b">memory</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">storageFraction</span><span style="color:#ff79c6">=</span>0<span style="color:#ff79c6">.</span><span style="color:#50fa7b">1</span>
</span></span><span style="display:flex;"><span>spark<span style="color:#ff79c6">.</span><span style="color:#50fa7b">default</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">parallelism</span> 200
</span></span></code></pre></td></tr></table>
</div>
</div><p>测试工具的 Benchmark_Parameters.sh主要参数</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>#<span style="color:#ff79c6">-----------------------------------</span>
</span></span><span style="display:flex;"><span># Spark Parameters
</span></span><span style="display:flex;"><span>#<span style="color:#ff79c6">-----------------------------------</span>
</span></span><span style="display:flex;"><span>SPARK_DRIVER_MEMORY<span style="color:#ff79c6">=</span>10g
</span></span><span style="display:flex;"><span>SPARK_EXECUTOR_MEMORY<span style="color:#ff79c6">=</span>64g
</span></span><span style="display:flex;"><span>SPARK_EXECUTOR_CORES<span style="color:#ff79c6">=</span>16
</span></span><span style="display:flex;"><span>SPARK_EXECUTOR_INSTANCES<span style="color:#ff79c6">=</span>7
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="os层面优化">OS层面优化</h3>
<p>需要注意的是，从应用到的系统层，越往下调优的效果可能就越小，系统层面的调整可能不会产生很大影响<br>
调整的参数<br>
内存</p>
<ul>
<li>关闭swap</li>
</ul>
<p>磁盘</p>
<ul>
<li>关闭XFS的CRC校验</li>
<li>关闭XFS的atime</li>
<li>对XFS做碎片整理</li>
</ul>
<p>网络</p>
<ul>
<li>增加TCP的读、写buffer</li>
<li>增加TCP的窗口大小</li>
</ul>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#6272a4"># 关闭swap</span>
</span></span><span style="display:flex;"><span>swapoff -a
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 调整磁盘</span>
</span></span><span style="display:flex;"><span>mkfs.xfs -m <span style="color:#8be9fd;font-style:italic">crc</span><span style="color:#ff79c6">=</span><span style="color:#bd93f9">0</span> /data
</span></span><span style="display:flex;"><span>xfs_db -c frag -r /data3
</span></span><span style="display:flex;"><span>xfs_fsr /data3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 调整网络</span>
</span></span><span style="display:flex;"><span>sysctl -w net.core.rmem_max<span style="color:#ff79c6">=</span><span style="color:#bd93f9">8388608</span>
</span></span><span style="display:flex;"><span>sysctl -w net.core.wmem_max<span style="color:#ff79c6">=</span><span style="color:#bd93f9">8388608</span>
</span></span><span style="display:flex;"><span>sysctl -w net.core.rmem_default<span style="color:#ff79c6">=</span><span style="color:#bd93f9">65536</span>
</span></span><span style="display:flex;"><span>sysctl -w net.core.wmem_default<span style="color:#ff79c6">=</span><span style="color:#bd93f9">65536</span>
</span></span><span style="display:flex;"><span>sysctl -w net.ipv4.tcp_mem<span style="color:#ff79c6">=</span>’8388608 <span style="color:#bd93f9">8388608</span> 8388608′
</span></span><span style="display:flex;"><span>sysctl -w net.ipv4.tcp_rmem<span style="color:#ff79c6">=</span>’4096 <span style="color:#bd93f9">87380</span> 8388608′
</span></span><span style="display:flex;"><span>sysctl -w net.ipv4.tcp_wmem<span style="color:#ff79c6">=</span>’4096 <span style="color:#bd93f9">65536</span> 8388608′
</span></span><span style="display:flex;"><span>sysctl -w net.ipv4.route.flush<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>调整完之后，可以通过 dstat，iostat，vmstat，iftop等命令持续观察效果</p>
<h3 id="单机版本对比">单机版本对比</h3>
<p>原生</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>1、生成：22<span style="color:#ff79c6">.</span><span style="color:#50fa7b">470s</span>
</span></span><span style="display:flex;"><span>2、排序：2m0<span style="color:#ff79c6">.</span><span style="color:#50fa7b">275s</span>
</span></span><span style="display:flex;"><span>3、校验：23<span style="color:#ff79c6">.</span><span style="color:#50fa7b">962s</span>
</span></span><span style="display:flex;"><span>总分数：2<span style="color:#ff79c6">.</span><span style="color:#50fa7b">0964</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>优化后</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>1<span style="color:#ff79c6">.</span> 生成：25<span style="color:#ff79c6">.</span><span style="color:#50fa7b">607s</span>
</span></span><span style="display:flex;"><span>2<span style="color:#ff79c6">.</span> 排序：1m6<span style="color:#ff79c6">.</span><span style="color:#50fa7b">439s</span>
</span></span><span style="display:flex;"><span>3<span style="color:#ff79c6">.</span> 校验：16<span style="color:#ff79c6">.</span><span style="color:#50fa7b">168s</span>
</span></span><span style="display:flex;"><span>总分：2<span style="color:#ff79c6">.</span><span style="color:#50fa7b">9325</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>优化后单节点利用率基本满了</p>
<h3 id="参考">参考</h3>
<ul>
<li><a href="https://spark.apache.org/docs/latest/configuration.html">Spark Configuration</a></li>
<li><a href="https://spark.apache.org/docs/latest/spark-standalone.html">Spark Standalone Mode</a></li>
<li><a href="https://spark.apache.org/docs/latest/tuning.html">Tuning Spark</a></li>
<li><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/storage_administration_guide/ch-swapspace">swap space</a></li>
<li><a href="https://wiki.archlinux.org/title/XFS%5B">XFS</a></li>
<li><a href="https://insights-core.readthedocs.io/en/latest/shared_parsers_catalog/xfs_info.html">xfs_info</a></li>
<li><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/storage_administration_guide/xfsmounting">XFS file system</a></li>
<li><a href="https://en.wikipedia.org/wiki/XFS">XFS wikipedia</a></li>
<li><a href="https://docs.pingcap.com/tidb/stable/tune-operating-system">Tune Operating System Performance</a></li>
<li><a href="https://www.brendangregg.com/Articles/Netflix_Linux_Perf_Analysis_60s.pdf">Linux Performance Analysis in 60,000 Milliseconds</a></li>
<li><a href="https://staff.ie.cuhk.edu.hk/~sfluk/wordpress/?p=1714">TCP/IP tuning</a></li>
<li><a href="https://docs.oracle.com/cd/E26576_01/doc.312/e24936/tuning-os.htm#GSPTG00007">Tuning the Operating System and Platform</a></li>
<li><a href="https://www.cyberciti.biz/faq/linux-tcp-tuning/">Linux Tune Network Stack (Buffers Size) To Increase Networking Performance</a></li>
<li><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/monitoring_and_managing_system_status_and_performance/tuning-the-network-performance_monitoring-and-managing-system-status-and-performance#tuning-tcp-connections-for-high-throughput_tuning-the-network-performance">Tuning the network performance</a></li>
<li><a href="https://github.com/scala/scala">Scala github</a></li>
<li><a href="https://docs.oracle.com/en-us/iaas/Content/Block/References/samplefiocommandslinux.htm">Sample FIO Commands for Block Volume Performance Tests on Linux-based Instances</a></li>
<li><a href="https://blog.purestorage.com/purely-technical/io-plumbing-tests-with-fio/">IO Plumbing tests with FIO</a></li>
</ul>
<h2 id="jvm优化">JVM优化</h2>
<h3 id="gc调优">GC调优</h3>
<p>通过 GC 日志，或者是 jstat 等命令，找到 GC 的次数，总执行时间，如果 GC 不是瓶颈那么调优的意义就不大了，这部分可以跳过。<br>
如果观察到 GC 有一定的影响，则可以通过参数调优，减少 GC 的时间<br>
可以先记录 GC日志，执行几次，然后用工具分析GC日志，分析工具可以使用在线的 GCeasy</p>
<p>对于服务端，可以用的 GC 算法包括：</p>
<ul>
<li>Throughput GC</li>
<li>CMS</li>
<li>G1</li>
<li>ZGC</li>
<li>Shenandoah</li>
</ul>
<p>CMS 和 Throughput 自身有一定的缺陷，如果是 JDK 8 可以使用 G1<br>
如果是 JKD11 或者跟高版本，则可以尝试用 ZGC <br>
Shenandoah 跟 ZGC的设计目标一样，都是10ms以内的暂停时间，从目前发展势头看 ZGC更好，特别是 JDK21 ZGC 增加了分带GC又进一步提升了性能</p>
<h3 id="g1调优">G1调优</h3>
<p>调优参数</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>JVM参数</th>
<th>功能解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>-XX:MaxGCPauseMillis</td>
<td>200，暂停时间 ms</td>
</tr>
<tr>
<td>2</td>
<td>-Xmx<!-- raw HTML omitted --> -Xmx<!-- raw HTML omitted --></td>
<td>最大内存，最小内存设置一样</td>
</tr>
<tr>
<td>3</td>
<td>-XX:+PrintGCDetails -XX:+PrintGCTimeStamps -Xloggc:<!-- raw HTML omitted --></td>
<td>记录日志，实际运行时关闭</td>
</tr>
<tr>
<td>4</td>
<td>-XX:MaxMetaspaceSize</td>
<td>增加元数据空间大小</td>
</tr>
<tr>
<td>5</td>
<td>-XX:+UseStringDeduplication</td>
<td>消除重复的 String</td>
</tr>
<tr>
<td>6</td>
<td>-XX:ParallelGCThreads</td>
<td>设置为核数大小，STW 时并行 GC的线程数</td>
</tr>
<tr>
<td>7</td>
<td>-XX:ConcGCThreads</td>
<td>并行GC 线程，CPU核多可以调整 1/5</td>
</tr>
<tr>
<td>8</td>
<td>-XX:InitiatingHeapOccupancyPercent</td>
<td>触发 GC 的阈值，默认 45，内存大时，可适当调大</td>
</tr>
<tr>
<td>9</td>
<td>-XX:+AlwaysPreTouch</td>
<td>启动的时候分配物理内存页</td>
</tr>
<tr>
<td>10</td>
<td>-Xbatch -XX:-TieredCompilation</td>
<td>开启 C2 编译</td>
</tr>
</tbody>
</table>
<p>G1调优的注意点</p>
<ul>
<li>不要出现FGC，这相当于是 CMS的并发回收失败，变成SerialGC</li>
<li>吞吐量和暂停时间需要做权限，暂停时间短整体吞吐量可能会下降，反之吞吐量提高暂停时间可能会增加</li>
</ul>
<p>下图吞吐量为 94.613%，暂停时间基本控制还可以<br>

        <a data-fancybox="gallery" href="https://woquhaha.gitee.io/pic_tech_1/post/2023/11/TPCx-HS/pauseGC_low.jpg">
            <img class="mx-auto" alt="" src="https://woquhaha.gitee.io/pic_tech_1/post/2023/11/TPCx-HS/pauseGC_low.jpg" />
        </a>
    </p>
<p>下图的吞吐量为 97.113%，但暂停时间提高了<br>

        <a data-fancybox="gallery" href="https://woquhaha.gitee.io/pic_tech_1/post/2023/11/TPCx-HS/pauseGC_high.jpg">
            <img class="mx-auto" alt="" src="https://woquhaha.gitee.io/pic_tech_1/post/2023/11/TPCx-HS/pauseGC_high.jpg" />
        </a>
    </p>
<h3 id="zgc调优">ZGC调优</h3>
<p>调优参数</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>JVM参数</th>
<th>功能解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>-XX:+UseZGC -XX:+ZGenerational</td>
<td>启用 ZGC 的分带功能</td>
</tr>
<tr>
<td>2</td>
<td>-Xmx<!-- raw HTML omitted --> -Xmx<!-- raw HTML omitted --></td>
<td>最大内存，最小内存设置一样</td>
</tr>
<tr>
<td>3</td>
<td>-XX:+PrintGCDetails -XX:+PrintGCTimeStamps -Xloggc:<!-- raw HTML omitted --></td>
<td>记录日志，实际运行时关闭</td>
</tr>
<tr>
<td>4</td>
<td>-XX:-ZUncommit</td>
<td>未使用的内存不归还给 OS，关闭对低延迟更有利</td>
</tr>
<tr>
<td>5</td>
<td>-XX:MaxMetaspaceSize</td>
<td>增加元数据空间大小</td>
</tr>
<tr>
<td>6</td>
<td>-XX:+UseStringDeduplication</td>
<td>消除重复的 String</td>
</tr>
<tr>
<td>7</td>
<td>-Xbatch -XX:-TieredCompilation</td>
<td>开启 C2 编译</td>
</tr>
<tr>
<td>8</td>
<td>-XX:+UseLargePages</td>
<td>开启 大page支持</td>
</tr>
<tr>
<td>9</td>
<td>-XX:+UseTransparentHugePages</td>
<td>支持透明大page</td>
</tr>
<tr>
<td>10</td>
<td>-XX:+AlwaysPreTouch</td>
<td>启动的时候分配物理内存页</td>
</tr>
</tbody>
</table>
<p>JDK 21 增加了分带GC功能，从暂停时间、CPU开销都进一步降低了，同时也能动态的调整并行线程数，支持8M-16T内存，很多事情都可以自动完成，能调优的不多
注意点</p>
<ul>
<li>ZGC扫描的是根对象，需要注意根对象不能太多，如果一些框架分配了大量的对象，则可能导致ZGC扫描时间过长</li>
<li>吞吐量和暂时时间也要做平衡，如果吞吐量占用太多，可适当降低并行线程数</li>
</ul>
<p>ZGC 无论是吞吐量、还是GC时间，比 G1 都有巨大的优势<br>

        <a data-fancybox="gallery" href="https://woquhaha.gitee.io/pic_tech_1/post/2023/11/TPCx-HS/zgc.jpg">
            <img class="mx-auto" alt="" src="https://woquhaha.gitee.io/pic_tech_1/post/2023/11/TPCx-HS/zgc.jpg" />
        </a>
    </p>
<h3 id="采样分析">采样分析</h3>
<p>这里的思路是通过工具，连接到JVM内部，然后执行一段时间的采样，最后分析这些采样结果，也就是采样；另一种方式是字节码注入，跟踪一段函数的入参、出参等
采样的结果大致分为两类</p>
<ul>
<li>通过 JFR采样整体指标，观察整个JVM在运行期间的问题</li>
<li>火焰图采样调用栈，分析整体函数时间占比</li>
</ul>
<p>下图是通过JFR执行的一次采样

        <a data-fancybox="gallery" href="https://woquhaha.gitee.io/pic_tech_1/post/2023/11/TPCx-HS/jfr.jpg">
            <img class="mx-auto" alt="" src="https://woquhaha.gitee.io/pic_tech_1/post/2023/11/TPCx-HS/jfr.jpg" />
        </a>
    </p>
<p>除了上图的系统数据外，还包括</p>
<ul>
<li>线程运行状态分析</li>
<li>文件I/O，网络I/O</li>
<li>异常分析</li>
<li>GC分析</li>
<li>调用栈执行时间</li>
<li>CPU、内存执行采样分析</li>
<li>环境变量信息等</li>
</ul>
<p>通过采样结果大致可以分析CPU还比较空闲，所以可以增加一些计算并行度，采样分析的目标是找到潜在的问题，然后再配合代码做一进步调整<br>
除 JFR外，还可以通过开启 JMX，远程连接到 JVM进程内观察其实时运行状态，其展现形式基本跟 JFR采样的差不多，这里不再阐述</p>
<p>下图是对Spark执行排序过程的一个火焰图</p>
<ul>
<li>绿色部分代表Java代码</li>
<li>蓝色部分代表第三方库代码</li>
<li>黄色部分代表JVM C++代码</li>
<li>橙色部分代表内核态C语言代码</li>
<li>红色代表用户态C语言代码

        <a data-fancybox="gallery" href="https://woquhaha.gitee.io/pic_tech_1/post/2023/11/TPCx-HS/flame_graph.jpg">
            <img class="mx-auto" alt="" src="https://woquhaha.gitee.io/pic_tech_1/post/2023/11/TPCx-HS/flame_graph.jpg" />
        </a>
    </li>
</ul>
<p>从上图中可以看到不同函数/功能的 总体占比</p>
<ul>
<li>ZGC占到了 15%，有点高了，需要适当降低并行GC 线程数</li>
<li>Shuffle大约占了22%</li>
<li>排序部分大约占了 21%</li>
<li>迭代部分占了12</li>
<li>Hadoop写部分占了12%</li>
</ul>
<p>采样可以多执行几次，因为每次的执行可能会有些不同，多执行几次，大概就清楚某个功能模块的总体时间占比了，像上图的排序部分，它调用的是 JDK的单线程排序，这部分就可以优化</p>
<h3 id="参考-1">参考</h3>
<ul>
<li><a href="https://docs.oracle.com/en/java/javase/17/gctuning/garbage-first-g1-garbage-collector1.html#GUID-ED3AB6D3-FD9B-4447-9EDF-983ED2F7A573">Garbage-First (G1) Garbage Collector</a></li>
<li><a href="https://wiki.openjdk.org/display/zgc/Main">OpenJDK ZGC</a></li>
<li><a href="https://gceasy.io/gc-recommendations/important-g1-gc-arguments.jsp?">Important G1 GC arguments</a></li>
<li><a href="https://blog.ycrash.io/2023/06/30/java-zgc-algorithm-tuning/">Java ZGC algorithm Tuning</a></li>
<li><a href="https://gceasy.io/">GC easy</a></li>
<li><a href="https://cr.openjdk.org/~pliden/slides/ZGC-OracleDevLive-2022.pdf">ZGC: The Future of Low-Latency Garbage Collection Is Here(Slides)</a></li>
<li><a href="https://cr.openjdk.org/~eosterlund/slides/Joker-ZGC-ConcStack.pdf">Concurrent thread-stack processing in the Z Garbage Collector(Slides)</a></li>
<li><a href="https://wiki.openjdk.org/display/shenandoah/Main">Shenandoah GC</a></li>
<li><a href="https://shipilev.net/talks/javazone-Sep2018-shenandoah.pdf">Shenandoah GC(Slides)</a></li>
<li><a href="https://dl.acm.org/doi/pdf/10.1145/3538532">Deep Dive into ZGC: A Modern Garbage Collector in OpenJDK</a></li>
<li><a href="https://arthas.aliyun.com/en/doc/quick-start.html">Arthas</a></li>
<li><a href="https://www.oracle.com/java/technologies/jdk-mission-control.html">JDK Mission Control</a></li>
<li><a href="https://docs.oracle.com/javacomponents/jmc-5-4/jfr-runtime-guide/about.htm#JFRUH170">Java Flight Recorder</a></li>
<li><a href="https://visualvm.github.io/">VisualVM</a></li>
<li><a href="https://www.ej-technologies.com/products/jprofiler/overview.html">Jprofiler</a></li>
<li><a href="https://docs.oracle.com/en/java/javase/17/docs/specs/man/jconsole.html">jconsole</a></li>
<li><a href="https://docs.oracle.com/en/java/javase/21/docs/specs/man/index.html">Java® Development Kit Version 21 Tool Specifications</a></li>
<li><a href="https://github.com/async-profiler/async-profiler">async-profiler</a></li>
</ul>
<h2 id="一些优化思路记录">一些优化思路记录</h2>
<p>这里的一些优化思路在实际测试过程都不起效果，但有一些优化的思想可以在其他地方有效，比如gluten可以用在 TPC-H 中，预启动优化可以用于微服务</p>
<h3 id="hdfs缓存">HDFS缓存</h3>
<p>存储分层，冷数据放到归档盘中，热数据放到SSD中，最频繁访问的数据放到内存中，实现读、写加速</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#ff79c6">&lt;property&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&lt;name&gt;</span>dfs.datanode.data.dir<span style="color:#ff79c6">&lt;/name&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&lt;value&gt;</span>/grid/0,/grid/1,/grid/2,[RAM_DISK]/mnt/dn-tmpfs<span style="color:#ff79c6">&lt;/value&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">&lt;/property&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里的<code>[RAM_DISK]</code>在HDFS 看来只是一个缓存层，之后会异步刷新到磁盘<br>
分配 32G内存</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;property&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;name&gt;</span>dfs.datanode.max.locked.memory<span style="color:#ff79c6">&lt;/name&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;value&gt;</span>34359738368<span style="color:#ff79c6">&lt;/value&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;/property&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>集中缓存，每个datanode管理一些堆外内存，然后又namenode统一分配<br>
通过cacheadmin 来指定缓存某个 hdfs路径</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>hdfs cacheadmin -addPool mypool -limit <span style="color:#bd93f9">34359738368</span>
</span></span><span style="display:flex;"><span>hdfs cacheadmin -addDirective -path /user/hdfs/TPCx-HS-benchmark -pool mypool
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>不起效果的原因</strong></p>
<ul>
<li>文件系统本身是有缓存的，通过free 等命令观察内存，会发现读写过程中cache部分是在不断增加的</li>
<li>当执行到校验部分时，需要从HDFS读取数据做校验，但dstat看此时并没有I/O，说明读的是文件系统缓存</li>
<li>因为读、写磁盘时本身就通过了缓存，再给HDFS额外加一层缓存，就没什么效果了</li>
</ul>
<h3 id="预启动优化">预启动优化</h3>
<p>启动JVM虚拟机需要加载class，对class做校验，再生成内存格式，当类很多的时候，就需要很长时间加载<br>
GraalVM是一个新的VM，其主要优化思想</p>
<ul>
<li>将编译后的class文件，直接编译成目标平台的二进制文件，可以提升10-20倍的启动时间</li>
<li>GraalVM在运行期优化方面做了很多工作，尤其是内联和逃逸分析，比原生的JDK有更好的优化效果</li>
</ul>
<p>对比启动时间原生 JDK 22</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>time <span style="color:#ff79c6">/</span>data<span style="color:#ff79c6">/</span>soft<span style="color:#ff79c6">/</span>jdk<span style="color:#ff79c6">-</span>22<span style="color:#ff79c6">/</span>bin<span style="color:#ff79c6">/</span>java HelloWorld 
</span></span><span style="display:flex;"><span>Hello<span style="color:#ff79c6">,</span> World<span style="color:#ff79c6">!</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>real	0m0<span style="color:#ff79c6">.</span><span style="color:#50fa7b">033s</span>
</span></span><span style="display:flex;"><span>user	0m0<span style="color:#ff79c6">.</span><span style="color:#50fa7b">018s</span>
</span></span><span style="display:flex;"><span>sys	0m0<span style="color:#ff79c6">.</span><span style="color:#50fa7b">021s</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>编译成二进制后</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>time <span style="color:#ff79c6">./</span>helloworld 
</span></span><span style="display:flex;"><span>Hello<span style="color:#ff79c6">,</span> World<span style="color:#ff79c6">!</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>real	0m0<span style="color:#ff79c6">.</span><span style="color:#50fa7b">002s</span>
</span></span><span style="display:flex;"><span>user	0m0<span style="color:#ff79c6">.</span><span style="color:#50fa7b">000s</span>
</span></span><span style="display:flex;"><span>sys	0m0<span style="color:#ff79c6">.</span><span style="color:#50fa7b">003s</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>JDK9 新增了 jatoc命令，用于将一个JVM运行期的内存格式dump出来，之后的JVM再启动时候就可以直接读取这个内存dump，从而加速启动<br>
在之后的JDK中将这个命令废弃了，JDK13开始又将这个功能重新做了提案又开发出来了，目前这个功能用于微服务等小型应用的比较多，但没看到用于大型分布式项目的</p>
<p><strong>不起效果的原因</strong></p>
<ul>
<li>将class文件编译成二进制只适合小型规模的项目，Spark有codegen和动态类加载无法这么编译</li>
<li>GraalVM对于OpenJDK22，其优化效果不明显</li>
<li>类共享功能在OpenJDK22默认就打开了，而对于大型项目，目前看也没有这么用的</li>
</ul>
<h3 id="向量化">向量化</h3>
<p>向量化的本质是利用了CPU的SIMD指令集，一条指令集可以执行多个任务，从而达到并行的效果<br>
JVM本身对于向量化支持的比较弱，直到JDK21，关于向量化的API仍然在孵化过程中，在这个领域C++ 支持的是比较好的，C++可以调用更底层的系统库实现加速效果<br>
一般Java的项目也都是将密集型的执行任务，交给底层的C++计算引擎完成</p>
<p>Spark在这个方向上有两个开源实现</p>
<ul>
<li>Blaze(rust 实现) +Apache Arrow DataFusion(rust实现)</li>
<li>Gluten(C++实现) + facebook velox(C++实现)</li>
</ul>
<p>Blaze 和 gluten只是一个转发层，真正的核心是DataFusion和velox，目前看这两个的成熟度差不多<br>
但是转发层gluten比blaze要活跃很多，所以选择向量化最好是选gluten<br>
Gluten实际对接的后端引擎有两个，velox和clickhouse，从官网支持力度和文档来看，gluten对velox的兼容度更好</p>
<p>Spark将其物理执行计划，转为Substrait执行计划，序列化为protobuf格式通过JNI交给C++层<br>
C++层反序列化后，得到了Substrait执行计划，然后根据这个执行计划直接执行<br>

        <a data-fancybox="gallery" href="https://woquhaha.gitee.io/pic_tech_1/post/2023/08/Gluten/gluten_1.jpg">
            <img class="mx-auto" alt="" src="https://woquhaha.gitee.io/pic_tech_1/post/2023/08/Gluten/gluten_1.jpg" />
        </a>
    </p>
<p>Gluten官网提供了预编译好的jar包，但是不能使用，需要在centos8上重新编译<br>
gluten 的组成和 依赖：</p>
<ul>
<li>arrow，apache 的开源项目，先要编译这个</li>
<li>velox，facebook 的向量化引擎，依赖 arrow</li>
<li>c++ 部分，依赖 velox，第三个编译</li>
<li>java 部分，最后编译</li>
</ul>
<p>编译环境</p>
<ul>
<li>GCC 11.2.1</li>
<li>Cmake 3.16.9</li>
<li>JDK 1.8</li>
<li>Maven 3.8.5</li>
</ul>
<p>编译的麻烦点在于Apache Arrow，以及velox，这两个都需要重新源码编译，尤其前者依赖了很多其他库，也都需要源码编译   <br>
而国内的网络限制需要手动下载，再修改cmake文件，将实际的https地址换成本地的<code>http://localhost:9999</code> 这样的地址   <br>
Gluten 的c++比较编译比较简单，java部分如果是新环境，需要从头下载非常多的依赖，光下载可能需要一天时间</p>
<p><strong>不起效果的原因</strong></p>
<ul>
<li>
<p>文件格式定死了必须是行格式，使用向量化就需要行转列、列转行有很大开销</p>
</li>
<li>
<p>整个过程非常简单，排序就是读取数据，然后做排序，这里的算子很简单，调用的是scala的sortBy，见下图</p>
</li>
<li>
<p>由于调用的是高阶算子，无法转换成gluten的物理计划</p>
</li>
<li>
<p>测试过程是不允许修改jar包，所以只能使用2.x版本的Spark，gluten只能用于Spark3.2和3.3，实际是没法用于测试的</p>
<p>
        <a data-fancybox="gallery" href="https://woquhaha.gitee.io/pic_tech_1/post/2023/11/TPCx-HS/stage.jpg">
            <img class="mx-auto" alt="" src="https://woquhaha.gitee.io/pic_tech_1/post/2023/11/TPCx-HS/stage.jpg" />
        </a>
    </p>
</li>
<li>
<p>
        <a data-fancybox="gallery" href="https://woquhaha.gitee.io/pic_tech_1/post/2023/11/TPCx-HS/stage1.jpg">
            <img class="mx-auto" alt="" src="https://woquhaha.gitee.io/pic_tech_1/post/2023/11/TPCx-HS/stage1.jpg" />
        </a>
    </p>
</li>
</ul>
<h3 id="参考-2">参考</h3>
<p>HDFS cache</p>
<ul>
<li><a href="https://hadoop.apache.org/docs/stable/hadoop-project-dist/hadoop-hdfs/MemoryStorage.html">Memory Storage Support in HDFS</a></li>
<li><a href="https://hadoop.apache.org/docs/stable/hadoop-project-dist/hadoop-hdfs/CentralizedCacheManagement.html">Centralized Cache Management in HDFS</a></li>
<li><a href="https://hadoop.apache.org/docs/stable/hadoop-project-dist/hadoop-hdfs/ArchivalStorage.html">Archival Storage, SSD &amp; Memory</a></li>
<li><a href="https://hadoop.apache.org/docs/stable/hadoop-project-dist/hadoop-hdfs/HDFSDiskbalancer.html">HDFS Disk Balancer</a></li>
</ul>
<p>ahead-of-time compilation</p>
<ul>
<li><a href="https://www.graalvm.org/">GraalVM</a></li>
<li><a href="https://www.oracle.com/hk/java/graalvm/">OracleGraalVM</a></li>
<li><a href="https://github.com/oracle/graal">GraalVM github</a></li>
<li><a href="https://blogs.oracle.com/java/post/apache-sparklightning-fast-on-graalvm-enterprise">Apache Spark—Lightning fast on GraalVM Enterprise</a></li>
<li><a href="https://medium.com/graalvm/graalvm-at-facebook-af09338ac519">GraalVM at Facebook</a></li>
<li><a href="https://dev.java/learn/jvm/cds-appcds/">CDS and AppCDS in Hotspot</a></li>
<li><a href="https://docs.oracle.com/en/java/javase/17/vm/class-data-sharing.html#GUID-7EAA3411-8CF0-4D19-BD05-DF5E1780AA91">Class Data Sharing</a></li>
<li><a href="https://nipafx.dev/java-application-class-data-sharing/#Creating-A-JDK-Class-Data-Archive">Improve Launch Times On Java 13 With Application Class-Data Sharing</a></li>
<li><a href="https://openjdk.org/jeps/350">JEP 350: Dynamic CDS Archives</a></li>
<li><a href="https://openjdk.org/jeps/341">JEP 341: Default CDS Archives</a></li>
<li><a href="https://openjdk.org/jeps/310">JEP 310: Application Class-Data Sharing</a></li>
<li><a href="https://en.wikipedia.org/wiki/Ahead-of-time_compilation">Ahead-of-time compilation wikipedia</a></li>
</ul>
<p>gluten</p>
<ul>
<li><a href="https://github.com/oap-project/gluten">gluten github</a></li>
<li><a href="https://oap-project.github.io/gluten/">gluten</a></li>
<li><a href="https://medium.com/intel-analytics-software/accelerate-spark-sql-queries-with-gluten-9000b65d1b4e">Accelerate Spark SQL Queries with Gluten</a></li>
<li><a href="https://engineering.fb.com/2023/03/09/open-source/velox-open-source-execution-engine/">Introducing Velox: An open source unified execution engine</a></li>
<li><a href="https://velox-lib.io/">velox</a></li>
<li><a href="https://github.com/facebookincubator/velox">velox github</a></li>
<li><a href="https://facebookincubator.github.io/velox/index.html">velox documentaion</a></li>
<li><a href="https://vldb.org/pvldb/vol15/p3372-pedreira.pdf">Velox: Meta’s Unified Execution Engine</a></li>
<li><a href="https://xsimd.readthedocs.io/en/latest/">Xsimd</a></li>
<li><a href="https://github.com/xtensor-stack/xsimd">Xsimd github</a></li>
<li><a href="https://substrait.io/">Substrait</a></li>
<li><a href="https://github.com/substrait-io/substrait">Substrait github</a></li>
<li><a href="https://arrow.apache.org/docs/cpp/getting_started.html">Apache Arrow documentation</a></li>
<li><a href="https://github.com/apache/arrow">Apache Arrow github</a></li>
<li><a href="https://www.intel.com/content/www/us/en/docs/intrinsics-guide/index.html">Intel® Intrinsics Guide</a></li>
<li><a href="https://en.wikipedia.org/wiki/Advanced_Vector_Extensions">Advanced Vector Extensions wikipedia</a></li>
<li><a href="https://docs.oracle.com/en/java/javase/17/docs/api/jdk.incubator.vector/jdk/incubator/vector/Vector.html">jdk.incubator.vector API</a></li>
<li><a href="https://medium.com/@Styp/java-18-vector-api-do-we-get-free-speed-up-c4510eda50d2">Java 18: Vector API — Do we get free speed-up?</a></li>
<li><a href="https://openjdk.org/jeps/448">JEP 448: Vector API (Sixth Incubator)</a></li>
<li><a href="https://docs.oracle.com/en/java/javase/17/docs/specs/man/jmod.html">The jmod Command</a></li>
<li><a href="https://github.com/intel/x86-simd-sort">x86-simd-sort</a></li>
<li><a href="https://jbaker.io/2022/06/09/vectors-in-java/">SIMD accelerated sorting in Java - how it works and why it was 3x faster</a></li>
<li><a href="https://arxiv.org/pdf/1704.08579.pdf">A Novel Hybrid Quicksort Algorithm Vectorized using AVX-512 on Intel Skylake</a></li>
<li><a href="https://www3.ntu.edu.sg/home/ehchua/programming/java/javanativeinterface.html">Java Programming Tutorial Java Native Interface (JNI)</a></li>
<li><a href="https://people.eecs.berkeley.edu/~matei/papers/2022/sigmod_photon.pdf">Photon: A Fast Query Engine for Lakehouse Systems</a></li>
<li><a href="https://github.com/blaze-init/blaze">blaze github</a></li>
<li><a href="https://arrow.apache.org/datafusion/">Apache Arrow DataFusion</a></li>
</ul>

			<script type="text/javascript"
        async
        src="https://cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[\[','\]\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});

MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<style>
code.has-jax {
    font: inherit;
    font-size: 100%;
    background: inherit;
    border: inherit;
    color: #515151;
}
</style>
        </div>

        


        

<div class="post-archive">
    <h2>相关文章</h2>
    <ul class="listing">
        
        <li><a href="/post/2023/06/%E8%B5%84%E6%BA%90%E9%9A%94%E7%A6%BB%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD/">资源隔离修改配置动态加载</a></li>
        
        <li><a href="/post/2023/06/%E8%B5%84%E6%BA%90%E9%9A%94%E7%A6%BB%E8%AE%BE%E8%AE%A1/">资源隔离设计</a></li>
        
        <li><a href="/post/2023/06/%E9%95%9C%E5%83%8F%E5%90%88%E5%B9%B6%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%90%8C%E6%AD%A5/">镜像合并&amp;配置文件同步</a></li>
        
        <li><a href="/post/2022/09/%E9%AB%98%E5%8F%AF%E7%94%A8%E8%AE%BE%E8%AE%A1/">高可用设计</a></li>
        
        <li><a href="/post/2022/08/kyuubi%E8%AE%BE%E8%AE%A1%E8%B0%83%E7%A0%94/">Kyuubi设计调研</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='/tags/tpcx-hs'>TPCx-HS</a></li>
                
                <li><a href='/tags/%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95'>工作记录</a></li>
                
            </ul>
            
        </div>
    </article>
    
    

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "himichael/hugoblogtalks"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
</div>


                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='https://code0xff.org/search/' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://code0xff.org/">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://code0xff.org/post/2024/01/hms/" title="Hive MetaStore的实现和优化">Hive MetaStore的实现和优化</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2024/01/lakehouse_storage_systems/" title="Analyzing and Comparing Lakehouse Storage Systems">Analyzing and Comparing Lakehouse Storage Systems</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2024/01/system_tuning/" title="系统调优">系统调优</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2024/01/doris_advanced/" title="Doris Advanced">Doris Advanced</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2024/01/doris/" title="Doris Basic">Doris Basic</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2023/12/%E9%9A%BE%E5%BF%98%E7%9A%84%E7%9E%AC%E9%97%B4/" title="难忘的时刻(2023年)">难忘的时刻(2023年)</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2023/12/impala_in_netease/" title="网易对Impala的一些使用">网易对Impala的一些使用</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2023/12/impala_tuning/" title="Impala Tuning Summary">Impala Tuning Summary</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2023/11/%E5%A4%A7%E6%95%B0%E6%8D%AE%E5%8E%86%E5%8F%B2/" title="The History of Big data">The History of Big data</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2023/11/tpcx-hs%E4%BC%98%E5%8C%96%E6%80%BB%E7%BB%93/" title="TPCx-HS优化总结">TPCx-HS优化总结</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories/'>分类</a></h3>
<ul class="widget-list">
    
    <li><a href="https://code0xff.org/categories/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式 (6)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/">原理分析 (13)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E5%95%86%E4%B8%9A/">商业 (3)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据 (41)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库 (38)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E6%96%87%E5%AD%A6%E5%92%8C%E8%89%BA%E6%9C%AF/">文学和艺术 (3)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E6%97%85%E8%A1%8C/">旅行 (12)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E6%9E%B6%E6%9E%84/">架构 (2)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E7%AE%97%E6%B3%95/">算法 (8)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E7%B3%BB%E7%BB%9F/">系统 (7)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/">编程语言 (5)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E8%A1%8C%E4%B8%9A%E8%A7%82%E5%AF%9F/">行业观察 (2)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">读书笔记 (12)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E9%9A%8F%E4%BE%BF%E5%86%99%E5%86%99/">随便写写 (3)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title">归档</a></h3>
<ul class="widget-list">
    
    <li><a href="https://code0xff.org/years/2021%E5%B9%B4/">2021年 (41)</a></li>
    
    <li><a href="https://code0xff.org/years/2022%E5%B9%B4/">2022年 (55)</a></li>
    
    <li><a href="https://code0xff.org/years/2023%E5%B9%B4/">2023年 (54)</a></li>
    
    <li><a href="https://code0xff.org/years/2024%E5%B9%B4/">2024年 (5)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags/'>标签</a></h3>
<div class="tagcloud">
    
    <a href="https://code0xff.org/tags/ambari/">Ambari </a>
    
    <a href="https://code0xff.org/tags/b%E6%A0%91/">B树 </a>
    
    <a href="https://code0xff.org/tags/c&#43;&#43;/">C&#43;&#43; </a>
    
    <a href="https://code0xff.org/tags/calcite/">calcite </a>
    
    <a href="https://code0xff.org/tags/cmu-database/">CMU-Database </a>
    
    <a href="https://code0xff.org/tags/doris/">Doris </a>
    
    <a href="https://code0xff.org/tags/flink/">flink </a>
    
    <a href="https://code0xff.org/tags/flume/">flume </a>
    
    <a href="https://code0xff.org/tags/gc/">GC </a>
    
    <a href="https://code0xff.org/tags/gluten/">Gluten </a>
    
    <a href="https://code0xff.org/tags/hana/">HANA </a>
    
    <a href="https://code0xff.org/tags/hive/">Hive </a>
    
    <a href="https://code0xff.org/tags/impala/">Impala </a>
    
    <a href="https://code0xff.org/tags/k8s/">k8s </a>
    
    <a href="https://code0xff.org/tags/kudu/">kudu </a>
    
    <a href="https://code0xff.org/tags/kyuubi/">Kyuubi </a>
    
    <a href="https://code0xff.org/tags/lakehouse/">Lakehouse </a>
    
    <a href="https://code0xff.org/tags/leveldb/">LevelDB </a>
    
    <a href="https://code0xff.org/tags/llvm/">LLVM </a>
    
    <a href="https://code0xff.org/tags/manacher/">Manacher </a>
    
    <a href="https://code0xff.org/tags/mapreduce/">MapReduce </a>
    
    <a href="https://code0xff.org/tags/mysql/">MySQL </a>
    
    <a href="https://code0xff.org/tags/newsql/">NewSQL </a>
    
    <a href="https://code0xff.org/tags/oceanbase/">OceanBase </a>
    
    <a href="https://code0xff.org/tags/paxos/">paxos </a>
    
    <a href="https://code0xff.org/tags/presto/">Presto </a>
    
    <a href="https://code0xff.org/tags/quick-sql/">quick-sql </a>
    
    <a href="https://code0xff.org/tags/raft/">raft </a>
    
    <a href="https://code0xff.org/tags/scala/">scala </a>
    
    <a href="https://code0xff.org/tags/simd/">SIMD </a>
    
    <a href="https://code0xff.org/tags/snowflake/">snowflake </a>
    
    <a href="https://code0xff.org/tags/spark/">spark </a>
    
    <a href="https://code0xff.org/tags/teradata/">TeraData </a>
    
    <a href="https://code0xff.org/tags/tpcx-hs/">TPCx-HS </a>
    
    <a href="https://code0xff.org/tags/tuning/">Tuning </a>
    
    <a href="https://code0xff.org/tags/unix/">unix </a>
    
    <a href="https://code0xff.org/tags/%E4%BA%8C%E5%88%86%E6%9F%A5%E6%89%BE/">二分查找 </a>
    
    <a href="https://code0xff.org/tags/%E4%BA%8C%E5%8F%89%E6%A0%91%E9%81%8D%E5%8E%86/">二叉树遍历 </a>
    
    <a href="https://code0xff.org/tags/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式 </a>
    
    <a href="https://code0xff.org/tags/%E5%88%97%E5%AD%98/">列存 </a>
    
    <a href="https://code0xff.org/tags/%E5%8A%A8%E6%80%81%E6%B3%A8%E5%85%A5/">动态注入 </a>
    
    <a href="https://code0xff.org/tags/%E5%8E%86%E5%8F%B2/">历史 </a>
    
    <a href="https://code0xff.org/tags/%E5%90%91%E9%87%8F%E5%8C%96/">向量化 </a>
    
    <a href="https://code0xff.org/tags/%E5%9B%9E%E6%BA%AF/">回溯 </a>
    
    <a href="https://code0xff.org/tags/%E5%9B%BD%E5%86%85%E6%97%85%E8%A1%8C/">国内旅行 </a>
    
    <a href="https://code0xff.org/tags/%E5%9B%BD%E5%A4%96%E6%97%85%E8%A1%8C/">国外旅行 </a>
    
    <a href="https://code0xff.org/tags/%E5%A4%9A%E7%A7%9F%E6%88%B7/">多租户 </a>
    
    <a href="https://code0xff.org/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据 </a>
    
    <a href="https://code0xff.org/tags/%E5%AD%98%E5%82%A8/">存储 </a>
    
    <a href="https://code0xff.org/tags/%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95/">工作记录 </a>
    
    <a href="https://code0xff.org/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务 </a>
    
    <a href="https://code0xff.org/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库 </a>
    
    <a href="https://code0xff.org/tags/%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B/">数据模型 </a>
    
    <a href="https://code0xff.org/tags/%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB/">数据迁移 </a>
    
    <a href="https://code0xff.org/tags/%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96/">查询优化 </a>
    
    <a href="https://code0xff.org/tags/%E6%9F%A5%E8%AF%A2%E7%BC%96%E8%AF%91/">查询编译 </a>
    
    <a href="https://code0xff.org/tags/%E6%B1%87%E7%BC%96/">汇编 </a>
    
    <a href="https://code0xff.org/tags/%E6%B5%8B%E8%AF%95/">测试 </a>
    
    <a href="https://code0xff.org/tags/%E6%B9%96%E4%BB%93%E4%B8%80%E4%BD%93/">湖仓一体 </a>
    
    <a href="https://code0xff.org/tags/%E7%94%9F%E6%B4%BB/">生活 </a>
    
    <a href="https://code0xff.org/tags/%E7%94%B5%E5%BD%B1/">电影 </a>
    
    <a href="https://code0xff.org/tags/%E7%AE%97%E6%B3%95/">算法 </a>
    
    <a href="https://code0xff.org/tags/%E7%B4%A2%E5%BC%95/">索引 </a>
    
    <a href="https://code0xff.org/tags/%E7%BB%8F%E6%B5%8E/">经济 </a>
    
    <a href="https://code0xff.org/tags/%E7%BC%93%E5%AD%98/">缓存 </a>
    
    <a href="https://code0xff.org/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/">编译原理 </a>
    
    <a href="https://code0xff.org/tags/%E7%BD%91%E7%BB%9C/">网络 </a>
    
    <a href="https://code0xff.org/tags/%E8%AE%A1%E7%AE%97%E6%A1%86%E6%9E%B6/">计算框架 </a>
    
    <a href="https://code0xff.org/tags/%E8%AE%BA%E6%96%87/">论文 </a>
    
    <a href="https://code0xff.org/tags/%E8%AF%BB%E4%B9%A6/">读书 </a>
    
    <a href="https://code0xff.org/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">读书笔记 </a>
    
</div>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">RSS</h3>
        <ul class="widget-list">
            <li><a href="https://code0xff.org/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
    <footer id="footer">
    <div>
        &copy; 2024 <a href="https://code0xff.org/">记录每个瞬间 By 老王</a>
        
    </div>
    <br />
    <div>
        <div class="github-badge">
            <a href="https://gohugo.io/" target="_black" rel="nofollow"><span class="badge-subject">Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
        </div>
        <div class="github-badge">
            <a href="https://github.com/flysnow-org/maupassant-hugo" target="_black"><span class="badge-subject">Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
        </div>
    </div>
</footer>


    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script><script src="https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'GA ID', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



    <script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>




</body>

</html>