<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="referrer" content="no-referrer-when-downgrade">
    

    <title>Spark的一些优化 | 记录每个瞬间</title>
    <meta property="og:title" content="Spark的一些优化 - 记录每个瞬间">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2024-10-23T09:08:07&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2024-10-23T09:08:07&#43;08:00'>
        
    <meta name="Keywords" content="">
    <meta name="description" content="Spark的一些优化">
        <meta name="author" content="隔壁老王">
        
    <meta property="og:url" content="https://code0xff.org/post/2024/10/spark_optimize/">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    
    
        <link href="https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" rel="stylesheet">
    
    
    
    
</head>


<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://code0xff.org/">
                        记录每个瞬间
                    </a>
                
                
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="https://code0xff.org/">首页</a>
                    
                    <a  href="https://code0xff.org/linked/" title="链接">链接</a>
                    
                    <a  href="https://code0xff.org/archives/" title="归档">归档</a>
                    
                    <a  href="https://code0xff.org/about/" title="关于">关于</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    
    <article class="post">
        <header>
            <h1 class="post-title">Spark的一些优化</h1>
        </header>
        <date class="post-meta meta-date">
            2024年10月23日
        </date>
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#调度过程">调度过程</a></li>
        <li><a href="#web-ui">WEB-UI</a></li>
        <li><a href="#shuffle优化">shuffle优化</a></li>
        <li><a href="#shuffle原理">shuffle原理</a></li>
        <li><a href="#源码层面优化">源码层面优化</a></li>
        <li><a href="#join优化">JOIN优化</a></li>
        <li><a href="#rss">RSS</a></li>
        <li><a href="#参考">参考</a></li>
      </ul>
    </li>
  </ul>
</nav>
        
        <div class="post-meta">
            
            <span class="post-meta meta-tags">
                <ul class="clearfix">
                    <a href='/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE'>大数据</a>
                </ul>
            </span>
            
        </div>
        
        
        <div class="post-meta">
            <span id="busuanzi_container_page_pv">|<span id="busuanzi_value_page_pv"></span><span>
                    阅读</span></span>
        </div>
        
        
        <div class="post-content">
            <h2 id="调度过程">调度过程</h2>
<p>架构<br>

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/10/26/756kAZ.png">
            <img class="mx-auto" alt="" src="https://v1.ax1x.com/2024/10/26/756kAZ.png" />
        </a>
    </p>
<p>调度过程<br>

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/10/26/756BJU.jpg">
            <img class="mx-auto" alt="" src="https://v1.ax1x.com/2024/10/26/756BJU.jpg" />
        </a>
    </p>
<h2 id="web-ui">WEB-UI</h2>
<p>Web-UI 需要关注的指标</p>
<ul>
<li>Executor 中
<ul>
<li>失败的数据，读数据，shuffle，cache</li>
<li>CPU，内存使用，RDD 数量，GC时间</li>
</ul>
</li>
<li>SQL 节点关注执行执行计划
<ul>
<li>整个执行计划的大体看下，关注 shuffle 部分</li>
<li>shuffle 读、写的数量，时间</li>
<li>shuffle 本地读，跨网络传输的数量，时间</li>
<li>Sort 的排序时间，spill 溢出数量</li>
<li>Aggregate 聚合的时间，spill 数量</li>
</ul>
</li>
<li>Stage 分析
<ul>
<li>看 DAG，看下大体情况</li>
<li>看 Event Timeline，就是这个 stage中每个步骤大概花了多少时间</li>
<li>schedule、deserialization、shuffle读写、executor计算时间</li>
<li>理想情况应该 executor计算时间最多</li>
<li>shuffle时间过大，考虑是否用 broadcast 优化</li>
<li>schedule时间多，优化并行度，减少调度开销</li>
</ul>
</li>
<li>Task Metrics
<ul>
<li>以一个更细的粒度，看 task 的执行细节</li>
<li>最小，25%分为，50%分为，75%，Locality level</li>
<li>shuffle读写，spill，持续时间，序列化，内存，schedule，GC time</li>
</ul>
</li>
<li>其他
<ul>
<li>Storage 信息</li>
<li>environment 信息</li>
</ul>
</li>
</ul>
<h2 id="shuffle优化">shuffle优化</h2>
<p><strong>提高shuffle操作的并行度</strong></p>
<ul>
<li>最简单的一种方式</li>
<li>增加了 task 数量，每个task 出来的任务少了</li>
<li>某个key对应100W数据，增加并行度后，这个 task 还是会处理这么多

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/10/26/752XfQ.jpg">
            <img class="mx-auto" alt="" src="https://v1.ax1x.com/2024/10/26/752XfQ.jpg" />
        </a>
    </li>
</ul>
<p><strong>两阶段聚合(局部聚合+全局聚合)</strong></p>
<ul>
<li>适合group by 这种操作</li>
<li>给每个key 增加随机前缀（executor数量），对这些打散的随机key做聚合</li>
<li>对局部聚合的数据去掉 随机前缀，再次聚合，就是最终结果

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/10/26/752n3f.jpg">
            <img class="mx-auto" alt="" src="https://v1.ax1x.com/2024/10/26/752n3f.jpg" />
        </a>
    </li>
</ul>
<p>实现</p>
<ul>
<li>第一步，给RDD中的每个key都打上一个随机前缀。</li>
<li>第二步，对打上随机前缀的key进行局部聚合。</li>
<li>第三步，去除RDD中每个key的随机前缀。</li>
<li>第四步，对去除了随机前缀的RDD进行全局聚合。</li>
</ul>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#6272a4">// 第一步，给RDD中的每个key都打上一个随机前缀。
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>JavaPairRDD<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">,</span> Long<span style="color:#ff79c6">&gt;</span> randomPrefixRdd <span style="color:#ff79c6">=</span> rdd<span style="color:#ff79c6">.</span><span style="color:#50fa7b">mapToPair</span><span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">new</span> PairFunction<span style="color:#ff79c6">&lt;</span>Tuple2<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">,</span>Long<span style="color:#ff79c6">&gt;,</span> String<span style="color:#ff79c6">,</span> Long<span style="color:#ff79c6">&gt;()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">long</span> serialVersionUID <span style="color:#ff79c6">=</span> 1L<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">public</span> Tuple2<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">,</span> Long<span style="color:#ff79c6">&gt;</span> <span style="color:#50fa7b">call</span><span style="color:#ff79c6">(</span>Tuple2<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">,</span> Long<span style="color:#ff79c6">&gt;</span> tuple<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                Random random <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Random<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd">int</span> prefix <span style="color:#ff79c6">=</span> random<span style="color:#ff79c6">.</span><span style="color:#50fa7b">nextInt</span><span style="color:#ff79c6">(</span>10<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> Tuple2<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">,</span> Long<span style="color:#ff79c6">&gt;(</span>prefix <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;_&#34;</span> <span style="color:#ff79c6">+</span> tuple<span style="color:#ff79c6">.</span><span style="color:#50fa7b">_1</span><span style="color:#ff79c6">,</span> tuple<span style="color:#ff79c6">.</span><span style="color:#50fa7b">_2</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">});</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// 第二步，对打上随机前缀的key进行局部聚合。
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>JavaPairRDD<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">,</span> Long<span style="color:#ff79c6">&gt;</span> localAggrRdd <span style="color:#ff79c6">=</span> randomPrefixRdd<span style="color:#ff79c6">.</span><span style="color:#50fa7b">reduceByKey</span><span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">new</span> Function2<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">,</span> Long<span style="color:#ff79c6">,</span> Long<span style="color:#ff79c6">&gt;()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">long</span> serialVersionUID <span style="color:#ff79c6">=</span> 1L<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">public</span> Long <span style="color:#50fa7b">call</span><span style="color:#ff79c6">(</span>Long v1<span style="color:#ff79c6">,</span> Long v2<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">return</span> v1 <span style="color:#ff79c6">+</span> v2<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">});</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// 第三步，去除RDD中每个key的随机前缀。
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>JavaPairRDD<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">,</span> Long<span style="color:#ff79c6">&gt;</span> removedRandomPrefixRdd <span style="color:#ff79c6">=</span> localAggrRdd<span style="color:#ff79c6">.</span><span style="color:#50fa7b">mapToPair</span><span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">new</span> PairFunction<span style="color:#ff79c6">&lt;</span>Tuple2<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">,</span>Long<span style="color:#ff79c6">&gt;,</span> Long<span style="color:#ff79c6">,</span> Long<span style="color:#ff79c6">&gt;()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">long</span> serialVersionUID <span style="color:#ff79c6">=</span> 1L<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">public</span> Tuple2<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">,</span> Long<span style="color:#ff79c6">&gt;</span> <span style="color:#50fa7b">call</span><span style="color:#ff79c6">(</span>Tuple2<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">,</span> Long<span style="color:#ff79c6">&gt;</span> tuple<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd">long</span> originalKey <span style="color:#ff79c6">=</span> Long<span style="color:#ff79c6">.</span><span style="color:#50fa7b">valueOf</span><span style="color:#ff79c6">(</span>tuple<span style="color:#ff79c6">.</span><span style="color:#50fa7b">_1</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">split</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;_&#34;</span><span style="color:#ff79c6">)[</span>1<span style="color:#ff79c6">]);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> Tuple2<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">,</span> Long<span style="color:#ff79c6">&gt;(</span>originalKey<span style="color:#ff79c6">,</span> tuple<span style="color:#ff79c6">.</span><span style="color:#50fa7b">_2</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">});</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// 第四步，对去除了随机前缀的RDD进行全局聚合。
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>JavaPairRDD<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">,</span> Long<span style="color:#ff79c6">&gt;</span> globalAggrRdd <span style="color:#ff79c6">=</span> removedRandomPrefixRdd<span style="color:#ff79c6">.</span><span style="color:#50fa7b">reduceByKey</span><span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">new</span> Function2<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">,</span> Long<span style="color:#ff79c6">,</span> Long<span style="color:#ff79c6">&gt;()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">long</span> serialVersionUID <span style="color:#ff79c6">=</span> 1L<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">public</span> Long <span style="color:#50fa7b">call</span><span style="color:#ff79c6">(</span>Long v1<span style="color:#ff79c6">,</span> Long v2<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">return</span> v1 <span style="color:#ff79c6">+</span> v2<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">});</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>将reduce join转为map join</strong></p>
<ul>
<li>也就是 BHJ 方式，用广播来优化</li>
<li>只是适合 大表 join 小表的场景</li>
</ul>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#6272a4">// 首先将数据量比较小的RDD的数据，collect到Driver中来。
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>List<span style="color:#ff79c6">&lt;</span>Tuple2<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">,</span> Row<span style="color:#ff79c6">&gt;&gt;</span> rdd1Data <span style="color:#ff79c6">=</span> rdd1<span style="color:#ff79c6">.</span><span style="color:#50fa7b">collect</span><span style="color:#ff79c6">()</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// 然后使用Spark的广播功能，将小RDD的数据转换成广播变量，这样每个Executor就只有一份RDD的数据。
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// 可以尽可能节省内存空间，并且减少网络传输性能开销。
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">final</span> Broadcast<span style="color:#ff79c6">&lt;</span>List<span style="color:#ff79c6">&lt;</span>Tuple2<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">,</span> Row<span style="color:#ff79c6">&gt;&gt;&gt;</span> rdd1DataBroadcast <span style="color:#ff79c6">=</span> sc<span style="color:#ff79c6">.</span><span style="color:#50fa7b">broadcast</span><span style="color:#ff79c6">(</span>rdd1Data<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// 对另外一个RDD执行map类操作，而不再是join类操作。
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>JavaPairRDD<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">,</span> Tuple2<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">,</span> Row<span style="color:#ff79c6">&gt;&gt;</span> joinedRdd <span style="color:#ff79c6">=</span> rdd2<span style="color:#ff79c6">.</span><span style="color:#50fa7b">mapToPair</span><span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">new</span> PairFunction<span style="color:#ff79c6">&lt;</span>Tuple2<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">,</span>String<span style="color:#ff79c6">&gt;,</span> String<span style="color:#ff79c6">,</span> Tuple2<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">,</span> Row<span style="color:#ff79c6">&gt;&gt;()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">long</span> serialVersionUID <span style="color:#ff79c6">=</span> 1L<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">public</span> Tuple2<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">,</span> Tuple2<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">,</span> Row<span style="color:#ff79c6">&gt;&gt;</span> <span style="color:#50fa7b">call</span><span style="color:#ff79c6">(</span>Tuple2<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">,</span> String<span style="color:#ff79c6">&gt;</span> tuple<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#6272a4">// 在算子函数中，通过广播变量，获取到本地Executor中的rdd1数据。
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>                List<span style="color:#ff79c6">&lt;</span>Tuple2<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">,</span> Row<span style="color:#ff79c6">&gt;&gt;</span> rdd1Data <span style="color:#ff79c6">=</span> rdd1DataBroadcast<span style="color:#ff79c6">.</span><span style="color:#50fa7b">value</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#6272a4">// 可以将rdd1的数据转换为一个Map，便于后面进行join操作。
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>                Map<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">,</span> Row<span style="color:#ff79c6">&gt;</span> rdd1DataMap <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> HashMap<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">,</span> Row<span style="color:#ff79c6">&gt;();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">for</span><span style="color:#ff79c6">(</span>Tuple2<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">,</span> Row<span style="color:#ff79c6">&gt;</span> data <span style="color:#ff79c6">:</span> rdd1Data<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                    rdd1DataMap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span>data<span style="color:#ff79c6">.</span><span style="color:#50fa7b">_1</span><span style="color:#ff79c6">,</span> data<span style="color:#ff79c6">.</span><span style="color:#50fa7b">_2</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#6272a4">// 获取当前RDD数据的key以及value。
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>                String key <span style="color:#ff79c6">=</span> tuple<span style="color:#ff79c6">.</span><span style="color:#50fa7b">_1</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>                String value <span style="color:#ff79c6">=</span> tuple<span style="color:#ff79c6">.</span><span style="color:#50fa7b">_2</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#6272a4">// 从rdd1数据Map中，根据key获取到可以join到的数据。
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>                Row rdd1Value <span style="color:#ff79c6">=</span> rdd1DataMap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">get</span><span style="color:#ff79c6">(</span>key<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> Tuple2<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">,</span> String<span style="color:#ff79c6">&gt;(</span>key<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">new</span> Tuple2<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">,</span> Row<span style="color:#ff79c6">&gt;(</span>value<span style="color:#ff79c6">,</span> rdd1Value<span style="color:#ff79c6">));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">});</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// 这里得提示一下。
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// 上面的做法，仅仅适用于rdd1中的key没有重复，全部是唯一的场景。
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// 如果rdd1中有多个相同的key，那么就得用flatMap类的操作，在进行join的时候不能用map，而是得遍历rdd1所有数据进行join。
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// rdd2中每条数据都可能会返回多条join后的数据。
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>采样倾斜key并分拆join操作</strong></p>
<p>
        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/10/26/752IAc.jpg">
            <img class="mx-auto" alt="" src="https://v1.ax1x.com/2024/10/26/752IAc.jpg" />
        </a>
    </p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">  9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">100
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">101
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">102
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">103
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">104
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">105
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">106
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">107
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">108
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">109
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#6272a4">// 首先从包含了少数几个导致数据倾斜key的rdd1中，采样10%的样本数据。
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>JavaPairRDD<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">,</span> String<span style="color:#ff79c6">&gt;</span> sampledRDD <span style="color:#ff79c6">=</span> rdd1<span style="color:#ff79c6">.</span><span style="color:#50fa7b">sample</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span> 0<span style="color:#ff79c6">.</span><span style="color:#50fa7b">1</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// 对样本数据RDD统计出每个key的出现次数，并按出现次数降序排序。
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// 对降序排序后的数据，取出top 1或者top 100的数据，也就是key最多的前n个数据。
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// 具体取出多少个数据量最多的key，由大家自己决定，我们这里就取1个作为示范。
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>JavaPairRDD<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">,</span> Long<span style="color:#ff79c6">&gt;</span> mappedSampledRDD <span style="color:#ff79c6">=</span> sampledRDD<span style="color:#ff79c6">.</span><span style="color:#50fa7b">mapToPair</span><span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">new</span> PairFunction<span style="color:#ff79c6">&lt;</span>Tuple2<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">,</span>String<span style="color:#ff79c6">&gt;,</span> Long<span style="color:#ff79c6">,</span> Long<span style="color:#ff79c6">&gt;()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">long</span> serialVersionUID <span style="color:#ff79c6">=</span> 1L<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">public</span> Tuple2<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">,</span> Long<span style="color:#ff79c6">&gt;</span> <span style="color:#50fa7b">call</span><span style="color:#ff79c6">(</span>Tuple2<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">,</span> String<span style="color:#ff79c6">&gt;</span> tuple<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> Tuple2<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">,</span> Long<span style="color:#ff79c6">&gt;(</span>tuple<span style="color:#ff79c6">.</span><span style="color:#50fa7b">_1</span><span style="color:#ff79c6">,</span> 1L<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">}</span>     
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">});</span>
</span></span><span style="display:flex;"><span>JavaPairRDD<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">,</span> Long<span style="color:#ff79c6">&gt;</span> countedSampledRDD <span style="color:#ff79c6">=</span> mappedSampledRDD<span style="color:#ff79c6">.</span><span style="color:#50fa7b">reduceByKey</span><span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">new</span> Function2<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">,</span> Long<span style="color:#ff79c6">,</span> Long<span style="color:#ff79c6">&gt;()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">long</span> serialVersionUID <span style="color:#ff79c6">=</span> 1L<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">public</span> Long <span style="color:#50fa7b">call</span><span style="color:#ff79c6">(</span>Long v1<span style="color:#ff79c6">,</span> Long v2<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">return</span> v1 <span style="color:#ff79c6">+</span> v2<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">});</span>
</span></span><span style="display:flex;"><span>JavaPairRDD<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">,</span> Long<span style="color:#ff79c6">&gt;</span> reversedSampledRDD <span style="color:#ff79c6">=</span> countedSampledRDD<span style="color:#ff79c6">.</span><span style="color:#50fa7b">mapToPair</span><span style="color:#ff79c6">(</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">new</span> PairFunction<span style="color:#ff79c6">&lt;</span>Tuple2<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">,</span>Long<span style="color:#ff79c6">&gt;,</span> Long<span style="color:#ff79c6">,</span> Long<span style="color:#ff79c6">&gt;()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">long</span> serialVersionUID <span style="color:#ff79c6">=</span> 1L<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">public</span> Tuple2<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">,</span> Long<span style="color:#ff79c6">&gt;</span> <span style="color:#50fa7b">call</span><span style="color:#ff79c6">(</span>Tuple2<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">,</span> Long<span style="color:#ff79c6">&gt;</span> tuple<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> Tuple2<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">,</span> Long<span style="color:#ff79c6">&gt;(</span>tuple<span style="color:#ff79c6">.</span><span style="color:#50fa7b">_2</span><span style="color:#ff79c6">,</span> tuple<span style="color:#ff79c6">.</span><span style="color:#50fa7b">_1</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">});</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">final</span> Long skewedUserid <span style="color:#ff79c6">=</span> reversedSampledRDD<span style="color:#ff79c6">.</span><span style="color:#50fa7b">sortByKey</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">).</span><span style="color:#50fa7b">take</span><span style="color:#ff79c6">(</span>1<span style="color:#ff79c6">).</span><span style="color:#50fa7b">get</span><span style="color:#ff79c6">(</span>0<span style="color:#ff79c6">).</span><span style="color:#50fa7b">_2</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// 从rdd1中分拆出导致数据倾斜的key，形成独立的RDD。
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>JavaPairRDD<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">,</span> String<span style="color:#ff79c6">&gt;</span> skewedRDD <span style="color:#ff79c6">=</span> rdd1<span style="color:#ff79c6">.</span><span style="color:#50fa7b">filter</span><span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">new</span> Function<span style="color:#ff79c6">&lt;</span>Tuple2<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">,</span>String<span style="color:#ff79c6">&gt;,</span> Boolean<span style="color:#ff79c6">&gt;()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">long</span> serialVersionUID <span style="color:#ff79c6">=</span> 1L<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">public</span> Boolean <span style="color:#50fa7b">call</span><span style="color:#ff79c6">(</span>Tuple2<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">,</span> String<span style="color:#ff79c6">&gt;</span> tuple<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">return</span> tuple<span style="color:#ff79c6">.</span><span style="color:#50fa7b">_1</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">equals</span><span style="color:#ff79c6">(</span>skewedUserid<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">});</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// 从rdd1中分拆出不导致数据倾斜的普通key，形成独立的RDD。
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>JavaPairRDD<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">,</span> String<span style="color:#ff79c6">&gt;</span> commonRDD <span style="color:#ff79c6">=</span> rdd1<span style="color:#ff79c6">.</span><span style="color:#50fa7b">filter</span><span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">new</span> Function<span style="color:#ff79c6">&lt;</span>Tuple2<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">,</span>String<span style="color:#ff79c6">&gt;,</span> Boolean<span style="color:#ff79c6">&gt;()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">long</span> serialVersionUID <span style="color:#ff79c6">=</span> 1L<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">public</span> Boolean <span style="color:#50fa7b">call</span><span style="color:#ff79c6">(</span>Tuple2<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">,</span> String<span style="color:#ff79c6">&gt;</span> tuple<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">!</span>tuple<span style="color:#ff79c6">.</span><span style="color:#50fa7b">_1</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">equals</span><span style="color:#ff79c6">(</span>skewedUserid<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">}</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">});</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// rdd2，就是那个所有key的分布相对较为均匀的rdd。
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// 这里将rdd2中，前面获取到的key对应的数据，过滤出来，分拆成单独的rdd，并对rdd中的数据使用flatMap算子都扩容100倍。
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// 对扩容的每条数据，都打上0～100的前缀。
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>JavaPairRDD<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">,</span> Row<span style="color:#ff79c6">&gt;</span> skewedRdd2 <span style="color:#ff79c6">=</span> rdd2<span style="color:#ff79c6">.</span><span style="color:#50fa7b">filter</span><span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span>         <span style="color:#ff79c6">new</span> Function<span style="color:#ff79c6">&lt;</span>Tuple2<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">,</span>Row<span style="color:#ff79c6">&gt;,</span> Boolean<span style="color:#ff79c6">&gt;()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">long</span> serialVersionUID <span style="color:#ff79c6">=</span> 1L<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">public</span> Boolean <span style="color:#50fa7b">call</span><span style="color:#ff79c6">(</span>Tuple2<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">,</span> Row<span style="color:#ff79c6">&gt;</span> tuple<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">return</span> tuple<span style="color:#ff79c6">.</span><span style="color:#50fa7b">_1</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">equals</span><span style="color:#ff79c6">(</span>skewedUserid<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}).</span><span style="color:#50fa7b">flatMapToPair</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> PairFlatMapFunction<span style="color:#ff79c6">&lt;</span>Tuple2<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">,</span>Row<span style="color:#ff79c6">&gt;,</span> String<span style="color:#ff79c6">,</span> Row<span style="color:#ff79c6">&gt;()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">long</span> serialVersionUID <span style="color:#ff79c6">=</span> 1L<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">public</span> Iterable<span style="color:#ff79c6">&lt;</span>Tuple2<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">,</span> Row<span style="color:#ff79c6">&gt;&gt;</span> <span style="color:#50fa7b">call</span><span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span>                    Tuple2<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">,</span> Row<span style="color:#ff79c6">&gt;</span> tuple<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                Random random <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Random<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>                List<span style="color:#ff79c6">&lt;</span>Tuple2<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">,</span> Row<span style="color:#ff79c6">&gt;&gt;</span> list <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ArrayList<span style="color:#ff79c6">&lt;</span>Tuple2<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">,</span> Row<span style="color:#ff79c6">&gt;&gt;();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">for</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">;</span> i <span style="color:#ff79c6">&lt;</span> 100<span style="color:#ff79c6">;</span> i<span style="color:#ff79c6">++)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                    list<span style="color:#ff79c6">.</span><span style="color:#50fa7b">add</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> Tuple2<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">,</span> Row<span style="color:#ff79c6">&gt;(</span>i <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;_&#34;</span> <span style="color:#ff79c6">+</span> tuple<span style="color:#ff79c6">.</span><span style="color:#50fa7b">_1</span><span style="color:#ff79c6">,</span> tuple<span style="color:#ff79c6">.</span><span style="color:#50fa7b">_2</span><span style="color:#ff79c6">));</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">return</span> list<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>              
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">});</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// 将rdd1中分拆出来的导致倾斜的key的独立rdd，每条数据都打上100以内的随机前缀。
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// 然后将这个rdd1中分拆出来的独立rdd，与上面rdd2中分拆出来的独立rdd，进行join。
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>JavaPairRDD<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">,</span> Tuple2<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">,</span> Row<span style="color:#ff79c6">&gt;&gt;</span> joinedRDD1 <span style="color:#ff79c6">=</span> skewedRDD<span style="color:#ff79c6">.</span><span style="color:#50fa7b">mapToPair</span><span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">new</span> PairFunction<span style="color:#ff79c6">&lt;</span>Tuple2<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">,</span>String<span style="color:#ff79c6">&gt;,</span> String<span style="color:#ff79c6">,</span> String<span style="color:#ff79c6">&gt;()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">long</span> serialVersionUID <span style="color:#ff79c6">=</span> 1L<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">public</span> Tuple2<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">,</span> String<span style="color:#ff79c6">&gt;</span> <span style="color:#50fa7b">call</span><span style="color:#ff79c6">(</span>Tuple2<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">,</span> String<span style="color:#ff79c6">&gt;</span> tuple<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                Random random <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Random<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8be9fd">int</span> prefix <span style="color:#ff79c6">=</span> random<span style="color:#ff79c6">.</span><span style="color:#50fa7b">nextInt</span><span style="color:#ff79c6">(</span>100<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> Tuple2<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">,</span> String<span style="color:#ff79c6">&gt;(</span>prefix <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;_&#34;</span> <span style="color:#ff79c6">+</span> tuple<span style="color:#ff79c6">.</span><span style="color:#50fa7b">_1</span><span style="color:#ff79c6">,</span> tuple<span style="color:#ff79c6">.</span><span style="color:#50fa7b">_2</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">})</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">.</span><span style="color:#50fa7b">join</span><span style="color:#ff79c6">(</span>skewedUserid2infoRDD<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">.</span><span style="color:#50fa7b">mapToPair</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> PairFunction<span style="color:#ff79c6">&lt;</span>Tuple2<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">,</span>Tuple2<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">,</span>Row<span style="color:#ff79c6">&gt;&gt;,</span> Long<span style="color:#ff79c6">,</span> Tuple2<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">,</span> Row<span style="color:#ff79c6">&gt;&gt;()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">long</span> serialVersionUID <span style="color:#ff79c6">=</span> 1L<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>                        @Override
</span></span><span style="display:flex;"><span>                        <span style="color:#8be9fd;font-style:italic">public</span> Tuple2<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">,</span> Tuple2<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">,</span> Row<span style="color:#ff79c6">&gt;&gt;</span> <span style="color:#50fa7b">call</span><span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span>                            Tuple2<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">,</span> Tuple2<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">,</span> Row<span style="color:#ff79c6">&gt;&gt;</span> tuple<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#8be9fd">long</span> key <span style="color:#ff79c6">=</span> Long<span style="color:#ff79c6">.</span><span style="color:#50fa7b">valueOf</span><span style="color:#ff79c6">(</span>tuple<span style="color:#ff79c6">.</span><span style="color:#50fa7b">_1</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">split</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;_&#34;</span><span style="color:#ff79c6">)[</span>1<span style="color:#ff79c6">]);</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> Tuple2<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">,</span> Tuple2<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">,</span> Row<span style="color:#ff79c6">&gt;&gt;(</span>key<span style="color:#ff79c6">,</span> tuple<span style="color:#ff79c6">.</span><span style="color:#50fa7b">_2</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#ff79c6">});</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// 将rdd1中分拆出来的包含普通key的独立rdd，直接与rdd2进行join。
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>JavaPairRDD<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">,</span> Tuple2<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">,</span> Row<span style="color:#ff79c6">&gt;&gt;</span> joinedRDD2 <span style="color:#ff79c6">=</span> commonRDD<span style="color:#ff79c6">.</span><span style="color:#50fa7b">join</span><span style="color:#ff79c6">(</span>rdd2<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// 将倾斜key join后的结果与普通key join后的结果，uinon起来。
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// 就是最终的join结果。
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>JavaPairRDD<span style="color:#ff79c6">&lt;</span>Long<span style="color:#ff79c6">,</span> Tuple2<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">,</span> Row<span style="color:#ff79c6">&gt;&gt;</span> joinedRDD <span style="color:#ff79c6">=</span> joinedRDD1<span style="color:#ff79c6">.</span><span style="color:#50fa7b">union</span><span style="color:#ff79c6">(</span>joinedRDD2<span style="color:#ff79c6">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>使用随机前缀和扩容RDD进行join</strong><br>
如果表中包含了很多倾斜 key，处理方式 跟 加盐 join 的类似</p>
<ul>
<li>首先将其中一个key分布相对较为均匀的RDD膨胀100倍。</li>
<li>其次，将另一个有数据倾斜key的RDD，每条数据都打上100以内的随机前缀。</li>
<li>将两个处理后的RDD进行join即可</li>
</ul>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.apache.spark.rdd.RDD
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.apache.spark.sql.Row
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> scala.collection.mutable.ListBuffer
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> scala.util.Random
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// Assume rdd1 and rdd2 are already created with types as follows:
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// rdd1: RDD[(Long, Row)]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// rdd2: RDD[(Long, String)]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// Step 1: Expanding skewed keys in rdd1
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">val</span> expandedRDD<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">RDD</span><span style="color:#ff79c6">[(</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">Row</span><span style="color:#ff79c6">)]</span> <span style="color:#ff79c6">=</span> rdd1<span style="color:#ff79c6">.</span>flatMap <span style="color:#ff79c6">{</span> <span style="color:#ff79c6">case</span> <span style="color:#ff79c6">(</span>key<span style="color:#ff79c6">,</span> row<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">=&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">val</span> list <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">ListBuffer</span><span style="color:#ff79c6">[(</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">Row</span><span style="color:#ff79c6">)]()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span>i <span style="color:#ff79c6">&lt;-</span> <span style="color:#bd93f9">0</span> until <span style="color:#bd93f9">100</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    list <span style="color:#ff79c6">+=</span> <span style="color:#ff79c6">((</span><span style="color:#f1fa8c">s&#34;</span><span style="color:#f1fa8c">${</span>i<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">_</span><span style="color:#f1fa8c">$key</span><span style="color:#f1fa8c">&#34;</span><span style="color:#ff79c6">,</span> row<span style="color:#ff79c6">))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>  list
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// Step 2: Adding random prefix (salt) to keys in rdd2
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">val</span> mappedRDD<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">RDD</span><span style="color:#ff79c6">[(</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">String</span><span style="color:#ff79c6">)]</span> <span style="color:#ff79c6">=</span> rdd2<span style="color:#ff79c6">.</span>map <span style="color:#ff79c6">{</span> <span style="color:#ff79c6">case</span> <span style="color:#ff79c6">(</span>key<span style="color:#ff79c6">,</span> value<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">=&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">val</span> random <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#50fa7b">Random</span><span style="color:#ff79c6">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">val</span> prefix <span style="color:#ff79c6">=</span> random<span style="color:#ff79c6">.</span>nextInt<span style="color:#ff79c6">(</span><span style="color:#bd93f9">100</span><span style="color:#ff79c6">)</span> <span style="color:#6272a4">// Random prefix between 0 and 99
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">(</span><span style="color:#f1fa8c">s&#34;</span><span style="color:#f1fa8c">${</span>prefix<span style="color:#f1fa8c">}</span><span style="color:#f1fa8c">_</span><span style="color:#f1fa8c">$key</span><span style="color:#f1fa8c">&#34;</span><span style="color:#ff79c6">,</span> value<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// Step 3: Joining the two RDDs
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">val</span> joinedRDD<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">RDD</span><span style="color:#ff79c6">[(</span><span style="color:#8be9fd">String</span>, <span style="color:#ff79c6">(</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">Row</span><span style="color:#ff79c6">))]</span> <span style="color:#ff79c6">=</span> mappedRDD<span style="color:#ff79c6">.</span>join<span style="color:#ff79c6">(</span>expandedRDD<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// Step 4: Removing the salt (prefix) from the keys to restore original keys
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">val</span> finalResult<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">RDD</span><span style="color:#ff79c6">[(</span><span style="color:#8be9fd">Long</span>, <span style="color:#ff79c6">(</span><span style="color:#8be9fd">String</span>, <span style="color:#8be9fd">Row</span><span style="color:#ff79c6">))]</span> <span style="color:#ff79c6">=</span> joinedRDD<span style="color:#ff79c6">.</span>map <span style="color:#ff79c6">{</span> <span style="color:#ff79c6">case</span> <span style="color:#ff79c6">(</span>saltedKey<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span>value<span style="color:#ff79c6">,</span> row<span style="color:#ff79c6">))</span> <span style="color:#ff79c6">=&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// Remove the prefix to get the original key
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">val</span> originalKey <span style="color:#ff79c6">=</span> saltedKey<span style="color:#ff79c6">.</span>split<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;_&#34;</span><span style="color:#ff79c6">)(</span><span style="color:#bd93f9">1</span><span style="color:#ff79c6">).</span>toLong
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">(</span>originalKey<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span>value<span style="color:#ff79c6">,</span> row<span style="color:#ff79c6">))</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// Collect and print the final result
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>finalResult<span style="color:#ff79c6">.</span>collect<span style="color:#ff79c6">().</span>foreach<span style="color:#ff79c6">(</span>println<span style="color:#ff79c6">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>另一个例子</strong><br>
代码</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#6272a4">//根据Join Keys是否倾斜、将内外表分别拆分为两部分
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">import</span> org.apache.spark.sql.functions.array_contains
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#6272a4">//将Join Keys分为两组，存在倾斜的、和分布均匀的
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">val</span> skewOrderIds<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Array</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Int</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">_</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">val</span> evenOrderIds<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Array</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Int</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">_</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">val</span> skewTx<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">DataFrame</span> <span style="color:#ff79c6">=</span> transactions<span style="color:#ff79c6">.</span>filter<span style="color:#ff79c6">(</span>array_contains<span style="color:#ff79c6">(</span>lit<span style="color:#ff79c6">(</span>skewOrderIds<span style="color:#ff79c6">),</span>$<span style="color:#f1fa8c">&#34;orderId&#34;</span><span style="color:#ff79c6">))</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">val</span> evenTx<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">DataFrame</span> <span style="color:#ff79c6">=</span> transactions<span style="color:#ff79c6">.</span>filter<span style="color:#ff79c6">(</span>array_contains<span style="color:#ff79c6">(</span>lit<span style="color:#ff79c6">(</span>evenOrderIds<span style="color:#ff79c6">),</span>$<span style="color:#f1fa8c">&#34;orderId&#34;</span><span style="color:#ff79c6">))</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">val</span> skewOrders<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">DataFrame</span> <span style="color:#ff79c6">=</span> orders<span style="color:#ff79c6">.</span>filter<span style="color:#ff79c6">(</span>array_contains<span style="color:#ff79c6">(</span>lit<span style="color:#ff79c6">(</span>skewOrderIds<span style="color:#ff79c6">),</span>$<span style="color:#f1fa8c">&#34;orderId&#34;</span><span style="color:#ff79c6">))</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">val</span> evenOrders<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">DataFrame</span> <span style="color:#ff79c6">=</span> orders<span style="color:#ff79c6">.</span>filter<span style="color:#ff79c6">(</span>array_contains<span style="color:#ff79c6">(</span>lit<span style="color:#ff79c6">(</span>evenOrderIds<span style="color:#ff79c6">),</span>$<span style="color:#f1fa8c">&#34;orderId&#34;</span><span style="color:#ff79c6">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">//将分布均匀的数据分别注册为临时表
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>evenTx<span style="color:#ff79c6">.</span>createOrReplaceTempView<span style="color:#ff79c6">(</span>“evenTx”<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>evenOrders<span style="color:#ff79c6">.</span>createOrReplaceTempView<span style="color:#ff79c6">(</span>“evenOrders”<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">val</span> evenQuery<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">String</span> <span style="color:#ff79c6">=</span> “
</span></span><span style="display:flex;"><span>select <span style="color:#6272a4">/*+ shuffle_hash(orders) */</span> sum<span style="color:#ff79c6">(</span>tx<span style="color:#ff79c6">.</span>price <span style="color:#ff79c6">*</span> tx<span style="color:#ff79c6">.</span>quantity<span style="color:#ff79c6">)</span> as revenue<span style="color:#ff79c6">,</span> o<span style="color:#ff79c6">.</span>orderId
</span></span><span style="display:flex;"><span>from evenTx as tx inner join evenOrders as o
</span></span><span style="display:flex;"><span>on tx<span style="color:#ff79c6">.</span>orderId <span style="color:#ff79c6">=</span> o<span style="color:#ff79c6">.</span>orderId
</span></span><span style="display:flex;"><span>where o<span style="color:#ff79c6">.</span>status <span style="color:#ff79c6">=</span> ‘<span style="color:#50fa7b">COMPLETE</span>’
</span></span><span style="display:flex;"><span>and o<span style="color:#ff79c6">.</span>date between ‘<span style="color:#bd93f9">2020</span><span style="color:#ff79c6">-</span><span style="color:#bd93f9">01</span><span style="color:#ff79c6">-</span><span style="color:#bd93f9">01</span>’ and ‘<span style="color:#bd93f9">2020</span><span style="color:#ff79c6">-</span><span style="color:#bd93f9">03</span><span style="color:#ff79c6">-</span><span style="color:#bd93f9">31</span>’
</span></span><span style="display:flex;"><span>group by o<span style="color:#ff79c6">.</span>orderId
</span></span><span style="display:flex;"><span>”
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">val</span> evenResults<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">DataFrame</span> <span style="color:#ff79c6">=</span> spark<span style="color:#ff79c6">.</span>sql<span style="color:#ff79c6">(</span>evenQuery<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// 加盐处理
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">import</span> org.apache.spark.sql.functions.udf
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#6272a4">//定义获取随机盐粒的UDF
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">val</span> numExecutors<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Int</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">_</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">val</span> rand <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">()</span> <span style="color:#ff79c6">=&gt;</span> scala<span style="color:#ff79c6">.</span>util<span style="color:#ff79c6">.</span><span style="color:#50fa7b">Random</span><span style="color:#ff79c6">.</span>nextInt<span style="color:#ff79c6">(</span>numExecutors<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">val</span> randUdf <span style="color:#ff79c6">=</span> udf<span style="color:#ff79c6">(</span>rand<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#6272a4">//第一阶段的加盐操作。注意：保留orderId字段，用于后期第二阶段的去盐化
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span> 
</span></span><span style="display:flex;"><span><span style="color:#6272a4">//外表随机加盐
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">val</span> saltedSkewTx <span style="color:#ff79c6">=</span> skewTx<span style="color:#ff79c6">.</span>withColumn<span style="color:#ff79c6">(</span>“joinKey”<span style="color:#ff79c6">,</span> concat<span style="color:#ff79c6">(</span>$“orderId”<span style="color:#ff79c6">,</span> lit<span style="color:#ff79c6">(</span>“<span style="color:#ff79c6">_</span>”<span style="color:#ff79c6">),</span> randUdf<span style="color:#ff79c6">()))</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#6272a4">//内表复制加盐
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">var</span> saltedskewOrders <span style="color:#ff79c6">=</span> skewOrders<span style="color:#ff79c6">.</span>withColumn<span style="color:#ff79c6">(</span>“joinKey”<span style="color:#ff79c6">,</span> concat<span style="color:#ff79c6">(</span>$“orderId”<span style="color:#ff79c6">,</span> lit<span style="color:#ff79c6">(</span>“<span style="color:#ff79c6">_</span>”<span style="color:#ff79c6">),</span> lit<span style="color:#ff79c6">(</span><span style="color:#bd93f9">1</span><span style="color:#ff79c6">)))</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span>i <span style="color:#ff79c6">&lt;-</span> <span style="color:#bd93f9">2</span> to numExecutors<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>  saltedskewOrders <span style="color:#ff79c6">=</span> saltedskewOrders union skewOrders<span style="color:#ff79c6">.</span>withColumn<span style="color:#ff79c6">(</span>“joinKey”<span style="color:#ff79c6">,</span> concat<span style="color:#ff79c6">(</span>$“orderId”<span style="color:#ff79c6">,</span> lit<span style="color:#ff79c6">(</span>“<span style="color:#ff79c6">_</span>”<span style="color:#ff79c6">),</span> lit<span style="color:#ff79c6">(</span>i<span style="color:#ff79c6">)))</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">//将加盐后的数据分别注册为临时表
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>saltedSkewTx<span style="color:#ff79c6">.</span>createOrReplaceTempView<span style="color:#ff79c6">(</span>“saltedSkewTx”<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>saltedskewOrders<span style="color:#ff79c6">.</span>createOrReplaceTempView<span style="color:#ff79c6">(</span>“saltedskewOrders”<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">val</span> skewQuery<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">String</span> <span style="color:#ff79c6">=</span> “
</span></span><span style="display:flex;"><span>select <span style="color:#6272a4">/*+ shuffle_hash(orders) */</span> sum<span style="color:#ff79c6">(</span>tx<span style="color:#ff79c6">.</span>price <span style="color:#ff79c6">*</span> tx<span style="color:#ff79c6">.</span>quantity<span style="color:#ff79c6">)</span> as initialRevenue<span style="color:#ff79c6">,</span> o<span style="color:#ff79c6">.</span>orderId<span style="color:#ff79c6">,</span> o<span style="color:#ff79c6">.</span>joinKey
</span></span><span style="display:flex;"><span>from saltedSkewTx as tx inner join saltedskewOrders as o
</span></span><span style="display:flex;"><span>on tx<span style="color:#ff79c6">.</span>joinKey <span style="color:#ff79c6">=</span> o<span style="color:#ff79c6">.</span>joinKey
</span></span><span style="display:flex;"><span>where o<span style="color:#ff79c6">.</span>status <span style="color:#ff79c6">=</span> ‘<span style="color:#50fa7b">COMPLETE</span>’
</span></span><span style="display:flex;"><span>and o<span style="color:#ff79c6">.</span>date between ‘<span style="color:#bd93f9">2020</span><span style="color:#ff79c6">-</span><span style="color:#bd93f9">01</span><span style="color:#ff79c6">-</span><span style="color:#bd93f9">01</span>’ and ‘<span style="color:#bd93f9">2020</span><span style="color:#ff79c6">-</span><span style="color:#bd93f9">03</span><span style="color:#ff79c6">-</span><span style="color:#bd93f9">31</span>’
</span></span><span style="display:flex;"><span>group by o<span style="color:#ff79c6">.</span>joinKey
</span></span><span style="display:flex;"><span>”
</span></span><span style="display:flex;"><span><span style="color:#6272a4">//第一阶段加盐、Shuffle、关联、聚合后的初步结果
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">val</span> skewInitialResults<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">DataFrame</span> <span style="color:#ff79c6">=</span> spark<span style="color:#ff79c6">.</span>sql<span style="color:#ff79c6">(</span>skewQuery<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// 去盐
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">val</span> skewResults<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">DataFrame</span> <span style="color:#ff79c6">=</span> skewInitialResults<span style="color:#ff79c6">.</span>select<span style="color:#ff79c6">(</span>“initialRevenue”<span style="color:#ff79c6">,</span> “orderId”<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">.</span>groupBy<span style="color:#ff79c6">(</span>col<span style="color:#ff79c6">(</span>“orderId”<span style="color:#ff79c6">)).</span>agg<span style="color:#ff79c6">(</span>sum<span style="color:#ff79c6">(</span>col<span style="color:#ff79c6">(</span>“initialRevenue”<span style="color:#ff79c6">)).</span>alias<span style="color:#ff79c6">(</span>“revenue”<span style="color:#ff79c6">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="shuffle原理">shuffle原理</h2>
<p>HashShuffleManager，现在已经没有了<br>
未优化的方式，task 生成的磁盘文件会很多<br>

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/10/26/752MJ3.jpg">
            <img class="mx-auto" alt="" src="https://v1.ax1x.com/2024/10/26/752MJ3.jpg" />
        </a>
    <br>
优化后的<br>

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/10/26/752iBj.jpg">
            <img class="mx-auto" alt="" src="https://v1.ax1x.com/2024/10/26/752iBj.jpg" />
        </a>
    </p>
<p>现在 ShuffleManager接口只有一个实现类</p>
<ul>
<li>SortShuffleManager</li>
</ul>
<p>普通情况下，会先排序，再写文件，最后 merge，这样文件就很少了<br>
为了方便下游 task read shuffle 的数据，还有一个 index 文件，记录了 key 对应文件的 offset<br>
总的文件数量，就是每个 executor 上的 task 数量   <br>

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/10/26/752sg5.jpg">
            <img class="mx-auto" alt="" src="https://v1.ax1x.com/2024/10/26/752sg5.jpg" />
        </a>
    </p>
<p>bypass 机制，最后也会merge 成一个文件，只是不做 sort 了，省了一些时间<br>

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/10/26/7522Ym.jpg">
            <img class="mx-auto" alt="" src="https://v1.ax1x.com/2024/10/26/7522Ym.jpg" />
        </a>
    </p>
<h2 id="源码层面优化">源码层面优化</h2>
<p>join优化</p>
<ul>
<li>bucked join</li>
<li>colocate join</li>
</ul>
<p>with 的优化</p>
<ul>
<li>创建 自己的 with 逻辑计划</li>
<li>逻辑计划中的 查询做优化</li>
<li>转换成自定义的 物理计划</li>
<li>物理计划缓存</li>
</ul>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">object</span> <span style="color:#50fa7b">CTECachingRule</span> <span style="color:#ff79c6">extends</span> <span style="color:#50fa7b">Rule</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">LogicalPlan</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">override</span> <span style="color:#ff79c6">def</span> apply<span style="color:#ff79c6">(</span>plan<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">LogicalPlan</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">LogicalPlan</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    plan transform <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">case</span> w <span style="color:#ff79c6">@</span> <span style="color:#50fa7b">WithCTE</span><span style="color:#ff79c6">(</span>child<span style="color:#ff79c6">,</span> cteDefs<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">=&gt;</span>
</span></span><span style="display:flex;"><span>        cteMap<span style="color:#ff79c6">(</span>cteName<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">=</span> ctePlan<span style="color:#ff79c6">.</span>cache<span style="color:#ff79c6">()</span>
</span></span><span style="display:flex;"><span>        w
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// 物理计划
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// Custom rule to avoid redundant shuffles on cached CTEs
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">object</span> <span style="color:#50fa7b">CTEPhysicalPlanReuseRule</span> <span style="color:#ff79c6">extends</span> <span style="color:#50fa7b">Rule</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">SparkPlan</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">override</span> <span style="color:#ff79c6">def</span> apply<span style="color:#ff79c6">(</span>plan<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">SparkPlan</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">SparkPlan</span> <span style="color:#ff79c6">=</span> plan transform <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">case</span> exchange<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">ReusedExchangeExec</span> <span style="color:#ff79c6">=&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#6272a4">// Ensure cached CTE result is reused directly
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>      <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>isCached<span style="color:#ff79c6">(</span>exchange<span style="color:#ff79c6">))</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        exchange<span style="color:#ff79c6">.</span>withNewChildren<span style="color:#ff79c6">(</span><span style="color:#50fa7b">Seq</span><span style="color:#ff79c6">.</span>empty<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        exchange
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">def</span> isCached<span style="color:#ff79c6">(</span>plan<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">SparkPlan</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Boolean</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// Logic to check if plan is cached in memory
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    plan<span style="color:#ff79c6">.</span>isInstanceOf<span style="color:#ff79c6">[</span><span style="color:#8be9fd">ReusedExchangeExec</span><span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>查询下推</p>
<ul>
<li>mysql_table_a   JOIN   mysql_table_b   JOIN   pg_table_c</li>
<li>可以将 mysql a，b 合并为一个 sql，下推到数据源</li>
<li>将spark的逻辑计划，转为 calcite 逻辑计划，再转换为数据源的 sql</li>
</ul>
<p>自动倾斜 join 优化</p>
<ul>
<li>需要一套元数据中心，通过元数据中心，获取数据源的信息</li>
<li>扩展 CBO，通过表数据量，可以做 join 的order 调整</li>
<li>扩展 优化规则，可能还需要一些物理计划</li>
</ul>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">object</span> <span style="color:#50fa7b">SkewedJoinSaltingRule</span> <span style="color:#ff79c6">extends</span> <span style="color:#50fa7b">Rule</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">LogicalPlan</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">override</span> <span style="color:#ff79c6">def</span> apply<span style="color:#ff79c6">(</span>plan<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">LogicalPlan</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">LogicalPlan</span> <span style="color:#ff79c6">=</span> plan transform <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">case</span> join <span style="color:#ff79c6">@</span> <span style="color:#50fa7b">Join</span><span style="color:#ff79c6">(</span>left<span style="color:#ff79c6">,</span> right<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">_</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">_</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">=&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#6272a4">// Detect skewed keys (example: assume keys with high frequency)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>      <span style="color:#ff79c6">val</span> skewedKeys <span style="color:#ff79c6">=</span> detectSkewedKeys<span style="color:#ff79c6">(</span>left<span style="color:#ff79c6">)</span>  <span style="color:#6272a4">// Custom logic to identify skewed keys
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>skewedKeys<span style="color:#ff79c6">.</span>nonEmpty<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        applySalting<span style="color:#ff79c6">(</span>join<span style="color:#ff79c6">,</span> skewedKeys<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        join  <span style="color:#6272a4">// No modification if no skew detected
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>      <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">def</span> detectSkewedKeys<span style="color:#ff79c6">(</span>left<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">LogicalPlan</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Set</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Any</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// Pseudo-code for detecting skewed keys
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// Example: Scan the data or use metadata to detect skew
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#50fa7b">Set</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">1</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">2</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">3</span><span style="color:#ff79c6">)</span>  <span style="color:#6272a4">// Replace with dynamic skew detection logic
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">def</span> applySalting<span style="color:#ff79c6">(</span>join<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Join</span><span style="color:#ff79c6">,</span> skewedKeys<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Set</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Any</span><span style="color:#ff79c6">])</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">LogicalPlan</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    join transformExpressions <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">case</span> key <span style="color:#ff79c6">if</span> skewedKeys<span style="color:#ff79c6">.</span>contains<span style="color:#ff79c6">(</span>key<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">=&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// Add salt to the skewed keys
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">val</span> salt <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">Literal</span><span style="color:#ff79c6">(</span><span style="color:#50fa7b">Random</span><span style="color:#ff79c6">.</span>nextInt<span style="color:#ff79c6">(</span><span style="color:#bd93f9">100</span><span style="color:#ff79c6">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">Concat</span><span style="color:#ff79c6">(</span>salt<span style="color:#ff79c6">,</span> key<span style="color:#ff79c6">.</span>asInstanceOf<span style="color:#ff79c6">[</span><span style="color:#8be9fd">AttributeReference</span><span style="color:#ff79c6">])</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Limit大数量</strong><br>
Limit 一次性取 1亿条，limit 1亿非常慢<br>
包括的Limit类型</p>
<ul>
<li>CollectLimitExec</li>
<li>CollectTailExec</li>
<li>BaseLimitExec</li>
<li>LocalLimitExec</li>
<li>GlobalLimitExec</li>
</ul>
<p>执行过程</p>
<ul>
<li>对于子RDD(上游RDD), 使用mapPartitionsInternal, 对每个partitions执行取前1亿行的操作</li>
<li>将第一步输出RDD进行shuffle, 混洗成一个单分区RDD(SinglePartition)</li>
<li>对单分区RDD再做一次取前1亿行的操作</li>
<li>建设分区 100个，每个分区都要取 1亿，再shuffle 到一个分区，再对这个分区取 1亿</li>
</ul>
<p>优化</p>
<ul>
<li>不要一次那么多</li>
<li>sample 采样获取</li>
<li>每个分区 take少量一些，最后再汇总，limit</li>
</ul>
<h2 id="join优化">JOIN优化</h2>
<p>bucked join</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">76
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">77
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">78
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">79
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>test<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;bucket join&#34;</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">import</span> org.apache.spark.sql.<span style="color:#ff79c6">{</span><span style="color:#50fa7b">SparkSession</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">Row</span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">import</span> org.apache.spark.sql.types._
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// Create the schema for people DataFrame
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">val</span> peopleSchema <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">StructType</span><span style="color:#ff79c6">(</span><span style="color:#50fa7b">Array</span><span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span>      <span style="color:#50fa7b">StructField</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;id&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">IntegerType</span><span style="color:#ff79c6">,</span> nullable <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#50fa7b">StructField</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;name&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">StringType</span><span style="color:#ff79c6">,</span> nullable <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#50fa7b">StructField</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;age&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">IntegerType</span><span style="color:#ff79c6">,</span> nullable <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// Create the data as Seq[Row]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">val</span> peopleData <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">Seq</span><span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span>      <span style="color:#50fa7b">Row</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">1</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;Michael&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">30</span><span style="color:#ff79c6">),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#50fa7b">Row</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">2</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;Andy&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">29</span><span style="color:#ff79c6">),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#50fa7b">Row</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">3</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;Justin&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">19</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// Create people DataFrame
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">val</span> peopleDF <span style="color:#ff79c6">=</span> spark<span style="color:#ff79c6">.</span>createDataFrame<span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span>      spark<span style="color:#ff79c6">.</span>sparkContext<span style="color:#ff79c6">.</span>parallelize<span style="color:#ff79c6">(</span>peopleData<span style="color:#ff79c6">),</span>
</span></span><span style="display:flex;"><span>      peopleSchema
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// Create the schema for employee DataFrame
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">val</span> employeeSchema <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">StructType</span><span style="color:#ff79c6">(</span><span style="color:#50fa7b">Array</span><span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span>      <span style="color:#50fa7b">StructField</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;id&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">IntegerType</span><span style="color:#ff79c6">,</span> nullable <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#50fa7b">StructField</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;name&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">StringType</span><span style="color:#ff79c6">,</span> nullable <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#50fa7b">StructField</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;salary&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">IntegerType</span><span style="color:#ff79c6">,</span> nullable <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// Create the data as Seq[Row]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">val</span> employeeData <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">Seq</span><span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span>      <span style="color:#50fa7b">Row</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">1</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;Michael&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">3000</span><span style="color:#ff79c6">),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#50fa7b">Row</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">2</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;Andy&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">4500</span><span style="color:#ff79c6">),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#50fa7b">Row</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">3</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;Justin&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">3500</span><span style="color:#ff79c6">),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#50fa7b">Row</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">4</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;Berta&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">4000</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// Create employee DataFrame
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">val</span> employeeDF <span style="color:#ff79c6">=</span> spark<span style="color:#ff79c6">.</span>createDataFrame<span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span>      spark<span style="color:#ff79c6">.</span>sparkContext<span style="color:#ff79c6">.</span>parallelize<span style="color:#ff79c6">(</span>employeeData<span style="color:#ff79c6">),</span>
</span></span><span style="display:flex;"><span>      employeeSchema
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// Show the DataFrames
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    peopleDF<span style="color:#ff79c6">.</span>show<span style="color:#ff79c6">()</span>
</span></span><span style="display:flex;"><span>    employeeDF<span style="color:#ff79c6">.</span>show<span style="color:#ff79c6">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// Save the DataFrames with bucketing by &#39;id&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    peopleDF<span style="color:#ff79c6">.</span>write
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">.</span>format<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;parquet&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">.</span>bucketBy<span style="color:#ff79c6">(</span><span style="color:#bd93f9">3</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;id&#34;</span><span style="color:#ff79c6">)</span>  <span style="color:#6272a4">// Bucketing by &#39;id&#39; into 3 buckets
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>      <span style="color:#ff79c6">.</span>sortBy<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;id&#34;</span><span style="color:#ff79c6">)</span>  <span style="color:#6272a4">// Sort within each bucket by &#39;id&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>      <span style="color:#ff79c6">.</span>saveAsTable<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;bucketed_people&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    employeeDF<span style="color:#ff79c6">.</span>write
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">.</span>format<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;parquet&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">.</span>bucketBy<span style="color:#ff79c6">(</span><span style="color:#bd93f9">3</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;id&#34;</span><span style="color:#ff79c6">)</span>  <span style="color:#6272a4">// Bucketing by &#39;id&#39; into 3 buckets
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>      <span style="color:#ff79c6">.</span>sortBy<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;id&#34;</span><span style="color:#ff79c6">)</span>  <span style="color:#6272a4">// Sort within each bucket by &#39;id&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>      <span style="color:#ff79c6">.</span>saveAsTable<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;bucketed_employees&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// ==========================================
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// Load the bucketed tables
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">val</span> bucketedPeopleDF <span style="color:#ff79c6">=</span> spark<span style="color:#ff79c6">.</span>table<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;bucketed_people&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">val</span> bucketedEmployeesDF <span style="color:#ff79c6">=</span> spark<span style="color:#ff79c6">.</span>table<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;bucketed_employees&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// Perform the join on bucketed tables without shuffle
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">val</span> resultDF <span style="color:#ff79c6">=</span> bucketedPeopleDF<span style="color:#ff79c6">.</span>join<span style="color:#ff79c6">(</span>bucketedEmployeesDF<span style="color:#ff79c6">,</span> <span style="color:#50fa7b">Seq</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;id&#34;</span><span style="color:#ff79c6">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// Show the result
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    resultDF<span style="color:#ff79c6">.</span>show<span style="color:#ff79c6">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// Check the physical plan to confirm bucketed join
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    resultDF<span style="color:#ff79c6">.</span>explain<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;extended&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>最后生成的物理计划，没有了<code>exchange</code>操作</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#ff79c6">==</span> Physical <span style="color:#8be9fd;font-style:italic">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span>AdaptiveSparkPlan <span style="color:#8be9fd;font-style:italic">isFinalPlan</span><span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">false</span>
</span></span><span style="display:flex;"><span>+- Project <span style="color:#ff79c6">[</span>id#50, name#51, age#52, name#57, salary#58<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>   +- SortMergeJoin <span style="color:#ff79c6">[</span>id#50<span style="color:#ff79c6">]</span>, <span style="color:#ff79c6">[</span>id#56<span style="color:#ff79c6">]</span>, Inner
</span></span><span style="display:flex;"><span>      :- Sort <span style="color:#ff79c6">[</span>id#50 ASC NULLS FIRST<span style="color:#ff79c6">]</span>, false, <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>      :  +- Filter isnotnull<span style="color:#ff79c6">(</span>id#50<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      :     +- FileScan parquet spark_catalog.default.bucketed_people<span style="color:#ff79c6">[</span>id#50,name#51,age#52<span style="color:#ff79c6">]</span> Batched: false, Bucketed: true, DataFilters: 
</span></span><span style="display:flex;"><span>	  <span style="color:#ff79c6">[</span>isnotnull<span style="color:#ff79c6">(</span>id#50<span style="color:#ff79c6">)]</span>, Format: Parquet, Location: InMemoryFileIndex<span style="color:#ff79c6">(</span><span style="color:#bd93f9">1</span> 
</span></span><span style="display:flex;"><span>	  paths<span style="color:#ff79c6">)[</span>file:/data0/test/spark-warehouse/bucketed_people<span style="color:#ff79c6">]</span>, PartitionFilters: <span style="color:#ff79c6">[]</span>, PushedFilters: <span style="color:#ff79c6">[</span>IsNotNull<span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">)]</span>, 
</span></span><span style="display:flex;"><span>	  ReadSchema: struct&lt;id:int,name:string,age:int&gt;, SelectedBucketsCount: <span style="color:#bd93f9">3</span> out of <span style="color:#bd93f9">3</span>
</span></span><span style="display:flex;"><span>      +- Sort <span style="color:#ff79c6">[</span>id#56 ASC NULLS FIRST<span style="color:#ff79c6">]</span>, false, <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>         +- Filter isnotnull<span style="color:#ff79c6">(</span>id#56<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>            +- FileScan parquet spark_catalog.default.bucketed_employees<span style="color:#ff79c6">[</span>id#56,name#57,salary#58<span style="color:#ff79c6">]</span> 
</span></span><span style="display:flex;"><span>			Batched: false, Bucketed: true, DataFilters: <span style="color:#ff79c6">[</span>isnotnull<span style="color:#ff79c6">(</span>id#56<span style="color:#ff79c6">)]</span>, Format: Parquet, Location: InMemoryFileIndex<span style="color:#ff79c6">(</span><span style="color:#bd93f9">1</span> 
</span></span><span style="display:flex;"><span>			paths<span style="color:#ff79c6">)[</span>file:/data0/test/spark-warehouse/bucketed_employees<span style="color:#ff79c6">]</span>, PartitionFilters: <span style="color:#ff79c6">[]</span>, 
</span></span><span style="display:flex;"><span>			PushedFilters: <span style="color:#ff79c6">[</span>IsNotNull<span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">)]</span>, ReadSchema: struct&lt;id:int,name:string,salary:int&gt;, SelectedBucketsCount: <span style="color:#bd93f9">3</span> out of <span style="color:#bd93f9">3</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>4个大表 join问题</strong><br>
sql 执行过程，是前面两个 SMJ，然后跟 第三个 SMJ，再跟第四个 SMJ<br>
整体的 DAG 是串行的</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> e.emp_id, e.emp_name, d.dept_name, p.project_name
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">FROM</span> employees e
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">INNER</span> <span style="color:#ff79c6">JOIN</span> departments d <span style="color:#ff79c6">ON</span> e.dept_id <span style="color:#ff79c6">=</span> d.dept_id
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">INNER</span> <span style="color:#ff79c6">JOIN</span> assignments a <span style="color:#ff79c6">ON</span> e.emp_id <span style="color:#ff79c6">=</span> a.emp_id
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">INNER</span> <span style="color:#ff79c6">JOIN</span> projects p <span style="color:#ff79c6">ON</span> a.project_id <span style="color:#ff79c6">=</span> p.project_id
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">ORDER</span> <span style="color:#ff79c6">BY</span> e.emp_id
</span></span></code></pre></td></tr></table>
</div>
</div><p>优化，数据量不变，但是并行度提高了</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#6272a4">-- Step 1: Join employees and departments
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">WITH</span> t12 <span style="color:#ff79c6">AS</span> (
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">SELECT</span> e.emp_id, e.emp_name, d.dept_name, e.dept_id
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">FROM</span> employees e
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">INNER</span> <span style="color:#ff79c6">JOIN</span> departments d <span style="color:#ff79c6">ON</span> e.dept_id <span style="color:#ff79c6">=</span> d.dept_id
</span></span><span style="display:flex;"><span>),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">-- Step 2: Join assignments and projects
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>t34 <span style="color:#ff79c6">AS</span> (
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">SELECT</span> a.emp_id, p.project_name, a.project_id
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">FROM</span> assignments a
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">INNER</span> <span style="color:#ff79c6">JOIN</span> projects p <span style="color:#ff79c6">ON</span> a.project_id <span style="color:#ff79c6">=</span> p.project_id
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">-- Step 3: Join the two intermediate results t12 and t34
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">SELECT</span> t12.emp_id, t12.emp_name, t12.dept_name, t34.project_name
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">FROM</span> t12
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">LEFT</span> <span style="color:#ff79c6">JOIN</span> t34 <span style="color:#ff79c6">ON</span> t12.emp_id <span style="color:#ff79c6">=</span> t34.emp_id
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">ORDER</span> <span style="color:#ff79c6">BY</span> t12.emp_id;
</span></span></code></pre></td></tr></table>
</div>
</div><p>打印的物理计划看，不再是串行了，而是 1 join 2， 3 join 4，是并行的<br>
最后 1,2 的结果 join 3,4 的结果</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>AdaptiveSparkPlan <span style="color:#8be9fd;font-style:italic">isFinalPlan</span><span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">false</span>
</span></span><span style="display:flex;"><span>+- Sort <span style="color:#ff79c6">[</span>emp_id#3 ASC NULLS FIRST<span style="color:#ff79c6">]</span>, true, <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>   +- Exchange rangepartitioning<span style="color:#ff79c6">(</span>emp_id#3 ASC NULLS FIRST, 200<span style="color:#ff79c6">)</span>, ENSURE_REQUIREMENTS, <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">plan_id</span><span style="color:#ff79c6">=</span>446<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>      +- Project <span style="color:#ff79c6">[</span>emp_id#3, emp_name#4, dept_name#12, project_name#18<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>         +- SortMergeJoin <span style="color:#ff79c6">[</span>emp_id#3<span style="color:#ff79c6">]</span>, <span style="color:#ff79c6">[</span>emp_id#23<span style="color:#ff79c6">]</span>, LeftOuter
</span></span><span style="display:flex;"><span>            :- Sort <span style="color:#ff79c6">[</span>emp_id#3 ASC NULLS FIRST<span style="color:#ff79c6">]</span>, false, <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>            :  +- Exchange hashpartitioning<span style="color:#ff79c6">(</span>emp_id#3, 200<span style="color:#ff79c6">)</span>, ENSURE_REQUIREMENTS, <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">plan_id</span><span style="color:#ff79c6">=</span>439<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>            :     +- Project <span style="color:#ff79c6">[</span>emp_id#3, emp_name#4, dept_name#12<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>            :        +- SortMergeJoin <span style="color:#ff79c6">[</span>dept_id#5<span style="color:#ff79c6">]</span>, <span style="color:#ff79c6">[</span>dept_id#11<span style="color:#ff79c6">]</span>, Inner
</span></span><span style="display:flex;"><span>            :           :- Sort <span style="color:#ff79c6">[</span>dept_id#5 ASC NULLS FIRST<span style="color:#ff79c6">]</span>, false, <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>            :           :  +- Exchange hashpartitioning<span style="color:#ff79c6">(</span>dept_id#5, 200<span style="color:#ff79c6">)</span>, ENSURE_REQUIREMENTS, <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">plan_id</span><span style="color:#ff79c6">=</span>424<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>            :           :     +- Filter isnotnull<span style="color:#ff79c6">(</span>dept_id#5<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>            :           :        +- Scan ExistingRDD<span style="color:#ff79c6">[</span>emp_id#3,emp_name#4,dept_id#5<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>            :           +- Sort <span style="color:#ff79c6">[</span>dept_id#11 ASC NULLS FIRST<span style="color:#ff79c6">]</span>, false, <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>            :              +- Exchange hashpartitioning<span style="color:#ff79c6">(</span>dept_id#11, 200<span style="color:#ff79c6">)</span>, ENSURE_REQUIREMENTS, <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">plan_id</span><span style="color:#ff79c6">=</span>425<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>            :                 +- Scan ExistingRDD<span style="color:#ff79c6">[</span>dept_id#11,dept_name#12<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>            +- Sort <span style="color:#ff79c6">[</span>emp_id#23 ASC NULLS FIRST<span style="color:#ff79c6">]</span>, false, <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>               +- Exchange hashpartitioning<span style="color:#ff79c6">(</span>emp_id#23, 200<span style="color:#ff79c6">)</span>, ENSURE_REQUIREMENTS, <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">plan_id</span><span style="color:#ff79c6">=</span>440<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>                  +- Project <span style="color:#ff79c6">[</span>emp_id#23, project_name#18<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>                     +- SortMergeJoin <span style="color:#ff79c6">[</span>project_id#24<span style="color:#ff79c6">]</span>, <span style="color:#ff79c6">[</span>project_id#17<span style="color:#ff79c6">]</span>, Inner
</span></span><span style="display:flex;"><span>                        :- Sort <span style="color:#ff79c6">[</span>project_id#24 ASC NULLS FIRST<span style="color:#ff79c6">]</span>, false, <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>                        :  +- Exchange hashpartitioning<span style="color:#ff79c6">(</span>project_id#24, 200<span style="color:#ff79c6">)</span>, ENSURE_REQUIREMENTS, <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">plan_id</span><span style="color:#ff79c6">=</span>431<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>                        :     +- Scan ExistingRDD<span style="color:#ff79c6">[</span>emp_id#23,project_id#24<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>                        +- Sort <span style="color:#ff79c6">[</span>project_id#17 ASC NULLS FIRST<span style="color:#ff79c6">]</span>, false, <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>                           +- Exchange hashpartitioning<span style="color:#ff79c6">(</span>project_id#17, 200<span style="color:#ff79c6">)</span>, ENSURE_REQUIREMENTS, <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">plan_id</span><span style="color:#ff79c6">=</span>432<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>                              +- Scan ExistingRDD<span style="color:#ff79c6">[</span>project_id#17,project_name#18<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Process finished with <span style="color:#8be9fd;font-style:italic">exit</span> code <span style="color:#bd93f9">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="rss">RSS</h2>
<p>Uber 的 原始 shuffle 问题</p>
<ul>
<li><strong>Hardware Reliability</strong>: Due to the large volumes of shuffle data being written to the SSD daily, Uber disks were worn out faster than the initial design. Instead of being sustained for three years, the disk at Uber wears out in 6 months.</li>
<li><strong>Shuffle failure</strong>: when the reducer fetches the data from all mapper tasks on the same machine, the service becomes unavailable, which causes a lot of shuffle failures.</li>
<li><strong>Noisy Neighbor Issue</strong>: An application that writes more significant shuffle data will potentially take all the disk space volume in the machine, which causes other applications on this machine to fail due to disk full exceptions.</li>
<li><strong>Shuffle Service Unreliability</strong>: Uber user external shuffle service in YARN and Mesos for Spark. They often experienced the shuffle service being unavailable in a set of nodes.</li>
</ul>
<p>普通的 shuffle 调用过程 <br>

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/10/27/756LYa.png">
            <img class="mx-auto" alt="" src="https://v1.ax1x.com/2024/10/27/756LYa.png" />
        </a>
    <br>

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/10/27/7560d7.png">
            <img class="mx-auto" alt="" src="https://v1.ax1x.com/2024/10/27/7560d7.png" />
        </a>
    </p>
<p>Uber 的 RSS 架构</p>
<ul>
<li>先将 RSS服务注册到 ZK 上，driver根据负载情况选择 RSS 服务</li>
<li>mapper 将相同的分区直接写到固定的 RSS 上，reducer 也去指定的 RSS 上获取</li>
<li>这样 reducer 就只需要跟一个 RSS通讯</li>
<li>为保持高可用，mapper可以写多个 RSS机器<br>

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/10/27/756luI.png">
            <img class="mx-auto" alt="" src="https://v1.ax1x.com/2024/10/27/756luI.png" />
        </a>
    </li>
</ul>
<h2 id="参考">参考</h2>
<ul>
<li><a href="https://spark.apache.org/docs/latest/tuning.html">Tuning Spark</a></li>
<li><a href="https://learn.lianglianglee.com/%E4%B8%93%E6%A0%8F/Spark%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98%E5%AE%9E%E6%88%98">Spark性能调优实战</a></li>
<li><a href="https://tech.meituan.com/2016/04/29/spark-tuning-basic.html">Spark性能优化指南——基础篇</a></li>
<li><a href="https://tech.meituan.com/2016/05/12/spark-tuning-pro.html">Spark性能优化指南——高级篇</a></li>
<li><a href="https://tech.meituan.com/2024/06/23/spark-gluten-velox.html">Spark向量化计算在美团生产环境的实践</a></li>
<li><a href="https://tech.meituan.com/2024/03/15/kv-squirrel-cellar.html">美团大规模KV存储挑战与架构实践</a></li>
<li><a href="https://leovan.me/cn/2021/05/big-data-sql-performance-tuning/">大数据 SQL 性能调优</a></li>
<li><a href="https://c.m.163.com/news/a/HO7BLU7805315PUD.html">国产化大数据，Hadoop该如何应对</a></li>
<li><a href="https://tianzhipeng-git.github.io/2023/11/06/spark-bloomfilter-join.html">spark硬核优化1 布隆过滤器大join优化</a></li>
<li><a href="https://www.qinglite.cn/doc/461364775f7dbec77">Spark 优化 | 京东 Spark 基于 Bloom Filter 算法的 Runtime Filter Join 优化机制</a></li>
<li><a href="https://github.com/apache/spark/pull/29065">[WIP][SPARK-32268][SQL] Bloom Filter Join</a></li>
<li><a href="https://www.infoq.cn/article/9uvdrn4ligyylqmpq0af">第四范式 OpenMLDB: 拓展 Spark 源码实现高性能 Join</a></li>
<li><a href="https://www.linkedin.com/pulse/optimize-join-operation-using-bucketing-apache-spark-ajay-sharma-3skmf/">Optimize Join operation using Bucketing in Apache Spark</a></li>
<li><a href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrameWriter.bucketBy.html">pyspark.sql.DataFrameWriter.bucketBy</a></li>
<li><a href="https://spark.apache.org/docs/latest/api/python/getting_started/quickstart_connect.html">Quickstart: Spark Connect</a></li>
<li><a href="https://spark.apache.org/docs/latest/sql-data-sources-parquet.html">Parquet Files</a></li>
<li><a href="https://medium.com/@diehardankush/what-all-about-bucketing-and-partitioning-in-spark-bc669441db63">What: All About Bucketing and Partitioning in Spark</a></li>
<li><a href="https://blog.det.life/how-does-uber-handle-petabytes-of-spark-shuffle-data-every-day-223d8317cfb1">How does Uber handle petabytes of Spark shuffle data every day?</a></li>
<li><a href="https://celeborn.apache.org/">Apache Celebron</a></li>
<li><a href="https://gluten.apache.org/">Apache Gluten</a></li>
<li><a href="https://github.com/facebookincubator/velox">facebook volex</a></li>
<li><a href="https://github.com/uber/RemoteShuffleService">Uber RemoteShuffleService</a></li>
<li><a href="https://vutr.substack.com/p/i-spent-6-hours-to-learn-how-apache">I spent 6 hours learning how Apache Spark plans the execution for us</a></li>
<li><a href="https://www.uber.com/en-SG/blog/ubers-highly-scalable-and-distributed-shuffle-as-a-service/">Uber’s Highly Scalable and Distributed Shuffle as a Service</a></li>
<li><a href="https://www.uber.com/en-KR/blog/resource-scheduler-cluster-management-peloton/?uclick_id=7e246c41-f7f1-4247-8d78-93f5b5932d71">Peloton: Uber’s Unified Resource Scheduler for Diverse Cluster Workloads</a></li>
</ul>

			<script type="text/javascript"
        async
        src="https://cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[\[','\]\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});

MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<style>
code.has-jax {
    font: inherit;
    font-size: 100%;
    background: inherit;
    border: inherit;
    color: #515151;
}
</style>
        </div>

        


        

<div class="post-archive">
    <h2>相关文章</h2>
    <ul class="listing">
        
        <li><a href="/post/2024/09/spark_streaming/">Spark-Streaming 原理</a></li>
        
        <li><a href="/post/2024/09/data_distribution/">Spark的 数据分布</a></li>
        
        <li><a href="/post/2024/05/spark_codegen/">code-gen</a></li>
        
        <li><a href="/post/2024/05/spark_join/">Spark原理-JOIN</a></li>
        
        <li><a href="/post/2024/05/spark_windows_cube/">Spark原理-窗口函数和多维分析</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='/tags/spark'>Spark</a></li>
                
            </ul>
            
        </div>
    </article>
    
    

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "himichael/hugoblogtalks"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
</div>


                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='https://code0xff.org/search/' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://code0xff.org/">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://code0xff.org/post/2025/01/spark_register_source/" title="Spark 注册数据源">Spark 注册数据源</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2025/01/spark_core_2/" title="Spark Core相关-2">Spark Core相关-2</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2024/12/llamafactory/" title="Llama Factory">Llama Factory</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2024/11/spark_core/" title="Spark Core相关-1">Spark Core相关-1</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2024/11/sae_tunnel/" title="sea tunnel">sea tunnel</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2024/11/k8s_networks/" title="k8s 网络">k8s 网络</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2024/11/ozone/" title="ozone">ozone</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2024/11/es/" title="ES的简单学习">ES的简单学习</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2025/02/ai/" title="AI的简单学习">AI的简单学习</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2024/11/big_data_investigation/" title="国内几个云厂商大数据平台">国内几个云厂商大数据平台</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories/'>分类</a></h3>
<ul class="widget-list">
    
    <li><a href="https://code0xff.org/categories/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式 (6)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/">原理分析 (24)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E5%95%86%E4%B8%9A/">商业 (3)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据 (56)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库 (41)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E6%96%87%E5%AD%A6%E5%92%8C%E8%89%BA%E6%9C%AF/">文学和艺术 (3)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E6%97%85%E8%A1%8C/">旅行 (12)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E6%9E%B6%E6%9E%84/">架构 (13)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E7%AE%97%E6%B3%95/">算法 (8)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E7%B3%BB%E7%BB%9F/">系统 (7)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/">编程语言 (7)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E8%A1%8C%E4%B8%9A%E8%A7%82%E5%AF%9F/">行业观察 (3)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">读书笔记 (14)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E9%9A%8F%E4%BE%BF%E5%86%99%E5%86%99/">随便写写 (3)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title">归档</a></h3>
<ul class="widget-list">
    
    <li><a href="https://code0xff.org/years/2021%E5%B9%B4/">2021年 (41)</a></li>
    
    <li><a href="https://code0xff.org/years/2022%E5%B9%B4/">2022年 (55)</a></li>
    
    <li><a href="https://code0xff.org/years/2023%E5%B9%B4/">2023年 (54)</a></li>
    
    <li><a href="https://code0xff.org/years/2024%E5%B9%B4/">2024年 (48)</a></li>
    
    <li><a href="https://code0xff.org/years/2025%E5%B9%B4/">2025年 (2)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags/'>标签</a></h3>
<div class="tagcloud">
    
    <a href="https://code0xff.org/tags/ai/">AI </a>
    
    <a href="https://code0xff.org/tags/ambari/">Ambari </a>
    
    <a href="https://code0xff.org/tags/architecture/">architecture </a>
    
    <a href="https://code0xff.org/tags/bigdata/">bigdata </a>
    
    <a href="https://code0xff.org/tags/b%E6%A0%91/">B树 </a>
    
    <a href="https://code0xff.org/tags/c&#43;&#43;/">C&#43;&#43; </a>
    
    <a href="https://code0xff.org/tags/calcite/">calcite </a>
    
    <a href="https://code0xff.org/tags/cmu-database/">CMU-Database </a>
    
    <a href="https://code0xff.org/tags/data_ingestion/">Data_Ingestion </a>
    
    <a href="https://code0xff.org/tags/deltalake/">DeltaLake </a>
    
    <a href="https://code0xff.org/tags/doris/">Doris </a>
    
    <a href="https://code0xff.org/tags/english/">English </a>
    
    <a href="https://code0xff.org/tags/es/">ES </a>
    
    <a href="https://code0xff.org/tags/facebook/">Facebook </a>
    
    <a href="https://code0xff.org/tags/flink/">flink </a>
    
    <a href="https://code0xff.org/tags/flume/">flume </a>
    
    <a href="https://code0xff.org/tags/gc/">GC </a>
    
    <a href="https://code0xff.org/tags/gluten/">Gluten </a>
    
    <a href="https://code0xff.org/tags/hana/">HANA </a>
    
    <a href="https://code0xff.org/tags/hive/">Hive </a>
    
    <a href="https://code0xff.org/tags/iceberg/">iceberg </a>
    
    <a href="https://code0xff.org/tags/impala/">Impala </a>
    
    <a href="https://code0xff.org/tags/janino/">janino </a>
    
    <a href="https://code0xff.org/tags/k8s/">k8s </a>
    
    <a href="https://code0xff.org/tags/kafka/">Kafka </a>
    
    <a href="https://code0xff.org/tags/kudu/">kudu </a>
    
    <a href="https://code0xff.org/tags/kyuubi/">Kyuubi </a>
    
    <a href="https://code0xff.org/tags/lakehouse/">Lakehouse </a>
    
    <a href="https://code0xff.org/tags/leveldb/">LevelDB </a>
    
    <a href="https://code0xff.org/tags/llamafactory/">LlamaFactory </a>
    
    <a href="https://code0xff.org/tags/llvm/">LLVM </a>
    
    <a href="https://code0xff.org/tags/manacher/">Manacher </a>
    
    <a href="https://code0xff.org/tags/mapreduce/">MapReduce </a>
    
    <a href="https://code0xff.org/tags/micro-service/">micro-service </a>
    
    <a href="https://code0xff.org/tags/mysql/">MySQL </a>
    
    <a href="https://code0xff.org/tags/newsql/">NewSQL </a>
    
    <a href="https://code0xff.org/tags/oceanbase/">OceanBase </a>
    
    <a href="https://code0xff.org/tags/openlogreplicator/">OpenLogReplicator </a>
    
    <a href="https://code0xff.org/tags/parquet/">parquet </a>
    
    <a href="https://code0xff.org/tags/paxos/">paxos </a>
    
    <a href="https://code0xff.org/tags/presto/">Presto </a>
    
    <a href="https://code0xff.org/tags/quick-sql/">quick-sql </a>
    
    <a href="https://code0xff.org/tags/raft/">raft </a>
    
    <a href="https://code0xff.org/tags/scala/">scala </a>
    
    <a href="https://code0xff.org/tags/simd/">SIMD </a>
    
    <a href="https://code0xff.org/tags/snowflake/">snowflake </a>
    
    <a href="https://code0xff.org/tags/spark/">spark </a>
    
    <a href="https://code0xff.org/tags/sre/">SRE </a>
    
    <a href="https://code0xff.org/tags/teradata/">TeraData </a>
    
    <a href="https://code0xff.org/tags/tpcx-hs/">TPCx-HS </a>
    
    <a href="https://code0xff.org/tags/trino/">Trino </a>
    
    <a href="https://code0xff.org/tags/tuning/">Tuning </a>
    
    <a href="https://code0xff.org/tags/unix/">unix </a>
    
    <a href="https://code0xff.org/tags/yarn/">YARN </a>
    
    <a href="https://code0xff.org/tags/%E4%BA%8C%E5%88%86%E6%9F%A5%E6%89%BE/">二分查找 </a>
    
    <a href="https://code0xff.org/tags/%E4%BA%8C%E5%8F%89%E6%A0%91%E9%81%8D%E5%8E%86/">二叉树遍历 </a>
    
    <a href="https://code0xff.org/tags/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式 </a>
    
    <a href="https://code0xff.org/tags/%E5%88%97%E5%AD%98/">列存 </a>
    
    <a href="https://code0xff.org/tags/%E5%8A%A8%E6%80%81%E6%B3%A8%E5%85%A5/">动态注入 </a>
    
    <a href="https://code0xff.org/tags/%E5%8E%86%E5%8F%B2/">历史 </a>
    
    <a href="https://code0xff.org/tags/%E5%90%91%E9%87%8F%E5%8C%96/">向量化 </a>
    
    <a href="https://code0xff.org/tags/%E5%9B%9E%E6%BA%AF/">回溯 </a>
    
    <a href="https://code0xff.org/tags/%E5%9B%BD%E5%86%85%E6%97%85%E8%A1%8C/">国内旅行 </a>
    
    <a href="https://code0xff.org/tags/%E5%9B%BD%E5%A4%96%E6%97%85%E8%A1%8C/">国外旅行 </a>
    
    <a href="https://code0xff.org/tags/%E5%A4%9A%E7%A7%9F%E6%88%B7/">多租户 </a>
    
    <a href="https://code0xff.org/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据 </a>
    
    <a href="https://code0xff.org/tags/%E5%AD%98%E5%82%A8/">存储 </a>
    
    <a href="https://code0xff.org/tags/%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95/">工作记录 </a>
    
    <a href="https://code0xff.org/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务 </a>
    
    <a href="https://code0xff.org/tags/%E6%95%B0%E6%8D%AE%E4%B8%AD%E5%8F%B0/">数据中台 </a>
    
    <a href="https://code0xff.org/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库 </a>
    
    <a href="https://code0xff.org/tags/%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B/">数据模型 </a>
    
    <a href="https://code0xff.org/tags/%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB/">数据迁移 </a>
    
    <a href="https://code0xff.org/tags/%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96/">查询优化 </a>
    
    <a href="https://code0xff.org/tags/%E6%9F%A5%E8%AF%A2%E7%BC%96%E8%AF%91/">查询编译 </a>
    
    <a href="https://code0xff.org/tags/%E6%A6%82%E7%8E%87/">概率 </a>
    
    <a href="https://code0xff.org/tags/%E6%B1%87%E7%BC%96/">汇编 </a>
    
    <a href="https://code0xff.org/tags/%E6%B5%8B%E8%AF%95/">测试 </a>
    
    <a href="https://code0xff.org/tags/%E7%94%9F%E6%B4%BB/">生活 </a>
    
    <a href="https://code0xff.org/tags/%E7%94%B5%E5%BD%B1/">电影 </a>
    
    <a href="https://code0xff.org/tags/%E7%AE%97%E6%B3%95/">算法 </a>
    
    <a href="https://code0xff.org/tags/%E7%B4%A2%E5%BC%95/">索引 </a>
    
    <a href="https://code0xff.org/tags/%E7%BB%8F%E6%B5%8E/">经济 </a>
    
    <a href="https://code0xff.org/tags/%E7%BC%93%E5%AD%98/">缓存 </a>
    
    <a href="https://code0xff.org/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/">编译原理 </a>
    
    <a href="https://code0xff.org/tags/%E7%BD%91%E7%BB%9C/">网络 </a>
    
    <a href="https://code0xff.org/tags/%E8%AE%A1%E7%AE%97%E6%A1%86%E6%9E%B6/">计算框架 </a>
    
    <a href="https://code0xff.org/tags/%E8%AE%BA%E6%96%87/">论文 </a>
    
    <a href="https://code0xff.org/tags/%E8%AF%BB%E4%B9%A6/">读书 </a>
    
    <a href="https://code0xff.org/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">读书笔记 </a>
    
</div>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">RSS</h3>
        <ul class="widget-list">
            <li><a href="https://code0xff.org/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
    <footer id="footer">
    <div>
        &copy; 2025 <a href="https://code0xff.org/">记录每个瞬间 By 老王</a>
        
    </div>
    <br />
    <div>
        <div class="github-badge">
            <a href="https://gohugo.io/" target="_black" rel="nofollow"><span class="badge-subject">Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
        </div>
        <div class="github-badge">
            <a href="https://github.com/flysnow-org/maupassant-hugo" target="_black"><span class="badge-subject">Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
        </div>
    </div>
</footer>


    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script><script src="https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'GA ID', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



    <script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>




</body>

</html>