<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="referrer" content="no-referrer-when-downgrade">
    

    <title>Spark原理-优化规则 | 记录每个瞬间</title>
    <meta property="og:title" content="Spark原理-优化规则 - 记录每个瞬间">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2024-03-04T09:08:07&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2024-03-04T09:08:07&#43;08:00'>
        
    <meta name="Keywords" content="">
    <meta name="description" content="Spark原理-优化规则">
        <meta name="author" content="隔壁老王">
        
    <meta property="og:url" content="https://code0xff.org/post/2024/03/spark_optimized/">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    
    
        <link href="https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" rel="stylesheet">
    
    
    
    
</head>


<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://code0xff.org/">
                        记录每个瞬间
                    </a>
                
                
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="https://code0xff.org/">首页</a>
                    
                    <a  href="https://code0xff.org/linked/" title="链接">链接</a>
                    
                    <a  href="https://code0xff.org/archives/" title="归档">归档</a>
                    
                    <a  href="https://code0xff.org/about/" title="关于">关于</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    
    <article class="post">
        <header>
            <h1 class="post-title">Spark原理-优化规则</h1>
        </header>
        <date class="post-meta meta-date">
            2024年3月4日
        </date>
<nav id="TableOfContents">
  <ul>
    <li><a href="#子查询">子查询</a>
      <ul>
        <li><a href="#理论">理论</a></li>
        <li><a href="#优化技术">优化技术</a></li>
        <li><a href="#spark中的查询分类">Spark中的查询分类</a></li>
        <li><a href="#optimzesubqueries">OptimzeSubqueries</a></li>
        <li><a href="#pullupcorrelatedpredicates">PullupCorrelatedPredicates</a></li>
        <li><a href="#rewritepredicatesubquery">RewritePredicateSubquery</a></li>
        <li><a href="#其他一些情况">其他一些情况</a></li>
      </ul>
    </li>
    <li><a href="#算子合并">算子合并</a>
      <ul>
        <li><a href="#collapserepartition">CollapseRepartition</a></li>
        <li><a href="#collapseproject">CollapseProject</a></li>
        <li><a href="#combinefilters">CombineFilters</a></li>
        <li><a href="#combineunions">CombineUnions</a></li>
        <li><a href="#其他">其他</a></li>
      </ul>
    </li>
    <li><a href="#常量折叠和强度消减">常量折叠和强度消减</a>
      <ul>
        <li><a href="#nullpropagation">NullPropagation</a></li>
        <li><a href="#constantpropagation">ConstantPropagation</a></li>
        <li><a href="#optimizein">OptimizeIn</a></li>
        <li><a href="#constantfolding">ConstantFolding</a></li>
        <li><a href="#replacenullwithfalseinpredicate">ReplaceNullWithFalseInPredicate</a></li>
        <li><a href="#combineconcats">CombineConcats</a></li>
        <li><a href="#其他-1">其他</a></li>
      </ul>
    </li>
    <li><a href="#算子简化">算子简化</a>
      <ul>
        <li><a href="#likesimplification">LikeSimplification</a></li>
        <li><a href="#booleansimplification">BooleanSimplification</a></li>
        <li><a href="#simplifybinarycomparison">SimplifyBinaryComparison</a></li>
        <li><a href="#prunefilters">PruneFilters</a></li>
        <li><a href="#eliminateserialization">EliminateSerialization</a></li>
        <li><a href="#simplifyextractvalueops">SimplifyExtractValueOps</a></li>
        <li><a href="#其他-2">其他</a></li>
      </ul>
    </li>
    <li><a href="#rewritereplaceeliminate规则">Rewrite/Replace/Eliminate规则</a>
      <ul>
        <li><a href="#eliminateouterjoin">EliminateOuterJoin</a></li>
        <li><a href="#eliminatedistinct">EliminateDistinct</a></li>
        <li><a href="#eliminatelimits">EliminateLimits</a></li>
        <li><a href="#其他-3">其他</a></li>
      </ul>
    </li>
    <li><a href="#下推规则">下推规则</a>
      <ul>
        <li><a href="#pushdownpredicates">PushDownPredicates</a></li>
        <li><a href="#pushpredicatethroughnonjoin">PushPredicateThroughNonJoin</a></li>
        <li><a href="#pushpredicatethroughjoin">PushPredicateThroughJoin</a></li>
        <li><a href="#limitpushdown">LimitPushDown</a></li>
        <li><a href="#columnpruning">ColumnPruning</a></li>
      </ul>
    </li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>
        
        <div class="post-meta">
            
            <span class="post-meta meta-tags">
                <ul class="clearfix">
                    <a href='/categories/%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90'>原理分析</a>
                </ul>
            </span>
            
        </div>
        
        
        <div class="post-meta">
            <span id="busuanzi_container_page_pv">|<span id="busuanzi_value_page_pv"></span><span>
                    阅读</span></span>
        </div>
        
        
        <div class="post-content">
            <h1 id="子查询">子查询</h1>
<h2 id="理论">理论</h2>
<p>SPJ，选择、投影、连接，最重要的三个操作<br>
非 SPJ</p>
<p>从子查询出现在SQL语句的位置看，它可以出现在</p>
<ul>
<li>目标列</li>
<li>FROM子句</li>
<li>WHERE子句</li>
<li>JOIN/ON子句</li>
<li>GROUPBY子句</li>
<li>HAVING子句</li>
<li>ORDERBY子句等位置</li>
</ul>
<p>子查询出现在不同位置对优化的影响如下</p>
<ul>
<li>目标列位置，子查询如果位于目标列，则只能是标量子查询</li>
<li>FROM子句位置，不能是相关子查询，可以是 非相关子查询，此时可以 上拉子查询变成 join</li>
<li>WHERE子句位置，是条件表达式的一部分，如Int类型的&gt;、&lt;、=、&lt;&gt; 此时必须是标量子查询，其他谓词包括：IN、BETWEEN、EXISTS</li>
<li>JOIN/ON，JOIN类似于FROM 子句，ON 类似于WHERE 子句，总体处理方式跟 FROM、WHERE 类似</li>
<li>GROUPBY子句位置，目标列必须和 group by 相关联，但一般没什么意义</li>
<li>ORDERBY子句位置，一般没什么意义</li>
</ul>
<p>子查询分类</p>
<ul>
<li>相关子查询。子查询的执行依赖于外层父查询的一些属性值。子查询因依赖于父查询的参数，当父查询的参数改变时，子查询需要根据新参数值重新执行</li>
<li>非相关子查询。子查询的执行不依赖于外层父查询的任何属性值，这样的子查询具有独立性，可独自求解</li>
</ul>
<p>从特定谓词看</p>
<ul>
<li>[NOT]IN/ALL/ANY/SOME子查询，语义相近，表示“[取反]存在/所有/任何/任何”，左面是操作数，右面是子查询，是最常见的子查询类型之一</li>
<li>[NOT]EXISTS子查询，半连接语义，表示“[取反]存在”，没有左操作数，右面是子查询，也是最常见的子查询类型之一</li>
</ul>
<p>查询分类</p>
<ul>
<li>SPJ子查询。由选择、连接、投影操作组成的查询。</li>
<li>GROUPBY子查询。SPJ子查询加上分组、聚集操作组成的查询。</li>
<li>其他子查询。GROUPBY子查询中加上其他子句如Top-N、LIMIT/OFFSET、集合、排序等操作</li>
<li>后两种子查询有时合称非SPJ子查询</li>
</ul>
<p>从结果集的角度看，子查询分为以下4类：</p>
<ul>
<li>标量子查询。子查询返回的结果集类型是一个单一值（return a scalar，a single value）。</li>
<li>列子查询。子查询返回的结果集类型是一条单一元组（return a single row）。</li>
<li>行子查询。子查询返回的结果集类型是一个单一列（return a single column）。</li>
<li>表子查询。子查询返回的结果集类型是一个表（多行多列）（return a table，one or more rows of one or more columns）</li>
</ul>
<h2 id="优化技术">优化技术</h2>
<p>子查询合并（Subquery Coalescing）</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> t1 <span style="color:#ff79c6">WHERE</span> a1<span style="color:#ff79c6">&lt;</span><span style="color:#bd93f9">10</span> <span style="color:#ff79c6">AND</span> (
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">EXISTS</span> (<span style="color:#ff79c6">SELECT</span> a2 <span style="color:#ff79c6">FROM</span> t2 <span style="color:#ff79c6">WHERE</span> t2.a2<span style="color:#ff79c6">&lt;</span><span style="color:#bd93f9">5</span> <span style="color:#ff79c6">AND</span> t2.b2<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span>) <span style="color:#ff79c6">OR</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">EXISTS</span> (<span style="color:#ff79c6">SELECT</span> a2 <span style="color:#ff79c6">FROM</span> t2 <span style="color:#ff79c6">WHERE</span> t2.a2<span style="color:#ff79c6">&lt;</span><span style="color:#bd93f9">5</span> <span style="color:#ff79c6">AND</span> t2.b2<span style="color:#ff79c6">=</span><span style="color:#bd93f9">2</span>) 
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></td></tr></table>
</div>
</div><p>可优化为：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> t1 <span style="color:#ff79c6">WHERE</span> a1<span style="color:#ff79c6">&lt;</span><span style="color:#bd93f9">10</span> <span style="color:#ff79c6">AND</span> (
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">EXISTS</span> (<span style="color:#ff79c6">SELECT</span> a2 <span style="color:#ff79c6">FROM</span> t2 <span style="color:#ff79c6">WHERE</span> t2.a2<span style="color:#ff79c6">&lt;</span><span style="color:#bd93f9">5</span> <span style="color:#ff79c6">AND</span> (t2.b2<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span> <span style="color:#ff79c6">OR</span> t2.b2<span style="color:#ff79c6">=</span><span style="color:#bd93f9">2</span>) 
</span></span></code></pre></td></tr></table>
</div>
</div><p>子查询展开（Subquery Unnesting）<br>
又称子查询反嵌套，又称为子查询上拉。把一些子查询置于外层的父查询中，作为连接关系与外层父查询并列</p>
<ul>
<li>如果子查询包含了：聚集、GROUPBY、DISTINCT子句，则子查询只能单独求解，不可以上拉到上层</li>
<li>如果子查询只是一个简单格式（SPJ格式）的查询语句，则可以上拉到上层</li>
</ul>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> t1, (<span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> t2 <span style="color:#ff79c6">WHERE</span> t2.a2 <span style="color:#ff79c6">&gt;</span><span style="color:#bd93f9">10</span>) v_t2 
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">WHERE</span> t1.a1<span style="color:#ff79c6">&lt;</span><span style="color:#bd93f9">10</span> <span style="color:#ff79c6">AND</span> v_t2.a2<span style="color:#ff79c6">&lt;</span><span style="color:#bd93f9">20</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p>可优化为：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> t1, t2 <span style="color:#ff79c6">WHERE</span> t1.a1<span style="color:#ff79c6">&lt;</span><span style="color:#bd93f9">10</span> <span style="color:#ff79c6">AND</span> t2.a2<span style="color:#ff79c6">&lt;</span><span style="color:#bd93f9">20</span> <span style="color:#ff79c6">AND</span> t2.a2 <span style="color:#ff79c6">&gt;</span><span style="color:#bd93f9">10</span>; 
</span></span></code></pre></td></tr></table>
</div>
</div><p>查询展开的具体步骤如下：</p>
<ol>
<li>将子查询和上层查询的FROM子句连接为同一个FROM子句，并且修改相应的运行参数。</li>
<li>将子查询的谓词符号进行相应修改（如：IN修改为=ANY）。</li>
<li>将子查询的WHERE条件作为一个整体与上层查询的WHERE条件合并，并用AND条件连接词连接，从而保证新生成的谓词与原谓词的上下文意思相同，且成为一个整体</li>
</ol>
<p>IN 子查询优化，将外层的条件 下推到内层，然后将 IN 改为 EXIST<br>
EXIST 可以被： 半连接算法实现优化</p>
<h2 id="spark中的查询分类">Spark中的查询分类</h2>
<p>Spark 中根据查询结果的 子查询分类</p>
<ul>
<li>OneRowSubquery，在 OptimizeOneRowRelationSubquery 中</li>
<li>LateralSubquery，多行多列</li>
<li>ScalarSubquery，一行一列</li>
</ul>
<h2 id="optimzesubqueries">OptimzeSubqueries</h2>
<p>OptimzeSubqueries 这个优化规则，目前只包含了一个场景，将子查询上面的 sort 去掉了<br>
这个规则值做这么一个简单的事情，由其他规则负责将 sub-queries 转为 join</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>    <span style="color:#ff79c6">private</span> <span style="color:#ff79c6">def</span> removeTopLevelSort<span style="color:#ff79c6">(</span>plan<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">LogicalPlan</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">LogicalPlan</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(!</span>plan<span style="color:#ff79c6">.</span>containsPattern<span style="color:#ff79c6">(</span><span style="color:#50fa7b">SORT</span><span style="color:#ff79c6">))</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> plan
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>      plan <span style="color:#ff79c6">match</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">case</span> <span style="color:#50fa7b">Sort</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">_</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">_</span><span style="color:#ff79c6">,</span> child<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">=&gt;</span> child
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">case</span> <span style="color:#50fa7b">Project</span><span style="color:#ff79c6">(</span>fields<span style="color:#ff79c6">,</span> child<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">=&gt;</span> <span style="color:#50fa7b">Project</span><span style="color:#ff79c6">(</span>fields<span style="color:#ff79c6">,</span> removeTopLevelSort<span style="color:#ff79c6">(</span>child<span style="color:#ff79c6">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">case</span> other <span style="color:#ff79c6">=&gt;</span> other
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">}</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><p>SQL语句如下：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-SQL" data-lang="SQL"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> id,
</span></span><span style="display:flex;"><span>          customer_id,
</span></span><span style="display:flex;"><span>         ( <span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">MAX</span>(item_price)
</span></span><span style="display:flex;"><span>               <span style="color:#ff79c6">FROM</span> item
</span></span><span style="display:flex;"><span>               <span style="color:#ff79c6">WHERE</span> item.order_id <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">order</span>.id
</span></span><span style="display:flex;"><span>               <span style="color:#ff79c6">ORDER</span> <span style="color:#ff79c6">BY</span> <span style="color:#ff79c6">MAX</span>(item_price)
</span></span><span style="display:flex;"><span>         ) <span style="color:#ff79c6">AS</span> max_item_price
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">FROM</span> <span style="color:#ff79c6">order</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>
        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/10/7bcJi7.png">
            <img class="mx-auto" alt="" src="https://v1.ax1x.com/2024/05/10/7bcJi7.png" />
        </a>
    <br>

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/10/7bcCOa.png">
            <img class="mx-auto" alt="" src="https://v1.ax1x.com/2024/05/10/7bcCOa.png" />
        </a>
    </p>
<h2 id="pullupcorrelatedpredicates">PullupCorrelatedPredicates</h2>
<p>PullupCorrelatedPredicates 优化规则实现如下  <br>
SQL如下：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> id, customer_id, order_name
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">FROM</span> <span style="color:#ff79c6">order</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">WHERE</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">MAX</span>(item_price) <span style="color:#ff79c6">AS</span> max_item_price
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">FROM</span> item
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">WHERE</span> item.order_id <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">order</span>.id
</span></span><span style="display:flex;"><span>) <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">100</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里还使用了 RewriteCorrelatedScalarSubquery ，将子查询改写为 join<br>
优化后，Filter(order_id = outer(id))，这个被优化成 join 条件了，也就是把相关 子查询中的 谓词给 上提了<br>

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/10/7bcnVV.png">
            <img class="mx-auto" alt="" src="https://v1.ax1x.com/2024/05/10/7bcnVV.png" />
        </a>
    <br>

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/10/7bcjlI.png">
            <img class="mx-auto" alt="" src="https://v1.ax1x.com/2024/05/10/7bcjlI.png" />
        </a>
    </p>
<p>注意，这个规则，以及类似的其他规则，只是做了一部分优化，后面会有其他规则继续做优化，最终看到的结果，是多个优化规则叠加完成的 <br>
这个规则执行前，t1 是内表</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> t2.id <span style="color:#ff79c6">FROM</span> t2 <span style="color:#ff79c6">WHERE</span> t2.id <span style="color:#ff79c6">IN</span>
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">SELECT</span> t1.id <span style="color:#ff79c6">FROM</span> t1 <span style="color:#ff79c6">WHERE</span> t1.id <span style="color:#ff79c6">=</span> t2.id
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>生成的逻辑规则是这样：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>id<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">int</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Filter</span> id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">1</span> <span style="color:#50fa7b">IN</span> <span style="color:#ff79c6">(</span>list<span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">])</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">:</span>  <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>3<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">:</span>     <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">Filter</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>3 <span style="color:#ff79c6">=</span> <span style="color:#8be9fd">outer</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">))</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">:</span>        <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">SubqueryAlias</span> <span style="color:#8be9fd">t1</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">:</span>           <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>3, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>4<span style="color:#ff79c6">]</span> t1
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">SubqueryAlias</span> t2
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>1, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>2<span style="color:#ff79c6">]</span>  t2
</span></span></code></pre></td></tr></table>
</div>
</div><p>下面的这个是优化的中间结果：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Filter</span> id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">1</span> <span style="color:#50fa7b">IN</span> <span style="color:#ff79c6">(</span>list<span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>1 <span style="color:#8be9fd">&amp;&amp;</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>3 <span style="color:#8be9fd">=</span> <span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">)])</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">:</span>  <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>3<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">:</span>     <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>3, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>4<span style="color:#ff79c6">]</span>  t1
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>1, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>2<span style="color:#ff79c6">]</span>  t2
</span></span></code></pre></td></tr></table>
</div>
</div><p>也就是只是将 子查询的条件 上提了，转成 JOIN 是后面的规则做的</p>
<h2 id="rewritepredicatesubquery">RewritePredicateSubquery</h2>
<p>RewritePredicateSubquery 这个规则将谓词子查询重写为left semi/anti join。支持以下谓词：</p>
<ul>
<li>EXISTS/NOT EXISTS将被重写为semi/anti join，Filter中未解析的条件将被提取为join条件</li>
<li>IN/NOT IN将被重写为semi/anti join，Filter中未解析的条件将作为join条件被拉出，value=selected列也将用作join条件</li>
</ul>
<p>两个表，结构一样，包含 id(int)， sname(varchar)</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> id, sname <span style="color:#ff79c6">FROM</span> t1 <span style="color:#ff79c6">WHERE</span> id <span style="color:#ff79c6">IN</span>
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">SELECT</span> id <span style="color:#ff79c6">FROM</span> p1 <span style="color:#ff79c6">WHERE</span> id <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">10</span>
</span></span><span style="display:flex;"><span>) <span style="color:#ff79c6">AND</span> id <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">999</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>逻辑计划：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Analyzed</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span>id<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">bigint</span><span style="color:#ff79c6">,</span> sname<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">string</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>118<span style="color:#8be9fd">L</span>, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>119<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Filter</span> <span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">118L</span> <span style="color:#50fa7b">IN</span> <span style="color:#ff79c6">(</span>list<span style="color:#ff79c6">#</span><span style="color:#bd93f9">142</span> <span style="color:#ff79c6">[])</span> <span style="color:#50fa7b">AND</span> <span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">118L</span> <span style="color:#ff79c6">&gt;</span> cast<span style="color:#ff79c6">(</span><span style="color:#bd93f9">999</span> as bigint<span style="color:#ff79c6">)))</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">:</span>  <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>15<span style="color:#8be9fd">L</span><span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">:</span>     <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">Filter</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>15<span style="color:#8be9fd">L</span> <span style="color:#8be9fd">&lt;</span> <span style="color:#8be9fd">cast</span><span style="color:#ff79c6">(</span>10 <span style="color:#8be9fd">as</span> <span style="color:#8be9fd">bigint</span><span style="color:#ff79c6">))</span>
</span></span><span style="display:flex;"><span>   <span style="color:#8be9fd">:</span>        <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">SubqueryAlias</span> <span style="color:#8be9fd">p1</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">:</span>           <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">View</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">`p1`</span><span style="color:#ff79c6">,</span> [<span style="color:#8be9fd">age</span><span style="color:#ff79c6">#</span>14<span style="color:#8be9fd">L</span><span style="color:#ff79c6">,</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">15L</span><span style="color:#ff79c6">,</span>sname<span style="color:#ff79c6">#</span><span style="color:#bd93f9">16</span>]<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">:</span>              <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">Relation</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">age</span><span style="color:#ff79c6">#</span>14<span style="color:#8be9fd">L</span>,<span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>15<span style="color:#8be9fd">L</span>,<span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>16<span style="color:#ff79c6">]</span> json
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">SubqueryAlias</span> t1
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">View</span> <span style="color:#ff79c6">(</span>`t1`<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">age</span><span style="color:#ff79c6">#</span>117<span style="color:#8be9fd">L</span>,<span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>118<span style="color:#8be9fd">L</span>,<span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>119<span style="color:#ff79c6">])</span>
</span></span><span style="display:flex;"><span>         <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Relation</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">age</span><span style="color:#ff79c6">#</span>117<span style="color:#8be9fd">L</span>,<span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>118<span style="color:#8be9fd">L</span>,<span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>119<span style="color:#ff79c6">]</span> json
</span></span></code></pre></td></tr></table>
</div>
</div><p>期间会有一个中间步骤的优化，大致相当于</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>118<span style="color:#8be9fd">L</span>, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>119<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Filter</span> <span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">118L</span> <span style="color:#50fa7b">IN</span> <span style="color:#ff79c6">(</span>list<span style="color:#ff79c6">#</span><span style="color:#bd93f9">142</span> <span style="color:#ff79c6">[])</span> <span style="color:#50fa7b">AND</span> <span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">118L</span> <span style="color:#ff79c6">&gt;</span> cast<span style="color:#ff79c6">(</span><span style="color:#bd93f9">999</span> as bigint<span style="color:#ff79c6">)))</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">:</span>  <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>15<span style="color:#8be9fd">L</span><span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">:</span>     <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">Filter</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>15<span style="color:#8be9fd">L</span> <span style="color:#8be9fd">&lt;</span> <span style="color:#8be9fd">cast</span><span style="color:#ff79c6">(</span>10 <span style="color:#8be9fd">as</span> <span style="color:#8be9fd">bigint</span><span style="color:#ff79c6">))</span>
</span></span><span style="display:flex;"><span>   <span style="color:#8be9fd">:</span>              <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">Relation</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">age</span><span style="color:#ff79c6">#</span>14<span style="color:#8be9fd">L</span>,<span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>15<span style="color:#8be9fd">L</span>,<span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>16<span style="color:#ff79c6">]</span> json
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Relation</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">age</span><span style="color:#ff79c6">#</span>117<span style="color:#8be9fd">L</span>,<span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>118<span style="color:#8be9fd">L</span>,<span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>119<span style="color:#ff79c6">]</span> json
</span></span></code></pre></td></tr></table>
</div>
</div><p>执行规则，这里用 IN 来 举例</p>
<ol>
<li>跟 IN 拆分 条件，IN 里面的是子查询，跟 IN 同级的是 普通查询的条件</li>
<li>将普通查询条件 用 AND 做连接，变成新条件</li>
<li>子查询做投影过滤，去掉不需要的列</li>
<li>根据外层 plan，新的 plan，获取 join 的ON 条件</li>
<li>新条件跟 原外层 plan合并，变成新 outerPlan</li>
<li>用 outerPlan，innerPlan(子查询变换的)，ON 条件，LeftSemi，组合成 JOIN 逻辑计划</li>
<li>如果是 NOT，则 JOIN 类型为 LeftAnti，也就是：左边中没有跟右表匹配的所有行</li>
</ol>
<p>优化后的：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Optimized</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">Join</span> <span style="color:#50fa7b">LeftSemi</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">118L</span> <span style="color:#ff79c6">=</span> id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">15L</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">:</span><span style="color:#8be9fd">-</span> <span style="color:#8be9fd">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>118<span style="color:#8be9fd">L</span>, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>119<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">:</span>  <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">Filter</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">isnotnull</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>118<span style="color:#8be9fd">L</span><span style="color:#ff79c6">)</span> <span style="color:#8be9fd">AND</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>118<span style="color:#8be9fd">L</span> <span style="color:#8be9fd">&gt;</span> 999<span style="color:#ff79c6">))</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">:</span>     <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">Relation</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">age</span><span style="color:#ff79c6">#</span>117<span style="color:#8be9fd">L</span>,<span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>118<span style="color:#8be9fd">L</span>,<span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>119<span style="color:#ff79c6">]</span> json
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>15<span style="color:#8be9fd">L</span><span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Filter</span> <span style="color:#ff79c6">(</span>isnotnull<span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">15L</span><span style="color:#ff79c6">)</span> <span style="color:#50fa7b">AND</span> <span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">15L</span> <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">10</span><span style="color:#ff79c6">))</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Relation</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">age</span><span style="color:#ff79c6">#</span>14<span style="color:#8be9fd">L</span>,<span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>15<span style="color:#8be9fd">L</span>,<span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>16<span style="color:#ff79c6">]</span> json
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="其他一些情况">其他一些情况</h2>
<p>带常数，无关子查询的 SQL</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> t1.<span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> t1 <span style="color:#ff79c6">WHERE</span> <span style="color:#bd93f9">10</span> <span style="color:#ff79c6">IN</span>
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">SELECT</span> t2.id <span style="color:#ff79c6">FROM</span> t2
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>优化后的，这里使用的是 Spark3.5</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Analyzed</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span>id<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">int</span><span style="color:#ff79c6">,</span> sname<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">string</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>1, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>2<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Filter</span> <span style="color:#bd93f9">10</span> <span style="color:#50fa7b">IN</span> <span style="color:#ff79c6">(</span>list<span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span> <span style="color:#ff79c6">[])</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">:</span>  <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>3<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">:</span>     <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">SubqueryAlias</span> <span style="color:#8be9fd">t2</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">:</span>        <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>3, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>4<span style="color:#ff79c6">]</span> t2
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">SubqueryAlias</span> t1
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>1, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>2<span style="color:#ff79c6">]</span> t1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Optimized</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">Join</span> <span style="color:#50fa7b">LeftSemi</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">:</span><span style="color:#8be9fd">-</span> <span style="color:#8be9fd">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>1, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>2<span style="color:#ff79c6">]</span> t1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">LocalLimit</span> <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Project</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Filter</span> <span style="color:#ff79c6">(</span><span style="color:#bd93f9">10</span> <span style="color:#ff79c6">=</span> id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">3</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>         <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>3<span style="color:#ff79c6">]</span> t2
</span></span></code></pre></td></tr></table>
</div>
</div><p>带随机值的SQL：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> t1.id <span style="color:#ff79c6">FROM</span>  t1 <span style="color:#ff79c6">WHERE</span> t1.id <span style="color:#ff79c6">+</span> RAND() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">10</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">IN</span>
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>     <span style="color:#ff79c6">SELECT</span> t2.id <span style="color:#ff79c6">FROM</span> t2
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>优化后的：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Analyzed</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span>id<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">int</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Filter</span> <span style="color:#ff79c6">(</span>cast<span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">1</span> as double<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">+</span> <span style="color:#ff79c6">(</span>rand<span style="color:#ff79c6">(</span><span style="color:#bd93f9">2079373737972317466</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">*</span> cast<span style="color:#ff79c6">(</span><span style="color:#bd93f9">10</span> as double<span style="color:#ff79c6">)))</span> <span style="color:#50fa7b">IN</span> <span style="color:#ff79c6">(</span>list<span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span> <span style="color:#ff79c6">[])</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">:</span>  <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">cast</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>3 <span style="color:#8be9fd">as</span> <span style="color:#8be9fd">double</span><span style="color:#ff79c6">)</span> <span style="color:#8be9fd">AS</span> <span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>5<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">:</span>     <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>3<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">:</span>        <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">SubqueryAlias</span> <span style="color:#8be9fd">t2</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">:</span>           <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>3, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>4<span style="color:#ff79c6">]</span> t2
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">SubqueryAlias</span> t1
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>1, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>2<span style="color:#ff79c6">]</span> t1 t1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Optimized</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">Join</span> <span style="color:#50fa7b">LeftSemi</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span>knownfloatingpointnormalized<span style="color:#ff79c6">(</span>normalizenanandzero<span style="color:#ff79c6">((</span>cast<span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">1</span> as double<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">+</span> <span style="color:#ff79c6">(</span>rand<span style="color:#ff79c6">(</span><span style="color:#bd93f9">2079373737972317466</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">10.0</span><span style="color:#ff79c6">))))</span> 
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">=</span> knownfloatingpointnormalized<span style="color:#ff79c6">(</span>normalizenanandzero<span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">5</span><span style="color:#ff79c6">)))</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">:</span><span style="color:#8be9fd">-</span> <span style="color:#8be9fd">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span> t1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">cast</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>3 <span style="color:#8be9fd">as</span> <span style="color:#8be9fd">double</span><span style="color:#ff79c6">)</span> <span style="color:#8be9fd">AS</span> <span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>5<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>3<span style="color:#ff79c6">]</span> t2
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="算子合并">算子合并</h1>
<h2 id="collapserepartition">CollapseRepartition</h2>
<p>合并相邻的RepartitionOperation和RebalancePartitions运算符</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>    <span style="color:#ff79c6">var</span> df <span style="color:#ff79c6">=</span> spark<span style="color:#ff79c6">.</span>range<span style="color:#ff79c6">(</span><span style="color:#bd93f9">1</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">100</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">1</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>    df <span style="color:#ff79c6">=</span> df<span style="color:#ff79c6">.</span>repartition<span style="color:#ff79c6">(</span><span style="color:#bd93f9">5</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>    df <span style="color:#ff79c6">=</span> df<span style="color:#ff79c6">.</span>coalesce<span style="color:#ff79c6">(</span><span style="color:#bd93f9">10</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>    df<span style="color:#ff79c6">.</span>explain<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;extended&#34;</span><span style="color:#ff79c6">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>逻辑计划：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Analyzed</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span>id<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">bigint</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">Repartition</span> <span style="color:#bd93f9">10</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Repartition</span> <span style="color:#bd93f9">5</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Range</span> <span style="color:#ff79c6">(</span><span style="color:#bd93f9">1</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">100</span><span style="color:#ff79c6">,</span> step<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span><span style="color:#ff79c6">,</span> splits<span style="color:#ff79c6">=</span><span style="color:#50fa7b">Some</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">8</span><span style="color:#ff79c6">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>优化后</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Optimized</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">Repartition</span> <span style="color:#bd93f9">5</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Range</span> <span style="color:#ff79c6">(</span><span style="color:#bd93f9">1</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">100</span><span style="color:#ff79c6">,</span> step<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span><span style="color:#ff79c6">,</span> splits<span style="color:#ff79c6">=</span><span style="color:#50fa7b">Some</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">8</span><span style="color:#ff79c6">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<p>如果 repartition 比 coalesce 更大，则不合并</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>    <span style="color:#ff79c6">var</span> df <span style="color:#ff79c6">=</span> spark<span style="color:#ff79c6">.</span>range<span style="color:#ff79c6">(</span><span style="color:#bd93f9">1</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">100</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">1</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>    df <span style="color:#ff79c6">=</span> df<span style="color:#ff79c6">.</span>repartition<span style="color:#ff79c6">(</span><span style="color:#bd93f9">10</span><span style="color:#ff79c6">).</span>coalesce<span style="color:#ff79c6">(</span><span style="color:#bd93f9">5</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>    df<span style="color:#ff79c6">.</span>explain<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;extended&#34;</span><span style="color:#ff79c6">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>逻辑和优化计划</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Analyzed</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span>id<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">bigint</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">Repartition</span> <span style="color:#bd93f9">5</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Repartition</span> <span style="color:#bd93f9">10</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Range</span> <span style="color:#ff79c6">(</span><span style="color:#bd93f9">1</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">100</span><span style="color:#ff79c6">,</span> step<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span><span style="color:#ff79c6">,</span> splits<span style="color:#ff79c6">=</span><span style="color:#50fa7b">Some</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">8</span><span style="color:#ff79c6">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Optimized</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">Repartition</span> <span style="color:#bd93f9">5</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Repartition</span> <span style="color:#bd93f9">10</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Range</span> <span style="color:#ff79c6">(</span><span style="color:#bd93f9">1</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">100</span><span style="color:#ff79c6">,</span> step<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span><span style="color:#ff79c6">,</span> splits<span style="color:#ff79c6">=</span><span style="color:#50fa7b">Some</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">8</span><span style="color:#ff79c6">))</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="collapseproject">CollapseProject</h2>
<p>两个Project运算符合并为一个别名替换，在以下情况下，将表达式合并为一个表达式</p>
<ol>
<li>两个Project运算符相邻时。</li>
<li>当两个Project运算符之间有LocalLimit/Sample/Repartition运算符，且上层的Project由相同数量的列组成，且列数相等或具有别名时。同时也考虑到GlobalLimit(LocalLimit)模式</li>
</ol>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> col_1 <span style="color:#ff79c6">FROM</span>
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">SELECT</span> <span style="color:#bd93f9">1</span> <span style="color:#ff79c6">as</span> col_1, <span style="color:#bd93f9">2</span> <span style="color:#ff79c6">as</span> col_2
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>逻辑计划</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Analyzed</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span>col_1<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">int</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">col_1</span><span style="color:#ff79c6">#</span>0<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">SubqueryAlias</span> <span style="color:#50fa7b">__auto_generated_subquery_name</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span>1 <span style="color:#8be9fd">AS</span> <span style="color:#8be9fd">col_1</span><span style="color:#ff79c6">#</span>0, 2 <span style="color:#8be9fd">AS</span> <span style="color:#8be9fd">col_2</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">OneRowRelation</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>优化后的</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Optimized</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span>1 <span style="color:#8be9fd">AS</span> <span style="color:#8be9fd">col_1</span><span style="color:#ff79c6">#</span>0<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">OneRowRelation</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="combinefilters">CombineFilters</h2>
<p>将两个相邻的Filter运算符合并为一个，将非冗余条件合并为一个连接谓词</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>    <span style="color:#ff79c6">var</span> df <span style="color:#ff79c6">=</span> spark<span style="color:#ff79c6">.</span>sql<span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f1fa8c">s&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        |SELECT id, sname FROM </span><span style="color:#f1fa8c">$mysqlName</span><span style="color:#f1fa8c">.</span><span style="color:#f1fa8c">$mysqlDB</span><span style="color:#f1fa8c">.t1
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        |&#34;&#34;&#34;</span><span style="color:#ff79c6">.</span>stripMargin<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>    df <span style="color:#ff79c6">=</span> df<span style="color:#ff79c6">.</span>filter<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;id &gt; 10&#34;</span><span style="color:#ff79c6">).</span>filter<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;id &lt; 999&#34;</span><span style="color:#ff79c6">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>逻辑计划</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Analyzed</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span>id<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">int</span><span style="color:#ff79c6">,</span> sname<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">string</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">Filter</span> <span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span> <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">999</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Filter</span> <span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span> <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">10</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">SubqueryAlias</span> my_catalog<span style="color:#ff79c6">.</span>mysql57<span style="color:#ff79c6">.</span>hello<span style="color:#ff79c6">.</span>t1
</span></span><span style="display:flex;"><span>         <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span> my_catalog<span style="color:#ff79c6">.</span>mysql57<span style="color:#ff79c6">.</span>hello<span style="color:#ff79c6">.</span>t1 t1
</span></span></code></pre></td></tr></table>
</div>
</div><p>中间结果</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#50fa7b">Filter</span> <span style="color:#ff79c6">((</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span> <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">10</span><span style="color:#ff79c6">)</span> <span style="color:#50fa7b">AND</span> <span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span> <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">999</span><span style="color:#ff79c6">))</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span> my_catalog<span style="color:#ff79c6">.</span>mysql57<span style="color:#ff79c6">.</span>hello<span style="color:#ff79c6">.</span>t1 t1
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="combineunions">CombineUnions</h2>
<p>将所有相邻的Union运算符合并为一个</p>
<p>逻辑计划</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Analyzed</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span>id<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">int</span><span style="color:#ff79c6">,</span> sname<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">string</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">Distinct</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Union</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">:</span><span style="color:#8be9fd">-</span> <span style="color:#8be9fd">Distinct</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">:</span>  <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">Union</span> <span style="color:#8be9fd">false</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">:</span>     <span style="color:#8be9fd">:-</span> <span style="color:#8be9fd">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">:</span>     <span style="color:#8be9fd">:</span>  <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">Filter</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0 <span style="color:#8be9fd">&lt;</span> 10<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#8be9fd">:</span>     <span style="color:#8be9fd">:</span>     <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">SubqueryAlias</span> <span style="color:#8be9fd">t1</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">:</span>     <span style="color:#8be9fd">:</span>        <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span>  t1
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">:</span>     <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>2, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>3<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">:</span>        <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">Filter</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>2 <span style="color:#8be9fd">&gt;</span> 100<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#8be9fd">:</span>           <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">SubqueryAlias</span> <span style="color:#8be9fd">t1</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">:</span>              <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>2, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>3<span style="color:#ff79c6">]</span>  t1
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>4, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>5<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Filter</span> <span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">4</span> <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">999</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>         <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">SubqueryAlias</span> t2
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>4, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>5<span style="color:#ff79c6">]</span>  t2
</span></span></code></pre></td></tr></table>
</div>
</div><p>优化的中间结果</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#50fa7b">Aggregate</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">],</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Union</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">:</span><span style="color:#8be9fd">-</span> <span style="color:#8be9fd">Filter</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0 <span style="color:#8be9fd">&lt;</span> 10<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">:</span>  <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span>  t1
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">:</span><span style="color:#8be9fd">-</span> <span style="color:#8be9fd">Filter</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>2 <span style="color:#8be9fd">&gt;</span> 100<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">:</span>  <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>2, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>3<span style="color:#ff79c6">]</span>  t1
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Filter</span> <span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">4</span> <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">999</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>     <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>4, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>5<span style="color:#ff79c6">]</span>  t2
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="其他">其他</h2>
<p>OptimizeWindowFunctions</p>
<ul>
<li>将first(col)替换成nth_value(col, 1)来获得更好的性能</li>
</ul>
<p>CollapseWindow</p>
<ul>
<li>折叠相邻的Window表达式</li>
<li>如果分区规格和顺序规格相同，并且窗口表达式是独立的，且属于相同的窗口函数类型，则折叠到父节点中</li>
</ul>
<h1 id="常量折叠和强度消减">常量折叠和强度消减</h1>
<p>在编译器构建中，强度消减（strength reduction）是一种编译器优化</p>
<ul>
<li>其中昂贵的操作被等效但成本较低的操作所取代</li>
<li>强度降低的经典例子将循环中的“强”乘法转换为“弱”加法——这是数组寻址中经常出现的情况</li>
<li>强度消减的例子包括：用加法替换循环中的乘法、用乘法替换循环中的指数</li>
</ul>
<h2 id="nullpropagation">NullPropagation</h2>
<p>Replaces Expressions that can be statically evaluated with equivalent Literal values. <br>
This rule is more specific with Null value propagation from bottom to top of the expression tree.</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">count</span>(id<span style="color:#ff79c6">=</span><span style="color:#ff79c6">NULL</span>) <span style="color:#ff79c6">FROM</span> t1
</span></span></code></pre></td></tr></table>
</div>
</div><p>逻辑计划</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Analyzed</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span>count<span style="color:#ff79c6">((</span>id <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">NULL</span><span style="color:#ff79c6">))</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">bigint</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">Aggregate</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">count</span><span style="color:#ff79c6">((</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0 <span style="color:#8be9fd">=</span> <span style="color:#8be9fd">cast</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">null</span> <span style="color:#8be9fd">as</span> <span style="color:#8be9fd">int</span><span style="color:#ff79c6">)))</span> <span style="color:#8be9fd">AS</span> <span style="color:#8be9fd">count</span><span style="color:#ff79c6">((</span><span style="color:#8be9fd">id</span> <span style="color:#8be9fd">=</span> <span style="color:#8be9fd">NULL</span><span style="color:#ff79c6">))</span><span style="color:#ff79c6">#</span>3<span style="color:#8be9fd">L</span><span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">SubqueryAlias</span> t1
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span> t1
</span></span></code></pre></td></tr></table>
</div>
</div><p>中间结果</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#50fa7b">Aggregate</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">cast</span><span style="color:#ff79c6">(</span>0 <span style="color:#8be9fd">as</span> <span style="color:#8be9fd">bigint</span><span style="color:#ff79c6">)</span> <span style="color:#8be9fd">AS</span> <span style="color:#8be9fd">count</span><span style="color:#ff79c6">((</span><span style="color:#8be9fd">id</span> <span style="color:#8be9fd">=</span> <span style="color:#8be9fd">NULL</span><span style="color:#ff79c6">))</span><span style="color:#ff79c6">#</span>3<span style="color:#8be9fd">L</span><span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span> t1
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="constantpropagation">ConstantPropagation</h2>
<p>用连接表达式中的相应值替换可以静态计算的属性</p>
<ul>
<li>例如：SELECT * FROM table WHERE i = 5 AND j = i + 3</li>
<li>可以替换为： ==&gt; SELECT * FROM table WHERE i = 5 AND j = 8</li>
<li>使用的方法：通过查看所有相等的谓词来填充属性 =&gt; 常量值的映射；</li>
<li>使用这个映射，将属性的出现的地方替换为AND节点中相应的常量值</li>
</ul>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">*</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">FROM</span> t3 <span style="color:#ff79c6">WHERE</span> id <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">10</span> <span style="color:#ff79c6">AND</span> sid <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">100</span> <span style="color:#ff79c6">+</span> id
</span></span></code></pre></td></tr></table>
</div>
</div><p>逻辑计划：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Analyzed</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span>id<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">int</span><span style="color:#ff79c6">,</span> sid<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">int</span><span style="color:#ff79c6">,</span> sname<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">string</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0, <span style="color:#8be9fd">sid</span><span style="color:#ff79c6">#</span>1, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>2<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Filter</span> <span style="color:#ff79c6">((</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span> <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">10</span><span style="color:#ff79c6">)</span> <span style="color:#50fa7b">AND</span> <span style="color:#ff79c6">(</span>sid<span style="color:#ff79c6">#</span><span style="color:#bd93f9">1</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span><span style="color:#bd93f9">100</span> <span style="color:#ff79c6">+</span> id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span><span style="color:#ff79c6">)))</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">SubqueryAlias</span> t3
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0, <span style="color:#8be9fd">sid</span><span style="color:#ff79c6">#</span>1, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>2<span style="color:#ff79c6">]</span>  t3
</span></span></code></pre></td></tr></table>
</div>
</div><p>中间结果</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#50fa7b">Filter</span> <span style="color:#ff79c6">((</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span> <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">10</span><span style="color:#ff79c6">)</span> <span style="color:#50fa7b">AND</span> <span style="color:#ff79c6">(</span>sid<span style="color:#ff79c6">#</span><span style="color:#bd93f9">1</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span><span style="color:#bd93f9">100</span> <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">10</span><span style="color:#ff79c6">)))</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0, <span style="color:#8be9fd">sid</span><span style="color:#ff79c6">#</span>1, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>2<span style="color:#ff79c6">]</span>  t3
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="optimizein">OptimizeIn</h2>
<p>优化IN谓词</p>
<ul>
<li>当列表为空且值不可为null时，将谓词转换为false</li>
<li>删除文本值重复</li>
<li>将In (value, seq[Literal])替换为更快的优化版本InSet (value, HashSet[Literal])</li>
</ul>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> t1
</span></span><span style="display:flex;"><span> <span style="color:#ff79c6">WHERE</span> id <span style="color:#ff79c6">IN</span> (<span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">1</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>逻辑计划：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Analyzed</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span>id<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">int</span><span style="color:#ff79c6">,</span> sname<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">string</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Filter</span> id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span> <span style="color:#50fa7b">IN</span> <span style="color:#ff79c6">(</span><span style="color:#bd93f9">1</span><span style="color:#ff79c6">,</span><span style="color:#bd93f9">2</span><span style="color:#ff79c6">,</span><span style="color:#bd93f9">1</span><span style="color:#ff79c6">,</span><span style="color:#bd93f9">1</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">SubqueryAlias</span> t1
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span>  t1
</span></span></code></pre></td></tr></table>
</div>
</div><p>优化的中间结果</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#50fa7b">Filter</span> id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span> <span style="color:#50fa7b">IN</span> <span style="color:#ff79c6">(</span><span style="color:#bd93f9">1</span><span style="color:#ff79c6">,</span><span style="color:#bd93f9">2</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span>  t1
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<p>如果 IN 中的条件太多，超过阈值，<code>spark.sql.optimizer.inSetConversionThreshold</code>则 改用 insert</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> t1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">WHERE</span> id <span style="color:#ff79c6">IN</span> (<span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">3</span>,<span style="color:#bd93f9">4</span>,<span style="color:#bd93f9">5</span>,<span style="color:#bd93f9">6</span>,<span style="color:#bd93f9">7</span>,<span style="color:#bd93f9">8</span>,<span style="color:#bd93f9">9</span>,<span style="color:#bd93f9">10</span>,<span style="color:#bd93f9">11</span>,<span style="color:#bd93f9">12</span>,<span style="color:#bd93f9">13</span>,<span style="color:#bd93f9">14</span>,<span style="color:#bd93f9">15</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>逻辑计划：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Analyzed</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span>id<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">int</span><span style="color:#ff79c6">,</span> sname<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">string</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Filter</span> id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span> <span style="color:#50fa7b">IN</span> <span style="color:#ff79c6">(</span><span style="color:#bd93f9">1</span><span style="color:#ff79c6">,</span><span style="color:#bd93f9">2</span><span style="color:#ff79c6">,</span><span style="color:#bd93f9">3</span><span style="color:#ff79c6">,</span><span style="color:#bd93f9">4</span><span style="color:#ff79c6">,</span><span style="color:#bd93f9">5</span><span style="color:#ff79c6">,</span><span style="color:#bd93f9">6</span><span style="color:#ff79c6">,</span><span style="color:#bd93f9">7</span><span style="color:#ff79c6">,</span><span style="color:#bd93f9">8</span><span style="color:#ff79c6">,</span><span style="color:#bd93f9">9</span><span style="color:#ff79c6">,</span><span style="color:#bd93f9">10</span><span style="color:#ff79c6">,</span><span style="color:#bd93f9">11</span><span style="color:#ff79c6">,</span><span style="color:#bd93f9">12</span><span style="color:#ff79c6">,</span><span style="color:#bd93f9">13</span><span style="color:#ff79c6">,</span><span style="color:#bd93f9">14</span><span style="color:#ff79c6">,</span><span style="color:#bd93f9">15</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">SubqueryAlias</span> t1
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span>  t1
</span></span></code></pre></td></tr></table>
</div>
</div><p>中间结果：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#50fa7b">Filter</span> id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span> <span style="color:#50fa7b">INSET</span> <span style="color:#bd93f9">1</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">10</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">11</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">12</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">13</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">14</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">15</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">2</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">3</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">4</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">5</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">6</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">7</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">8</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">9</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span>  t1
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="constantfolding">ConstantFolding</h2>
<p>替换可以用等效文本值静态计算的表达式 <br>
The following conditions are used to determine suitability for constant folding:</p>
<ul>
<li>A Coalesce is foldable if all of its children are foldable</li>
<li>A BinaryExpression is foldable if its both left and right child are foldable</li>
<li>A Not, IsNull, or IsNotNull is foldable if its child is foldable</li>
<li>A Literal is foldable</li>
<li>A Cast or UnaryMinus is foldable if its child is foldable</li>
</ul>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">replace</span>(<span style="color:#f1fa8c">&#39;123456&#39;</span>, <span style="color:#f1fa8c">&#39;123&#39;</span>, <span style="color:#f1fa8c">&#39;abc&#39;</span>) <span style="color:#ff79c6">AS</span> r
</span></span></code></pre></td></tr></table>
</div>
</div><p>逻辑计划：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Analyzed</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span>r<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">string</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">replace</span><span style="color:#ff79c6">(</span>123456, 123, <span style="color:#8be9fd">abc</span><span style="color:#ff79c6">)</span> <span style="color:#8be9fd">AS</span> <span style="color:#8be9fd">r</span><span style="color:#ff79c6">#</span>0<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">OneRowRelation</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>中间结果：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">abc456</span> <span style="color:#8be9fd">AS</span> <span style="color:#8be9fd">r</span><span style="color:#ff79c6">#</span>0<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">OneRowRelation</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里面用到了 StringReplace，有很多相关的类<br>

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/04/30/7KWplL.png">
            <img class="mx-auto" alt="" src="https://v1.ax1x.com/2024/04/30/7KWplL.png" />
        </a>
    </p>
<p>调用了 父类 TernaryExpression#eval()，做求值计算的</p>
<hr>
<p>另一种情况</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> <span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> (id <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">2</span>) <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">3</span> <span style="color:#ff79c6">FROM</span> $mysqlName.$mysqlDB.t1
</span></span></code></pre></td></tr></table>
</div>
</div><p>逻辑计划：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Analyzed</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">((</span><span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> <span style="color:#ff79c6">(</span>id <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">2</span><span style="color:#ff79c6">))</span> <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">3</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">int</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[((</span>1 <span style="color:#8be9fd">+</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0 <span style="color:#8be9fd">+</span> 2<span style="color:#ff79c6">))</span> <span style="color:#8be9fd">+</span> 3<span style="color:#ff79c6">)</span> <span style="color:#8be9fd">AS</span> <span style="color:#ff79c6">((</span>1 <span style="color:#8be9fd">+</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">id</span> <span style="color:#8be9fd">+</span> 2<span style="color:#ff79c6">))</span> <span style="color:#8be9fd">+</span> 3<span style="color:#ff79c6">)</span><span style="color:#ff79c6">#</span>2<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">SubqueryAlias</span> t1
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span>  t1
</span></span></code></pre></td></tr></table>
</div>
</div><p>优化后的：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Optimized</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[(</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0 <span style="color:#8be9fd">+</span> 6<span style="color:#ff79c6">)</span> <span style="color:#8be9fd">AS</span> <span style="color:#ff79c6">((</span>1 <span style="color:#8be9fd">+</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">id</span> <span style="color:#8be9fd">+</span> 2<span style="color:#ff79c6">))</span> <span style="color:#8be9fd">+</span> 3<span style="color:#ff79c6">)</span><span style="color:#ff79c6">#</span>2<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0<span style="color:#ff79c6">]</span> t1
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="replacenullwithfalseinpredicate">ReplaceNullWithFalseInPredicate</h2>
<p>一个用False Literal替换Literal(null, BooleanType) 的规则，如果可能的话，在WHERE/HAVING/ON(JOIN)子句的搜索条件中<br>
该子句包含一个隐式布尔运算符(search condition) = TRUE。当计算整个搜索条件时，只有当Literal(null, BooleanType)在语义上等同于FalseLiteral时，替换才有效 <br>
请注意，在大多数情况下，当搜索条件包含NOT和可空的表达式时，FALSE和NULL是不可交换的 <br>
因此，该规则非常保守，适用于非常有限的情况 <br>
例如</p>
<ul>
<li>Filter(Literal(null, BooleanType))等同于Filter(FalseLiteral)</li>
<li>另一个包含分支的示例是Filter(If(cond, FalseLiteral, Literal(null, _)))；</li>
<li>这可以优化为Filter(If(cond, FalseLiteral, FalseLiteral))，</li>
<li>最终Filter(FalseLiteral) -</li>
<li>此外，该规则还转换所有If表达式中的谓词，以及所有CaseWhen表达式中的分支条件，即使它们不是搜索条件的一部分</li>
<li>例如，Project(If(And(cond, Literal(null)), Literal(1), Literal(2)))可以简化为Project(Literal(2))</li>
</ul>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">IF</span>  ((( <span style="color:#bd93f9">2</span> <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">1</span>) <span style="color:#ff79c6">AND</span> <span style="color:#ff79c6">NULL</span>), <span style="color:#f1fa8c">&#39;good&#39;</span>, <span style="color:#f1fa8c">&#39;bad&#39;</span>) <span style="color:#ff79c6">AS</span> col
</span></span></code></pre></td></tr></table>
</div>
</div><p>逻辑计划和优化后的</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Analyzed</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span>col<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">string</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">if</span> <span style="color:#ff79c6">(((</span>2 <span style="color:#8be9fd">&gt;</span> 1<span style="color:#ff79c6">)</span> <span style="color:#8be9fd">AND</span> <span style="color:#8be9fd">cast</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">null</span> <span style="color:#8be9fd">as</span> <span style="color:#8be9fd">boolean</span><span style="color:#ff79c6">)))</span> <span style="color:#8be9fd">good</span> <span style="color:#8be9fd">else</span> <span style="color:#8be9fd">bad</span> <span style="color:#8be9fd">AS</span> <span style="color:#8be9fd">col</span><span style="color:#ff79c6">#</span>0<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">OneRowRelation</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Optimized</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">bad</span> <span style="color:#8be9fd">AS</span> <span style="color:#8be9fd">col</span><span style="color:#ff79c6">#</span>0<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">OneRowRelation</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="combineconcats">CombineConcats</h2>
<p>合并嵌套的Concat表达式</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> concat(<span style="color:#f1fa8c">&#34;abc&#34;</span>, concat(<span style="color:#f1fa8c">&#34;def&#34;</span>, <span style="color:#f1fa8c">&#34;ghi&#34;</span>)) <span style="color:#ff79c6">AS</span> col
</span></span></code></pre></td></tr></table>
</div>
</div><p>逻辑计划和优化后的</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Analyzed</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span>col<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">string</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">concat</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">abc</span>, <span style="color:#8be9fd">concat</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">def</span>, <span style="color:#8be9fd">ghi</span><span style="color:#ff79c6">))</span> <span style="color:#8be9fd">AS</span> <span style="color:#8be9fd">col</span><span style="color:#ff79c6">#</span>0<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">OneRowRelation</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Optimized</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">abcdefghi</span> <span style="color:#8be9fd">AS</span> <span style="color:#8be9fd">col</span><span style="color:#ff79c6">#</span>0<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">OneRowRelation</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="其他-1">其他</h2>
<p>还有很多，如</p>
<ul>
<li>TransposeWindow
<ul>
<li>转置相邻的窗口表达式。如果父窗口表达式的分区规范与子窗口表达式的分区规范兼容，就转置它们</li>
</ul>
</li>
<li>NullDownPropagation
<ul>
<li>如果输入不允许为空，则展开IsNull/IsNotNull的输入</li>
<li>例如：IsNull(Not(null)) == IsNull(null)</li>
</ul>
</li>
<li>FoldablePropagation
<ul>
<li>用原始可折叠表达式的别名替换属性。其他优化将利用传播的可折叠表达</li>
<li>如，此规则可以将SELECT 1.0 x, &lsquo;abc&rsquo; y, Now() z ORDER BY x, y, 3</li>
<li>优化成SELECT 1.0 x, &lsquo;abc&rsquo; y, Now() z ORDER BY 1.0, &lsquo;abc&rsquo;, Now()</li>
<li>其他规则可以进一步优化它，并且删除ORDER BY运算符</li>
</ul>
</li>
<li>PushFoldableIntoBranches
<ul>
<li>将可折叠表达式下推到if / case分支</li>
</ul>
</li>
<li>RemoveDispensableExpressions
<ul>
<li>移除不必要的节点</li>
</ul>
</li>
</ul>
<h1 id="算子简化">算子简化</h1>
<h2 id="likesimplification">LikeSimplification</h2>
<p>简化了不需要完整正则表达式来计算条件的LIKE表达式<br>
例如，当表达式只是检查字符串是否以给定模式开头时</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">*</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">FROM</span>  t1  <span style="color:#ff79c6">WHERE</span> sname <span style="color:#ff79c6">LIKE</span> <span style="color:#f1fa8c">&#39;%abc&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>逻辑计划：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Analyzed</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span>id<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">int</span><span style="color:#ff79c6">,</span> sname<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">string</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Filter</span> sname<span style="color:#ff79c6">#</span><span style="color:#bd93f9">1</span> <span style="color:#50fa7b">LIKE</span> <span style="color:#ff79c6">%</span>abc
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">SubqueryAlias</span> t1
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span>  t1
</span></span></code></pre></td></tr></table>
</div>
</div><p>优化的中间结果：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#50fa7b">Filter</span> <span style="color:#50fa7b">EndsWith</span><span style="color:#ff79c6">(</span>sname<span style="color:#ff79c6">#</span><span style="color:#bd93f9">1</span><span style="color:#ff79c6">,</span> abc<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span>  t1
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="booleansimplification">BooleanSimplification</h2>
<p>简化了布尔表达式：</p>
<ul>
<li>简化了答案可以在不计算双方的情况下确定的表达式</li>
<li>消除/提取共同的因子</li>
<li>合并相同的表达式</li>
<li>删除Not运算符</li>
</ul>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">*</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">FROM</span>  t1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">WHERE</span> (id <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">10</span> <span style="color:#ff79c6">AND</span> id <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">100</span>) <span style="color:#ff79c6">OR</span> id <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">10</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>
        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/10/7bcfTJ.png">
            <img class="mx-auto" alt="" src="https://v1.ax1x.com/2024/05/10/7bcfTJ.png" />
        </a>
    <br>

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/10/7bcIXL.png">
            <img class="mx-auto" alt="" src="https://v1.ax1x.com/2024/05/10/7bcIXL.png" />
        </a>
    </p>
<h2 id="simplifybinarycomparison">SimplifyBinaryComparison</h2>
<p>使用语义相等的表达式简化二进制比较</p>
<ol>
<li>用true文本值替代&lt;==&gt;；</li>
<li>如果操作数都是非空的，用true文本值替代 =， &lt;=， 和 &gt;=；</li>
<li>如果操作数都是非空的，用false文本值替代&gt;和&lt;；</li>
<li>如果有一边操作数是布尔文本值，就展开=、&lt;=&gt;</li>
</ol>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> (<span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">2</span>) <span style="color:#ff79c6">&lt;=&gt;</span> (<span style="color:#bd93f9">4</span> <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">1</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>逻辑计划和优化后的</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Analyzed</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">((</span><span style="color:#bd93f9">1</span> <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">2</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">&lt;=&gt;</span> <span style="color:#ff79c6">(</span><span style="color:#bd93f9">4</span> <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">1</span><span style="color:#ff79c6">))</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">boolean</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[((</span>1 <span style="color:#8be9fd">+</span> 2<span style="color:#ff79c6">)</span> <span style="color:#8be9fd">&lt;=&gt;</span> <span style="color:#ff79c6">(</span>4 <span style="color:#8be9fd">-</span> 1<span style="color:#ff79c6">))</span> <span style="color:#8be9fd">AS</span> <span style="color:#ff79c6">((</span>1 <span style="color:#8be9fd">+</span> 2<span style="color:#ff79c6">)</span> <span style="color:#8be9fd">&lt;=&gt;</span> <span style="color:#ff79c6">(</span>4 <span style="color:#8be9fd">-</span> 1<span style="color:#ff79c6">))</span><span style="color:#ff79c6">#</span>0<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">OneRowRelation</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Optimized</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">true</span> <span style="color:#8be9fd">AS</span> <span style="color:#ff79c6">((</span>1 <span style="color:#8be9fd">+</span> 2<span style="color:#ff79c6">)</span> <span style="color:#8be9fd">&lt;=&gt;</span> <span style="color:#ff79c6">(</span>4 <span style="color:#8be9fd">-</span> 1<span style="color:#ff79c6">))</span><span style="color:#ff79c6">#</span>0<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">OneRowRelation</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="prunefilters">PruneFilters</h2>
<p>删除可以进行简单计算的Filter。这可以通过以下方式实现：</p>
<ol>
<li>在其计算结果始终为true的情况下，省略Filter</li>
<li>当筛选器的计算结果总是为false时，替换成一个伪空关系</li>
<li>消除子节点输出给定约束始终为true的条件</li>
</ol>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> t1 <span style="color:#ff79c6">WHERE</span> <span style="color:#bd93f9">1</span> <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>逻辑计划和优化后的</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Analyzed</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span>id<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">int</span><span style="color:#ff79c6">,</span> sname<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">string</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Filter</span> <span style="color:#ff79c6">(</span><span style="color:#bd93f9">1</span> <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">SubqueryAlias</span> t1
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span>  t1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Optimized</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span> t1
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="eliminateserialization">EliminateSerialization</h2>
<p>消除不必要地在对象和数据项的序列化（InternalRow）表示之间切换的情况。例如，背对背映射操作</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>spark.range(<span style="color:#bd93f9">10</span>).ap(_ <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">1</span>).<span style="color:#ff79c6">map</span>(_ <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">2</span>).<span style="color:#ff79c6">explain</span>(<span style="color:#f1fa8c">&#34;extended&#34;</span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>
        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/10/7bcsrB.png">
            <img class="mx-auto" alt="" src="https://v1.ax1x.com/2024/05/10/7bcsrB.png" />
        </a>
    <br>

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/10/7bcihG.png">
            <img class="mx-auto" alt="" src="https://v1.ax1x.com/2024/05/10/7bcihG.png" />
        </a>
    </p>
<h2 id="simplifyextractvalueops">SimplifyExtractValueOps</h2>
<p>简化冗余的 CreateNamedStruct/CreateArray/CreateMap表达式</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> <span style="color:#8be9fd;font-style:italic">array</span>(<span style="color:#f1fa8c">&#39;a&#39;</span>, <span style="color:#f1fa8c">&#39;b&#39;</span>, <span style="color:#f1fa8c">&#39;c&#39;</span>)[<span style="color:#bd93f9">0</span>] <span style="color:#ff79c6">as</span> col_1
</span></span></code></pre></td></tr></table>
</div>
</div><p>逻辑计划和优化后的</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Analyzed</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span>col_1<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">string</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">array</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">a</span>, <span style="color:#8be9fd">b</span>, <span style="color:#8be9fd">c</span><span style="color:#ff79c6">)[</span>0<span style="color:#ff79c6">]</span> <span style="color:#8be9fd">AS</span> <span style="color:#8be9fd">col_1</span><span style="color:#ff79c6">#</span>0<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">OneRowRelation</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Optimized</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">a</span> <span style="color:#8be9fd">AS</span> <span style="color:#8be9fd">col_1</span><span style="color:#ff79c6">#</span>0<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">OneRowRelation</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<p>map 的简化</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">map</span>(<span style="color:#f1fa8c">&#39;a_key&#39;</span>, <span style="color:#f1fa8c">&#39;a_value&#39;</span>, <span style="color:#f1fa8c">&#39;b_key&#39;</span>, <span style="color:#f1fa8c">&#39;b_value&#39;</span>).a_key <span style="color:#ff79c6">as</span> col_1
</span></span></code></pre></td></tr></table>
</div>
</div><p>逻辑计划和优化后的</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Analyzed</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span>col_1<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">string</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">map</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">a_key</span>, <span style="color:#8be9fd">a_value</span>, <span style="color:#8be9fd">b_key</span>, <span style="color:#8be9fd">b_value</span><span style="color:#ff79c6">)[</span><span style="color:#8be9fd">a_key</span><span style="color:#ff79c6">]</span> <span style="color:#8be9fd">AS</span> <span style="color:#8be9fd">col_1</span><span style="color:#ff79c6">#</span>0<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">OneRowRelation</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Optimized</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">a_value</span> <span style="color:#8be9fd">AS</span> <span style="color:#8be9fd">col_1</span><span style="color:#ff79c6">#</span>0<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">OneRowRelation</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="其他-2">其他</h2>
<p>SimplifyCasts</p>
<ul>
<li>删除不必要的强制转换，因为输入已经是正确的类型。</li>
</ul>
<p>SimplifyCaseConversionExpressions</p>
<ul>
<li>删除不必要的内部大小写转换表达式，因为内部转换被外部转换覆盖</li>
</ul>
<p>RemoveRedundantAliases</p>
<ul>
<li>从查询计划中删除冗余别名</li>
<li>冗余别名是不会更改列的名称或元数据，也不会消除重复数据的别名</li>
</ul>
<h1 id="rewritereplaceeliminate规则">Rewrite/Replace/Eliminate规则</h1>
<h2 id="eliminateouterjoin">EliminateOuterJoin</h2>
<p>包含的主要逻辑<br>

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/04/30/7KWBDI.png">
            <img class="mx-auto" alt="" src="https://v1.ax1x.com/2024/04/30/7KWBDI.png" />
        </a>
    <br>
图片来源，<a href="https://mp.weixin.qq.com/s?__biz=MzU5NTc1NzE2OA==&amp;mid=2247484451&amp;idx=1&amp;sn=32295bb3e4e0035432eea9baa6e6fb8c&amp;chksm=fe6c553cc91bdc2a52d39c6c9d010f0500065730f3d841ca5f651c01ca547aab73f015a7f4b0&amp;scene=21#wechat_redirect">这里</a></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>    join<span style="color:#ff79c6">.</span>joinType <span style="color:#ff79c6">match</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">case</span> <span style="color:#50fa7b">RightOuter</span> <span style="color:#ff79c6">if</span> leftHasNonNullPredicate <span style="color:#ff79c6">=&gt;</span> <span style="color:#50fa7b">Inner</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">case</span> <span style="color:#50fa7b">LeftOuter</span> <span style="color:#ff79c6">if</span> rightHasNonNullPredicate <span style="color:#ff79c6">=&gt;</span> <span style="color:#50fa7b">Inner</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">case</span> <span style="color:#50fa7b">FullOuter</span> <span style="color:#ff79c6">if</span> leftHasNonNullPredicate <span style="color:#ff79c6">&amp;&amp;</span> rightHasNonNullPredicate <span style="color:#ff79c6">=&gt;</span> <span style="color:#50fa7b">Inner</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">case</span> <span style="color:#50fa7b">FullOuter</span> <span style="color:#ff79c6">if</span> leftHasNonNullPredicate <span style="color:#ff79c6">=&gt;</span> <span style="color:#50fa7b">LeftOuter</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">case</span> <span style="color:#50fa7b">FullOuter</span> <span style="color:#ff79c6">if</span> rightHasNonNullPredicate <span style="color:#ff79c6">=&gt;</span> <span style="color:#50fa7b">RightOuter</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">case</span> o <span style="color:#ff79c6">=&gt;</span> o
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>转换的几个要求</p>
<ul>
<li>right outer类型，对join的左表有过滤操作，转换 innert join</li>
<li>left outer类型，对右表有过滤操作，转换为 inner join</li>
<li>full outer，对左右表都有过滤，转为 inner join</li>
<li>full outer，join的左表有过滤，转为 left outer</li>
<li>full outer，join的右表有过滤，转为 right outer</li>
</ul>
<p><strong>以  left outer 为例</strong></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> a.sname, b.sname <span style="color:#ff79c6">FROM</span> $mysqlName.$mysqlDB.t1 <span style="color:#ff79c6">AS</span> a
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">LEFT</span> <span style="color:#ff79c6">JOIN</span> $mysqlName.$mysqlDB.t2 <span style="color:#ff79c6">AS</span> b
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">ON</span> a.id <span style="color:#ff79c6">=</span> b.id
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">WHERE</span> b.id <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">99</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>逻辑计划：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Analyzed</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span>sname<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">string</span><span style="color:#ff79c6">,</span> sname<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">string</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>3<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Filter</span> <span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">2</span> <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">99</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Join</span> <span style="color:#50fa7b">LeftOuter</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span> <span style="color:#ff79c6">=</span> id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">2</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">:</span><span style="color:#8be9fd">-</span> <span style="color:#8be9fd">SubqueryAlias</span> <span style="color:#8be9fd">a</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">:</span>  <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">SubqueryAlias</span> <span style="color:#8be9fd">t1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">:</span>     <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span>  t1
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">SubqueryAlias</span> b
</span></span><span style="display:flex;"><span>         <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">SubqueryAlias</span> t2
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>2, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>3<span style="color:#ff79c6">]</span>  t2
</span></span></code></pre></td></tr></table>
</div>
</div><p>优化的中间结果:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#50fa7b">Filter</span> <span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">2</span> <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">99</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Join</span> <span style="color:#50fa7b">Inner</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span> <span style="color:#ff79c6">=</span> id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">2</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">:</span><span style="color:#8be9fd">-</span> <span style="color:#8be9fd">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span>  t1
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>2, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>3<span style="color:#ff79c6">]</span>  t2
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<p><strong>FULL JOIN的优化</strong></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> a.sname, b.sname <span style="color:#ff79c6">FROM</span> t1 <span style="color:#ff79c6">AS</span> a
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">FULL</span> <span style="color:#ff79c6">JOIN</span> t2 <span style="color:#ff79c6">AS</span> b
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">ON</span> a.id <span style="color:#ff79c6">=</span> b.id
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">WHERE</span> b.id <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">99</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>逻辑计划：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Analyzed</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span>sname<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">string</span><span style="color:#ff79c6">,</span> sname<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">string</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>3<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Filter</span> <span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">2</span> <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">99</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Join</span> <span style="color:#50fa7b">FullOuter</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span> <span style="color:#ff79c6">=</span> id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">2</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">:</span><span style="color:#8be9fd">-</span> <span style="color:#8be9fd">SubqueryAlias</span> <span style="color:#8be9fd">a</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">:</span>  <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">SubqueryAlias</span> <span style="color:#8be9fd">t1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">:</span>     <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span>  t1
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">SubqueryAlias</span> b
</span></span><span style="display:flex;"><span>         <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">SubqueryAlias</span> t2
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>2, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>3<span style="color:#ff79c6">]</span>  t2
</span></span></code></pre></td></tr></table>
</div>
</div><p>优化的中间结果：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#50fa7b">Filter</span> <span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">2</span> <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">99</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Join</span> <span style="color:#50fa7b">RightOuter</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span> <span style="color:#ff79c6">=</span> id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">2</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">:</span><span style="color:#8be9fd">-</span> <span style="color:#8be9fd">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span>  t1
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>2, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>3<span style="color:#ff79c6">]</span>  t2
</span></span></code></pre></td></tr></table>
</div>
</div><p>
        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/10/7bc2dt.png">
            <img class="mx-auto" alt="join类型图解" src="https://v1.ax1x.com/2024/05/10/7bc2dt.png" />
        </a>
    </p>
<h2 id="eliminatedistinct">EliminateDistinct</h2>
<p>消除聚合函数中不需要的 distinct</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">max</span>(<span style="color:#ff79c6">distinct</span> id) <span style="color:#ff79c6">as</span> max_id <span style="color:#ff79c6">FROM</span>  t1
</span></span></code></pre></td></tr></table>
</div>
</div><p>逻辑计划 和 优化结果：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Analyzed</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span>max_id<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">int</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">Aggregate</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">max</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">distinct</span> <span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">)</span> <span style="color:#8be9fd">AS</span> <span style="color:#8be9fd">max_id</span><span style="color:#ff79c6">#</span>0<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">SubqueryAlias</span> <span style="color:#ff79c6">.</span>t1
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>1, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>2<span style="color:#ff79c6">]</span>  t1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Optimized</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">MAX</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">`id`</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">#</span>6 <span style="color:#8be9fd">AS</span> <span style="color:#8be9fd">max</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">)</span><span style="color:#ff79c6">#</span>3 <span style="color:#8be9fd">AS</span> <span style="color:#8be9fd">max_id</span><span style="color:#ff79c6">#</span>0<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">MAX</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">`id`</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">#</span>6<span style="color:#ff79c6">]</span> t1
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="eliminatelimits">EliminateLimits</h2>
<p>该规则由normal和AQE优化器应用，并通过以下方式优化Limit运算符：</p>
<ul>
<li>如果是child max row&lt;=Limit，则消除Limit/GlobalLimit运算符</li>
<li>将两个相邻的Limit运算符合并为一个，将多个表达式合并成一个</li>
</ul>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>    <span style="color:#ff79c6">var</span> df <span style="color:#ff79c6">=</span> spark<span style="color:#ff79c6">.</span>sql<span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f1fa8c">s&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        |SELECT id, sname FROM </span><span style="color:#f1fa8c">$mysqlName</span><span style="color:#f1fa8c">.</span><span style="color:#f1fa8c">$mysqlDB</span><span style="color:#f1fa8c">.t1
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        |&#34;&#34;&#34;</span><span style="color:#ff79c6">.</span>stripMargin<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>    df <span style="color:#ff79c6">=</span> df<span style="color:#ff79c6">.</span>limit<span style="color:#ff79c6">(</span><span style="color:#bd93f9">5</span><span style="color:#ff79c6">).</span>limit<span style="color:#ff79c6">(</span><span style="color:#bd93f9">10</span><span style="color:#ff79c6">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>逻辑计划</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Analyzed</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span>id<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">int</span><span style="color:#ff79c6">,</span> sname<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">string</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">GlobalLimit</span> <span style="color:#bd93f9">10</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">LocalLimit</span> <span style="color:#bd93f9">10</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">GlobalLimit</span> <span style="color:#bd93f9">5</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">LocalLimit</span> <span style="color:#bd93f9">5</span>
</span></span><span style="display:flex;"><span>         <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">SubqueryAlias</span> t1
</span></span><span style="display:flex;"><span>               <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span>  t1
</span></span></code></pre></td></tr></table>
</div>
</div><p>中间结果</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#50fa7b">GlobalLimit</span> <span style="color:#bd93f9">5</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">LocalLimit</span> <span style="color:#bd93f9">5</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span>  t1
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="其他-3">其他</h2>
<p>ReplaceIntersectWithSemiJoin</p>
<ul>
<li>使用 left-semi Join 运算符替代逻辑Intersect运算符</li>
</ul>
<p>ReplaceExceptWithFilter</p>
<ul>
<li>如果逻辑Except运算符中的一或两个数据集都纯粹地使用Filter转换过</li>
<li>这个规则会使用反转Except运算符右侧条件之后的Filter运算符替代</li>
</ul>
<p>ReplaceExceptWithAntiJoin</p>
<ul>
<li>使用 left-anti Join运算符替代逻辑Except运算符</li>
</ul>
<p>ReplaceDistinctWithAggregate</p>
<ul>
<li>使用Aggregate运算符替代逻辑Distinct运算符</li>
</ul>
<p>RewriteExceptAll</p>
<ul>
<li>混合使用Union、Aggregate、Generate 运算符来替代逻辑的Except运算符</li>
</ul>
<p>RewriteIntersectAll</p>
<ul>
<li>混合使用Union、Aggregate、Generate 运算符来替代逻辑的Intersect运算符</li>
</ul>
<p>EliminateLimits</p>
<ul>
<li>该规则由normal和AQE优化器应用，并通过以下方式优化Limit运算符：</li>
<li>1.如果是child max row&lt;=Limit，则消除Limit/GlobalLimit运算符</li>
<li>2.将两个相邻的Limit运算符合并为一个，将多个表达式合并成一个</li>
</ul>
<p>EliminateAggregateFilter</p>
<ul>
<li>删除聚合表达式的无用FILTER子句</li>
<li>在RewriteDistinctAggregates之前，应该先应用这个规则</li>
</ul>
<p>EliminateSerialization</p>
<ul>
<li>消除不必要地在对象和数据项的序列化（InternalRow）表示之间切换的情况</li>
<li>例如，背对背映射操作</li>
</ul>
<hr>
<p>ReplaceIntersectWithSemiJoin</p>
<ul>
<li>使用 left-semi Join 运算符替代逻辑Intersect运算符</li>
</ul>
<p>ReplaceExceptWithFilter</p>
<ul>
<li>如果逻辑Except运算符中的一或两个数据集都纯粹地使用Filter转换过</li>
<li>这个规则会使用反转Except运算符右侧条件之后的Filter运算符替代。</li>
</ul>
<p>ReplaceExceptWithAntiJoin</p>
<ul>
<li>用 left-anti Join运算符替代逻辑Except运算符</li>
</ul>
<p>ReplaceDistinctWithAggregate</p>
<ul>
<li>使用Aggregate运算符替代逻辑Distinct运算符</li>
</ul>
<p>RewriteExceptAll</p>
<ul>
<li>混合使用Union、Aggregate、Generate 运算符来替代逻辑的Except运算符</li>
</ul>
<p>RewriteIntersectAll</p>
<ul>
<li>混合使用Union、Aggregate、Generate 运算符来替代逻辑的Intersect运算符</li>
</ul>
<h1 id="下推规则">下推规则</h1>
<h2 id="pushdownpredicates">PushDownPredicates</h2>
<p>这个规则由三个规则组成</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">object</span> <span style="color:#50fa7b">PushDownPredicates</span> <span style="color:#ff79c6">extends</span> <span style="color:#50fa7b">Rule</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">LogicalPlan</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">def</span> apply<span style="color:#ff79c6">(</span>plan<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">LogicalPlan</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">LogicalPlan</span> <span style="color:#ff79c6">=</span> plan<span style="color:#ff79c6">.</span>transformWithPruning<span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">_</span><span style="color:#ff79c6">.</span>containsAnyPattern<span style="color:#ff79c6">(</span><span style="color:#50fa7b">FILTER</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">JOIN</span><span style="color:#ff79c6">))</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">CombineFilters</span><span style="color:#ff79c6">.</span>applyLocally
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">.</span>orElse<span style="color:#ff79c6">(</span><span style="color:#50fa7b">PushPredicateThroughNonJoin</span><span style="color:#ff79c6">.</span>applyLocally<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">.</span>orElse<span style="color:#ff79c6">(</span><span style="color:#50fa7b">PushPredicateThroughJoin</span><span style="color:#ff79c6">.</span>applyLocally<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>
        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/04/30/7KVoZa.png">
            <img class="mx-auto" alt="" src="https://v1.ax1x.com/2024/04/30/7KVoZa.png" />
        </a>
    <br>
图片来自<a href="https://cloud.tencent.com/developer/article/1902503">这里</a></p>
<h2 id="pushpredicatethroughnonjoin">PushPredicateThroughNonJoin</h2>
<p>这个规则又包含了 6 个处理逻辑：

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/09/24/7x4Anh.png">
            <img class="mx-auto" alt="" src="https://v1.ax1x.com/2024/09/24/7x4Anh.png" />
        </a>
    </p>
<p><strong>Case 1</strong> – Push predicate through Project</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span> <span style="color:#ff79c6">SELECT</span> id <span style="color:#ff79c6">FROM</span>
</span></span><span style="display:flex;"><span> (
</span></span><span style="display:flex;"><span> <span style="color:#ff79c6">SELECT</span> id <span style="color:#ff79c6">FROM</span> t1 <span style="color:#ff79c6">WHERE</span>
</span></span><span style="display:flex;"><span> ) <span style="color:#ff79c6">WHERE</span> id <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">100</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>首先要判断 project 中的字符安是否是确定性的，只有确定性的才能将条件下推<br>
转换后的中间结果</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Filter</span> <span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span> <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">100</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span> t1
</span></span></code></pre></td></tr></table>
</div>
</div><p>这种情况就不能下推，外层</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span> <span style="color:#ff79c6">SELECT</span> id, r <span style="color:#ff79c6">FROM</span>
</span></span><span style="display:flex;"><span> (
</span></span><span style="display:flex;"><span> <span style="color:#ff79c6">SELECT</span> id, rand() <span style="color:#ff79c6">*</span> <span style="color:#bd93f9">10</span> <span style="color:#ff79c6">AS</span> r  <span style="color:#ff79c6">FROM</span> t1
</span></span><span style="display:flex;"><span>     <span style="color:#ff79c6">WHERE</span> r <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">10</span>
</span></span><span style="display:flex;"><span> ) <span style="color:#ff79c6">WHERE</span> r <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">100</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>下推后相当于： (r &gt; 10 AND r &lt; 100)，但因为 字段 r 是随机产生的，是不确定的<br>
这样过滤后结果就不对了，所以不能下推</p>
<hr>
<p><strong>Case 2</strong> – Push predicate through Aggregate<br>
SQL如下：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span> <span style="color:#ff79c6">SELECT</span> id, sname <span style="color:#ff79c6">FROM</span>
</span></span><span style="display:flex;"><span> (
</span></span><span style="display:flex;"><span> <span style="color:#ff79c6">SELECT</span> id, sname, <span style="color:#ff79c6">count</span>(<span style="color:#bd93f9">1</span>) <span style="color:#ff79c6">AS</span> <span style="color:#ff79c6">c</span>  <span style="color:#ff79c6">FROM</span> t1
</span></span><span style="display:flex;"><span>     <span style="color:#ff79c6">WHERE</span> id <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">10</span>  <span style="color:#ff79c6">GROUP</span> <span style="color:#ff79c6">BY</span> id, sname
</span></span><span style="display:flex;"><span> ) <span style="color:#ff79c6">WHERE</span> <span style="color:#ff79c6">c</span> <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span> <span style="color:#ff79c6">AND</span> id <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">999</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>执行逻辑：</p>
<ul>
<li>首先也是检查  project 中的字符安是否是确定性的，只有确定性的才能下推</li>
<li>字段必须要有 GROUP BY，也就是外层的 Filter 字段在 GROUP BY 中才可以下推</li>
<li>获取 Aggregate 中别名和真实字段的对应关系</li>
<li>将 Filter字段拆分为 确定的（候选字段）、不确定的</li>
<li>根据候选字段，跟聚会的字段作比较，只有在 聚合列表中的，比如 id &lt; 999 中的id可以，c 则不行</li>
<li>将能不能下推的字段重新组合</li>
<li>能下推的字段，移到 Aggregate 下面作为 Filter，这样就完成了下推</li>
</ul>
<p>逻辑计划：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Analyzed</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span>id<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">int</span><span style="color:#ff79c6">,</span> sname<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">string</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>1, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>2<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Filter</span> <span style="color:#ff79c6">((</span>c<span style="color:#ff79c6">#</span><span style="color:#bd93f9">0L</span> <span style="color:#ff79c6">=</span> cast<span style="color:#ff79c6">(</span><span style="color:#bd93f9">1</span> as bigint<span style="color:#ff79c6">))</span> <span style="color:#50fa7b">AND</span> <span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">1</span> <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">999</span><span style="color:#ff79c6">))</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">SubqueryAlias</span> <span style="color:#50fa7b">__auto_generated_subquery_name</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Aggregate</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>1, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>2<span style="color:#ff79c6">],</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>1, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>2, <span style="color:#8be9fd">count</span><span style="color:#ff79c6">(</span>1<span style="color:#ff79c6">)</span> <span style="color:#8be9fd">AS</span> <span style="color:#8be9fd">c</span><span style="color:#ff79c6">#</span>0<span style="color:#8be9fd">L</span><span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>         <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Filter</span> <span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">1</span> <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">10</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">SubqueryAlias</span> t1
</span></span><span style="display:flex;"><span>               <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>1, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>2<span style="color:#ff79c6">]</span>  t1
</span></span></code></pre></td></tr></table>
</div>
</div><p>优化的中间结果：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#50fa7b">Filter</span> <span style="color:#ff79c6">(</span>c<span style="color:#ff79c6">#</span><span style="color:#bd93f9">0L</span> <span style="color:#ff79c6">=</span> cast<span style="color:#ff79c6">(</span><span style="color:#bd93f9">1</span> as bigint<span style="color:#ff79c6">))</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Aggregate</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>1, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>2<span style="color:#ff79c6">],</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>1, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>2, <span style="color:#8be9fd">count</span><span style="color:#ff79c6">(</span>1<span style="color:#ff79c6">)</span> <span style="color:#8be9fd">AS</span> <span style="color:#8be9fd">c</span><span style="color:#ff79c6">#</span>0<span style="color:#8be9fd">L</span><span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Filter</span> <span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">1</span> <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">999</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Filter</span> <span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">1</span> <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">10</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>         <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>1, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>2<span style="color:#ff79c6">]</span> t1
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<p><strong>Case 3</strong> – Push predicate through Window<br>
SQL:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span> <span style="color:#ff79c6">SELECT</span> id, sname <span style="color:#ff79c6">FROM</span>
</span></span><span style="display:flex;"><span> (
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">SELECT</span> id, sname,
</span></span><span style="display:flex;"><span>    row_number() over(partition <span style="color:#ff79c6">by</span> id <span style="color:#ff79c6">order</span> <span style="color:#ff79c6">by</span> sname <span style="color:#ff79c6">desc</span> ) <span style="color:#ff79c6">AS</span> rn
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">FROM</span> $mysqlName.$mysqlDB.t2
</span></span><span style="display:flex;"><span> ) tmp <span style="color:#ff79c6">WHERE</span> id <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">999</span> <span style="color:#ff79c6">AND</span> sname <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;aa&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>执行过程</p>
<ul>
<li>跟 Aggregate 类似，判断 project中的字段是否是确定的</li>
<li>找出可以下推的，也就是出现的 windows 函数中的字段</li>
<li>将不能下推的重新组合，能下推的移动到 windows 算子下面</li>
</ul>
<p>逻辑计划：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Analyzed</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span>id<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">int</span><span style="color:#ff79c6">,</span> sname<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">string</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>1, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>2<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Filter</span> <span style="color:#ff79c6">((</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">1</span> <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">999</span><span style="color:#ff79c6">)</span> <span style="color:#50fa7b">AND</span> <span style="color:#ff79c6">(</span>sname<span style="color:#ff79c6">#</span><span style="color:#bd93f9">2</span> <span style="color:#ff79c6">=</span> aa<span style="color:#ff79c6">))</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">SubqueryAlias</span> tmp
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>1, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>2, <span style="color:#8be9fd">rn</span><span style="color:#ff79c6">#</span>0<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>         <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>1, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>2, <span style="color:#8be9fd">rn</span><span style="color:#ff79c6">#</span>0, <span style="color:#8be9fd">rn</span><span style="color:#ff79c6">#</span>0<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Window</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">row_number</span><span style="color:#ff79c6">()</span> <span style="color:#8be9fd">windowspecdefinition</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>1, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>2 <span style="color:#8be9fd">DESC</span> <span style="color:#8be9fd">NULLS</span> <span style="color:#8be9fd">LAST</span>, <span style="color:#8be9fd">specifiedwindowframe</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">RowFrame</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#8be9fd">unboundedpreceding$</span><span style="color:#ff79c6">()</span>, <span style="color:#8be9fd">currentrow$</span><span style="color:#ff79c6">()))</span> <span style="color:#8be9fd">AS</span> <span style="color:#8be9fd">rn</span><span style="color:#ff79c6">#</span>0<span style="color:#ff79c6">],</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">],</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>2 <span style="color:#8be9fd">DESC</span> <span style="color:#8be9fd">NULLS</span> <span style="color:#8be9fd">LAST</span><span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>               <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>1, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>2<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">SubqueryAlias</span> t2
</span></span><span style="display:flex;"><span>                     <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>1, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>2<span style="color:#ff79c6">]</span> t2
</span></span></code></pre></td></tr></table>
</div>
</div><p>优化后的中间结果</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#50fa7b">Filter</span> <span style="color:#ff79c6">(</span>sname<span style="color:#ff79c6">#</span><span style="color:#bd93f9">2</span> <span style="color:#ff79c6">=</span> aa<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Window</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">row_number</span><span style="color:#ff79c6">()</span> <span style="color:#8be9fd">windowspecdefinition</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>1, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>2 <span style="color:#8be9fd">DESC</span> <span style="color:#8be9fd">NULLS</span> <span style="color:#8be9fd">LAST</span>, <span style="color:#8be9fd">specifiedwindowframe</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">RowFrame</span>,
</span></span><span style="display:flex;"><span> <span style="color:#8be9fd">unboundedpreceding$</span><span style="color:#ff79c6">()</span>, <span style="color:#8be9fd">currentrow$</span><span style="color:#ff79c6">()))</span> <span style="color:#8be9fd">AS</span> <span style="color:#8be9fd">rn</span><span style="color:#ff79c6">#</span>0<span style="color:#ff79c6">],</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">],</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>2 <span style="color:#8be9fd">DESC</span> <span style="color:#8be9fd">NULLS</span> <span style="color:#8be9fd">LAST</span><span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Filter</span> <span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">1</span> <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">999</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>1, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>2<span style="color:#ff79c6">]</span>  t2
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<p><strong>Case 4</strong> – Push predicate through Union<br>
SQL如下：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> tmpc <span style="color:#ff79c6">FROM</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">SELECT</span>  id <span style="color:#ff79c6">AS</span> tmpc  <span style="color:#ff79c6">FROM</span> t1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">UNION</span> <span style="color:#ff79c6">ALL</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">SELECT</span>  id <span style="color:#ff79c6">AS</span> tmpc  <span style="color:#ff79c6">FROM</span> t2
</span></span><span style="display:flex;"><span>) tmp <span style="color:#ff79c6">WHERE</span> tmpc <span style="color:#ff79c6">&gt;</span><span style="color:#bd93f9">1</span> <span style="color:#ff79c6">AND</span> rand()<span style="color:#ff79c6">&gt;</span><span style="color:#bd93f9">0</span>.<span style="color:#bd93f9">1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>逻辑计划：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Analyzed</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span>tmpc<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">int</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">tmpc</span><span style="color:#ff79c6">#</span>0<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Filter</span> <span style="color:#ff79c6">((</span>tmpc<span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span> <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">1</span><span style="color:#ff79c6">)</span> <span style="color:#50fa7b">AND</span> <span style="color:#ff79c6">(</span>rand<span style="color:#ff79c6">(</span><span style="color:#bd93f9">5842271494822007178</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">&gt;</span> cast<span style="color:#ff79c6">(</span><span style="color:#bd93f9">0.1</span> asf double<span style="color:#ff79c6">)))</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">SubqueryAlias</span> tmp
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Union</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>         <span style="color:#ff79c6">:</span><span style="color:#8be9fd">-</span> <span style="color:#8be9fd">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>2 <span style="color:#8be9fd">AS</span> <span style="color:#8be9fd">tmpc</span><span style="color:#ff79c6">#</span>0<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>         <span style="color:#ff79c6">:</span>  <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">SubqueryAlias</span> <span style="color:#8be9fd">t1</span>
</span></span><span style="display:flex;"><span>         <span style="color:#ff79c6">:</span>     <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>2, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>3<span style="color:#ff79c6">]</span>  t1
</span></span><span style="display:flex;"><span>         <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>4 <span style="color:#8be9fd">AS</span> <span style="color:#8be9fd">tmpc</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">SubqueryAlias</span> t2
</span></span><span style="display:flex;"><span>               <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>4, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>5<span style="color:#ff79c6">]</span> <span style="color:#bd93f9">2</span> t2
</span></span></code></pre></td></tr></table>
</div>
</div><p>优化后的中间结果，之前最外层的 tmpc &gt; 1 被下推到了 UNION的下层了，而不确定的字段 rand 则没被下推</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#50fa7b">Filter</span> <span style="color:#ff79c6">(</span>rand<span style="color:#ff79c6">(</span><span style="color:#bd93f9">5842271494822007178</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">&gt;</span> cast<span style="color:#ff79c6">(</span><span style="color:#bd93f9">0.1</span> as double<span style="color:#ff79c6">))</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Union</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">:</span><span style="color:#8be9fd">-</span> <span style="color:#8be9fd">Filter</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">tmpc</span><span style="color:#ff79c6">#</span>0 <span style="color:#8be9fd">&gt;</span> 1<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#8be9fd">:</span>  <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>2 <span style="color:#8be9fd">AS</span> <span style="color:#8be9fd">tmpc</span><span style="color:#ff79c6">#</span>0<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">:</span>     <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>2, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>3<span style="color:#ff79c6">]</span>  t1
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Filter</span> <span style="color:#ff79c6">(</span>tmpc<span style="color:#ff79c6">#</span><span style="color:#bd93f9">1</span> <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">1</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>4 <span style="color:#8be9fd">AS</span> <span style="color:#8be9fd">tmpc</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>         <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>4, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>5<span style="color:#ff79c6">]</span>  t2
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<p><strong>Case 5</strong> – Push predicate through all other supported operators<br>
其他一些可以下推的场景</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>  <span style="color:#ff79c6">def</span> canPushThrough<span style="color:#ff79c6">(</span>p<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">UnaryNode</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Boolean</span> <span style="color:#ff79c6">=</span> p <span style="color:#ff79c6">match</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// Note that some operators (e.g. project, aggregate, union) are being handled separately
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// (earlier in this rule).
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">case</span> <span style="color:#ff79c6">_:</span> <span style="color:#8be9fd">AppendColumns</span> <span style="color:#ff79c6">=&gt;</span> <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">case</span> <span style="color:#ff79c6">_:</span> <span style="color:#8be9fd">Distinct</span> <span style="color:#ff79c6">=&gt;</span> <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">case</span> <span style="color:#ff79c6">_:</span> <span style="color:#8be9fd">Generate</span> <span style="color:#ff79c6">=&gt;</span> <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">case</span> <span style="color:#ff79c6">_:</span> <span style="color:#8be9fd">Pivot</span> <span style="color:#ff79c6">=&gt;</span> <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">case</span> <span style="color:#ff79c6">_:</span> <span style="color:#8be9fd">RepartitionByExpression</span> <span style="color:#ff79c6">=&gt;</span> <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">case</span> <span style="color:#ff79c6">_:</span> <span style="color:#8be9fd">Repartition</span> <span style="color:#ff79c6">=&gt;</span> <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">case</span> <span style="color:#ff79c6">_:</span> <span style="color:#8be9fd">RebalancePartitions</span> <span style="color:#ff79c6">=&gt;</span> <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">case</span> <span style="color:#ff79c6">_:</span> <span style="color:#8be9fd">ScriptTransformation</span> <span style="color:#ff79c6">=&gt;</span> <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">case</span> <span style="color:#ff79c6">_:</span> <span style="color:#8be9fd">Sort</span> <span style="color:#ff79c6">=&gt;</span> <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">case</span> <span style="color:#ff79c6">_:</span> <span style="color:#8be9fd">BatchEvalPython</span> <span style="color:#ff79c6">=&gt;</span> <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">case</span> <span style="color:#ff79c6">_:</span> <span style="color:#8be9fd">ArrowEvalPython</span> <span style="color:#ff79c6">=&gt;</span> <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">case</span> <span style="color:#ff79c6">_:</span> <span style="color:#8be9fd">Expand</span> <span style="color:#ff79c6">=&gt;</span> <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">case</span> <span style="color:#ff79c6">_</span> <span style="color:#ff79c6">=&gt;</span> <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>SQL</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> order_id <span style="color:#ff79c6">FROM</span>
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> item
</span></span><span style="display:flex;"><span>	pivot (
</span></span><span style="display:flex;"><span>	    <span style="color:#ff79c6">count</span>(id)
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">FOR</span> item_name <span style="color:#ff79c6">IN</span> (
</span></span><span style="display:flex;"><span>		    <span style="color:#f1fa8c">&#39;item1&#39;</span> item_1
</span></span><span style="display:flex;"><span>		)
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>) <span style="color:#ff79c6">WHERE</span> order_id <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">10</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>
        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/10/7bcdiP.png">
            <img class="mx-auto" alt="" src="https://v1.ax1x.com/2024/05/10/7bcdiP.png" />
        </a>
    <br>

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/10/7bcZOe.png">
            <img class="mx-auto" alt="" src="https://v1.ax1x.com/2024/05/10/7bcZOe.png" />
        </a>
    </p>
<h2 id="pushpredicatethroughjoin">PushPredicateThroughJoin</h2>
<p>
        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/10/7bvkXO.png">
            <img class="mx-auto" alt="" src="https://v1.ax1x.com/2024/05/10/7bvkXO.png" />
        </a>
    <br>

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/08/27/7xlNs3.png">
            <img class="mx-auto" alt="" src="https://v1.ax1x.com/2024/08/27/7xlNs3.png" />
        </a>
       <br>
图片来自<a href="https://blog.csdn.net/xiaoluobutou/article/details/129009816">这里</a></p>
<p><strong>case-1</strong>，Filter+inner join：把过滤条件下推到参加Join的两端<br>
步骤</p>
<ul>
<li>这里会取出 left 条件， right 条件，以及通用条件，然后分别跟 left子节点，right子节点重新拼接</li>
<li>也就是将 Filter放到 left、right 节点的上面，实现下推，最后将两个新的 子节点（此时左右都是 Filter）</li>
<li>拼接成一个新的 JOIN</li>
</ul>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> a.sname, b.sname <span style="color:#ff79c6">FROM</span> t1 <span style="color:#ff79c6">AS</span> a  <span style="color:#ff79c6">JOIN</span> t2 <span style="color:#ff79c6">AS</span> b
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">ON</span> a.id <span style="color:#ff79c6">=</span> b.id
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">WHERE</span> a.id <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">1</span> <span style="color:#ff79c6">AND</span> b.id <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">99</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>逻辑计划：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Analyzed</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span>sname<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">string</span><span style="color:#ff79c6">,</span> sname<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">string</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>3<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Filter</span> <span style="color:#ff79c6">((</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span> <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">1</span><span style="color:#ff79c6">)</span> <span style="color:#50fa7b">AND</span> <span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">2</span> <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">99</span><span style="color:#ff79c6">))</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Join</span> <span style="color:#50fa7b">Inner</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span> <span style="color:#ff79c6">=</span> id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">2</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">:</span><span style="color:#8be9fd">-</span> <span style="color:#8be9fd">SubqueryAlias</span> <span style="color:#8be9fd">a</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">:</span>  <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">SubqueryAlias</span> <span style="color:#8be9fd">t1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">:</span>     <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span>  t1
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">SubqueryAlias</span> b
</span></span><span style="display:flex;"><span>         <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">SubqueryAlias</span> t2
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>2, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>3<span style="color:#ff79c6">]</span>  t2
</span></span></code></pre></td></tr></table>
</div>
</div><p>优化的中间结果：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#50fa7b">Join</span> <span style="color:#50fa7b">Inner</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span> <span style="color:#ff79c6">=</span> id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">2</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">:</span><span style="color:#8be9fd">-</span> <span style="color:#8be9fd">Filter</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0 <span style="color:#8be9fd">&lt;</span> 1<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">:</span>  <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span>  t1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Filter</span> <span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">2</span> <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">99</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>2, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>3<span style="color:#ff79c6">]</span>  t2
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<p><strong>case-2</strong>，Filter+left join，把where子句的左侧数据表的过滤条件下推到左侧数据表<br>
跟 case-1 差不多，只是下推了左节点的条件</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> a.sname, b.sname <span style="color:#ff79c6">FROM</span> t1 <span style="color:#ff79c6">AS</span> a  <span style="color:#ff79c6">LEFT</span> <span style="color:#ff79c6">OUTER</span> <span style="color:#ff79c6">JOIN</span> t2 <span style="color:#ff79c6">AS</span> b   
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">ON</span> a.id <span style="color:#ff79c6">=</span> b.id
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">WHERE</span> a.id <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>逻辑计划：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Analyzed</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span>sname<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">string</span><span style="color:#ff79c6">,</span> sname<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">string</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>3<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Filter</span> <span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span> <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">1</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Join</span> <span style="color:#50fa7b">LeftOuter</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span> <span style="color:#ff79c6">=</span> id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">2</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">:</span><span style="color:#8be9fd">-</span> <span style="color:#8be9fd">SubqueryAlias</span> <span style="color:#8be9fd">a</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">:</span>  <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">SubqueryAlias</span> <span style="color:#8be9fd">t1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">:</span>     <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span>  t1
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">SubqueryAlias</span> b
</span></span><span style="display:flex;"><span>         <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">SubqueryAlias</span> t2
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>2, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>3<span style="color:#ff79c6">]</span>  t2
</span></span></code></pre></td></tr></table>
</div>
</div><p>中间结果：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#50fa7b">Join</span> <span style="color:#50fa7b">LeftOuter</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span> <span style="color:#ff79c6">=</span> id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">2</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">:</span><span style="color:#8be9fd">-</span> <span style="color:#8be9fd">Filter</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0 <span style="color:#8be9fd">&lt;</span> 1<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">:</span>  <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span>  t1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>2, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>3<span style="color:#ff79c6">]</span>  t2
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<p><strong>case-3</strong>，Filter+left join，把where子句的右侧数据表的过滤条件下推到右侧数据表</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> a.sname, b.sname <span style="color:#ff79c6">FROM</span> t1 <span style="color:#ff79c6">AS</span> a  <span style="color:#ff79c6">RIGHT</span> <span style="color:#ff79c6">OUTER</span> <span style="color:#ff79c6">JOIN</span> t2 <span style="color:#ff79c6">AS</span> b
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">ON</span> a.id <span style="color:#ff79c6">=</span> b.id
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">WHERE</span> b.id <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">99</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>逻辑计划：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Analyzed</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span>sname<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">string</span><span style="color:#ff79c6">,</span> sname<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">string</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>3<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Filter</span> <span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">2</span> <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">99</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Join</span> <span style="color:#50fa7b">RightOuter</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span> <span style="color:#ff79c6">=</span> id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">2</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">:</span><span style="color:#8be9fd">-</span> <span style="color:#8be9fd">SubqueryAlias</span> <span style="color:#8be9fd">a</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">:</span>  <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">SubqueryAlias</span> <span style="color:#8be9fd">t1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">:</span>     <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span> <span style="color:#bd93f9">1</span> t1
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">SubqueryAlias</span> b
</span></span><span style="display:flex;"><span>         <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">SubqueryAlias</span> t2
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>2, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>3<span style="color:#ff79c6">]</span>  t2
</span></span></code></pre></td></tr></table>
</div>
</div><p>中间结果：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#50fa7b">Join</span> <span style="color:#50fa7b">RightOuter</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span> <span style="color:#ff79c6">=</span> id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">2</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">:</span><span style="color:#8be9fd">-</span> <span style="color:#8be9fd">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span>  t1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Filter</span> <span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">2</span> <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">99</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>2, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>3<span style="color:#ff79c6">]</span>  t2
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<p><strong>case-4</strong>，full join，这个很多时候会被转换为 left、right或者 inner<br>
然后再进一步下推<br>
带 where 的 full join 实际是</p>
<ul>
<li>EliminateOuterJoin</li>
<li>PushPredicateThroughJoin</li>
</ul>
<p>共同完成的转换，下推的</p>
<hr>
<p><strong>case-5</strong>，join 的 ON 条件下推，这里仅列出 INNER 的情况，其他场景类似</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> a.sname, b.sname <span style="color:#ff79c6">FROM</span> t1 <span style="color:#ff79c6">AS</span> a  <span style="color:#ff79c6">JOIN</span> t2 <span style="color:#ff79c6">AS</span> b
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">ON</span> a.id <span style="color:#ff79c6">=</span> b.id
</span></span><span style="display:flex;"><span> <span style="color:#ff79c6">AND</span> a.id <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">99</span> <span style="color:#ff79c6">AND</span> b.sname <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;hehe&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>逻辑计划：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Analyzed</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span>sname<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">string</span><span style="color:#ff79c6">,</span> sname<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">string</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>3<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Join</span> <span style="color:#50fa7b">Inner</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(((</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span> <span style="color:#ff79c6">=</span> id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">2</span><span style="color:#ff79c6">)</span> <span style="color:#50fa7b">AND</span> <span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span> <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">99</span><span style="color:#ff79c6">))</span> <span style="color:#50fa7b">AND</span> <span style="color:#ff79c6">(</span>sname<span style="color:#ff79c6">#</span><span style="color:#bd93f9">3</span> <span style="color:#ff79c6">=</span> hehe<span style="color:#ff79c6">))</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">:</span><span style="color:#8be9fd">-</span> <span style="color:#8be9fd">SubqueryAlias</span> <span style="color:#8be9fd">a</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">:</span>  <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">SubqueryAlias</span> <span style="color:#8be9fd">t1</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">:</span>     <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span>  t1
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">SubqueryAlias</span> b
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">SubqueryAlias</span> t2
</span></span><span style="display:flex;"><span>         <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>2, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>3<span style="color:#ff79c6">]</span>  t2
</span></span></code></pre></td></tr></table>
</div>
</div><p>优化后的中间结果：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#50fa7b">Join</span> <span style="color:#50fa7b">Inner</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span> <span style="color:#ff79c6">=</span> id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">2</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">:</span><span style="color:#8be9fd">-</span> <span style="color:#8be9fd">Filter</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0 <span style="color:#8be9fd">&gt;</span> 99<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">:</span>  <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span>  t1
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Filter</span> <span style="color:#ff79c6">(</span>sname<span style="color:#ff79c6">#</span><span style="color:#bd93f9">3</span> <span style="color:#ff79c6">=</span> hehe<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>2, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>3<span style="color:#ff79c6">]</span>  t2
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="limitpushdown">LimitPushDown</h2>
<p>可以下推的包括</p>
<ul>
<li>子节点为 Union</li>
<li>子节点为 JOIN，分好几种情况
<ul>
<li>RightOuter 时，join 条件不空，可以下推 limit 到join 右边</li>
<li>LeftOuter 时，join条件不空，可以下推 limit 到 join 左边</li>
<li>InnerLike 时，条件不空，下推到左右两边</li>
<li>LeftSemi，LeftAnti 时，条件不空，下推到 join 的左边</li>
</ul>
</li>
<li>子节点为 PROJECT
<ul>
<li>孙子为 JOIN</li>
<li>孙子为 BatchEvalPython</li>
<li>孙子为 ArrowEvalPython</li>
</ul>
</li>
<li>limit 1，并且字节为 Aggregate</li>
<li>limit 1，并且子节点为 project</li>
<li>子节点为 OFFSET</li>
<li>子节点为 BatchEvalPython</li>
<li>子节点为 ArrowEvalPython</li>
</ul>
<p>SQL:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#50fa7b">SELECT</span> a<span style="color:#ff79c6">.</span>sname<span style="color:#ff79c6">,</span> b<span style="color:#ff79c6">.</span>sname <span style="color:#50fa7b">FROM</span> t1 <span style="color:#50fa7b">AS</span> a
</span></span><span style="display:flex;"><span>   <span style="color:#50fa7b">LEFT</span> <span style="color:#50fa7b">OUTER</span> <span style="color:#50fa7b">JOIN</span>
</span></span><span style="display:flex;"><span>   t2 <span style="color:#50fa7b">AS</span> b
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">ON</span> a<span style="color:#ff79c6">.</span>id <span style="color:#ff79c6">=</span> b<span style="color:#ff79c6">.</span>id  <span style="color:#50fa7b">LIMIT</span> <span style="color:#bd93f9">1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>逻辑计划：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Analyzed</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span>sname<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">string</span><span style="color:#ff79c6">,</span> sname<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">string</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">GlobalLimit</span> <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">LocalLimit</span> <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>3<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Join</span> <span style="color:#50fa7b">LeftOuter</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span> <span style="color:#ff79c6">=</span> id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">2</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>         <span style="color:#ff79c6">:</span><span style="color:#8be9fd">-</span> <span style="color:#8be9fd">SubqueryAlias</span> <span style="color:#8be9fd">a</span>
</span></span><span style="display:flex;"><span>         <span style="color:#ff79c6">:</span>  <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">SubqueryAlias</span> <span style="color:#8be9fd">t1</span>
</span></span><span style="display:flex;"><span>         <span style="color:#ff79c6">:</span>     <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span> t1
</span></span><span style="display:flex;"><span>         <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">SubqueryAlias</span> b
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">SubqueryAlias</span> t2
</span></span><span style="display:flex;"><span>               <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>2, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>3<span style="color:#ff79c6">]</span>  t2
</span></span></code></pre></td></tr></table>
</div>
</div><p>优化后：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Optimized</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">GlobalLimit</span> <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">LocalLimit</span> <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>3<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Join</span> <span style="color:#50fa7b">LeftOuter</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">0</span> <span style="color:#ff79c6">=</span> id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">2</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>         <span style="color:#ff79c6">:</span><span style="color:#8be9fd">-</span> <span style="color:#8be9fd">LocalLimit</span> 1
</span></span><span style="display:flex;"><span>         <span style="color:#8be9fd">:</span>  <span style="color:#8be9fd">+-</span> <span style="color:#8be9fd">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>0, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span> t1
</span></span><span style="display:flex;"><span>         <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>2, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>3<span style="color:#ff79c6">]</span> t2
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="columnpruning">ColumnPruning</h2>
<p>试图消除查询计划中不需要的列读取</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span>  id, m_id <span style="color:#ff79c6">FROM</span>
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">SELECT</span> id, <span style="color:#ff79c6">max</span>(id) <span style="color:#ff79c6">as</span> m_id,  <span style="color:#ff79c6">max</span>(parent_id) <span style="color:#ff79c6">as</span> m_pid
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">FROM</span> $mysqlName.$mysqlDB.zz_3 <span style="color:#ff79c6">GROUP</span> <span style="color:#ff79c6">BY</span> id
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>逻辑计划：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">==</span> <span style="color:#50fa7b">Analyzed</span> <span style="color:#50fa7b">Logical</span> <span style="color:#50fa7b">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span>id<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">int</span><span style="color:#ff79c6">,</span> m_id<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">int</span>
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>2, <span style="color:#8be9fd">m_id</span><span style="color:#ff79c6">#</span>0<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">SubqueryAlias</span> <span style="color:#50fa7b">__auto_generated_subquery_name</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Aggregate</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>2<span style="color:#ff79c6">],</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>2, <span style="color:#8be9fd">max</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>2<span style="color:#ff79c6">)</span> <span style="color:#8be9fd">AS</span> <span style="color:#8be9fd">m_id</span><span style="color:#ff79c6">#</span>0, <span style="color:#8be9fd">max</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">parent_id</span><span style="color:#ff79c6">#</span>3<span style="color:#ff79c6">)</span> <span style="color:#8be9fd">AS</span> <span style="color:#8be9fd">m_pid</span><span style="color:#ff79c6">#</span>1<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">SubqueryAlias</span> zz_3
</span></span><span style="display:flex;"><span>         <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>2, <span style="color:#8be9fd">parent_id</span><span style="color:#ff79c6">#</span>3, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>4<span style="color:#ff79c6">]</span>  zz_3
</span></span></code></pre></td></tr></table>
</div>
</div><p>中间结果：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#50fa7b">Project</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>2, <span style="color:#8be9fd">m_id</span><span style="color:#ff79c6">#</span>0<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Aggregate</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>2<span style="color:#ff79c6">],</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>2, <span style="color:#8be9fd">max</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>2<span style="color:#ff79c6">)</span> <span style="color:#8be9fd">AS</span> <span style="color:#8be9fd">m_id</span><span style="color:#ff79c6">#</span>0<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">RelationV2</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>2, <span style="color:#8be9fd">parent_id</span><span style="color:#ff79c6">#</span>3, <span style="color:#8be9fd">sname</span><span style="color:#ff79c6">#</span>4<span style="color:#ff79c6">]</span>  zz_3
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="参考">参考</h1>
<ul>
<li><a href="https://dataninjago.com/category/deep-dive-spark-sql-query-engine/">Deep Dive – Spark SQL Query Engine</a></li>
<li><a href="https://cloud.tencent.com/developer/article/1902503">spark sql非join情况的谓词下推优化器PushPredicateThroughNonJoin</a></li>
<li><a href="https://dataninjago.com/2021/12/26/spark-deep-dive-9-catalyst-optimizer-rules-part-2/">Catalyst Optimizer Rules</a></li>
<li><a href="https://dataninjago.com/2021/12/21/spark-deep-dive-8-catalyst-optimizer-rules-part-1/">Catalyst Optimizer Rules (Part 1)</a></li>
<li><a href="https://hyperj.net/note.sql-engine/spark/catalyst/">Catalyst 分析</a></li>
<li><a href="https://www.jianshu.com/p/730eed6a98d2">Spark Storage 模块整体架构</a></li>
<li><a href="https://books.japila.pl/spark-sql-internals/catalyst/Optimizer/">spark internal Optimizer </a></li>
<li><a href="https://blog.csdn.net/Shockang/article/details/123930918">Spark SQL 工作流程源码解析（四）optimization 阶段</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/60380557">SQL 子查询的优化</a></li>
<li><a href="https://ericfu.me/apache-spark-in-nutshell/">一文读懂 Apache Spark</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/62338250">Calcite 子查询处理 - I (RemoveSubQuery)</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/66227661">Calcite 子查询处理 - II (Decorrelate)</a></li>
<li><a href="https://kyuubi.readthedocs.io/en/v1.6.1-incubating/deployment/spark/aqe.html">How To Use Spark Adaptive Query Execution (AQE) in Kyuubi</a></li>
<li><a href="https://estuary.dev/stream-processing-framework/">9 Best Stream Processing Frameworks: Comparison 2024</a></li>
<li><a href="https://dataninjago.com/tag/streaming/">Spark Structured Streaming Deep Dive</a></li>
<li><a href="https://mp.weixin.qq.com/s?__biz=MzU5NTc1NzE2OA==&amp;mid=2247484244&amp;idx=1&amp;sn=7aa9afb71109cec4bb32d1097dd1492f&amp;chksm=fe6c524bc91bdb5d0f8b8926383aa346a8a5c1299f5bb2c292c9cf57290dad7a8591625d3e49&amp;scene=21#wechat_redirect">spark sql解析过程中对tree的遍历（源码详解）</a></li>
<li><a href="https://blog.csdn.net/Shockang/article/details/131512410?spm=1001.2014.3001.5502">大数据存储架构详解</a></li>
</ul>

			<script type="text/javascript"
        async
        src="https://cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[\[','\]\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});

MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<style>
code.has-jax {
    font: inherit;
    font-size: 100%;
    background: inherit;
    border: inherit;
    color: #515151;
}
</style>
        </div>

        


        

<div class="post-archive">
    <h2>相关文章</h2>
    <ul class="listing">
        
        <li><a href="/post/2024/03/spark_internal/">Spark原理-解析过程和Catalog</a></li>
        
        <li><a href="/post/2023/06/spark_tuning/">Spark性能调优</a></li>
        
        <li><a href="/post/2023/01/photon-a-fast-query-engine-for-lakehouse-systems/">Photon A Fast Query Engine for Lakehouse Systems</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='/tags/spark'>Spark</a></li>
                
            </ul>
            
        </div>
    </article>
    
    

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "himichael/hugoblogtalks"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
</div>


                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='https://code0xff.org/search/' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://code0xff.org/">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://code0xff.org/post/2025/01/spark_register_source/" title="Spark 注册数据源">Spark 注册数据源</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2025/01/spark_core_2/" title="Spark Core相关-2">Spark Core相关-2</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2024/12/llamafactory/" title="Llama Factory">Llama Factory</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2024/11/spark_core/" title="Spark Core相关-1">Spark Core相关-1</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2024/11/sae_tunnel/" title="sea tunnel">sea tunnel</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2024/11/k8s_networks/" title="k8s 网络">k8s 网络</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2024/11/ozone/" title="ozone">ozone</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2024/11/es/" title="ES的简单学习">ES的简单学习</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2025/02/ai/" title="AI的简单学习">AI的简单学习</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2024/11/big_data_investigation/" title="国内几个云厂商大数据平台">国内几个云厂商大数据平台</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories/'>分类</a></h3>
<ul class="widget-list">
    
    <li><a href="https://code0xff.org/categories/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式 (6)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/">原理分析 (24)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E5%95%86%E4%B8%9A/">商业 (3)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据 (56)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库 (41)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E6%96%87%E5%AD%A6%E5%92%8C%E8%89%BA%E6%9C%AF/">文学和艺术 (3)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E6%97%85%E8%A1%8C/">旅行 (12)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E6%9E%B6%E6%9E%84/">架构 (13)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E7%AE%97%E6%B3%95/">算法 (8)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E7%B3%BB%E7%BB%9F/">系统 (7)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/">编程语言 (7)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E8%A1%8C%E4%B8%9A%E8%A7%82%E5%AF%9F/">行业观察 (3)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">读书笔记 (14)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E9%9A%8F%E4%BE%BF%E5%86%99%E5%86%99/">随便写写 (3)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title">归档</a></h3>
<ul class="widget-list">
    
    <li><a href="https://code0xff.org/years/2021%E5%B9%B4/">2021年 (41)</a></li>
    
    <li><a href="https://code0xff.org/years/2022%E5%B9%B4/">2022年 (55)</a></li>
    
    <li><a href="https://code0xff.org/years/2023%E5%B9%B4/">2023年 (54)</a></li>
    
    <li><a href="https://code0xff.org/years/2024%E5%B9%B4/">2024年 (48)</a></li>
    
    <li><a href="https://code0xff.org/years/2025%E5%B9%B4/">2025年 (2)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags/'>标签</a></h3>
<div class="tagcloud">
    
    <a href="https://code0xff.org/tags/ai/">AI </a>
    
    <a href="https://code0xff.org/tags/ambari/">Ambari </a>
    
    <a href="https://code0xff.org/tags/architecture/">architecture </a>
    
    <a href="https://code0xff.org/tags/bigdata/">bigdata </a>
    
    <a href="https://code0xff.org/tags/b%E6%A0%91/">B树 </a>
    
    <a href="https://code0xff.org/tags/c&#43;&#43;/">C&#43;&#43; </a>
    
    <a href="https://code0xff.org/tags/calcite/">calcite </a>
    
    <a href="https://code0xff.org/tags/cmu-database/">CMU-Database </a>
    
    <a href="https://code0xff.org/tags/data_ingestion/">Data_Ingestion </a>
    
    <a href="https://code0xff.org/tags/deltalake/">DeltaLake </a>
    
    <a href="https://code0xff.org/tags/doris/">Doris </a>
    
    <a href="https://code0xff.org/tags/english/">English </a>
    
    <a href="https://code0xff.org/tags/es/">ES </a>
    
    <a href="https://code0xff.org/tags/facebook/">Facebook </a>
    
    <a href="https://code0xff.org/tags/flink/">flink </a>
    
    <a href="https://code0xff.org/tags/flume/">flume </a>
    
    <a href="https://code0xff.org/tags/gc/">GC </a>
    
    <a href="https://code0xff.org/tags/gluten/">Gluten </a>
    
    <a href="https://code0xff.org/tags/hana/">HANA </a>
    
    <a href="https://code0xff.org/tags/hive/">Hive </a>
    
    <a href="https://code0xff.org/tags/iceberg/">iceberg </a>
    
    <a href="https://code0xff.org/tags/impala/">Impala </a>
    
    <a href="https://code0xff.org/tags/janino/">janino </a>
    
    <a href="https://code0xff.org/tags/k8s/">k8s </a>
    
    <a href="https://code0xff.org/tags/kafka/">Kafka </a>
    
    <a href="https://code0xff.org/tags/kudu/">kudu </a>
    
    <a href="https://code0xff.org/tags/kyuubi/">Kyuubi </a>
    
    <a href="https://code0xff.org/tags/lakehouse/">Lakehouse </a>
    
    <a href="https://code0xff.org/tags/leveldb/">LevelDB </a>
    
    <a href="https://code0xff.org/tags/llamafactory/">LlamaFactory </a>
    
    <a href="https://code0xff.org/tags/llvm/">LLVM </a>
    
    <a href="https://code0xff.org/tags/manacher/">Manacher </a>
    
    <a href="https://code0xff.org/tags/mapreduce/">MapReduce </a>
    
    <a href="https://code0xff.org/tags/micro-service/">micro-service </a>
    
    <a href="https://code0xff.org/tags/mysql/">MySQL </a>
    
    <a href="https://code0xff.org/tags/newsql/">NewSQL </a>
    
    <a href="https://code0xff.org/tags/oceanbase/">OceanBase </a>
    
    <a href="https://code0xff.org/tags/openlogreplicator/">OpenLogReplicator </a>
    
    <a href="https://code0xff.org/tags/parquet/">parquet </a>
    
    <a href="https://code0xff.org/tags/paxos/">paxos </a>
    
    <a href="https://code0xff.org/tags/presto/">Presto </a>
    
    <a href="https://code0xff.org/tags/quick-sql/">quick-sql </a>
    
    <a href="https://code0xff.org/tags/raft/">raft </a>
    
    <a href="https://code0xff.org/tags/scala/">scala </a>
    
    <a href="https://code0xff.org/tags/simd/">SIMD </a>
    
    <a href="https://code0xff.org/tags/snowflake/">snowflake </a>
    
    <a href="https://code0xff.org/tags/spark/">spark </a>
    
    <a href="https://code0xff.org/tags/sre/">SRE </a>
    
    <a href="https://code0xff.org/tags/teradata/">TeraData </a>
    
    <a href="https://code0xff.org/tags/tpcx-hs/">TPCx-HS </a>
    
    <a href="https://code0xff.org/tags/trino/">Trino </a>
    
    <a href="https://code0xff.org/tags/tuning/">Tuning </a>
    
    <a href="https://code0xff.org/tags/unix/">unix </a>
    
    <a href="https://code0xff.org/tags/yarn/">YARN </a>
    
    <a href="https://code0xff.org/tags/%E4%BA%8C%E5%88%86%E6%9F%A5%E6%89%BE/">二分查找 </a>
    
    <a href="https://code0xff.org/tags/%E4%BA%8C%E5%8F%89%E6%A0%91%E9%81%8D%E5%8E%86/">二叉树遍历 </a>
    
    <a href="https://code0xff.org/tags/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式 </a>
    
    <a href="https://code0xff.org/tags/%E5%88%97%E5%AD%98/">列存 </a>
    
    <a href="https://code0xff.org/tags/%E5%8A%A8%E6%80%81%E6%B3%A8%E5%85%A5/">动态注入 </a>
    
    <a href="https://code0xff.org/tags/%E5%8E%86%E5%8F%B2/">历史 </a>
    
    <a href="https://code0xff.org/tags/%E5%90%91%E9%87%8F%E5%8C%96/">向量化 </a>
    
    <a href="https://code0xff.org/tags/%E5%9B%9E%E6%BA%AF/">回溯 </a>
    
    <a href="https://code0xff.org/tags/%E5%9B%BD%E5%86%85%E6%97%85%E8%A1%8C/">国内旅行 </a>
    
    <a href="https://code0xff.org/tags/%E5%9B%BD%E5%A4%96%E6%97%85%E8%A1%8C/">国外旅行 </a>
    
    <a href="https://code0xff.org/tags/%E5%A4%9A%E7%A7%9F%E6%88%B7/">多租户 </a>
    
    <a href="https://code0xff.org/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据 </a>
    
    <a href="https://code0xff.org/tags/%E5%AD%98%E5%82%A8/">存储 </a>
    
    <a href="https://code0xff.org/tags/%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95/">工作记录 </a>
    
    <a href="https://code0xff.org/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务 </a>
    
    <a href="https://code0xff.org/tags/%E6%95%B0%E6%8D%AE%E4%B8%AD%E5%8F%B0/">数据中台 </a>
    
    <a href="https://code0xff.org/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库 </a>
    
    <a href="https://code0xff.org/tags/%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B/">数据模型 </a>
    
    <a href="https://code0xff.org/tags/%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB/">数据迁移 </a>
    
    <a href="https://code0xff.org/tags/%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96/">查询优化 </a>
    
    <a href="https://code0xff.org/tags/%E6%9F%A5%E8%AF%A2%E7%BC%96%E8%AF%91/">查询编译 </a>
    
    <a href="https://code0xff.org/tags/%E6%A6%82%E7%8E%87/">概率 </a>
    
    <a href="https://code0xff.org/tags/%E6%B1%87%E7%BC%96/">汇编 </a>
    
    <a href="https://code0xff.org/tags/%E6%B5%8B%E8%AF%95/">测试 </a>
    
    <a href="https://code0xff.org/tags/%E7%94%9F%E6%B4%BB/">生活 </a>
    
    <a href="https://code0xff.org/tags/%E7%94%B5%E5%BD%B1/">电影 </a>
    
    <a href="https://code0xff.org/tags/%E7%AE%97%E6%B3%95/">算法 </a>
    
    <a href="https://code0xff.org/tags/%E7%B4%A2%E5%BC%95/">索引 </a>
    
    <a href="https://code0xff.org/tags/%E7%BB%8F%E6%B5%8E/">经济 </a>
    
    <a href="https://code0xff.org/tags/%E7%BC%93%E5%AD%98/">缓存 </a>
    
    <a href="https://code0xff.org/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/">编译原理 </a>
    
    <a href="https://code0xff.org/tags/%E7%BD%91%E7%BB%9C/">网络 </a>
    
    <a href="https://code0xff.org/tags/%E8%AE%A1%E7%AE%97%E6%A1%86%E6%9E%B6/">计算框架 </a>
    
    <a href="https://code0xff.org/tags/%E8%AE%BA%E6%96%87/">论文 </a>
    
    <a href="https://code0xff.org/tags/%E8%AF%BB%E4%B9%A6/">读书 </a>
    
    <a href="https://code0xff.org/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">读书笔记 </a>
    
</div>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">RSS</h3>
        <ul class="widget-list">
            <li><a href="https://code0xff.org/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
    <footer id="footer">
    <div>
        &copy; 2025 <a href="https://code0xff.org/">记录每个瞬间 By 老王</a>
        
    </div>
    <br />
    <div>
        <div class="github-badge">
            <a href="https://gohugo.io/" target="_black" rel="nofollow"><span class="badge-subject">Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
        </div>
        <div class="github-badge">
            <a href="https://github.com/flysnow-org/maupassant-hugo" target="_black"><span class="badge-subject">Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
        </div>
    </div>
</footer>


    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script><script src="https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'GA ID', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



    <script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>




</body>

</html>