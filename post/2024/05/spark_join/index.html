<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="referrer" content="no-referrer-when-downgrade">
    

    <title>Spark原理-JOIN | 记录每个瞬间</title>
    <meta property="og:title" content="Spark原理-JOIN - 记录每个瞬间">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2024-04-27T09:08:07&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2024-04-27T09:08:07&#43;08:00'>
        
    <meta name="Keywords" content="">
    <meta name="description" content="Spark原理-JOIN">
        <meta name="author" content="隔壁老王">
        
    <meta property="og:url" content="https://code0xff.org/post/2024/05/spark_join/">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    
    
        <link href="https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" rel="stylesheet">
    
    
    
    
</head>


<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://code0xff.org/">
                        记录每个瞬间
                    </a>
                
                
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="https://code0xff.org/">首页</a>
                    
                    <a  href="https://code0xff.org/linked/" title="链接">链接</a>
                    
                    <a  href="https://code0xff.org/archives/" title="归档">归档</a>
                    
                    <a  href="https://code0xff.org/about/" title="关于">关于</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    
    <article class="post">
        <header>
            <h1 class="post-title">Spark原理-JOIN</h1>
        </header>
        <date class="post-meta meta-date">
            2024年4月27日
        </date>
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#基础原理">基础原理</a></li>
        <li><a href="#解析">解析</a></li>
        <li><a href="#生成物理计划">生成物理计划</a>
          <ul>
            <li><a href="#父类-hashjoin">父类 HashJoin</a></li>
          </ul>
        </li>
        <li><a href="#join-的执行">JOIN 的执行</a>
          <ul>
            <li><a href="#broadcast-hash-join">Broadcast Hash Join</a></li>
            <li><a href="#shuffle-hash-join">Shuffle Hash Join</a></li>
            <li><a href="#shuffle-sort-merge-join">Shuffle Sort Merge Join</a>
              <ul>
                <li><a href="#sortmergejoinscanner">SortMergeJoinScanner</a></li>
                <li><a href="#sortmergefullouterjoinscanner">SortMergeFullOuterJoinScanner</a></li>
              </ul>
            </li>
            <li><a href="#broadcastnestedloopjoinexec">BroadcastNestedLoopJoinExec</a></li>
            <li><a href="#cartesianproduct">CartesianProduct</a></li>
          </ul>
        </li>
        <li><a href="#参考">参考</a></li>
      </ul>
    </li>
  </ul>
</nav>
        
        <div class="post-meta">
            
            <span class="post-meta meta-tags">
                <ul class="clearfix">
                    <a href='/categories/%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90'>原理分析</a>
                </ul>
            </span>
            
        </div>
        
        
        <div class="post-meta">
            <span id="busuanzi_container_page_pv">|<span id="busuanzi_value_page_pv"></span><span>
                    阅读</span></span>
        </div>
        
        
        <div class="post-content">
            <h2 id="基础原理">基础原理</h2>
<p>JOIN 的语法定义<br>

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/02/7Kiac4.jpg">
            <img class="mx-auto" alt="1" src="https://v1.ax1x.com/2024/05/02/7Kiac4.jpg" />
        </a>
    </p>
<p>Spark SQL中支持的 Join类型主要包括</p>
<ul>
<li>Inner</li>
<li>FullOuter</li>
<li>LeftOuter</li>
<li>RightOuter</li>
<li>LeftSemi</li>
<li>LeftAnti</li>
<li>Cross</li>
</ul>
<p>Spark SQL支持的Join类型

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/02/7KivQm.jpg">
            <img class="mx-auto" alt="2" src="https://v1.ax1x.com/2024/05/02/7KivQm.jpg" />
        </a>
    </p>
<p>各种 JOIN 类型图形表示：<br>

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/02/7KiDnh.jpg">
            <img class="mx-auto" alt="3" src="https://v1.ax1x.com/2024/05/02/7KiDnh.jpg" />
        </a>
    </p>
<p>语法解析后的 AST<br>

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/03/7Ki1zH.jpg">
            <img class="mx-auto" alt="4" src="https://v1.ax1x.com/2024/05/03/7Ki1zH.jpg" />
        </a>
    </p>
<p>SEMI 等价写法</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> student.id <span style="color:#ff79c6">FROM</span> student <span style="color:#ff79c6">LEFT</span> SEMI <span style="color:#ff79c6">JOIN</span>  exam
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">ON</span> student.id <span style="color:#ff79c6">=</span> exam.studentID
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">-- 等价于
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">SELECT</span> id <span style="color:#ff79c6">FROM</span> student <span style="color:#ff79c6">WHERE</span> id <span style="color:#ff79c6">IN</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">SELECT</span> studentId <span style="color:#ff79c6">FROM</span> exam
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>ANTI JOIN 等价写法</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> student.id <span style="color:#ff79c6">FROM</span> student  <span style="color:#ff79c6">LEFT</span> ANTI <span style="color:#ff79c6">JOIN</span>  exam
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">ON</span> student.id <span style="color:#ff79c6">=</span> exam.studentID
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">-- 等价于
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">SELECT</span> id <span style="color:#ff79c6">FROM</span> student <span style="color:#ff79c6">WHERE</span> id <span style="color:#ff79c6">NOT</span> <span style="color:#ff79c6">IN</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">SELECT</span> studentId <span style="color:#ff79c6">FROM</span> exam
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></td></tr></table>
</div>
</div><p>关闭 codegen</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>    spark <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">SparkSession</span><span style="color:#ff79c6">.</span>builder
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">.</span>master<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;local[*]&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">.</span>appName<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;my_test&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">.</span>config<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;spark.sql.codegen.wholeStage&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;false&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">.</span>getOrCreate
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="解析">解析</h2>
<p>JOIN type 的类图<br>

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/03/7KiPoZ.jpg">
            <img class="mx-auto" alt="5" src="https://v1.ax1x.com/2024/05/03/7KiPoZ.jpg" />
        </a>
    </p>
<p>JOIN 逻辑算子节点</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#6272a4">// 变量
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>lfet<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">LogicalPlan</span>
</span></span><span style="display:flex;"><span>right<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">LogicalPlan</span>
</span></span><span style="display:flex;"><span>joinType<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">JoinType</span>
</span></span><span style="display:flex;"><span>condition<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Option</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Expression</span><span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// 函数
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">def</span> resolvedExceptNatural<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Boolean</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> resolved<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Boolean</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> statistics<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Statistics</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> output<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Seq</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Attribute</span><span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> validConstrains<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Set</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Expression</span><span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> duplicateResolved<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Boolean</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>未解析的逻辑 计划 -&gt; 解析后的 logicalPlan<br>

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/03/7KiYHU.jpg">
            <img class="mx-auto" alt="6" src="https://v1.ax1x.com/2024/05/03/7KiYHU.jpg" />
        </a>
    </p>
<p>Elim inateSubqueryAliases优化规则，如下：<br>

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/03/7Kit2s.jpg">
            <img class="mx-auto" alt="7" src="https://v1.ax1x.com/2024/05/03/7Kit2s.jpg" />
        </a>
    </p>
<p>ColumnPruning优化规则 应用后如下：<br>

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/03/7Kir1q.jpg">
            <img class="mx-auto" alt="8" src="https://v1.ax1x.com/2024/05/03/7Kir1q.jpg" />
        </a>
    </p>
<p>InferFiltersFrom Constraints优化规则，如下：<br>

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/03/7Ki4Qa.jpg">
            <img class="mx-auto" alt="9" src="https://v1.ax1x.com/2024/05/03/7Ki4Qa.jpg" />
        </a>
    </p>
<p>PushPredicateThroughJoin优化规则，如下：   <br>

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/03/7KiCv7.jpg">
            <img class="mx-auto" alt="10" src="https://v1.ax1x.com/2024/05/03/7KiCv7.jpg" />
        </a>
    </p>
<p>PushDownPredicate优化规则，如下：<br>

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/03/7KiJnI.jpg">
            <img class="mx-auto" alt="11" src="https://v1.ax1x.com/2024/05/03/7KiJnI.jpg" />
        </a>
    </p>
<h2 id="生成物理计划">生成物理计划</h2>
<p>三个策略：</p>
<ul>
<li>文件数据源（FileSource）策略，选择具体的 scan 物理算子</li>
<li>基本算子（BasicOperators）策略，做投影</li>
<li>Join选择（JoinSelection），选择合适的 JOIN

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/03/7KijLV.jpg">
            <img class="mx-auto" alt="12" src="https://v1.ax1x.com/2024/05/03/7KijLV.jpg" />
        </a>
    </li>
</ul>
<p>Spark支持 这几种 join：</p>
<ul>
<li>BroadcastHashJoinExec</li>
<li>ShuffledHashJoinExec</li>
<li>SortMergeJoinExec</li>
<li>CartesianProductExec</li>
<li>BroadcastNestedLoopJoinExec</li>
</ul>
<p>5 种 JOIN 执行效率<br>

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/04/30/7KcBej.jpg">
            <img class="mx-auto" alt="" src="https://v1.ax1x.com/2024/04/30/7KcBej.jpg" />
        </a>
    </p>
<p>它们是来自 2 种数据分发方式（广播和 Shuffle）与 3 种 Join 实现机制（Hash Joins、Sort Merge Joins 和 Nested Loop Joins）的排列组合<br>

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/04/30/7KcLs4.jpg">
            <img class="mx-auto" alt="" src="https://v1.ax1x.com/2024/04/30/7KcLs4.jpg" />
        </a>
    </p>
<p>The Join strategy selection takes three factors into account, including:</p>
<ul>
<li>Join type is equi-join or not</li>
<li>Join strategy hint</li>
<li>Size of Join relations</li>
</ul>
<p>三种选择策略判断逻辑<br>

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/03/7KinxL.png">
            <img class="mx-auto" alt="13" src="https://v1.ax1x.com/2024/05/03/7KinxL.png" />
        </a>
    <br>
图片来自<a href="https://dataninjago.com/2022/01/11/spark-sql-query-engine-deep-dive-11-join-strategies/">这里</a></p>
<p>Equi-Join vs Not</p>
<ul>
<li>不相等 就是：&lt;, &gt;, &gt;=, &lt;= 这些比较方式</li>
<li>not equi 只有：BroadcastNestedLoopJoinExec，CartesianProductExec 支持</li>
<li>所有的 5 个join 类型都支持 等值 join</li>
</ul>
<p>在 join 选择策略时，用<code>ExtractEquiJoinKeys </code> 来提取 join 的相关新</p>
<ul>
<li>join type</li>
<li>left keys</li>
<li>right keys</li>
<li>join condition</li>
<li>left join relation</li>
<li>right join relation</li>
<li>join hint</li>
</ul>
<p>ExtractEquiJoinKeys 的主要定义</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">object</span> <span style="color:#50fa7b">ExtractEquiJoinKeys</span> <span style="color:#ff79c6">extends</span> <span style="color:#50fa7b">Logging</span> <span style="color:#ff79c6">with</span> <span style="color:#50fa7b">PredicateHelper</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">/** (joinType, leftKeys, rightKeys, otherCondition, conditionOnJoinKeys, leftChild,
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">   * rightChild, joinHint).
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">   */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">// Note that `otherCondition` is NOT the original Join condition and it contains only
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// the subset that is not handled by the &#39;leftKeys&#39; to &#39;rightKeys&#39; equijoin.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// &#39;conditionOnJoinKeys&#39; is the subset of the original Join condition that corresponds to the
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#6272a4">// &#39;leftKeys&#39; to &#39;rightKeys&#39; equijoin.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#ff79c6">type</span> <span style="color:#8be9fd">ReturnType</span> <span style="color:#ff79c6">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">(</span><span style="color:#50fa7b">JoinType</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">Seq</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Expression</span><span style="color:#ff79c6">],</span> <span style="color:#50fa7b">Seq</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Expression</span><span style="color:#ff79c6">],</span>
</span></span><span style="display:flex;"><span>      <span style="color:#50fa7b">Option</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Expression</span><span style="color:#ff79c6">],</span> <span style="color:#50fa7b">Option</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Expression</span><span style="color:#ff79c6">],</span> <span style="color:#50fa7b">LogicalPlan</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">LogicalPlan</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">JoinHint</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>	  
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">def</span> unapply<span style="color:#ff79c6">(</span>join<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Join</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Option</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">ReturnType</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> join <span style="color:#ff79c6">match</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>     。。。  
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">}</span> 
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#6272a4">/**
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> * The enumeration of join strategy hints.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> *
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> * The hinted strategy will be used for the join with which it is associated if doable. In case
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> * of contradicting strategy hints specified for each side of the join, hints are prioritized as
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> * BROADCAST over SHUFFLE_MERGE over SHUFFLE_HASH over SHUFFLE_REPLICATE_NL.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">object</span> <span style="color:#50fa7b">JoinStrategyHint</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">val</span> strategies<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Set</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">JoinStrategyHint</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">Set</span><span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">BROADCAST</span><span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">SHUFFLE_MERGE</span><span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">SHUFFLE_HASH</span><span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">SHUFFLE_REPLICATE_NL</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>hint 语法：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> <span style="color:#6272a4">/*+ BROADCAST(a) */</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> people <span style="color:#ff79c6">AS</span> a <span style="color:#ff79c6">JOIN</span> employee <span style="color:#ff79c6">AS</span> b
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">ON</span> a.id <span style="color:#ff79c6">=</span> b.id
</span></span></code></pre></td></tr></table>
</div>
</div><p>从未解析的计划 &ndash;&gt; 解析后的 &ndash;&gt; 优化后的 &ndash;&gt; 物理计划</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#ff79c6">==</span> Parsed Logical <span style="color:#8be9fd;font-style:italic">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#39;UnresolvedHint BROADCAST, [&#39;</span>a<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>+- <span style="color:#f1fa8c">&#39;Project [*]
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">   +- &#39;</span>Join Inner, <span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#39;a.id = &#39;</span>b.id<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      :- <span style="color:#f1fa8c">&#39;SubqueryAlias a
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">      :  +- &#39;</span>UnresolvedRelation <span style="color:#ff79c6">[</span>people<span style="color:#ff79c6">]</span>, <span style="color:#ff79c6">[]</span>, <span style="color:#8be9fd;font-style:italic">false</span>
</span></span><span style="display:flex;"><span>      +- <span style="color:#f1fa8c">&#39;SubqueryAlias b
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">         +- &#39;</span>UnresolvedRelation <span style="color:#ff79c6">[</span>employee<span style="color:#ff79c6">]</span>, <span style="color:#ff79c6">[]</span>, <span style="color:#8be9fd;font-style:italic">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">==</span> Analyzed Logical <span style="color:#8be9fd;font-style:italic">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span>age: bigint, id: string, name: string, id: string, name: string, salary: bigint
</span></span><span style="display:flex;"><span>Project <span style="color:#ff79c6">[</span>age#6L, id#7, name#8, id#18, name#19, salary#20L<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>+- Join Inner, <span style="color:#ff79c6">(</span>id#7 <span style="color:#ff79c6">=</span> id#18<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>   :- ResolvedHint <span style="color:#ff79c6">(</span><span style="color:#8be9fd;font-style:italic">strategy</span><span style="color:#ff79c6">=</span>broadcast<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>   :  +- SubqueryAlias a
</span></span><span style="display:flex;"><span>   :     +- SubqueryAlias people
</span></span><span style="display:flex;"><span>   :        +- View <span style="color:#ff79c6">(</span><span style="color:#f1fa8c">`</span>people<span style="color:#f1fa8c">`</span>, <span style="color:#ff79c6">[</span>age#6L,id#7,name#8<span style="color:#ff79c6">])</span>
</span></span><span style="display:flex;"><span>   :           +- LogicalRDD <span style="color:#ff79c6">[</span>age#6L, id#7, name#8<span style="color:#ff79c6">]</span>, <span style="color:#8be9fd;font-style:italic">false</span>
</span></span><span style="display:flex;"><span>   +- SubqueryAlias b
</span></span><span style="display:flex;"><span>      +- SubqueryAlias employee
</span></span><span style="display:flex;"><span>         +- View <span style="color:#ff79c6">(</span><span style="color:#f1fa8c">`</span>employee<span style="color:#f1fa8c">`</span>, <span style="color:#ff79c6">[</span>id#18,name#19,salary#20L<span style="color:#ff79c6">])</span>
</span></span><span style="display:flex;"><span>            +- LogicalRDD <span style="color:#ff79c6">[</span>id#18, name#19, salary#20L<span style="color:#ff79c6">]</span>, <span style="color:#8be9fd;font-style:italic">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">==</span> Optimized Logical <span style="color:#8be9fd;font-style:italic">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span>Join Inner, <span style="color:#ff79c6">(</span>id#7 <span style="color:#ff79c6">=</span> id#18<span style="color:#ff79c6">)</span>, <span style="color:#8be9fd;font-style:italic">leftHint</span><span style="color:#ff79c6">=(</span><span style="color:#8be9fd;font-style:italic">strategy</span><span style="color:#ff79c6">=</span>broadcast<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>:- Filter isnotnull<span style="color:#ff79c6">(</span>id#7<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>:  +- LogicalRDD <span style="color:#ff79c6">[</span>age#6L, id#7, name#8<span style="color:#ff79c6">]</span>, <span style="color:#8be9fd;font-style:italic">false</span>
</span></span><span style="display:flex;"><span>+- Filter isnotnull<span style="color:#ff79c6">(</span>id#18<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>   +- LogicalRDD <span style="color:#ff79c6">[</span>id#18, name#19, salary#20L<span style="color:#ff79c6">]</span>, <span style="color:#8be9fd;font-style:italic">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">==</span> Physical <span style="color:#8be9fd;font-style:italic">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span>AdaptiveSparkPlan <span style="color:#8be9fd;font-style:italic">isFinalPlan</span><span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">false</span>
</span></span><span style="display:flex;"><span>+- BroadcastHashJoin <span style="color:#ff79c6">[</span>id#7<span style="color:#ff79c6">]</span>, <span style="color:#ff79c6">[</span>id#18<span style="color:#ff79c6">]</span>, Inner, BuildLeft, <span style="color:#8be9fd;font-style:italic">false</span>
</span></span><span style="display:flex;"><span>   :- BroadcastExchange HashedRelationBroadcastMode<span style="color:#ff79c6">(</span>List<span style="color:#ff79c6">(</span>input<span style="color:#ff79c6">[</span>1, string, false<span style="color:#ff79c6">])</span>,false<span style="color:#ff79c6">)</span>, <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">plan_id</span><span style="color:#ff79c6">=</span>115<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>   :  +- Filter isnotnull<span style="color:#ff79c6">(</span>id#7<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>   :     +- Scan ExistingRDD<span style="color:#ff79c6">[</span>age#6L,id#7,name#8<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>   +- Filter isnotnull<span style="color:#ff79c6">(</span>id#18<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      +- Scan ExistingRDD<span style="color:#ff79c6">[</span>id#18,name#19,salary#20L<span style="color:#ff79c6">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>等值 join 的选择策略，如下：<br>

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/03/7KiIzJ.jpg">
            <img class="mx-auto" alt="14" src="https://v1.ax1x.com/2024/05/03/7KiIzJ.jpg" />
        </a>
    </p>
<p>有效的 join hint基于如下：</p>
<ul>
<li>For BROADCAST hint, select the BroadcastHashJoinExec operator. when BROADCAST hint is specified on both sides of the join, select the smaller side.</li>
<li>For SUFFLE_HASH hint, select the ShuffledHashJoinExec operator. when SUFFLE_HASH hint is specified on both sides of the join, select the smaller side.</li>
<li>For SUFFLE_MERGE hint, select the SortMergeJoinExec operator if the join keys are sortable.</li>
<li>For SUFFLE_REPLICATE_NL, select the CartesianProductExec operator if join type is inner like.</li>
</ul>
<p>如果未指定连接提示或未满足指定连接提示的连接条件，则选择流将沿决策树向下移动</p>
<h3 id="父类-hashjoin">父类 HashJoin</h3>
<p>HashJoin</p>
<ul>
<li>根据数据表的角色不同分为streamedTable流式表和BuildTable构建表</li>
<li>通常将大表设定为流式表，将小表设定为构建表</li>
<li>在一次Build过程中，流式表迭代器streamedlter遍历流式表的每条记录，然后在构建表迭代器buildlter中查找相匹配的记录</li>
<li>每次Build的结果为一条JoinedRow(left, right)。如果left来自streamedlter，right来自buildlter，则为BuildRight操作</li>
<li>如果right来自 streamedlter，left来自 buildlter，则为BuildLeft操作</li>
</ul>
<p>Join操作的基本流程<br>

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/04/7Kis1t.jpg">
            <img class="mx-auto" alt="15" src="https://v1.ax1x.com/2024/05/04/7Kis1t.jpg" />
        </a>
    </p>
<p>join 类型不同，输出也不同，这是由 output 函数控制的</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>  <span style="color:#ff79c6">override</span> <span style="color:#ff79c6">def</span> output<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Seq</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Attribute</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    joinType <span style="color:#ff79c6">match</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">case</span> <span style="color:#ff79c6">_:</span> <span style="color:#8be9fd">InnerLike</span> <span style="color:#ff79c6">=&gt;</span>
</span></span><span style="display:flex;"><span>        left<span style="color:#ff79c6">.</span>output <span style="color:#ff79c6">++</span> right<span style="color:#ff79c6">.</span>output
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">case</span> <span style="color:#50fa7b">LeftOuter</span> <span style="color:#ff79c6">=&gt;</span>
</span></span><span style="display:flex;"><span>        left<span style="color:#ff79c6">.</span>output <span style="color:#ff79c6">++</span> right<span style="color:#ff79c6">.</span>output<span style="color:#ff79c6">.</span>map<span style="color:#ff79c6">(</span><span style="color:#ff79c6">_</span><span style="color:#ff79c6">.</span>withNullability<span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">))</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">case</span> <span style="color:#50fa7b">RightOuter</span> <span style="color:#ff79c6">=&gt;</span>
</span></span><span style="display:flex;"><span>        left<span style="color:#ff79c6">.</span>output<span style="color:#ff79c6">.</span>map<span style="color:#ff79c6">(</span><span style="color:#ff79c6">_</span><span style="color:#ff79c6">.</span>withNullability<span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">))</span> <span style="color:#ff79c6">++</span> right<span style="color:#ff79c6">.</span>output
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">case</span> j<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">ExistenceJoin</span> <span style="color:#ff79c6">=&gt;</span>
</span></span><span style="display:flex;"><span>        left<span style="color:#ff79c6">.</span>output <span style="color:#ff79c6">:</span><span style="color:#8be9fd">+</span> <span style="color:#8be9fd">j.exists</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">case</span> <span style="color:#50fa7b">LeftExistence</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">_</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">=&gt;</span>
</span></span><span style="display:flex;"><span>        left<span style="color:#ff79c6">.</span>output
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">case</span> x <span style="color:#ff79c6">=&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">throw</span> <span style="color:#ff79c6">new</span> <span style="color:#50fa7b">IllegalArgumentException</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">s&#34;HashJoin should not take </span><span style="color:#f1fa8c">$x</span><span style="color:#f1fa8c"> as the JoinType&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>outputPartitioning()</p>
<ul>
<li>输出数据的分区模式，由streamedPlan决定</li>
</ul>
<p>不同类型 join 的执行：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>  <span style="color:#ff79c6">protected</span> <span style="color:#ff79c6">def</span> join<span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span>      streamedIter<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Iterator</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">InternalRow</span><span style="color:#ff79c6">],</span>
</span></span><span style="display:flex;"><span>      hashed<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">HashedRelation</span><span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span>      numOutputRows<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">SQLMetric</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Iterator</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">InternalRow</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">val</span> joinedIter <span style="color:#ff79c6">=</span> joinType <span style="color:#ff79c6">match</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">case</span> <span style="color:#ff79c6">_:</span> <span style="color:#8be9fd">InnerLike</span> <span style="color:#ff79c6">=&gt;</span>
</span></span><span style="display:flex;"><span>        innerJoin<span style="color:#ff79c6">(</span>streamedIter<span style="color:#ff79c6">,</span> hashed<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">case</span> <span style="color:#50fa7b">LeftOuter</span> <span style="color:#ff79c6">|</span> <span style="color:#50fa7b">RightOuter</span> <span style="color:#ff79c6">=&gt;</span>
</span></span><span style="display:flex;"><span>        outerJoin<span style="color:#ff79c6">(</span>streamedIter<span style="color:#ff79c6">,</span> hashed<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">case</span> <span style="color:#50fa7b">LeftSemi</span> <span style="color:#ff79c6">=&gt;</span>
</span></span><span style="display:flex;"><span>        semiJoin<span style="color:#ff79c6">(</span>streamedIter<span style="color:#ff79c6">,</span> hashed<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">case</span> <span style="color:#50fa7b">LeftAnti</span> <span style="color:#ff79c6">=&gt;</span>
</span></span><span style="display:flex;"><span>        antiJoin<span style="color:#ff79c6">(</span>streamedIter<span style="color:#ff79c6">,</span> hashed<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">case</span> <span style="color:#ff79c6">_:</span> <span style="color:#8be9fd">ExistenceJoin</span> <span style="color:#ff79c6">=&gt;</span>
</span></span><span style="display:flex;"><span>        existenceJoin<span style="color:#ff79c6">(</span>streamedIter<span style="color:#ff79c6">,</span> hashed<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">case</span> x <span style="color:#ff79c6">=&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">throw</span> <span style="color:#ff79c6">new</span> <span style="color:#50fa7b">IllegalArgumentException</span><span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f1fa8c">s&#34;HashJoin should not take </span><span style="color:#f1fa8c">$x</span><span style="color:#f1fa8c"> as the JoinType&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">val</span> resultProj <span style="color:#ff79c6">=</span> createResultProjection
</span></span><span style="display:flex;"><span>    joinedIter<span style="color:#ff79c6">.</span>map <span style="color:#ff79c6">{</span> r <span style="color:#ff79c6">=&gt;</span>
</span></span><span style="display:flex;"><span>      numOutputRows <span style="color:#ff79c6">+=</span> <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>      resultProj<span style="color:#ff79c6">(</span>r<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>JoinedRow 的结构</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#ff79c6">class</span> <span style="color:#50fa7b">JoinedRow</span> <span style="color:#ff79c6">extends</span> <span style="color:#50fa7b">InternalRow</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">private</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">this</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">var</span> row1<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">InternalRow</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">_</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">private</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">this</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">var</span> row2<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">InternalRow</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">_</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>私有函数 InnerLike（innter 和 cross） 执行过</p>
<ul>
<li>对应的JoinType为Inner和Cross。hashedRelation对应的是构建表的HashMap结构</li>
<li>遍历流式表，将连接键相同的构建表的行与流式表的当前行组合成JoinedRow，流式表的一行可能和多个构建表的行对应</li>
<li>从代码中可以看出此函数中对JoinRow进行了复用，如果直接物化返回的迭代器将会导致重复</li>
<li>但是由于函数返回的是迭代器类型，最后进行计算ResultTask时，遍历innerJoin()返回的迭代器的同时从内存中取出对应数据，这样就不会产生重复</li>
</ul>
<p>outerJoin()</p>
<ul>
<li>对应的JoinType为LeftOuter和RightOuter</li>
<li>如果流式表中的连接键在构建表中没有，则会返回流式表对应行和空值连接的行。其余情况与innerJoin()一致</li>
</ul>
<p>semiJoin()</p>
<ul>
<li>对应的JoinType为LeftSemi</li>
<li>当流式表的连接键不为空且构建表中存在对应的行时，返回流式表的行</li>
</ul>
<p>antiJoin()</p>
<ul>
<li>对应的JoinType为LeftAnti</li>
<li>当流式表的连接键不为空且构建表中不存在对应的行时，返回流式表的行</li>
</ul>
<p>HashJoin 的 doConsume()，用于生成 code gen 过程：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>  <span style="color:#ff79c6">override</span> <span style="color:#ff79c6">def</span> doConsume<span style="color:#ff79c6">(</span>ctx<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">CodegenContext</span><span style="color:#ff79c6">,</span> input<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Seq</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">ExprCode</span><span style="color:#ff79c6">],</span> row<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">ExprCode</span><span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">String</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    joinType <span style="color:#ff79c6">match</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">case</span> <span style="color:#ff79c6">_:</span> <span style="color:#8be9fd">InnerLike</span> <span style="color:#ff79c6">=&gt;</span> codegenInner<span style="color:#ff79c6">(</span>ctx<span style="color:#ff79c6">,</span> input<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">case</span> <span style="color:#50fa7b">LeftOuter</span> <span style="color:#ff79c6">|</span> <span style="color:#50fa7b">RightOuter</span> <span style="color:#ff79c6">=&gt;</span> codegenOuter<span style="color:#ff79c6">(</span>ctx<span style="color:#ff79c6">,</span> input<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">case</span> <span style="color:#50fa7b">LeftSemi</span> <span style="color:#ff79c6">=&gt;</span> codegenSemi<span style="color:#ff79c6">(</span>ctx<span style="color:#ff79c6">,</span> input<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">case</span> <span style="color:#50fa7b">LeftAnti</span> <span style="color:#ff79c6">=&gt;</span> codegenAnti<span style="color:#ff79c6">(</span>ctx<span style="color:#ff79c6">,</span> input<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">case</span> <span style="color:#ff79c6">_:</span> <span style="color:#8be9fd">ExistenceJoin</span> <span style="color:#ff79c6">=&gt;</span> codegenExistence<span style="color:#ff79c6">(</span>ctx<span style="color:#ff79c6">,</span> input<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">case</span> x <span style="color:#ff79c6">=&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">throw</span> <span style="color:#ff79c6">new</span> <span style="color:#50fa7b">IllegalArgumentException</span><span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f1fa8c">s&#34;HashJoin should not take </span><span style="color:#f1fa8c">$x</span><span style="color:#f1fa8c"> as the JoinType&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>几个 join 的类图<br>

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/04/7KioL6.jpg">
            <img class="mx-auto" alt="20" src="https://v1.ax1x.com/2024/05/04/7KioL6.jpg" />
        </a>
    </p>
<h2 id="join-的执行">JOIN 的执行</h2>
<h3 id="broadcast-hash-join">Broadcast Hash Join</h3>
<p>测试代码：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>  test<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;broadcast json data test&#34;</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">val</span> peopleData <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">Seq</span><span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f1fa8c">&#34;&#34;&#34;{&#34;id&#34;:1,&#34;name&#34;:&#34;Michael&#34;}&#34;&#34;&#34;</span><span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f1fa8c">&#34;&#34;&#34;{&#34;id&#34;:2,&#34;name&#34;:&#34;Andy&#34;, &#34;age&#34;:30}&#34;&#34;&#34;</span><span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f1fa8c">&#34;&#34;&#34;{&#34;id&#34;:3,&#34;name&#34;:&#34;Justin&#34;, &#34;age&#34;:19}&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">val</span> employeeData <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">Seq</span><span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f1fa8c">&#34;&#34;&#34;{&#34;id&#34;:1,&#34;name&#34;:&#34;Michael&#34;, &#34;salary&#34;:3000}&#34;&#34;&#34;</span><span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f1fa8c">&#34;&#34;&#34;{&#34;id&#34;:2,&#34;name&#34;:&#34;Andy&#34;, &#34;salary&#34;:4500}&#34;&#34;&#34;</span><span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f1fa8c">&#34;&#34;&#34;{&#34;id&#34;:3,&#34;name&#34;:&#34;Justin&#34;, &#34;salary&#34;:3500}&#34;&#34;&#34;</span><span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f1fa8c">&#34;&#34;&#34;{&#34;id&#34;:4,&#34;name&#34;:&#34;Berta&#34;, &#34;salary&#34;:4000}&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    spark<span style="color:#ff79c6">.</span>read<span style="color:#ff79c6">.</span>json<span style="color:#ff79c6">(</span>spark<span style="color:#ff79c6">.</span>sparkContext<span style="color:#ff79c6">.</span>parallelize<span style="color:#ff79c6">(</span>peopleData<span style="color:#ff79c6">)).</span>createTempView<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;people&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>    spark<span style="color:#ff79c6">.</span>read<span style="color:#ff79c6">.</span>json<span style="color:#ff79c6">(</span>spark<span style="color:#ff79c6">.</span>sparkContext<span style="color:#ff79c6">.</span>parallelize<span style="color:#ff79c6">(</span>employeeData<span style="color:#ff79c6">)).</span>createTempView<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;employee&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">val</span> df <span style="color:#ff79c6">=</span> spark<span style="color:#ff79c6">.</span>sql<span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f1fa8c">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        |SELECT /*+ BROADCAST(a) */
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        |* FROM people AS a JOIN employee AS b
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        |ON a.id = b.id
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        |&#34;&#34;&#34;</span><span style="color:#ff79c6">.</span>stripMargin<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>    df<span style="color:#ff79c6">.</span>show<span style="color:#ff79c6">()</span>
</span></span><span style="display:flex;"><span>    df<span style="color:#ff79c6">.</span>explain<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;extended&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>广播之前，需要确保子节点满足需求<code>requiredChildDistribution </code>，增加 BroadcastExchange 节点</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>  <span style="color:#ff79c6">override</span> <span style="color:#ff79c6">def</span> requiredChildDistribution<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Seq</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Distribution</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">val</span> mode <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">HashedRelationBroadcastMode</span><span style="color:#ff79c6">(</span>buildBoundKeys<span style="color:#ff79c6">,</span> isNullAwareAntiJoin<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>    buildSide <span style="color:#ff79c6">match</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">case</span> <span style="color:#50fa7b">BuildLeft</span> <span style="color:#ff79c6">=&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">BroadcastDistribution</span><span style="color:#ff79c6">(</span>mode<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">:</span><span style="color:#8be9fd">:</span> <span style="color:#8be9fd">UnspecifiedDistribution</span> <span style="color:#8be9fd">::</span> <span style="color:#8be9fd">Nil</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">case</span> <span style="color:#50fa7b">BuildRight</span> <span style="color:#ff79c6">=&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#50fa7b">UnspecifiedDistribution</span> <span style="color:#ff79c6">:</span><span style="color:#8be9fd">:</span> <span style="color:#8be9fd">BroadcastDistribution</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">mode</span><span style="color:#ff79c6">)</span> <span style="color:#8be9fd">::</span> <span style="color:#8be9fd">Nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>几个 Exchange 的关系  <br>

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/04/7Ki26b.jpg">
            <img class="mx-auto" alt="16" src="https://v1.ax1x.com/2024/05/04/7Ki26b.jpg" />
        </a>
    </p>
<p>增加需要的节点后的物理计划，此时多了<code>BroadcastExchange</code><br>
也就是把 people 广播出去</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#ff79c6">==</span> Physical <span style="color:#8be9fd;font-style:italic">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span>AdaptiveSparkPlan <span style="color:#8be9fd;font-style:italic">isFinalPlan</span><span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">false</span>
</span></span><span style="display:flex;"><span>+- BroadcastHashJoin <span style="color:#ff79c6">[</span>id#7L<span style="color:#ff79c6">]</span>, <span style="color:#ff79c6">[</span>id#18L<span style="color:#ff79c6">]</span>, Inner, BuildLeft, <span style="color:#8be9fd;font-style:italic">false</span>
</span></span><span style="display:flex;"><span>   :- BroadcastExchange HashedRelationBroadcastMode<span style="color:#ff79c6">(</span>List<span style="color:#ff79c6">(</span>input<span style="color:#ff79c6">[</span>1, bigint, false<span style="color:#ff79c6">])</span>,false<span style="color:#ff79c6">)</span>, <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">plan_id</span><span style="color:#ff79c6">=</span>115<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>   :  +- Filter isnotnull<span style="color:#ff79c6">(</span>id#7L<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>   :     +- Scan ExistingRDD<span style="color:#ff79c6">[</span>age#6L,id#7L,name#8<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>   +- Filter isnotnull<span style="color:#ff79c6">(</span>id#18L<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      +- Scan ExistingRDD<span style="color:#ff79c6">[</span>id#18L,name#19,salary#20L<span style="color:#ff79c6">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>当 BroadcastExchange 执行时，driver 会收集所有 executor 端的数据<br>

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/04/7KiFQe.jpg">
            <img class="mx-auto" alt="17" src="https://v1.ax1x.com/2024/05/04/7KiFQe.jpg" />
        </a>
    </p>
<p>这里有两个 广播的控制变量</p>
<ul>
<li>spark.sql.autoBroadcastJoinThreshold，控制 hash join 的广播阈值，默认 10M</li>
<li>MAX_BROADCAST_TABLE_ROWS，控制 broadcast exchange 时的阈值，默认约 341 million rows</li>
</ul>
<p>之后每个 executor 端都收到了 广播表，建立 BuildTable<br>
然遍历流表，再去 BuildTable 中查找是否匹配<br>

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/04/7KiZvP.jpg">
            <img class="mx-auto" alt="18" src="https://v1.ax1x.com/2024/05/04/7KiZvP.jpg" />
        </a>
    </p>
<p>BroadcastExchangeExec 的执行过程</p>
<ul>
<li>child.executeCollectIterator() 收集数据</li>
<li>sparkContext.broadcastInternal(relation, serializedOnly = true) 广播

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/04/7KidIw.jpg">
            <img class="mx-auto" alt="19" src="https://v1.ax1x.com/2024/05/04/7KidIw.jpg" />
        </a>
    </li>
</ul>
<p>非 code-gen执行时，会用到 SparkPlan 的 execute()</p>
<ul>
<li>execute 中会先调用 executeQuery，这里会做一些 prepare 的动作</li>
<li>prepare 中调用 doPrepare，由子类完成具体的准备</li>
<li>execute 再调用子类的 doExecute，执行具体操作</li>
</ul>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>  <span style="color:#ff79c6">final</span> <span style="color:#ff79c6">def</span> execute<span style="color:#ff79c6">()</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">RDD</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">InternalRow</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> executeQuery <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>isCanonicalizedPlan<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">throw</span> <span style="color:#50fa7b">SparkException</span><span style="color:#ff79c6">.</span>internalError<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;A canonicalized plan is not supposed to be executed.&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    doExecute<span style="color:#ff79c6">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">protected</span> <span style="color:#ff79c6">final</span> <span style="color:#ff79c6">def</span> executeQuery<span style="color:#ff79c6">[</span><span style="color:#8be9fd">T</span><span style="color:#ff79c6">](</span>query<span style="color:#ff79c6">:</span> <span style="color:#ff79c6">=&gt;</span> T<span style="color:#ff79c6">)</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">T</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#50fa7b">RDDOperationScope</span><span style="color:#ff79c6">.</span>withScope<span style="color:#ff79c6">(</span>sparkContext<span style="color:#ff79c6">,</span> nodeName<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>      prepare<span style="color:#ff79c6">()</span>
</span></span><span style="display:flex;"><span>      waitForSubqueries<span style="color:#ff79c6">()</span>
</span></span><span style="display:flex;"><span>      query
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里会使用<code>HashedRelation</code>类，它有两个子类</p>
<ul>
<li>LongHashedRelation</li>
<li>UnsafeHashedRelation</li>
</ul>
<p>执行过程如下（非 codegen 模式）：</p>
<ul>
<li>首先由 AdaptiveSparkPlanExec 触发，经过SparkPlan一些通用函数后</li>
<li>调用到 BroadcastHashJoinExec，这个类再委托 SparkPlan，调用 doExecuteBroadcast</li>
<li>然后由 BroadcastExchangeExec 负责执行广播，这个类又会调用到 TorrentBroadcast，最后由 BlockManager 负责读取本地、或者远程的数据块</li>
<li>回到 BroadcastHashJoinExec，它会调用子类 FilterExec、RDDScanExec 读取过滤数据</li>
<li>之后执行 join 算法，这块由父类 HashJoin 统一执行</li>
<li>遍历流表，然后从 LongToUnsafeRowMap 这个hash 表中读取数据做匹配</li>
</ul>
<p>
        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/05/7KsN59.jpg">
            <img class="mx-auto" alt="27" src="https://v1.ax1x.com/2024/05/05/7KsN59.jpg" />
        </a>
    </p>
<h3 id="shuffle-hash-join">Shuffle Hash Join</h3>
<p>测试代码：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>    <span style="color:#ff79c6">val</span> df <span style="color:#ff79c6">=</span> spark<span style="color:#ff79c6">.</span>sql<span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f1fa8c">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        |SELECT /*+ SHUFFLE_HASH(a) */
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        |* FROM people AS a JOIN employee AS b
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        |ON a.id = b.id
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        |&#34;&#34;&#34;</span><span style="color:#ff79c6">.</span>stripMargin<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>    df3<span style="color:#ff79c6">.</span>show<span style="color:#ff79c6">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>生成的物理计划：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#ff79c6">==</span> Physical <span style="color:#8be9fd;font-style:italic">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span>AdaptiveSparkPlan <span style="color:#8be9fd;font-style:italic">isFinalPlan</span><span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">false</span>
</span></span><span style="display:flex;"><span>+- ShuffledHashJoin <span style="color:#ff79c6">[</span>id#7L<span style="color:#ff79c6">]</span>, <span style="color:#ff79c6">[</span>id#18L<span style="color:#ff79c6">]</span>, Inner, BuildLeft
</span></span><span style="display:flex;"><span>   :- Exchange hashpartitioning<span style="color:#ff79c6">(</span>id#7L, 200<span style="color:#ff79c6">)</span>, ENSURE_REQUIREMENTS, <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">plan_id</span><span style="color:#ff79c6">=</span>142<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>   :  +- Filter isnotnull<span style="color:#ff79c6">(</span>id#7L<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>   :     +- Scan ExistingRDD<span style="color:#ff79c6">[</span>age#6L,id#7L,name#8<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>   +- Exchange hashpartitioning<span style="color:#ff79c6">(</span>id#18L, 200<span style="color:#ff79c6">)</span>, ENSURE_REQUIREMENTS, <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">plan_id</span><span style="color:#ff79c6">=</span>143<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>      +- Filter isnotnull<span style="color:#ff79c6">(</span>id#18L<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>         +- Scan ExistingRDD<span style="color:#ff79c6">[</span>id#18L,name#19,salary#20L<span style="color:#ff79c6">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>要求</p>
<ul>
<li>在外连接中，基表不能被广播</li>
<li>spark.sql.join.preferSortMergeJoin参数必须设置为 false</li>
<li>小表小于spark.sql.autoBroadcastJoinThreshold*spark.sql.shuffle.partitions</li>
<li>小表远远小于(muchSmaller())大表</li>
</ul>
<p>对于子节点的要求：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>  <span style="color:#ff79c6">override</span> <span style="color:#ff79c6">def</span> requiredChildDistribution<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Seq</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Distribution</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>isSkewJoin<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#6272a4">// We re-arrange the shuffle partitions to deal with skew join, and the new children
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>      <span style="color:#6272a4">// partitioning doesn&#39;t satisfy `HashClusteredDistribution`.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>      <span style="color:#50fa7b">UnspecifiedDistribution</span> <span style="color:#ff79c6">:</span><span style="color:#8be9fd">:</span> <span style="color:#8be9fd">UnspecifiedDistribution</span> <span style="color:#8be9fd">::</span> <span style="color:#8be9fd">Nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#50fa7b">ClusteredDistribution</span><span style="color:#ff79c6">(</span>leftKeys<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">:</span><span style="color:#8be9fd">:</span> <span style="color:#8be9fd">ClusteredDistribution</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">rightKeys</span><span style="color:#ff79c6">)</span> <span style="color:#8be9fd">::</span> <span style="color:#8be9fd">Nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Distribution 表示节点间的数据分布，其类的继承关系<br>

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/05/7KswkH.jpg">
            <img class="mx-auto" alt="28" src="https://v1.ax1x.com/2024/05/05/7KswkH.jpg" />
        </a>
    </p>
<p>选择策略：<br>

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/04/7Ksk4Q.jpg">
            <img class="mx-auto" alt="21" src="https://v1.ax1x.com/2024/05/04/7Ksk4Q.jpg" />
        </a>
    </p>
<p>需要节点的要求：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>  <span style="color:#ff79c6">override</span> <span style="color:#ff79c6">def</span> requiredChildDistribution<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Seq</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Distribution</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>isSkewJoin<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#6272a4">// We re-arrange the shuffle partitions to deal with skew join, and the new children
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>      <span style="color:#6272a4">// partitioning doesn&#39;t satisfy `HashClusteredDistribution`.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>      <span style="color:#50fa7b">UnspecifiedDistribution</span> <span style="color:#ff79c6">:</span><span style="color:#8be9fd">:</span> <span style="color:#8be9fd">UnspecifiedDistribution</span> <span style="color:#8be9fd">::</span> <span style="color:#8be9fd">Nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#50fa7b">ClusteredDistribution</span><span style="color:#ff79c6">(</span>leftKeys<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">:</span><span style="color:#8be9fd">:</span> <span style="color:#8be9fd">ClusteredDistribution</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">rightKeys</span><span style="color:#ff79c6">)</span> <span style="color:#8be9fd">::</span> <span style="color:#8be9fd">Nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>doExecute()</p>
<ul>
<li>doExecute()函数返回RDD[InternalRow]，显示了具体的运算逻辑</li>
<li>在调用prepareForExecution()进行准备工作时，会添加 Exchange物理计划对流式表和构建表分别进行shuffle，让两张表中拥有相同连接键哈希值的行分到相同的分区中</li>
<li>调用流式表物理计划的RDD[InternalRow]的zipPartitions()函数转化为新的RDD，在RDD内将构建表构造成HashedRelation，然后调用其父类的HashJoin.join()函数计算出Join后的行</li>
</ul>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>  <span style="color:#ff79c6">protected</span> <span style="color:#ff79c6">override</span> <span style="color:#ff79c6">def</span> doExecute<span style="color:#ff79c6">()</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">RDD</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">InternalRow</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">val</span> numOutputRows <span style="color:#ff79c6">=</span> longMetric<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;numOutputRows&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>    streamedPlan<span style="color:#ff79c6">.</span>execute<span style="color:#ff79c6">().</span>zipPartitions<span style="color:#ff79c6">(</span>buildPlan<span style="color:#ff79c6">.</span>execute<span style="color:#ff79c6">())</span> <span style="color:#ff79c6">{</span> <span style="color:#ff79c6">(</span>streamIter<span style="color:#ff79c6">,</span> buildIter<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">=&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">val</span> hashed <span style="color:#ff79c6">=</span> buildHashedRelation<span style="color:#ff79c6">(</span>buildIter<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      joinType <span style="color:#ff79c6">match</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">case</span> <span style="color:#50fa7b">FullOuter</span> <span style="color:#ff79c6">=&gt;</span> buildSideOrFullOuterJoin<span style="color:#ff79c6">(</span>streamIter<span style="color:#ff79c6">,</span> hashed<span style="color:#ff79c6">,</span> numOutputRows<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span>          isFullOuterJoin <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">case</span> <span style="color:#50fa7b">LeftOuter</span> <span style="color:#ff79c6">if</span> buildSide<span style="color:#ff79c6">.</span>equals<span style="color:#ff79c6">(</span><span style="color:#50fa7b">BuildLeft</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">=&gt;</span>
</span></span><span style="display:flex;"><span>          buildSideOrFullOuterJoin<span style="color:#ff79c6">(</span>streamIter<span style="color:#ff79c6">,</span> hashed<span style="color:#ff79c6">,</span> numOutputRows<span style="color:#ff79c6">,</span> isFullOuterJoin <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">case</span> <span style="color:#50fa7b">RightOuter</span> <span style="color:#ff79c6">if</span> buildSide<span style="color:#ff79c6">.</span>equals<span style="color:#ff79c6">(</span><span style="color:#50fa7b">BuildRight</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">=&gt;</span>
</span></span><span style="display:flex;"><span>          buildSideOrFullOuterJoin<span style="color:#ff79c6">(</span>streamIter<span style="color:#ff79c6">,</span> hashed<span style="color:#ff79c6">,</span> numOutputRows<span style="color:#ff79c6">,</span> isFullOuterJoin <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">case</span> <span style="color:#ff79c6">_</span> <span style="color:#ff79c6">=&gt;</span> join<span style="color:#ff79c6">(</span>streamIter<span style="color:#ff79c6">,</span> hashed<span style="color:#ff79c6">,</span> numOutputRows<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>执行过程：<br>

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/04/7Ks9xO.jpg">
            <img class="mx-auto" alt="22" src="https://v1.ax1x.com/2024/05/04/7Ks9xO.jpg" />
        </a>
    </p>
<p>具体执行时，分两部</p>
<ul>
<li>先物化，等待 shuffle 等结果</li>
<li>然后执行 shuffle hash</li>
</ul>
<p>第一步，materialize 的执行过程，比如执行广播等操作，调用者会执行 Future 等待其完成</p>
<ul>
<li>这里先由 AdaptiveSparkPlanExec 触发</li>
<li>之后调用到 ShuffleExchangeExec，执行 shuffle操作，然后每个分区内再执行 filter + scan<br>

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/05/7KsOqb.jpg">
            <img class="mx-auto" alt="30" src="https://v1.ax1x.com/2024/05/05/7KsOqb.jpg" />
        </a>
    </li>
</ul>
<p>在 ShuffledHashJoinExec#doExecute 中，获取 hash 端、流表端的时候，是通过 AQEShuffleRead 获取的<br>
hash 端，流表端都是通过 AQEShuffleRead 拿到的</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#50fa7b">AQEShuffleRead</span> coalesced
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">ShuffleQueryStage</span> <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Exchange</span> hashpartitioning<span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">7L</span><span style="color:#ff79c6">,</span> <span style="color:#bd93f9">200</span><span style="color:#ff79c6">),</span> <span style="color:#50fa7b">ENSURE_REQUIREMENTS</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">[</span><span style="color:#8be9fd">plan_id=</span>54<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Filter</span> isnotnull<span style="color:#ff79c6">(</span>id<span style="color:#ff79c6">#</span><span style="color:#bd93f9">7L</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>         <span style="color:#ff79c6">+-</span> <span style="color:#50fa7b">Scan</span> <span style="color:#50fa7b">ExistingRDD</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">age</span><span style="color:#ff79c6">#</span>6<span style="color:#8be9fd">L</span>,<span style="color:#8be9fd">id</span><span style="color:#ff79c6">#</span>7<span style="color:#8be9fd">L</span>,<span style="color:#8be9fd">name</span><span style="color:#ff79c6">#</span>8<span style="color:#ff79c6">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>第二步，执行过程如下（非 codegen 模式）：</p>
<ul>
<li>也是由 AdaptiveSparkPlanExec 触发</li>
<li>先是投影操作，然后到 ShuffleExchangeExec，之后委托 AQEShuffleReadExec 读取 shuffle 数据</li>
<li>等拿到数据后，就 build hash 关系，然后调用 join() 函数，这个是父类 HashJoin的函数</li>
<li>后面的流程跟 BroadcastHashJoinExec 调用的 join是类似的

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/05/7KsSae.jpg">
            <img class="mx-auto" alt="" src="https://v1.ax1x.com/2024/05/05/7KsSae.jpg" />
        </a>
    </li>
</ul>
<p>QueryStageExec 的继承关系</p>
<ul>
<li>查询阶段是查询计划的独立子图</li>
<li>AQE框架将在执行查询计划的其他操作符之前实现其输出</li>
<li>物化输出的数据统计信息可用于优化查询计划的其余部分

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/05/7KsaFt.jpg">
            <img class="mx-auto" alt="29" src="https://v1.ax1x.com/2024/05/05/7KsaFt.jpg" />
        </a>
    </li>
</ul>
<h3 id="shuffle-sort-merge-join">Shuffle Sort Merge Join</h3>
<p>测试代码：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>    <span style="color:#ff79c6">val</span> df <span style="color:#ff79c6">=</span> spark<span style="color:#ff79c6">.</span>sql<span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f1fa8c">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        |SELECT
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        |* FROM people AS a JOIN employee AS b
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        |ON a.id = b.id
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        |&#34;&#34;&#34;</span><span style="color:#ff79c6">.</span>stripMargin<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>    df<span style="color:#ff79c6">.</span>show<span style="color:#ff79c6">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>生成的物理计划：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#ff79c6">==</span> Physical <span style="color:#8be9fd;font-style:italic">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span>AdaptiveSparkPlan <span style="color:#8be9fd;font-style:italic">isFinalPlan</span><span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">false</span>
</span></span><span style="display:flex;"><span>+- SortMergeJoin <span style="color:#ff79c6">[</span>id#7L<span style="color:#ff79c6">]</span>, <span style="color:#ff79c6">[</span>id#18L<span style="color:#ff79c6">]</span>, Inner
</span></span><span style="display:flex;"><span>   :- Sort <span style="color:#ff79c6">[</span>id#7L ASC NULLS FIRST<span style="color:#ff79c6">]</span>, false, <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>   :  +- Exchange hashpartitioning<span style="color:#ff79c6">(</span>id#7L, 200<span style="color:#ff79c6">)</span>, ENSURE_REQUIREMENTS, <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">plan_id</span><span style="color:#ff79c6">=</span>136<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>   :     +- Filter isnotnull<span style="color:#ff79c6">(</span>id#7L<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>   :        +- Scan ExistingRDD<span style="color:#ff79c6">[</span>age#6L,id#7L,name#8<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>   +- Sort <span style="color:#ff79c6">[</span>id#18L ASC NULLS FIRST<span style="color:#ff79c6">]</span>, false, <span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>      +- Exchange hashpartitioning<span style="color:#ff79c6">(</span>id#18L, 200<span style="color:#ff79c6">)</span>, ENSURE_REQUIREMENTS, <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">plan_id</span><span style="color:#ff79c6">=</span>137<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>         +- Filter isnotnull<span style="color:#ff79c6">(</span>id#18L<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>            +- Scan ExistingRDD<span style="color:#ff79c6">[</span>id#18L,name#19,salary#20L<span style="color:#ff79c6">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>介绍</p>
<ul>
<li>当两个表的数据量都非常大时，会使用SortMergeJoin方式进行Join</li>
<li>对两张表参与Join的连接键使用相同的分区算法和分区数进行分区，目的就是保证相同的连接键的行都落到相同的分区里面</li>
<li>之后再对每个分区按照连接键进行排序，最后Reduce端获取两张表相同分区的数据进行Merge Join</li>
</ul>
<p>不满足BroadcastHashJoin和ShuffledHashJoin
只支持等值连接，并且要求参与Join的连接键可排序
选择过程

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/04/7KsmKc.png">
            <img class="mx-auto" alt="23" src="https://v1.ax1x.com/2024/05/04/7KsmKc.png" />
        </a>
    </p>
<p>对于子节点的要求：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>  <span style="color:#ff79c6">override</span> <span style="color:#ff79c6">def</span> requiredChildOrdering<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Seq</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Seq</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">SortOrder</span><span style="color:#ff79c6">]]</span> <span style="color:#ff79c6">=</span>
</span></span><span style="display:flex;"><span>    requiredOrders<span style="color:#ff79c6">(</span>leftKeys<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">:</span><span style="color:#8be9fd">:</span> <span style="color:#8be9fd">requiredOrders</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">rightKeys</span><span style="color:#ff79c6">)</span> <span style="color:#8be9fd">::</span> <span style="color:#8be9fd">Nil</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">private</span> <span style="color:#ff79c6">def</span> requiredOrders<span style="color:#ff79c6">(</span>keys<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Seq</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Expression</span><span style="color:#ff79c6">])</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Seq</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">SortOrder</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// This must be ascending in order to agree with the `keyOrdering` defined in `doExecute()`.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    keys<span style="color:#ff79c6">.</span>map<span style="color:#ff79c6">(</span><span style="color:#50fa7b">SortOrder</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">_</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">Ascending</span><span style="color:#ff79c6">))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>doExecute</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>  <span style="color:#ff79c6">protected</span> <span style="color:#ff79c6">override</span> <span style="color:#ff79c6">def</span> doExecute<span style="color:#ff79c6">()</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">RDD</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">InternalRow</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">val</span> numOutputRows <span style="color:#ff79c6">=</span> longMetric<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;numOutputRows&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">val</span> spillSize <span style="color:#ff79c6">=</span> longMetric<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;spillSize&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">val</span> spillThreshold <span style="color:#ff79c6">=</span> getSpillThreshold
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">val</span> inMemoryThreshold <span style="color:#ff79c6">=</span> getInMemoryThreshold
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">val</span> evaluatorFactory <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#50fa7b">SortMergeJoinEvaluatorFactory</span><span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span>      leftKeys<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span>      rightKeys<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span>      joinType<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span>      condition<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span>      left<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span>      right<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span>      output<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span>      inMemoryThreshold<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span>      spillThreshold<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span>      numOutputRows<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span>      spillSize<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span>      onlyBufferFirstMatchedRow
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>conf<span style="color:#ff79c6">.</span>usePartitionEvaluator<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>      left<span style="color:#ff79c6">.</span>execute<span style="color:#ff79c6">().</span>zipPartitionsWithEvaluator<span style="color:#ff79c6">(</span>right<span style="color:#ff79c6">.</span>execute<span style="color:#ff79c6">(),</span> evaluatorFactory<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>      left<span style="color:#ff79c6">.</span>execute<span style="color:#ff79c6">().</span>zipPartitions<span style="color:#ff79c6">(</span>right<span style="color:#ff79c6">.</span>execute<span style="color:#ff79c6">())</span> <span style="color:#ff79c6">{</span> <span style="color:#ff79c6">(</span>leftIter<span style="color:#ff79c6">,</span> rightIter<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">=&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">val</span> evaluator <span style="color:#ff79c6">=</span> evaluatorFactory<span style="color:#ff79c6">.</span>createEvaluator<span style="color:#ff79c6">()</span>
</span></span><span style="display:flex;"><span>        evaluator<span style="color:#ff79c6">.</span>eval<span style="color:#ff79c6">(</span><span style="color:#bd93f9">0</span><span style="color:#ff79c6">,</span> leftIter<span style="color:#ff79c6">,</span> rightIter<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>总结</p>
<ul>
<li>速度上可能没有 hash 的快，但是也比 nested loop join  更好，属于性能适中的</li>
<li>不需要全部加载到内存，所以对内存没有限制</li>
<li>StreamTable or BuildTable 对于 join 两边都合适，反正都不用放到内存中</li>
<li>两边都是使用迭代遍历的方式，遍历流表，然后遍历迭代表查找匹配的 结果</li>
</ul>
<p>执行过程：<br>

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/04/7KsT9f.png">
            <img class="mx-auto" alt="24" src="https://v1.ax1x.com/2024/05/04/7KsT9f.png" />
        </a>
    </p>
<p>时序图<br>
从分区读取数据的过程，跟 shuffle hash join 类似<br>

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/05/7KsOqb.jpg">
            <img class="mx-auto" alt="30" src="https://v1.ax1x.com/2024/05/05/7KsOqb.jpg" />
        </a>
    </p>
<p>Sort merge join 的 join 执行过程</p>
<ul>
<li>跟 shuffle-hash-join不同，这里多了一个 SortExec 子节点</li>
<li>后面的流程跟 shuffle-hash-join 差不多，也是通过 AQEShuffleReadExec 读数据<br>

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/07/7KoXtw.png">
            <img class="mx-auto" alt="32" src="https://v1.ax1x.com/2024/05/07/7KoXtw.png" />
        </a>
    </li>
</ul>
<p>读取 shuffle 数据的过程</p>
<ul>
<li>sort-merge-join，shuffle-hash-join 都会使用到这个流程</li>
<li>通过 SortShuffleManager 读取网络数据<br>

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/07/7Koje6.png">
            <img class="mx-auto" alt="33" src="https://v1.ax1x.com/2024/05/07/7Koje6.png" />
        </a>
    </li>
</ul>
<h4 id="sortmergejoinscanner">SortMergeJoinScanner</h4>
<p>RowIterator</p>
<ul>
<li>advanceNext()方法将Iterator向前移动一行</li>
<li>getRow()获取当前行</li>
</ul>
<p>SortMergeJoinScanner 的构造参数中会传递</p>
<ul>
<li>streamedlter: streamedTable的迭代器</li>
<li>bufferedlter: bufferedTable的迭代器</li>
<li>streamedKeyGenerator, bufferedKeyGenerator: streamedTable和bufferedTable的连接键</li>
<li>keyOrdering: 连接键的排序器

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/04/7KspP3.jpg">
            <img class="mx-auto" alt="26" src="https://v1.ax1x.com/2024/05/04/7KspP3.jpg" />
        </a>
    <br>
如上</li>
<li>streamedTable与bufferedTable都是shuffle后的数据，所以都是已经排好序的</li>
<li>在匹配满足条件数据的过程中只需要不断移动迭代器，得到新的数据行进行比较再Join即可</li>
<li>与当前steamedTable行匹配的所有bufferedTable缓存在bufferedMatches中</li>
</ul>
<p>SortMergeJoinScanner#findNextInnerJoinRows 执行流程</p>
<ul>
<li>循环调用advancedStreamed()直到当前streamedTable连接键streamRowKey不包含null字段</li>
<li>如果streamedTable行streamRow为null或者bufferedTable行bufferedRow为null，说明streamedTable或者bufferedTable处理完毕，清空bufferedMatches，返回false</li>
<li>如果streamedTable连接键streamedRowKey和bufferedTable连接键bufferedRowKey相等，那么bufferedMatches数组已经是可以和streamRow连接的bufferedTable中的所有行</li>
<li>不断比较streamedRowKey和bufferedRowKey，如果streamedRowKey值较小，则调用advancedStreamed()获取streamedTable下一行</li>
<li>如果bufferedRowKey值较小，则调用advancedBufferedToRowWithNullFreeJoinKey()获取bufferedTable下一行。直到两者相等或者其中一行为null</li>
<li>当满足Join条件时，执行bufferMatchingRows()方法得到bufferedMatches数组</li>
</ul>
<p>SortMergeJoinScanner#findNextOuterJoinRows 执行流程</p>
<ul>
<li>如果streamedTable全部行都已经处理完，则清空bufferedMatches，并返回false</li>
<li>如果两个连接键相等，则直接返回true</li>
<li>如果不相等，那么不断迭代bufferedTable直到当前bufferedRowKey值比streamedRowKey值大或两者相等</li>
<li>如果相等则调用bufferMatchingRows()方法获得bufferedMatches并返回true，否则直接返回true</li>
</ul>
<p>SortMergeJoinScanner 依赖的外部类<br>
ExternalAppendOnlyUnsafeRowArray 是暂存数据的地方，也会溢出到磁盘<br>

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/07/7bx9VG.png">
            <img class="mx-auto" alt="35" src="https://v1.ax1x.com/2024/05/07/7bx9VG.png" />
        </a>
    </p>
<h4 id="sortmergefullouterjoinscanner">SortMergeFullOuterJoinScanner</h4>
<p>执行过程</p>
<ul>
<li>左表和右表分别前移的方法为advancedLeft()和advancedRight()</li>
<li>在SortMergeFullOuterJoinScanner遍历数据过程中会构造两个缓冲区leftMatches和rightMatches</li>
<li>来缓存匹配右表当前数据行的数据与缓存匹配左表当前数据行的数据</li>
<li>scanNextlnBuffered()方法返回两个缓冲区full join的数据放入joinedRow

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/07/7bGolJ.png">
            <img class="mx-auto" alt="34" src="https://v1.ax1x.com/2024/05/07/7bGolJ.png" />
        </a>
    </li>
</ul>
<p>不同 join 类型对应的 迭代算法

        <a data-fancybox="gallery" href="https://v1.ax1x.com/2024/05/04/7KsL6j.jpg">
            <img class="mx-auto" alt="25" src="https://v1.ax1x.com/2024/05/04/7KsL6j.jpg" />
        </a>
    </p>
<h3 id="broadcastnestedloopjoinexec">BroadcastNestedLoopJoinExec</h3>
<p>测试代码：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>    <span style="color:#ff79c6">val</span> df <span style="color:#ff79c6">=</span> spark<span style="color:#ff79c6">.</span>sql<span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f1fa8c">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        |SELECT /*+ BROADCAST(a), SHUFFLE_REPLICATE_NL(b) */
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        |* FROM people AS a LEFT OUTER JOIN employee AS b
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        |ON a.id != b.id WHERE a.id &gt; 10 and b.id &gt; 10
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        |&#34;&#34;&#34;</span><span style="color:#ff79c6">.</span>stripMargin<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>    df<span style="color:#ff79c6">.</span>show<span style="color:#ff79c6">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>生成的物理计划：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#ff79c6">==</span> Physical <span style="color:#8be9fd;font-style:italic">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span>AdaptiveSparkPlan <span style="color:#8be9fd;font-style:italic">isFinalPlan</span><span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">false</span>
</span></span><span style="display:flex;"><span>+- BroadcastNestedLoopJoin BuildLeft, Inner, NOT <span style="color:#ff79c6">(</span>id#7L <span style="color:#ff79c6">=</span> id#18L<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>   :- BroadcastExchange IdentityBroadcastMode, <span style="color:#ff79c6">[</span><span style="color:#8be9fd;font-style:italic">plan_id</span><span style="color:#ff79c6">=</span>87<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>   :  +- Filter <span style="color:#ff79c6">(</span>isnotnull<span style="color:#ff79c6">(</span>id#7L<span style="color:#ff79c6">)</span> AND <span style="color:#ff79c6">(</span>id#7L &gt; 10<span style="color:#ff79c6">))</span>
</span></span><span style="display:flex;"><span>   :     +- Scan ExistingRDD<span style="color:#ff79c6">[</span>age#6L,id#7L,name#8<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>   +- Filter <span style="color:#ff79c6">(</span>isnotnull<span style="color:#ff79c6">(</span>id#18L<span style="color:#ff79c6">)</span> AND <span style="color:#ff79c6">(</span>id#18L &gt; 10<span style="color:#ff79c6">))</span>
</span></span><span style="display:flex;"><span>      +- Scan ExistingRDD<span style="color:#ff79c6">[</span>id#18L,name#19,salary#20L<span style="color:#ff79c6">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>BroadcastNestedLoopJoinExec会根据相关条件对小表进行广播，以减少表的扫描次数。触发广播的需要满足以下三个条件之一</p>
<ul>
<li>right outer join是会广播左表</li>
<li>left outer, left semi, left anti或者 existence join时会广播右表</li>
<li>inner join的时候两张表都会广播</li>
</ul>
<p>对子节点的要求：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>  <span style="color:#ff79c6">override</span> <span style="color:#ff79c6">def</span> requiredChildDistribution<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Seq</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Distribution</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> buildSide <span style="color:#ff79c6">match</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">case</span> <span style="color:#50fa7b">BuildLeft</span> <span style="color:#ff79c6">=&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#50fa7b">BroadcastDistribution</span><span style="color:#ff79c6">(</span><span style="color:#50fa7b">IdentityBroadcastMode</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">:</span><span style="color:#8be9fd">:</span> <span style="color:#8be9fd">UnspecifiedDistribution</span> <span style="color:#8be9fd">::</span> <span style="color:#8be9fd">Nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">case</span> <span style="color:#50fa7b">BuildRight</span> <span style="color:#ff79c6">=&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#50fa7b">UnspecifiedDistribution</span> <span style="color:#ff79c6">:</span><span style="color:#8be9fd">:</span> <span style="color:#8be9fd">BroadcastDistribution</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">IdentityBroadcastMode</span><span style="color:#ff79c6">)</span> <span style="color:#8be9fd">::</span> <span style="color:#8be9fd">Nil</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>doExecute：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>  <span style="color:#ff79c6">protected</span> <span style="color:#ff79c6">override</span> <span style="color:#ff79c6">def</span> doExecute<span style="color:#ff79c6">()</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">RDD</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">InternalRow</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">val</span> broadcastedRelation <span style="color:#ff79c6">=</span> broadcast<span style="color:#ff79c6">.</span>executeBroadcast<span style="color:#ff79c6">[</span><span style="color:#8be9fd">Array</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">InternalRow</span><span style="color:#ff79c6">]]()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">val</span> resultRdd <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>joinType<span style="color:#ff79c6">,</span> buildSide<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">match</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">case</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">_:</span> <span style="color:#8be9fd">InnerLike</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">_</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">=&gt;</span>
</span></span><span style="display:flex;"><span>        innerJoin<span style="color:#ff79c6">(</span>broadcastedRelation<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">case</span> <span style="color:#ff79c6">(</span><span style="color:#50fa7b">LeftOuter</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">BuildRight</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">|</span> <span style="color:#ff79c6">(</span><span style="color:#50fa7b">RightOuter</span><span style="color:#ff79c6">,</span> <span style="color:#50fa7b">BuildLeft</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">=&gt;</span>
</span></span><span style="display:flex;"><span>        outerJoin<span style="color:#ff79c6">(</span>broadcastedRelation<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">case</span> <span style="color:#ff79c6">(</span><span style="color:#50fa7b">LeftSemi</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">_</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">=&gt;</span>
</span></span><span style="display:flex;"><span>        leftExistenceJoin<span style="color:#ff79c6">(</span>broadcastedRelation<span style="color:#ff79c6">,</span> exists <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">case</span> <span style="color:#ff79c6">(</span><span style="color:#50fa7b">LeftAnti</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">_</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">=&gt;</span>
</span></span><span style="display:flex;"><span>        leftExistenceJoin<span style="color:#ff79c6">(</span>broadcastedRelation<span style="color:#ff79c6">,</span> exists <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">case</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">_:</span> <span style="color:#8be9fd">ExistenceJoin</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">_</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">=&gt;</span>
</span></span><span style="display:flex;"><span>        existenceJoin<span style="color:#ff79c6">(</span>broadcastedRelation<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">case</span> <span style="color:#ff79c6">_</span> <span style="color:#ff79c6">=&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">/**
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">         * LeftOuter with BuildLeft
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">         * RightOuter with BuildRight
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">         * FullOuter
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">         */</span>
</span></span><span style="display:flex;"><span>        defaultJoin<span style="color:#ff79c6">(</span>broadcastedRelation<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">val</span> numOutputRows <span style="color:#ff79c6">=</span> longMetric<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;numOutputRows&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>    resultRdd<span style="color:#ff79c6">.</span>mapPartitionsWithIndexInternal <span style="color:#ff79c6">{</span> <span style="color:#ff79c6">(</span>index<span style="color:#ff79c6">,</span> iter<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">=&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">val</span> resultProj <span style="color:#ff79c6">=</span> genResultProjection
</span></span><span style="display:flex;"><span>      resultProj<span style="color:#ff79c6">.</span>initialize<span style="color:#ff79c6">(</span>index<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      iter<span style="color:#ff79c6">.</span>map <span style="color:#ff79c6">{</span> r <span style="color:#ff79c6">=&gt;</span>
</span></span><span style="display:flex;"><span>        numOutputRows <span style="color:#ff79c6">+=</span> <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>        resultProj<span style="color:#ff79c6">(</span>r<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>innerJoin 实现：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>  <span style="color:#ff79c6">private</span> <span style="color:#ff79c6">def</span> innerJoin<span style="color:#ff79c6">(</span>relation<span style="color:#ff79c6">:</span> <span style="color:#8be9fd">Broadcast</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">Array</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">InternalRow</span><span style="color:#ff79c6">]])</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">RDD</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">InternalRow</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    streamed<span style="color:#ff79c6">.</span>execute<span style="color:#ff79c6">().</span>mapPartitionsInternal <span style="color:#ff79c6">{</span> streamedIter <span style="color:#ff79c6">=&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">val</span> buildRows <span style="color:#ff79c6">=</span> relation<span style="color:#ff79c6">.</span>value
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">val</span> joinedRow <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#50fa7b">JoinedRow</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      streamedIter<span style="color:#ff79c6">.</span>flatMap <span style="color:#ff79c6">{</span> streamedRow <span style="color:#ff79c6">=&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">val</span> joinedRows <span style="color:#ff79c6">=</span> buildRows<span style="color:#ff79c6">.</span>iterator<span style="color:#ff79c6">.</span>map<span style="color:#ff79c6">(</span>r <span style="color:#ff79c6">=&gt;</span> joinedRow<span style="color:#ff79c6">(</span>streamedRow<span style="color:#ff79c6">,</span> r<span style="color:#ff79c6">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>condition<span style="color:#ff79c6">.</span>isDefined<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>          joinedRows<span style="color:#ff79c6">.</span>filter<span style="color:#ff79c6">(</span>boundCondition<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>          joinedRows
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>基本上就等价于 两个<code>for</code>循环</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">for</span> record_1 in relation_1<span style="color:#ff79c6">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">for</span> record_2 in relation_2<span style="color:#ff79c6">:</span>
</span></span><span style="display:flex;"><span>    # join condition is executed
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="cartesianproduct">CartesianProduct</h3>
<p>如果两张参与Join的表没有连接条件且是内连接类型，那么会产生CartesianProduct，得到笛卡尔积</p>
<p>测试代码：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>    val df <span style="color:#ff79c6">=</span> spark.<span style="color:#ff79c6">sql</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#f1fa8c">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        |SELECT /*+ SHUFFLE_REPLICATE_NL(a), SHUFFLE_REPLICATE_NL(b) */
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        |* FROM people AS a LEFT OUTER JOIN employee AS b
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        |ON a.id == b.id WHERE a.id &gt; 10 and b.id &gt; 10
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        |&#34;&#34;&#34;</span>.stripMargin)
</span></span><span style="display:flex;"><span>    df.<span style="color:#ff79c6">show</span>()
</span></span></code></pre></td></tr></table>
</div>
</div><p>生成的物理计划：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#ff79c6">==</span> Physical <span style="color:#8be9fd;font-style:italic">Plan</span> <span style="color:#ff79c6">==</span>
</span></span><span style="display:flex;"><span>CartesianProduct <span style="color:#ff79c6">(</span>id#7L <span style="color:#ff79c6">=</span> id#18L<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>:- Filter <span style="color:#ff79c6">(</span>isnotnull<span style="color:#ff79c6">(</span>id#7L<span style="color:#ff79c6">)</span> AND <span style="color:#ff79c6">(</span>id#7L &gt; 10<span style="color:#ff79c6">))</span>
</span></span><span style="display:flex;"><span>:  +- Scan ExistingRDD<span style="color:#ff79c6">[</span>age#6L,id#7L,name#8<span style="color:#ff79c6">]</span>
</span></span><span style="display:flex;"><span>+- Filter <span style="color:#ff79c6">(</span>isnotnull<span style="color:#ff79c6">(</span>id#18L<span style="color:#ff79c6">)</span> AND <span style="color:#ff79c6">(</span>id#18L &gt; 10<span style="color:#ff79c6">))</span>
</span></span><span style="display:flex;"><span>   +- Scan ExistingRDD<span style="color:#ff79c6">[</span>id#18L,name#19,salary#20L<span style="color:#ff79c6">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>对子节点的分布没有要求<br>
doExecute，比较简单，就是 两个 for 循环</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>  <span style="color:#ff79c6">protected</span> <span style="color:#ff79c6">override</span> <span style="color:#ff79c6">def</span> doExecute<span style="color:#ff79c6">()</span><span style="color:#ff79c6">:</span> <span style="color:#8be9fd">RDD</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">InternalRow</span><span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">val</span> numOutputRows <span style="color:#ff79c6">=</span> longMetric<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;numOutputRows&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">val</span> leftResults <span style="color:#ff79c6">=</span> left<span style="color:#ff79c6">.</span>execute<span style="color:#ff79c6">().</span>asInstanceOf<span style="color:#ff79c6">[</span><span style="color:#8be9fd">RDD</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">UnsafeRow</span><span style="color:#ff79c6">]]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">val</span> rightResults <span style="color:#ff79c6">=</span> right<span style="color:#ff79c6">.</span>execute<span style="color:#ff79c6">().</span>asInstanceOf<span style="color:#ff79c6">[</span><span style="color:#8be9fd">RDD</span><span style="color:#ff79c6">[</span><span style="color:#8be9fd">UnsafeRow</span><span style="color:#ff79c6">]]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">val</span> pair <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#50fa7b">UnsafeCartesianRDD</span><span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span>      leftResults<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span>      rightResults<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span>      conf<span style="color:#ff79c6">.</span>cartesianProductExecBufferInMemoryThreshold<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span>      conf<span style="color:#ff79c6">.</span>cartesianProductExecBufferSpillThreshold<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>    pair<span style="color:#ff79c6">.</span>mapPartitionsWithIndexInternal <span style="color:#ff79c6">{</span> <span style="color:#ff79c6">(</span>index<span style="color:#ff79c6">,</span> iter<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">=&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">val</span> joiner <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">GenerateUnsafeRowJoiner</span><span style="color:#ff79c6">.</span>create<span style="color:#ff79c6">(</span>left<span style="color:#ff79c6">.</span>schema<span style="color:#ff79c6">,</span> right<span style="color:#ff79c6">.</span>schema<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">val</span> filtered <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>condition<span style="color:#ff79c6">.</span>isDefined<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">val</span> boundCondition <span style="color:#ff79c6">=</span> <span style="color:#50fa7b">Predicate</span><span style="color:#ff79c6">.</span>create<span style="color:#ff79c6">(</span>condition<span style="color:#ff79c6">.</span>get<span style="color:#ff79c6">,</span> left<span style="color:#ff79c6">.</span>output <span style="color:#ff79c6">++</span> right<span style="color:#ff79c6">.</span>output<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>        boundCondition<span style="color:#ff79c6">.</span>initialize<span style="color:#ff79c6">(</span>index<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">val</span> joined <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#50fa7b">JoinedRow</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        iter<span style="color:#ff79c6">.</span>filter <span style="color:#ff79c6">{</span> r <span style="color:#ff79c6">=&gt;</span>
</span></span><span style="display:flex;"><span>          boundCondition<span style="color:#ff79c6">.</span>eval<span style="color:#ff79c6">(</span>joined<span style="color:#ff79c6">(</span>r<span style="color:#ff79c6">.</span>_1<span style="color:#ff79c6">,</span> r<span style="color:#ff79c6">.</span>_2<span style="color:#ff79c6">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        iter
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>      filtered<span style="color:#ff79c6">.</span>map <span style="color:#ff79c6">{</span> r <span style="color:#ff79c6">=&gt;</span>
</span></span><span style="display:flex;"><span>        numOutputRows <span style="color:#ff79c6">+=</span> <span style="color:#bd93f9">1</span>
</span></span><span style="display:flex;"><span>        joiner<span style="color:#ff79c6">.</span>join<span style="color:#ff79c6">(</span>r<span style="color:#ff79c6">.</span>_1<span style="color:#ff79c6">,</span> r<span style="color:#ff79c6">.</span>_2<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="参考">参考</h2>
<ul>
<li><a href="https://spark.apache.org/docs/latest/sql-ref-syntax-qry-select-join.html">Spark join</a></li>
<li><a href="https://spark.apache.org/docs/latest/sql-ref-syntax-qry-select-hints.html">Spark Join Hints</a></li>
<li><a href="https://dataninjago.com/2022/01/11/spark-sql-query-engine-deep-dive-11-join-strategies/">Join Strategies</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/408526346">OpenMLDB: 拓展Spark源码实现高性能Join</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/271910611">Spark源码修改系列 - 拓展Join算法实现</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/298203303">Spark源码修改系列 - UnsafeRow内存布局和代码优化</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/159330178">推荐系统大规模特征工程与Spark LLVM优化</a></li>
<li><a href="https://mp.weixin.qq.com/s/HusOqNA-45lpf5GduLz-pA">每个 Spark 工程师都应该知道的五种 Join 策略</a></li>
<li><a href="https://blog.csdn.net/shockang/article/details/124305570">Spark 3.x 的 WSCG 机制源码解析</a></li>
</ul>

			<script type="text/javascript"
        async
        src="https://cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[\[','\]\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});

MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<style>
code.has-jax {
    font: inherit;
    font-size: 100%;
    background: inherit;
    border: inherit;
    color: #515151;
}
</style>
        </div>

        


        

<div class="post-archive">
    <h2>相关文章</h2>
    <ul class="listing">
        
        <li><a href="/post/2024/05/spark_windows_cube/">Spark原理-窗口函数和多维分析</a></li>
        
        <li><a href="/post/2024/04/spark_agg/">Spark原理-聚合</a></li>
        
        <li><a href="/post/2024/03/spark_plan_agg/">Spark原理-物理计划&amp;聚合</a></li>
        
        <li><a href="/post/2024/03/spark_optimized/">Spark原理-优化规则</a></li>
        
        <li><a href="/post/2024/03/spark_internal/">Spark原理-解析过程和Catalog</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='/tags/spark'>Spark</a></li>
                
            </ul>
            
        </div>
    </article>
    
    

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "himichael/hugoblogtalks"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
</div>


                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='https://code0xff.org/search/' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://code0xff.org/">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://code0xff.org/post/2025/01/spark_register_source/" title="Spark 注册数据源">Spark 注册数据源</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2025/01/spark_core_2/" title="Spark Core相关-2">Spark Core相关-2</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2024/12/llamafactory/" title="Llama Factory">Llama Factory</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2024/11/spark_core/" title="Spark Core相关-1">Spark Core相关-1</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2024/11/sae_tunnel/" title="sea tunnel">sea tunnel</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2024/11/k8s_networks/" title="k8s 网络">k8s 网络</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2024/11/ozone/" title="ozone">ozone</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2024/11/es/" title="ES的简单学习">ES的简单学习</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2025/02/ai/" title="AI的简单学习">AI的简单学习</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2024/11/big_data_investigation/" title="国内几个云厂商大数据平台">国内几个云厂商大数据平台</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories/'>分类</a></h3>
<ul class="widget-list">
    
    <li><a href="https://code0xff.org/categories/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式 (6)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/">原理分析 (24)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E5%95%86%E4%B8%9A/">商业 (3)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据 (56)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库 (41)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E6%96%87%E5%AD%A6%E5%92%8C%E8%89%BA%E6%9C%AF/">文学和艺术 (3)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E6%97%85%E8%A1%8C/">旅行 (12)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E6%9E%B6%E6%9E%84/">架构 (13)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E7%AE%97%E6%B3%95/">算法 (8)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E7%B3%BB%E7%BB%9F/">系统 (7)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/">编程语言 (7)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E8%A1%8C%E4%B8%9A%E8%A7%82%E5%AF%9F/">行业观察 (3)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">读书笔记 (14)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E9%9A%8F%E4%BE%BF%E5%86%99%E5%86%99/">随便写写 (3)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title">归档</a></h3>
<ul class="widget-list">
    
    <li><a href="https://code0xff.org/years/2021%E5%B9%B4/">2021年 (41)</a></li>
    
    <li><a href="https://code0xff.org/years/2022%E5%B9%B4/">2022年 (55)</a></li>
    
    <li><a href="https://code0xff.org/years/2023%E5%B9%B4/">2023年 (54)</a></li>
    
    <li><a href="https://code0xff.org/years/2024%E5%B9%B4/">2024年 (48)</a></li>
    
    <li><a href="https://code0xff.org/years/2025%E5%B9%B4/">2025年 (2)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags/'>标签</a></h3>
<div class="tagcloud">
    
    <a href="https://code0xff.org/tags/ai/">AI </a>
    
    <a href="https://code0xff.org/tags/ambari/">Ambari </a>
    
    <a href="https://code0xff.org/tags/architecture/">architecture </a>
    
    <a href="https://code0xff.org/tags/bigdata/">bigdata </a>
    
    <a href="https://code0xff.org/tags/b%E6%A0%91/">B树 </a>
    
    <a href="https://code0xff.org/tags/c&#43;&#43;/">C&#43;&#43; </a>
    
    <a href="https://code0xff.org/tags/calcite/">calcite </a>
    
    <a href="https://code0xff.org/tags/cmu-database/">CMU-Database </a>
    
    <a href="https://code0xff.org/tags/data_ingestion/">Data_Ingestion </a>
    
    <a href="https://code0xff.org/tags/deltalake/">DeltaLake </a>
    
    <a href="https://code0xff.org/tags/doris/">Doris </a>
    
    <a href="https://code0xff.org/tags/english/">English </a>
    
    <a href="https://code0xff.org/tags/es/">ES </a>
    
    <a href="https://code0xff.org/tags/facebook/">Facebook </a>
    
    <a href="https://code0xff.org/tags/flink/">flink </a>
    
    <a href="https://code0xff.org/tags/flume/">flume </a>
    
    <a href="https://code0xff.org/tags/gc/">GC </a>
    
    <a href="https://code0xff.org/tags/gluten/">Gluten </a>
    
    <a href="https://code0xff.org/tags/hana/">HANA </a>
    
    <a href="https://code0xff.org/tags/hive/">Hive </a>
    
    <a href="https://code0xff.org/tags/iceberg/">iceberg </a>
    
    <a href="https://code0xff.org/tags/impala/">Impala </a>
    
    <a href="https://code0xff.org/tags/janino/">janino </a>
    
    <a href="https://code0xff.org/tags/k8s/">k8s </a>
    
    <a href="https://code0xff.org/tags/kafka/">Kafka </a>
    
    <a href="https://code0xff.org/tags/kudu/">kudu </a>
    
    <a href="https://code0xff.org/tags/kyuubi/">Kyuubi </a>
    
    <a href="https://code0xff.org/tags/lakehouse/">Lakehouse </a>
    
    <a href="https://code0xff.org/tags/leveldb/">LevelDB </a>
    
    <a href="https://code0xff.org/tags/llamafactory/">LlamaFactory </a>
    
    <a href="https://code0xff.org/tags/llvm/">LLVM </a>
    
    <a href="https://code0xff.org/tags/manacher/">Manacher </a>
    
    <a href="https://code0xff.org/tags/mapreduce/">MapReduce </a>
    
    <a href="https://code0xff.org/tags/micro-service/">micro-service </a>
    
    <a href="https://code0xff.org/tags/mysql/">MySQL </a>
    
    <a href="https://code0xff.org/tags/newsql/">NewSQL </a>
    
    <a href="https://code0xff.org/tags/oceanbase/">OceanBase </a>
    
    <a href="https://code0xff.org/tags/openlogreplicator/">OpenLogReplicator </a>
    
    <a href="https://code0xff.org/tags/parquet/">parquet </a>
    
    <a href="https://code0xff.org/tags/paxos/">paxos </a>
    
    <a href="https://code0xff.org/tags/presto/">Presto </a>
    
    <a href="https://code0xff.org/tags/quick-sql/">quick-sql </a>
    
    <a href="https://code0xff.org/tags/raft/">raft </a>
    
    <a href="https://code0xff.org/tags/scala/">scala </a>
    
    <a href="https://code0xff.org/tags/simd/">SIMD </a>
    
    <a href="https://code0xff.org/tags/snowflake/">snowflake </a>
    
    <a href="https://code0xff.org/tags/spark/">spark </a>
    
    <a href="https://code0xff.org/tags/sre/">SRE </a>
    
    <a href="https://code0xff.org/tags/teradata/">TeraData </a>
    
    <a href="https://code0xff.org/tags/tpcx-hs/">TPCx-HS </a>
    
    <a href="https://code0xff.org/tags/trino/">Trino </a>
    
    <a href="https://code0xff.org/tags/tuning/">Tuning </a>
    
    <a href="https://code0xff.org/tags/unix/">unix </a>
    
    <a href="https://code0xff.org/tags/yarn/">YARN </a>
    
    <a href="https://code0xff.org/tags/%E4%BA%8C%E5%88%86%E6%9F%A5%E6%89%BE/">二分查找 </a>
    
    <a href="https://code0xff.org/tags/%E4%BA%8C%E5%8F%89%E6%A0%91%E9%81%8D%E5%8E%86/">二叉树遍历 </a>
    
    <a href="https://code0xff.org/tags/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式 </a>
    
    <a href="https://code0xff.org/tags/%E5%88%97%E5%AD%98/">列存 </a>
    
    <a href="https://code0xff.org/tags/%E5%8A%A8%E6%80%81%E6%B3%A8%E5%85%A5/">动态注入 </a>
    
    <a href="https://code0xff.org/tags/%E5%8E%86%E5%8F%B2/">历史 </a>
    
    <a href="https://code0xff.org/tags/%E5%90%91%E9%87%8F%E5%8C%96/">向量化 </a>
    
    <a href="https://code0xff.org/tags/%E5%9B%9E%E6%BA%AF/">回溯 </a>
    
    <a href="https://code0xff.org/tags/%E5%9B%BD%E5%86%85%E6%97%85%E8%A1%8C/">国内旅行 </a>
    
    <a href="https://code0xff.org/tags/%E5%9B%BD%E5%A4%96%E6%97%85%E8%A1%8C/">国外旅行 </a>
    
    <a href="https://code0xff.org/tags/%E5%A4%9A%E7%A7%9F%E6%88%B7/">多租户 </a>
    
    <a href="https://code0xff.org/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据 </a>
    
    <a href="https://code0xff.org/tags/%E5%AD%98%E5%82%A8/">存储 </a>
    
    <a href="https://code0xff.org/tags/%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95/">工作记录 </a>
    
    <a href="https://code0xff.org/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务 </a>
    
    <a href="https://code0xff.org/tags/%E6%95%B0%E6%8D%AE%E4%B8%AD%E5%8F%B0/">数据中台 </a>
    
    <a href="https://code0xff.org/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库 </a>
    
    <a href="https://code0xff.org/tags/%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B/">数据模型 </a>
    
    <a href="https://code0xff.org/tags/%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB/">数据迁移 </a>
    
    <a href="https://code0xff.org/tags/%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96/">查询优化 </a>
    
    <a href="https://code0xff.org/tags/%E6%9F%A5%E8%AF%A2%E7%BC%96%E8%AF%91/">查询编译 </a>
    
    <a href="https://code0xff.org/tags/%E6%A6%82%E7%8E%87/">概率 </a>
    
    <a href="https://code0xff.org/tags/%E6%B1%87%E7%BC%96/">汇编 </a>
    
    <a href="https://code0xff.org/tags/%E6%B5%8B%E8%AF%95/">测试 </a>
    
    <a href="https://code0xff.org/tags/%E7%94%9F%E6%B4%BB/">生活 </a>
    
    <a href="https://code0xff.org/tags/%E7%94%B5%E5%BD%B1/">电影 </a>
    
    <a href="https://code0xff.org/tags/%E7%AE%97%E6%B3%95/">算法 </a>
    
    <a href="https://code0xff.org/tags/%E7%B4%A2%E5%BC%95/">索引 </a>
    
    <a href="https://code0xff.org/tags/%E7%BB%8F%E6%B5%8E/">经济 </a>
    
    <a href="https://code0xff.org/tags/%E7%BC%93%E5%AD%98/">缓存 </a>
    
    <a href="https://code0xff.org/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/">编译原理 </a>
    
    <a href="https://code0xff.org/tags/%E7%BD%91%E7%BB%9C/">网络 </a>
    
    <a href="https://code0xff.org/tags/%E8%AE%A1%E7%AE%97%E6%A1%86%E6%9E%B6/">计算框架 </a>
    
    <a href="https://code0xff.org/tags/%E8%AE%BA%E6%96%87/">论文 </a>
    
    <a href="https://code0xff.org/tags/%E8%AF%BB%E4%B9%A6/">读书 </a>
    
    <a href="https://code0xff.org/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">读书笔记 </a>
    
</div>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">RSS</h3>
        <ul class="widget-list">
            <li><a href="https://code0xff.org/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
    <footer id="footer">
    <div>
        &copy; 2025 <a href="https://code0xff.org/">记录每个瞬间 By 老王</a>
        
    </div>
    <br />
    <div>
        <div class="github-badge">
            <a href="https://gohugo.io/" target="_black" rel="nofollow"><span class="badge-subject">Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
        </div>
        <div class="github-badge">
            <a href="https://github.com/flysnow-org/maupassant-hugo" target="_black"><span class="badge-subject">Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
        </div>
    </div>
</footer>


    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script><script src="https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'GA ID', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



    <script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>




</body>

</html>