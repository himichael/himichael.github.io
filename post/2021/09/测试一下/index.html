<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.88.1" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>测试一下 &middot; My New Hugo Site</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://himichael.github.io/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://himichael.github.io/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://himichael.github.io/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://himichael.github.io/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  
</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://himichael.github.io/"><h1>My New Hugo Site</h1></a>
      <p class="lead">
      An elegant open source and mobile first theme for <a href="http://hugo.spf13.com">hugo</a> made by <a href="http://twitter.com/mdo">@mdo</a>. Originally made for Jekyll.
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://himichael.github.io/">Home</a> </li>
        
      </ul>
    </nav>

    <p>&copy; 2021. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>测试一下</h1>
  <time datetime=2021-09-22T14:09:03&#43;0800 class="post-date">Wed, Sep 22, 2021</time>
  <p>[[<em>TOC</em>]]</p>
<p>本文根据腾讯云数据库官方文档，总结了</p>
<ul>
<li>MySQL版</li>
<li>PostgreSQL版</li>
</ul>
<p>两个数据库的总体架构、具体操作、计费等情况<br>
由于数据库没有试用版，本文主要是通过阅读官方文档做出的总结</p>
<p>MySQL官方文档 -&gt; 【<a href="https://cloud.tencent.com/document/product/557">链接</a>】<br>
PostgreSQL官方文档 -&gt; 【<a href="https://cloud.tencent.com/document/product/1129">链接</a>】</p>
<h2 id="mysql版">MySQL版</h2>
<h4 id="总体概览">总体概览</h4>
<p>看展示的图片(控制台操作界面)，貌似是 MySQL8.x 改造的 <br>
单机分片最大量6T，最大QPS 24W</p>
<p>其原理是基于 shard-key做分片，这是目前已有的实现方案，这里的TProxy没找到介绍，可能是腾讯自己研发的，或者基于开源实现改造的 <br>
<img src="/uploads/0ee558333ed785db6b92a33ffd9f287c/image.png" alt="image"></p>
<hr>
<p>对原生MySQL新增的功能：<br>
1、自动数据平衡</p>
<ul>
<li>新增节时候，自动平衡数据，但会有几秒-几十秒的不可写</li>
<li>升级节点时，将旧节点数据-&gt;新节点，然后proxy指向新节点<br>
<img src="1.jpg" alt="image"></li>
</ul>
<p>2、复制方式 <br>
在 MySQL自己的强同步之上，增加了异步特性<br>
比如 5个行程，处理10个事务，看性能测试 写和混合读写时候，比原生MySQL快 20-30%左右 <br>
<img src="2.jpg" alt="image"></p>
<p>3、shard-key，修改了MySQL语法，在创建表的时候指定了按哪个字段做分片<br>
在写入的时候，必须指定分片字段，否则报错</p>
<blockquote>
<p>SLA，99.95%</p>
</blockquote>
<h4 id="计费">计费</h4>
<p>计费方式：包年包月、按需计费    <br>
梯度计费<br>
1、0 - 96 小时<br>
2、96 - 360 小时 <br>
3、&gt; 360小时<br>
使用时间越长，价格越低</p>
<p>总费用 = 实例费用 + 备份空间费用（目前免费）+ 流量费用（目前免费）<br>
实例费用 = 节点价格 × 节点数量 × 分片数量 = (节点内存 × 内存价格 + 节点硬盘 × 硬盘价格) × 节点数量 × 分片数量</p>
<p>价格列表，北上广最便宜</p>
<table>
<thead>
<tr>
<th>地区</th>
<th>内存价格(1元，一个月)</th>
<th>磁盘价格(1元，一个月)</th>
</tr>
</thead>
<tbody>
<tr>
<td>广州、 北京、上海</td>
<td>45.90</td>
<td>0.324</td>
</tr>
<tr>
<td>成都、重庆</td>
<td>35.70</td>
<td>0.252</td>
</tr>
<tr>
<td>北京金融、深圳金融、上海金融</td>
<td>113.6</td>
<td>0.640</td>
</tr>
<tr>
<td>中国香港</td>
<td>68.85</td>
<td>0.540</td>
</tr>
<tr>
<td>弗吉尼亚、法兰克福</td>
<td>89.00</td>
<td>0.400</td>
</tr>
<tr>
<td>多伦多</td>
<td>91.50</td>
<td>0.600</td>
</tr>
<tr>
<td>孟买、新加坡</td>
<td>87.50</td>
<td>0.600</td>
</tr>
<tr>
<td>首尔、东京</td>
<td>66.00</td>
<td>0.750</td>
</tr>
</tbody>
</table>
<h4 id="具体操作">具体操作</h4>
<p>主要功能：</p>
<ul>
<li>支持内网、外网访问</li>
<li>灾备/只读实例</li>
<li>安全管理</li>
<li>性能检测</li>
<li>慢查询分析</li>
<li>配置读写分离</li>
<li>备份</li>
</ul>
<p>支持 单机 &lt;-&gt; 分布式环境互导入</p>
<p>分布式实例主要功能：</p>
<ul>
<li>提供了灵活的读写分离模式</li>
<li>支持全局的 order by、group by、limit 操作</li>
<li>聚合函数支持 sum、count、avg、min、max 等</li>
<li>支持跨节点（set）的 join、子查询</li>
<li>支持预处理协议</li>
<li>支持全局唯一字段，支持 sequence</li>
<li>支持分布式事务</li>
<li>支持两级分区</li>
<li>提供特定的 SQL 查询整个集群的配置和状态</li>
</ul>
<p>不支持的操作：</p>
<ul>
<li>不支持自定义函数、事件、表空间</li>
<li>不支持视图、存储过程、触发器、游标</li>
<li>不支持外键、自建分区</li>
<li>不支持复合语句，如 BEGIN END、LOOP</li>
<li>不支持主备同步相关的 SQL</li>
</ul>
<p>这里有完整的不支持的操作列表 -&gt; <a href="https://cloud.tencent.com/document/product/557/47511">链接</a></p>
<p>连接，直接用mysql方式连接：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">mysql -hxxx.xxx.xxx.xxx -Pxxxx -uxxx -pxxx -c
</code></pre></div><p>支持 php，JDBC</p>
<p>TDSQL MySQL版 实例会对 SQL 进行语法解析，有一定的限制，如果用户想在某个节点（set）中执行 MySQL 支持，但分布式实例不支持的 SQL 时，可以使用透传 SQL 的功能。</p>
<p>分布式表类型：</p>
<ul>
<li>分表</li>
<li>单表(普通表)</li>
<li>广播表</li>
</ul>
<p>建分表，多了一个 <code>shardkey</code> 语法</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> test1 ( a int, b int, <span style="color:#66d9ef">c</span> char(<span style="color:#ae81ff">20</span>),<span style="color:#66d9ef">primary</span> <span style="color:#66d9ef">key</span> (a,b),<span style="color:#66d9ef">unique</span> <span style="color:#66d9ef">key</span> u_1(a,<span style="color:#66d9ef">c</span>) ) shardkey<span style="color:#f92672">=</span>a;
Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">07</span> sec)
</code></pre></div><p>广播表:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> global_table ( a int, b int <span style="color:#66d9ef">key</span>) shardkey<span style="color:#f92672">=</span>noshardkey_allset;
Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">06</span> sec)
</code></pre></div><p>单表：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> noshard_table ( a int, b int <span style="color:#66d9ef">key</span>);
Query OK, <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">rows</span> affected (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">02</span> sec)
</code></pre></div><h4 id="api">API</h4>
<p>安全组相关</p>
<ul>
<li>查询实例安全组信息</li>
<li>查询项目安全组信息</li>
<li>安全组批量解绑云资源</li>
<li>修改云数据库安全组</li>
</ul>
<p>分布式数据库相关操作</p>
<ul>
<li>取消DCN同步</li>
<li>克隆实例账户</li>
<li>关闭外网访问</li>
<li>复制账号权限</li>
<li>创建账号</li>
<li>创建DCDB分布式实例</li>
<li>创建独享集群DCDB实例</li>
<li>删除账号</li>
<li>查询账号权限</li>
<li>查询账号列表</li>
<li>获取日志列表</li>
<li>查看数据库参数</li>
<li>查询同步模式</li>
<li>获取实例节点信息</li>
<li>查询实例列表</li>
<li>新购分布式数据库实例询价</li>
<li>续费实例询价</li>
<li>查询分布式数据库可售卖地域和可用区信息</li>
<li>查询分片信息</li>
<li>查询变配分布式数据库实例价格</li>
<li>查询数据库对象列表</li>
<li>查询数据库表信息</li>
<li>查询数据库列表</li>
<li>获取实例灾备详情</li>
<li>查询流程状态</li>
<li>查询订单信息</li>
<li>查询项目列表</li>
<li>查询分布式数据库可售卖分片规格</li>
<li>获取SQL日志</li>
<li>拉取用户任务列表</li>
<li>销毁已隔离的包年包月实例</li>
<li>销毁按量计费实例</li>
<li>切分Binlog</li>
<li>设置账号权限</li>
<li>初始化实例</li>
<li>修改数据库账号备注</li>
<li>修改实例所属项目</li>
<li>修改数据库参数</li>
<li>修改同步模式</li>
<li>修改RS的访问策略</li>
<li>开通外网访问</li>
<li>续费分布式数据库实例</li>
<li>重置账号密码</li>
<li>升级分布式数据库</li>
</ul>
<h4 id="总结">总结</h4>
<p>总结</p>
<ul>
<li>从官方文档看，对原生MySQL改动不多，基本上可以认为就是原生MySQL的简单增强</li>
<li>原生MySQL也有集群、主备、主从等高可用方案从，从文档上看基本上都是业界通用的方案</li>
<li>对MySQL的语法有一些修改，主要是配合分布式方面做的改动，基本上还是兼容MySQL语法，可以用JDBC直连</li>
<li>分布式数据库的底层运维不知道是怎么做的，只是从SLA(99.95%)看基础运维应该还可以</li>
<li>API比较偏运维层面，运营的API基本没有</li>
<li>使用需要付费，目前没有免费试用的</li>
</ul>
<h2 id="postgresql版">PostgreSQL版</h2>
<h4 id="总体概览-1">总体概览</h4>
<p>PostgreSQL版本同时支持OLAP、OLTP两种方式 <br>
支持地理位置、NoSQL等，这些应该都是用原生PostgreSQL的方式实现</p>
<p>主要功能：</p>
<ul>
<li>分布式JOIN计算，这个可能是基于GreenPlum实现</li>
<li>审计、脱敏、数据加密</li>
<li>冷热分离</li>
<li>多级容灾
<ul>
<li>强同步复制</li>
<li>主从高可用</li>
<li>基于时间点的恢复功能</li>
</ul>
</li>
<li>分布式事务</li>
<li>兼容PostgreSQL语法</li>
</ul>
<p>TDSQL PostgreSQL版 采用无共享 share nothing 架构。数据库实例分为三种节点：</p>
<ul>
<li>协调节点（ Coordinator，CN）：是数据库服务的对外入口，负责数据的分发和查询规划，多个节点位置对等。</li>
<li>数据节点（Datanode，DN） ：负责执行协调节点分发的执行请求，实际存储业务数据。</li>
<li>全局事务管理器（GlobalTransactionManager，GTM）：负责全局事务管理。</li>
</ul>
<p><img src="3.jpg" alt="image"></p>
<p>PostgreSQL版，采用了主从模式，写主，读从 <br>
OLTP运行在主节点，OLAP运行在从节点，二者之间通过流复制的方式实现同步</p>
<blockquote>
<p>PostgreSQL 官方文档上面没有找到<strong>服务协议</strong>相关的说明</p>
</blockquote>
<h4 id="计费-1">计费</h4>
<p>内存价格：</p>
<table>
<thead>
<tr>
<th>内存规格（GB）</th>
<th>广州（元/GB/月）</th>
<th>上海（元/GB/月）</th>
<th>北京（元/GB/月）</th>
<th>香港（元/GB/月）</th>
</tr>
</thead>
<tbody>
<tr>
<td>0GB - 24 GB （不含24GB）</td>
<td>51</td>
<td>51</td>
<td>51</td>
<td>86</td>
</tr>
<tr>
<td>24GB - 96 GB （不含96GB）</td>
<td>46</td>
<td>46</td>
<td>46</td>
<td>85</td>
</tr>
<tr>
<td>96GB及以上</td>
<td>45</td>
<td>45</td>
<td>45</td>
<td>72</td>
</tr>
</tbody>
</table>
<p>磁盘价格：</p>
<table>
<thead>
<tr>
<th>地域</th>
<th>单价（元/GB/月）</th>
</tr>
</thead>
<tbody>
<tr>
<td>广州、上海、北京</td>
<td>0.36</td>
</tr>
<tr>
<td>香港</td>
<td>0.60</td>
</tr>
</tbody>
</table>
<p>跟MySQL类似，PostgreSQL也有梯度计费的方式 <br>
计费公式：</p>
<blockquote>
<p>总费用 = 实例费用 + 备份空间费用（目前免费）+ 流量费用（目前免费）<br>
其中，实例费用 = (节点总内存数 × 内存价格 + 节点总磁盘数 × 磁盘价格) × 时长</p>
</blockquote>
<h4 id="具体操作-1">具体操作</h4>
<p>优化SQL，可以通过命令行方式，explain给出调优建议，<a href="https://cloud.tencent.com/document/product/1129/39825">链接</a></p>
<ul>
<li>查看是否为分布式键查询</li>
<li>是否使用索引</li>
<li>是否为分布式key join</li>
<li>查看join发生节点</li>
<li>查看并行的worker数</li>
<li>查看各节点的执行计划是否一致</li>
</ul>
<p>建表
不支持shard-key，会默认分配一个shard-key</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> t_first_col_share(id serial <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span>,nickname text);
</code></pre></div><p>指定shard-key</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> t_appoint_col(id serial <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">null</span>,nickname text) distribute <span style="color:#66d9ef">by</span> shard(nickname);
<span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span>
</code></pre></div><p>创建范围分区表</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> t_range (f1 bigint,f2 <span style="color:#66d9ef">timestamp</span> <span style="color:#66d9ef">default</span> now(), f3 integer) partition <span style="color:#66d9ef">by</span> range (f3) <span style="color:#66d9ef">begin</span> (<span style="color:#ae81ff">1</span>) step (<span style="color:#ae81ff">50</span>) partitions (<span style="color:#ae81ff">3</span>) distribute <span style="color:#66d9ef">by</span> shard(f1) <span style="color:#66d9ef">to</span> <span style="color:#66d9ef">group</span> default_group;
<span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span>
</code></pre></div><p>冷热分区表</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">table</span> t_cold_hot_table(f1 bigint, f2 <span style="color:#66d9ef">timestamp</span> ,f3 bigint) partition <span style="color:#66d9ef">by</span> range (f2) <span style="color:#66d9ef">begin</span> (<span style="color:#66d9ef">timestamp</span> <span style="color:#66d9ef">without</span> time <span style="color:#66d9ef">zone</span> <span style="color:#e6db74">&#39;2017-09-01 0:0:0&#39;</span>) step (interval <span style="color:#e6db74">&#39;1 month&#39;</span>) partitions (<span style="color:#ae81ff">12</span>) distribute <span style="color:#66d9ef">by</span> shard(f1,f2) <span style="color:#66d9ef">to</span> <span style="color:#66d9ef">group</span> default_group ext_group;
<span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span>
</code></pre></div><p>分布式表和视图类型：</p>
<ul>
<li>分区表</li>
<li>范围分区，range，list，时间</li>
<li>冷热分区</li>
<li>逻辑分区</li>
<li>多级分区</li>
<li>物化视图</li>
</ul>
<h4 id="总结-1">总结</h4>
<p>PostgreSQL版本跟MySQL版差别比较大</p>
<ul>
<li>文档上没有介绍专门定制开发的功能，看起来所有的功能基本上都是原生PostgreSQL或者插件的</li>
<li>计费方式基本上跟MySQL差不多</li>
<li>SQL的优化，分区设置什么的比MySQL版的强，但主要依赖于PostgreSQL</li>
<li>没有API，管理运营都比较弱</li>
<li>目前看就是原生PostgreSQL+插件，比较难的底层存储运维不知道是怎么实现的</li>
</ul>

</div>


    </main>

    
      
    
  </body>
</html>
