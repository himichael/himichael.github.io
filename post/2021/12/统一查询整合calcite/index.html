<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="referrer" content="no-referrer-when-downgrade">
    

    <title>统一查询项目整合Calcite | 记录每个瞬间</title>
    <meta property="og:title" content="统一查询项目整合Calcite - 记录每个瞬间">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2021-12-27T13:07:19&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2021-12-27T13:07:19&#43;08:00'>
        
    <meta name="Keywords" content="">
    <meta name="description" content="统一查询项目整合Calcite">
        <meta name="author" content="隔壁老王">
        
    <meta property="og:url" content="https://code0xff.org/post/2021/12/%E7%BB%9F%E4%B8%80%E6%9F%A5%E8%AF%A2%E6%95%B4%E5%90%88calcite/">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    
    
        <link href="https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" rel="stylesheet">
    
    
    
    
</head>


<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://code0xff.org/">
                        记录每个瞬间
                    </a>
                
                
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="https://code0xff.org/">首页</a>
                    
                    <a  href="https://code0xff.org/linked/" title="链接">链接</a>
                    
                    <a  href="https://code0xff.org/archives/" title="归档">归档</a>
                    
                    <a  href="https://code0xff.org/about/" title="关于">关于</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    
    <article class="post">
        <header>
            <h1 class="post-title">统一查询项目整合Calcite</h1>
        </header>
        <date class="post-meta meta-date">
            2021年12月27日
        </date>
<nav id="TableOfContents">
  <ul>
    <li><a href="#jdbc服务端解析">JDBC服务端解析</a>
      <ul>
        <li><a href="#架构">架构</a></li>
        <li><a href="#查询过程">查询过程</a>
          <ul>
            <li><a href="#创建连接">创建连接</a></li>
            <li><a href="#创建statement">创建statement</a></li>
            <li><a href="#执行查询">执行查询</a></li>
          </ul>
        </li>
        <li><a href="#调试记录">调试记录</a>
          <ul>
            <li><a href="#正确的结果">正确的结果</a></li>
            <li><a href="#错误的结果">错误的结果</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#calcite自身对spark的整合分析">Calcite自身对Spark的整合分析</a>
      <ul>
        <li><a href="#引入spark">引入Spark</a></li>
        <li><a href="#测试执行">测试执行</a></li>
        <li><a href="#原理分析">原理分析</a></li>
        <li><a href="#一个可以测试的demo例子">一个可以测试的demo例子</a></li>
        <li><a href="#总结">总结</a></li>
      </ul>
    </li>
    <li><a href="#elasticsearch解析问题分析">ElasticSearch解析问题分析</a>
      <ul>
        <li><a href="#问题描述">问题描述</a></li>
        <li><a href="#解析问题">解析问题</a></li>
        <li><a href="#生成json问题">生成JSON问题</a></li>
        <li><a href="#es-查询语句">ES 查询语句：</a></li>
        <li><a href="#目前-es-的问题">目前 ES 的问题</a></li>
      </ul>
    </li>
    <li><a href="#测试中发现的bug记录">测试中发现的bug记录</a></li>
    <li><a href="#精简client驱动依赖">精简client驱动依赖</a>
      <ul>
        <li><a href="#依赖包">依赖包</a></li>
        <li><a href="#发现的问题">发现的问题</a>
          <ul>
            <li><a href="#protobuf">protobuf</a></li>
            <li><a href="#slf4j">slf4j</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
        
        <div class="post-meta">
            
            <span class="post-meta meta-tags">
                <ul class="clearfix">
                    <a href='/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE'>大数据</a>
                </ul>
            </span>
            
        </div>
        
        
        <div class="post-meta">
            <span id="busuanzi_container_page_pv">|<span id="busuanzi_value_page_pv"></span><span>
                    阅读</span></span>
        </div>
        
        
        <div class="post-content">
            <h1 id="jdbc服务端解析">JDBC服务端解析</h1>
<h2 id="架构">架构</h2>
<p>服务端整体架构如下：

        <a data-fancybox="gallery" href="https://woquhaha.gitee.io/pic_tech_1/post/2021/12/%E7%BB%9F%E4%B8%80%E6%9F%A5%E8%AF%A2%E9%A1%B9%E7%9B%AE%E6%95%B4%E5%90%88Calcite/1.jpg">
            <img class="mx-auto" alt="" src="https://woquhaha.gitee.io/pic_tech_1/post/2021/12/%E7%BB%9F%E4%B8%80%E6%9F%A5%E8%AF%A2%E9%A1%B9%E7%9B%AE%E6%95%B4%E5%90%88Calcite/1.jpg" />
        </a>
    <br>
服务端依托于<code>Jetty</code>运行的，通过内嵌的方式启动一个jetty，将<code>AvaticaJsonHandler</code>注册到jeety中。<br>
客户端发送的是JSON或者Protobuf格式的协议，服务端接收到请求后会调用<code>AvaticaJsonHandler</code>来处理这个请求。<br>
<code>AvaticaJsonHandler</code>首先解析请求，然后执行请求内容，在执行的时候根据是否是直连会选择两种执行方式：</p>
<ul>
<li>原始的JDBC方式执行</li>
<li>调用my-project来执行，这里就是调用SqlRunner、Pipeline那套流程</li>
</ul>
<p>客户端和服务端进行交互的时候，是根据不同的操作，调用对应的对象，再将这些对象 编码/解码<br>
比如，要执行创建连接，那么会触发一个<code>openConnection</code>的操作，之后生成<code>OpenConnectionRequest</code>的对象。客户端会将这个对象编码为 JSON 或者 Protobuf。<br>
类似的，服务端会接收到这个 JSON，然后将其解码成<code>OpenConnectionRequest</code>对象，再触发对应的操作。</p>
<p>客户端封装的请求类型如下(下面的都是一系列操作对象，发送前会被编码为JSON格式)：  <br>

        <a data-fancybox="gallery" href="https://woquhaha.gitee.io/pic_tech_1/post/2021/12/%E7%BB%9F%E4%B8%80%E6%9F%A5%E8%AF%A2%E9%A1%B9%E7%9B%AE%E6%95%B4%E5%90%88Calcite/2.png">
            <img class="mx-auto" alt="" src="https://woquhaha.gitee.io/pic_tech_1/post/2021/12/%E7%BB%9F%E4%B8%80%E6%9F%A5%E8%AF%A2%E9%A1%B9%E7%9B%AE%E6%95%B4%E5%90%88Calcite/2.png" />
        </a>
    </p>
<p>服务端封装的请求类型如下(将JSON格式解码为下面这些对象)：   <br>

        <a data-fancybox="gallery" href="https://woquhaha.gitee.io/pic_tech_1/post/2021/12/%E7%BB%9F%E4%B8%80%E6%9F%A5%E8%AF%A2%E9%A1%B9%E7%9B%AE%E6%95%B4%E5%90%88Calcite/3.jpg">
            <img class="mx-auto" alt="" src="https://woquhaha.gitee.io/pic_tech_1/post/2021/12/%E7%BB%9F%E4%B8%80%E6%9F%A5%E8%AF%A2%E9%A1%B9%E7%9B%AE%E6%95%B4%E5%90%88Calcite/3.jpg" />
        </a>
    </p>
<p>客户端 -&gt; 服务端的交互概览如下：

        <a data-fancybox="gallery" href="https://woquhaha.gitee.io/pic_tech_1/post/2021/12/%E7%BB%9F%E4%B8%80%E6%9F%A5%E8%AF%A2%E9%A1%B9%E7%9B%AE%E6%95%B4%E5%90%88Calcite/4.jpg">
            <img class="mx-auto" alt="" src="https://woquhaha.gitee.io/pic_tech_1/post/2021/12/%E7%BB%9F%E4%B8%80%E6%9F%A5%E8%AF%A2%E9%A1%B9%E7%9B%AE%E6%95%B4%E5%90%88Calcite/4.jpg" />
        </a>
      <br>
客户端执行 JDBC 查询，比如<code>openConnect</code>、<code>createStatement</code>等操作，这会委托给 AvaticaConnection 这个类去做。<br>
AvaticaConnection 又会调用到<code>Meta</code>，<code>Meta</code>只是一个接口，所以需要一个具体的实现类。<br>
这里的实现类是<code>QuicksqlRemoteMeta</code>，但看起来<code>RemoteMeta</code>也能完成，不清楚 quicksql 的实现有何用处<br>
似乎<code>Meta</code>的实现类只是作为一个桥接用的，用来连接 AvaticaConnection 和 具体发送者之间的桥梁。<br>
RemoteMeta 最后会交给 JsonService 来完成。在 JsonService 内部完成对象的编码 和 解码，HTTP发送动作是由 RemoteService来做的。
以上就是客户端的工作了，再看服务端：<br>
服务端是依托于 Jetty 的，jetty 接收到请求会交给自定义的 AvaticaJsonHandler， 再交给 JsonHandler 来完成 decode 和 encode</p>
<p>所谓的 decode 就是将请求的 json 解码(用jackson将json解析成对象类型)，之后交给 my-projectServiceMeta，这个类也类似于桥梁的作用，真正执行的是交给后面的 my-project-code去做的。</p>
<h2 id="查询过程">查询过程</h2>
<h3 id="创建连接">创建连接</h3>
<p>执行一个创建连接的动作:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Connection connection <span style="color:#ff79c6">=</span> DriverManager<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getConnection</span><span style="color:#ff79c6">(</span>url<span style="color:#ff79c6">,</span> properties<span style="color:#ff79c6">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>客户端会发送一个UUID，服务端根据这个UUID会将连接<code>java.sql.Connection</code>、<code>java.sql.Statement</code>给缓存(Guava)起来。<br>
下次再有请求过来会首先从缓存中查找。<br>
这里客户端需要服务端执行一个<code>openConnection</code>操作，也就是下面 json 中request中表示的
客户端发送json：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">&#34;request&#34;</span>: <span style="color:#f1fa8c">&#34;openConnection&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">&#34;connectionId&#34;</span>: <span style="color:#f1fa8c">&#34;cebe4551-9788-439e-8d1a-792064cd7a00&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">&#34;info&#34;</span>: {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">&#34;schemaPath&#34;</span>: {
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">&#34;version&#34;</span>: <span style="color:#f1fa8c">&#34;1.0&#34;</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">&#34;defaultSchema&#34;</span>: <span style="color:#f1fa8c">&#34;my_test&#34;</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">&#34;schemas&#34;</span>: [{
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;name&#34;</span>: <span style="color:#f1fa8c">&#34;my_test&#34;</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;type&#34;</span>: <span style="color:#f1fa8c">&#34;custom&#34;</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;factory&#34;</span>: <span style="color:#f1fa8c">&#34;org.apache.calcite.adapter.jdbc.JdbcSchema$Factory&#34;</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;operand&#34;</span>: {
</span></span><span style="display:flex;"><span>					<span style="color:#ff79c6">&#34;jdbcDriver&#34;</span>: <span style="color:#f1fa8c">&#34;com.mysql.jdbc.Driver&#34;</span>,
</span></span><span style="display:flex;"><span>					<span style="color:#ff79c6">&#34;jdbcUrl&#34;</span>: <span style="color:#f1fa8c">&#34;jdbc:mysql://10.200.64.11:3306/my_test?useSSL=false&#34;</span>,
</span></span><span style="display:flex;"><span>					<span style="color:#ff79c6">&#34;jdbcUser&#34;</span>: <span style="color:#f1fa8c">&#34;name&#34;</span>,
</span></span><span style="display:flex;"><span>					<span style="color:#ff79c6">&#34;jdbcPassword&#34;</span>: <span style="color:#f1fa8c">&#34;password&#34;</span>,
</span></span><span style="display:flex;"><span>					<span style="color:#ff79c6">&#34;dbType&#34;</span>: <span style="color:#f1fa8c">&#34;mysql&#34;</span>
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}]
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>服务端返回的json：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">&#34;response&#34;</span>: <span style="color:#f1fa8c">&#34;openConnection&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">&#34;rpcMetadata&#34;</span>: {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">&#34;response&#34;</span>: <span style="color:#f1fa8c">&#34;rpcMetadata&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">&#34;serverAddress&#34;</span>: <span style="color:#f1fa8c">&#34;KJBJ-01-DN-004889:15888&#34;</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="创建statement">创建statement</h3>
<p>再执行一个创建statement的动作：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Statement statement1 <span style="color:#ff79c6">=</span> connection<span style="color:#ff79c6">.</span><span style="color:#50fa7b">createStatement</span><span style="color:#ff79c6">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里会继续触发一个 HTTP 请求，客户端会继续使用之前的 UUID，服务端根据 请求的 UUID 从缓存中取出连接。<br>
这次客户端会要求执行<code>connectionSync</code>这个操作：
客户端发送的json：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">&#34;request&#34;</span>: <span style="color:#f1fa8c">&#34;connectionSync&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">&#34;connectionId&#34;</span>: <span style="color:#f1fa8c">&#34;cebe4551-9788-439e-8d1a-792064cd7a00&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">&#34;connProps&#34;</span>: {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">&#34;connProps&#34;</span>: <span style="color:#f1fa8c">&#34;connPropsImpl&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">&#34;autoCommit&#34;</span>: <span style="color:#ff79c6">null</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">&#34;readOnly&#34;</span>: <span style="color:#ff79c6">null</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">&#34;transactionIsolation&#34;</span>: <span style="color:#ff79c6">null</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">&#34;catalog&#34;</span>: <span style="color:#ff79c6">null</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">&#34;schema&#34;</span>: <span style="color:#ff79c6">null</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">&#34;dirty&#34;</span>: <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>服务端返回的json：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">&#34;response&#34;</span>: <span style="color:#f1fa8c">&#34;connectionSync&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">&#34;connProps&#34;</span>: {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">&#34;connProps&#34;</span>: <span style="color:#f1fa8c">&#34;connPropsImpl&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">&#34;autoCommit&#34;</span>: <span style="color:#ff79c6">null</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">&#34;readOnly&#34;</span>: <span style="color:#ff79c6">null</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">&#34;transactionIsolation&#34;</span>: <span style="color:#ff79c6">null</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">&#34;catalog&#34;</span>: <span style="color:#ff79c6">null</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">&#34;schema&#34;</span>: <span style="color:#ff79c6">null</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">&#34;dirty&#34;</span>: <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">&#34;rpcMetadata&#34;</span>: {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">&#34;response&#34;</span>: <span style="color:#f1fa8c">&#34;rpcMetadata&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">&#34;serverAddress&#34;</span>: <span style="color:#f1fa8c">&#34;KJBJ-01-DN-004889:15888&#34;</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>之后客户端会要求执行<code>createStatement</code>这个操作
客户端再次发送：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">&#34;request&#34;</span>: <span style="color:#f1fa8c">&#34;createStatement&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">&#34;connectionId&#34;</span>: <span style="color:#f1fa8c">&#34;cebe4551-9788-439e-8d1a-792064cd7a00&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>服务端响应：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">&#34;response&#34;</span>: <span style="color:#f1fa8c">&#34;createStatement&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">&#34;connectionId&#34;</span>: <span style="color:#f1fa8c">&#34;cebe4551-9788-439e-8d1a-792064cd7a00&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">&#34;statementId&#34;</span>: <span style="color:#bd93f9">0</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">&#34;rpcMetadata&#34;</span>: {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">&#34;response&#34;</span>: <span style="color:#f1fa8c">&#34;rpcMetadata&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">&#34;serverAddress&#34;</span>: <span style="color:#f1fa8c">&#34;KJBJ-01-DN-004889:15888&#34;</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="执行查询">执行查询</h3>
<p>执行的时序图如下：

        <a data-fancybox="gallery" href="https://woquhaha.gitee.io/pic_tech_1/post/2021/12/%E7%BB%9F%E4%B8%80%E6%9F%A5%E8%AF%A2%E9%A1%B9%E7%9B%AE%E6%95%B4%E5%90%88Calcite/5.jpg">
            <img class="mx-auto" alt="" src="https://woquhaha.gitee.io/pic_tech_1/post/2021/12/%E7%BB%9F%E4%B8%80%E6%9F%A5%E8%AF%A2%E9%A1%B9%E7%9B%AE%E6%95%B4%E5%90%88Calcite/5.jpg" />
        </a>
    <br>
首先客户端发送请求给<strong>jetty</strong>，<strong>jetty</strong>接受到请求后，会调用到自定义的handler，也就是<code>AvaticaJsonHandler</code>。<br>
<code>AvaticaJsonHandler</code>是真正执行具体逻辑的地方，这里主要干两件事：</p>
<ul>
<li>根据请求对象解析出传递的内容，也就是解析json；根据json格式生成对应的对象</li>
<li>执行这个对象，并生成json结果，最后返回给客户端</li>
</ul>
<p>这里解析完<strong>json</strong>后，得到的是<code>PrepareAndExecuteRequest</code>这么一个对象，之后会触发到<code>QuicksqlServerMeta</code>来执行<strong>prepareAndExecute</strong>函数。<br>
这个函数就是用于执行具体sql的，它会根据客户端传递的参数，来决定执行方式：</p>
<ul>
<li>如果客户端传递的直连查询，就用原始的JDBC方式查询，比如创建mysql驱动再查询mysql，或者创建oracle驱动再查询oracle</li>
<li>非直连查询，这里走的就是正常的calcite逻辑，也就是调用 SqlRunner解析sql并得到一个pipeline，再执行pipeline，最后将结果封装成ExecuteResutl并返回给客户端</li>
</ul>
<p>客户端发送查询，要求执行<code>prepareAndExecute</code>操作</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">&#34;request&#34;</span>: <span style="color:#f1fa8c">&#34;prepareAndExecute&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">&#34;connectionId&#34;</span>: <span style="color:#f1fa8c">&#34;0f276a88-335f-4f01-8916-36d11075e223&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">&#34;statementId&#34;</span>: <span style="color:#bd93f9">1</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">&#34;sql&#34;</span>: <span style="color:#f1fa8c">&#34;select * from my_test&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">&#34;maxRowsInFirstFrame&#34;</span>: <span style="color:#bd93f9">-1</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">&#34;maxRowCount&#34;</span>: <span style="color:#bd93f9">-1</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>服务端返回结果：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">76
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">77
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">78
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">79
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">80
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">81
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">82
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">83
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">84
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">85
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">86
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">87
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">88
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">89
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">90
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">91
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">92
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">93
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">94
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">95
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">96
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">97
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">98
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">&#34;response&#34;</span>: <span style="color:#f1fa8c">&#34;executeResults&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">&#34;missingStatement&#34;</span>: <span style="color:#ff79c6">false</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">&#34;rpcMetadata&#34;</span>: {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">&#34;response&#34;</span>: <span style="color:#f1fa8c">&#34;rpcMetadata&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">&#34;serverAddress&#34;</span>: <span style="color:#f1fa8c">&#34;KJBJ-01-DN-004889:5888&#34;</span>
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">&#34;results&#34;</span>: [{
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">&#34;response&#34;</span>: <span style="color:#f1fa8c">&#34;resultSet&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">&#34;connectionId&#34;</span>: <span style="color:#f1fa8c">&#34;0f276a88-335f-4f01-8916-36d11075e223&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">&#34;statementId&#34;</span>: <span style="color:#bd93f9">1</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">&#34;ownStatement&#34;</span>: <span style="color:#ff79c6">true</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">&#34;signature&#34;</span>: {
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">&#34;columns&#34;</span>: [{
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;ordinal&#34;</span>: <span style="color:#bd93f9">0</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;autoIncrement&#34;</span>: <span style="color:#ff79c6">true</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;caseSensitive&#34;</span>: <span style="color:#ff79c6">false</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;searchable&#34;</span>: <span style="color:#ff79c6">true</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;currency&#34;</span>: <span style="color:#ff79c6">false</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;nullable&#34;</span>: <span style="color:#bd93f9">0</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;signed&#34;</span>: <span style="color:#ff79c6">true</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;displaySize&#34;</span>: <span style="color:#bd93f9">11</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;label&#34;</span>: <span style="color:#f1fa8c">&#34;id&#34;</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;columnName&#34;</span>: <span style="color:#f1fa8c">&#34;id&#34;</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;schemaName&#34;</span>: <span style="color:#f1fa8c">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;precision&#34;</span>: <span style="color:#bd93f9">11</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;scale&#34;</span>: <span style="color:#bd93f9">0</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;tableName&#34;</span>: <span style="color:#f1fa8c">&#34;my_test&#34;</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;catalogName&#34;</span>: <span style="color:#f1fa8c">&#34;linkis_test&#34;</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;type&#34;</span>: {
</span></span><span style="display:flex;"><span>					<span style="color:#ff79c6">&#34;type&#34;</span>: <span style="color:#f1fa8c">&#34;scalar&#34;</span>,
</span></span><span style="display:flex;"><span>					<span style="color:#ff79c6">&#34;id&#34;</span>: <span style="color:#bd93f9">4</span>,
</span></span><span style="display:flex;"><span>					<span style="color:#ff79c6">&#34;name&#34;</span>: <span style="color:#f1fa8c">&#34;INT&#34;</span>,
</span></span><span style="display:flex;"><span>					<span style="color:#ff79c6">&#34;rep&#34;</span>: <span style="color:#f1fa8c">&#34;PRIMITIVE_INT&#34;</span>
</span></span><span style="display:flex;"><span>				},
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;readOnly&#34;</span>: <span style="color:#ff79c6">false</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;writable&#34;</span>: <span style="color:#ff79c6">true</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;definitelyWritable&#34;</span>: <span style="color:#ff79c6">true</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;columnClassName&#34;</span>: <span style="color:#f1fa8c">&#34;java.lang.Integer&#34;</span>
</span></span><span style="display:flex;"><span>			}, {
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;ordinal&#34;</span>: <span style="color:#bd93f9">1</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;autoIncrement&#34;</span>: <span style="color:#ff79c6">false</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;caseSensitive&#34;</span>: <span style="color:#ff79c6">false</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;searchable&#34;</span>: <span style="color:#ff79c6">true</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;currency&#34;</span>: <span style="color:#ff79c6">false</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;nullable&#34;</span>: <span style="color:#bd93f9">1</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;signed&#34;</span>: <span style="color:#ff79c6">false</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;displaySize&#34;</span>: <span style="color:#bd93f9">200</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;label&#34;</span>: <span style="color:#f1fa8c">&#34;name&#34;</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;columnName&#34;</span>: <span style="color:#f1fa8c">&#34;name&#34;</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;schemaName&#34;</span>: <span style="color:#f1fa8c">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;precision&#34;</span>: <span style="color:#bd93f9">200</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;scale&#34;</span>: <span style="color:#bd93f9">0</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;tableName&#34;</span>: <span style="color:#f1fa8c">&#34;my_test&#34;</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;catalogName&#34;</span>: <span style="color:#f1fa8c">&#34;linkis_test&#34;</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;type&#34;</span>: {
</span></span><span style="display:flex;"><span>					<span style="color:#ff79c6">&#34;type&#34;</span>: <span style="color:#f1fa8c">&#34;scalar&#34;</span>,
</span></span><span style="display:flex;"><span>					<span style="color:#ff79c6">&#34;id&#34;</span>: <span style="color:#bd93f9">12</span>,
</span></span><span style="display:flex;"><span>					<span style="color:#ff79c6">&#34;name&#34;</span>: <span style="color:#f1fa8c">&#34;VARCHAR&#34;</span>,
</span></span><span style="display:flex;"><span>					<span style="color:#ff79c6">&#34;rep&#34;</span>: <span style="color:#f1fa8c">&#34;STRING&#34;</span>
</span></span><span style="display:flex;"><span>				},
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;readOnly&#34;</span>: <span style="color:#ff79c6">false</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;writable&#34;</span>: <span style="color:#ff79c6">true</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;definitelyWritable&#34;</span>: <span style="color:#ff79c6">true</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;columnClassName&#34;</span>: <span style="color:#f1fa8c">&#34;java.lang.String&#34;</span>
</span></span><span style="display:flex;"><span>			}],
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">&#34;sql&#34;</span>: <span style="color:#ff79c6">null</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">&#34;parameters&#34;</span>: [],
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">&#34;cursorFactory&#34;</span>: {
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;style&#34;</span>: <span style="color:#f1fa8c">&#34;LIST&#34;</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;clazz&#34;</span>: <span style="color:#ff79c6">null</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;fieldNames&#34;</span>: <span style="color:#ff79c6">null</span>
</span></span><span style="display:flex;"><span>			},
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">&#34;statementType&#34;</span>: <span style="color:#ff79c6">null</span>
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">&#34;firstFrame&#34;</span>: {
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">&#34;offset&#34;</span>: <span style="color:#bd93f9">0</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">&#34;done&#34;</span>: <span style="color:#ff79c6">true</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">&#34;rows&#34;</span>: [
</span></span><span style="display:flex;"><span>				[<span style="color:#bd93f9">1</span>, <span style="color:#f1fa8c">&#34;aaaaa&#34;</span>],
</span></span><span style="display:flex;"><span>				[<span style="color:#bd93f9">2</span>, <span style="color:#f1fa8c">&#34;bbbb&#34;</span>],
</span></span><span style="display:flex;"><span>				[<span style="color:#bd93f9">3</span>, <span style="color:#f1fa8c">&#34;ccccc&#34;</span>],
</span></span><span style="display:flex;"><span>				[<span style="color:#bd93f9">4</span>, <span style="color:#f1fa8c">&#34;dddd&#34;</span>],
</span></span><span style="display:flex;"><span>				[<span style="color:#bd93f9">5</span>, <span style="color:#f1fa8c">&#34;eeee&#34;</span>],
</span></span><span style="display:flex;"><span>				[<span style="color:#bd93f9">8</span>, <span style="color:#f1fa8c">&#34;xxxxxxxx!!!&#34;</span>],
</span></span><span style="display:flex;"><span>				[<span style="color:#bd93f9">9</span>, <span style="color:#f1fa8c">&#34;kkkkkkk&#34;</span>],
</span></span><span style="display:flex;"><span>				[<span style="color:#bd93f9">10</span>, <span style="color:#f1fa8c">&#34;wokao&#34;</span>],
</span></span><span style="display:flex;"><span>				[<span style="color:#bd93f9">11</span>, <span style="color:#ff79c6">null</span>],
</span></span><span style="display:flex;"><span>				[<span style="color:#bd93f9">12</span>, <span style="color:#f1fa8c">&#34;xxxxx!!!&#34;</span>]
</span></span><span style="display:flex;"><span>			]
</span></span><span style="display:flex;"><span>		},
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">&#34;updateCount&#34;</span>: <span style="color:#bd93f9">-1</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">&#34;rpcMetadata&#34;</span>: {
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">&#34;response&#34;</span>: <span style="color:#f1fa8c">&#34;rpcMetadata&#34;</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">&#34;serverAddress&#34;</span>: <span style="color:#f1fa8c">&#34;KJBJ-01-DN-004889:5888&#34;</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="调试记录">调试记录</h2>
<h3 id="正确的结果">正确的结果</h3>
<p>需要解析的json：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{<span style="color:#ff79c6">&#34;request&#34;</span>:<span style="color:#f1fa8c">&#34;prepareAndExecute&#34;</span>,<span style="color:#ff79c6">&#34;connectionId&#34;</span>:<span style="color:#f1fa8c">&#34;1c5b48cf-78b9-4373-a256-3a28ed11a6b5&#34;</span>,<span style="color:#ff79c6">&#34;statementId&#34;</span>:<span style="color:#bd93f9">0</span>,
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">&#34;sql&#34;</span>:<span style="color:#f1fa8c">&#34;select * from my_test&#34;</span>,<span style="color:#ff79c6">&#34;maxRowsInFirstFrame&#34;</span>:<span style="color:#bd93f9">-1</span>,<span style="color:#ff79c6">&#34;maxRowCount&#34;</span>:<span style="color:#bd93f9">-1</span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>class类型：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">org</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">apache</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">calcite</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">avatica</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">remote</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">Service$Request</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>com.fasterxml.jackson.databind.ObjectMapper 版本：</p>
<pre tabindex="0"><code>result = {ProtectionDomain@3518} &#34;ProtectionDomain  (file:/E:/maven_repository/com/fasterxml/jackson/core/jackson-databind/2.6.5/
jackson-databind-2.6.5.jar &lt;no signer certificates&gt;)
 jdk.internal.loader.ClassLoaders$AppClassLoader@2f0e140b\n &lt;no principals&gt;
 java.security.Permissions@2cc846be (\n (&#34;java.lang.RuntimePermission&#34; &#34;exitVM&#34;)
 (&#34;java.io.FilePermission&#34; &#34;E:\maven_repository\com\fasterxml\jackson\core\jackson-databind\2.6.5\jackson-databi
 nd-2.6.5.jar&#34; &#34;read&#34;))&#34;
 
 codesource = {CodeSource@3527} &#34;(file:/E:/maven_repository/com/fasterxml
 /jackson/core/jackson-databind/2.6.5/
 jackson-databind-2.6.5.jar &lt;no signer certificates&gt;)&#34;
</code></pre><h3 id="错误的结果">错误的结果</h3>
<p>需要解析的json：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{<span style="color:#ff79c6">&#34;request&#34;</span>:<span style="color:#f1fa8c">&#34;prepareAndExecute&#34;</span>,<span style="color:#ff79c6">&#34;connectionId&#34;</span>:<span style="color:#f1fa8c">&#34;aaca743e-5dda-48e8-ae38-e419afd592ae&#34;</span>,
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">&#34;statementId&#34;</span>:<span style="color:#bd93f9">0</span>,<span style="color:#ff79c6">&#34;sql&#34;</span>:<span style="color:#f1fa8c">&#34;select * from
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"> my_test&#34;</span>,<span style="color:#ff79c6">&#34;maxRowsInFirstFrame&#34;</span>:<span style="color:#bd93f9">-1</span>,<span style="color:#ff79c6">&#34;maxRowCount&#34;</span>:<span style="color:#bd93f9">-1</span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>class类型：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">org</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">apache</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">calcite</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">avatica</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">remote</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">Service$Request</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>com.fasterxml.jackson.databind.ObjectMapper 版本：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>result <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>ProtectionDomain@3478<span style="color:#ff79c6">}</span> <span style="color:#f1fa8c">&#34;ProtectionDomain  (file:/E:/maven_repository/com/fasterxml/jackson/core/
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">jackson-databind/2.6.5/jackson-databind-2.6.5.jar &lt;no signer certificates&gt;)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"> jdk.internal.loader.ClassLoaders$AppClassLoader@2f0e140b\n &lt;no principals&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"> java.security.Permissions@e84bed7 (\n (&#34;</span>java<span style="color:#ff79c6">.</span><span style="color:#50fa7b">lang</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">RuntimePermission</span><span style="color:#f1fa8c">&#34; &#34;</span>exitVM<span style="color:#f1fa8c">&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"> (&#34;</span>java<span style="color:#ff79c6">.</span><span style="color:#50fa7b">io</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">FilePermission</span><span style="color:#f1fa8c">&#34; &#34;</span>E<span style="color:#ff79c6">:</span>\maven_repository\com\fasterxml\jackson\core\jackson<span style="color:#ff79c6">-</span>databind\2<span style="color:#ff79c6">.</span><span style="color:#50fa7b">6</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">5</span>
</span></span><span style="display:flex;"><span> \jackson<span style="color:#ff79c6">-</span>databind<span style="color:#ff79c6">-</span>2<span style="color:#ff79c6">.</span><span style="color:#50fa7b">6</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">5</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">jar</span><span style="color:#f1fa8c">&#34; &#34;</span>read<span style="color:#f1fa8c">&#34;)\n)&#34;</span>
</span></span><span style="display:flex;"><span> codesource <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">{</span>CodeSource@3488<span style="color:#ff79c6">}</span> <span style="color:#f1fa8c">&#34;(file:/E:/maven_repository/com/fasterxml/jackson/core/jackson-databind/
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c"> 2.6.5/jackson-databind-2.6.5.jar &lt;no signer certificates&gt;)&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>PrepareAandExecuteRequest</p>
<pre tabindex="0"><code>{&#34;request&#34;:&#34;prepareAndExecute&#34;,&#34;connectionId&#34;:&#34;56fca4c8-495a-4024-9c6e-5c5d54e36ddc&#34;,&#34;statementId&#34;:0,&#34;sql&#34;:&#34;select * from my_test&#34;,&#34;maxRowsInFirstFrame&#34;:-1,&#34;maxRowCount&#34;:-1}
</code></pre><p>真正出错的地方：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> HandlerResponse<span style="color:#ff79c6">&lt;</span>T<span style="color:#ff79c6">&gt;</span> <span style="color:#50fa7b">apply</span><span style="color:#ff79c6">(</span>T serializedRequest<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            Request request <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">decode</span><span style="color:#ff79c6">(</span>serializedRequest<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            Response response <span style="color:#ff79c6">=</span> request<span style="color:#ff79c6">.</span><span style="color:#50fa7b">accept</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">service</span><span style="color:#ff79c6">);</span>    <span style="color:#6272a4">//这里出错的
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> HandlerResponse<span style="color:#ff79c6">(</span><span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">encode</span><span style="color:#ff79c6">(</span>response<span style="color:#ff79c6">),</span> 200<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Exception var4<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">convertToErrorResponse</span><span style="color:#ff79c6">(</span>var4<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>原因：
</span></span><span style="display:flex;"><span>java<span style="color:#ff79c6">.</span><span style="color:#50fa7b">lang</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">NoClassDefFoundError</span><span style="color:#ff79c6">:</span> Could not initialize <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">com</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">my</span><span style="color:#ff79c6">-</span>project<span style="color:#ff79c6">.</span><span style="color:#50fa7b">utils</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">JdbcSourceInfo</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="calcite自身对spark的整合分析">Calcite自身对Spark的整合分析</h1>
<h2 id="引入spark">引入Spark</h2>
<p><code>Calcite</code>自身就可以支持<code>Spark</code>，只需要引入相关的类就可以。<br>
依赖的类以 <code>org.apache.calcite.adapter.spark</code> 开头。<br>
不过这些类并不在 <code>Calcite 1.26</code> 的库中，需要单独引入进来。<br>
下载<code>Calcite</code>的源码，就可以拿到这些类了，然后将这些类以源码的方式引入工程中。<br>

        <a data-fancybox="gallery" href="https://woquhaha.gitee.io/pic_tech_1/post/2021/12/%E7%BB%9F%E4%B8%80%E6%9F%A5%E8%AF%A2%E9%A1%B9%E7%9B%AE%E6%95%B4%E5%90%88Calcite/6.png">
            <img class="mx-auto" alt="" src="https://woquhaha.gitee.io/pic_tech_1/post/2021/12/%E7%BB%9F%E4%B8%80%E6%9F%A5%E8%AF%A2%E9%A1%B9%E7%9B%AE%E6%95%B4%E5%90%88Calcite/6.png" />
        </a>
    </p>
<p>再引入相关依赖：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;groupId&gt;</span>org.apache.spark<span style="color:#ff79c6">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;artifactId&gt;</span>spark-core_2.11<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;version&gt;</span>2.4.3<span style="color:#ff79c6">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;groupId&gt;</span>org.apache.spark<span style="color:#ff79c6">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;artifactId&gt;</span>spark-sql_2.11<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;version&gt;</span>2.4.3<span style="color:#ff79c6">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;groupId&gt;</span>org.jetbrains<span style="color:#ff79c6">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;artifactId&gt;</span>annotations<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;version&gt;</span>RELEASE<span style="color:#ff79c6">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;scope&gt;</span>compile<span style="color:#ff79c6">&lt;/scope&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;groupId&gt;</span>org.codehaus.janino<span style="color:#ff79c6">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;artifactId&gt;</span>commons-compiler<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;version&gt;</span>3.0.11<span style="color:#ff79c6">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;groupId&gt;</span>org.checkerframework<span style="color:#ff79c6">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;artifactId&gt;</span>checker-qual<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;version&gt;</span>2.0.0<span style="color:#ff79c6">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="测试执行">测试执行</h2>
<p>这个很简单，增加一句话就可以了，如下面代码，增加第二行即可。</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>        Properties properties <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Properties<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        properties<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setProperty</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;spark&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;true&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        Connection connection <span style="color:#ff79c6">=</span> CalciteUtil<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getConnect</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;/cross_join.json&#34;</span><span style="color:#ff79c6">,</span> properties<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        Statement statement <span style="color:#ff79c6">=</span> connection<span style="color:#ff79c6">.</span><span style="color:#50fa7b">createStatement</span><span style="color:#ff79c6">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="原理分析">原理分析</h2>
<p>从<code>Test</code>类开始，经过一路调用：</p>
<pre tabindex="0"><code>             Test
              |
AvaticaStatement#executeQuery
              |
AvaticaConnection#prepareAndExecuteInternal
              |
CalciteMetaImpl#prepareAndExecute
              |
CalcitePrepareImpl#parseQuery
              |
        create spark handler
</code></pre><p>最后由<code>ContextImpl</code>这个类完成创建<code>SparkHanlder</code>，它继承自<code>CalcitePrepare.Context</code>：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> CalcitePrepare<span style="color:#ff79c6">.</span><span style="color:#50fa7b">SparkHandler</span> <span style="color:#50fa7b">spark</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">boolean</span> enable <span style="color:#ff79c6">=</span> config<span style="color:#ff79c6">().</span><span style="color:#50fa7b">spark</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> CalcitePrepare<span style="color:#ff79c6">.</span><span style="color:#50fa7b">Dummy</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getSparkHandler</span><span style="color:#ff79c6">(</span>enable<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">synchronized</span> SparkHandler <span style="color:#50fa7b">getSparkHandler</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">boolean</span> enable<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>sparkHandler <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        sparkHandler <span style="color:#ff79c6">=</span> enable <span style="color:#ff79c6">?</span> createHandler<span style="color:#ff79c6">()</span> <span style="color:#ff79c6">:</span> <span style="color:#ff79c6">new</span> TrivialSparkHandler<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> sparkHandler<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> SparkHandler <span style="color:#50fa7b">createHandler</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">final</span> Class<span style="color:#ff79c6">&lt;?&gt;</span> clazz <span style="color:#ff79c6">=</span>
</span></span><span style="display:flex;"><span>            Class<span style="color:#ff79c6">.</span><span style="color:#50fa7b">forName</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;org.apache.calcite.adapter.spark.SparkHandlerImpl&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        Method method <span style="color:#ff79c6">=</span> clazz<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getMethod</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;instance&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">(</span>CalcitePrepare<span style="color:#ff79c6">.</span><span style="color:#50fa7b">SparkHandler</span><span style="color:#ff79c6">)</span> method<span style="color:#ff79c6">.</span><span style="color:#50fa7b">invoke</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">null</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>ClassNotFoundException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> TrivialSparkHandler<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>IllegalAccessException <span style="color:#ff79c6">|</span> ClassCastException <span style="color:#ff79c6">|</span> InvocationTargetException <span style="color:#ff79c6">|</span> NoSuchMethodException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">throw</span> <span style="color:#ff79c6">new</span> RuntimeException<span style="color:#ff79c6">(</span>e<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>创建<code>SparkHandler</code>时，还有会启动一个内嵌的<code>Jetty</code>服务器，之后程序继续执行，并交给<code>Prepare</code>这个类。</p>
<pre tabindex="0"><code>CalcitePrepareImpl -&gt; Prepare
</code></pre><p><code>Prepare</code>这类看起来是<code>Avtical</code>和<code>Calcite</code>内部的桥梁。<br>
<code>Prepare</code>又会委托<code>CalciteConnectionImpl</code>获取<code>DataContext</code>的实现类。<br>
而到这里，就出问题了：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">public</span> DataContext <span style="color:#50fa7b">createDataContext</span><span style="color:#ff79c6">(</span>Map<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">,</span> Object<span style="color:#ff79c6">&gt;</span> parameterValues<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span>      CalciteSchema rootSchema<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>config<span style="color:#ff79c6">().</span><span style="color:#50fa7b">spark</span><span style="color:#ff79c6">())</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> SlimDataContext<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> DataContextImpl<span style="color:#ff79c6">(</span><span style="color:#ff79c6">this</span><span style="color:#ff79c6">,</span> parameterValues<span style="color:#ff79c6">,</span> rootSchema<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里返回的<code>SlimDataContext </code>内部实现全部都是空：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">SlimDataContext</span> <span style="color:#8be9fd;font-style:italic">implements</span> DataContext<span style="color:#ff79c6">,</span> Serializable <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> SchemaPlus <span style="color:#50fa7b">getRootSchema</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> JavaTypeFactory <span style="color:#50fa7b">getTypeFactory</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> QueryProvider <span style="color:#50fa7b">getQueryProvider</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> Object <span style="color:#50fa7b">get</span><span style="color:#ff79c6">(</span>String name<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>再往后，就是 <code>Calcite</code>调用逻辑表达式，转换成物理表达式，利用<code>linq4j</code>将物理表达式转换成对应的代码片段。<br>
生成的代码，再编码代码片段并执行。<br>
代码片段很长，这里截取其中一小段，注意<code>root.getRootSchema()</code>：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">final</span> org<span style="color:#ff79c6">.</span><span style="color:#50fa7b">apache</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">calcite</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">linq4j</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">Enumerable</span> _inputEnumerable <span style="color:#ff79c6">=</span> 
</span></span><span style="display:flex;"><span>org<span style="color:#ff79c6">.</span><span style="color:#50fa7b">apache</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">calcite</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">schema</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">Schemas</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">enumerable</span><span style="color:#ff79c6">((</span>org<span style="color:#ff79c6">.</span><span style="color:#50fa7b">apache</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">calcite</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">schema</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">ScannableTable</span><span style="color:#ff79c6">)</span> 
</span></span><span style="display:flex;"><span>root<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getRootSchema</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">getSubSchema</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;TEST_CSV&#34;</span><span style="color:#ff79c6">).</span><span style="color:#50fa7b">getTable</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;CSV_TEST03&#34;</span><span style="color:#ff79c6">),</span> root<span style="color:#ff79c6">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>代码片段被编译为<code>Bindable</code>接口的实现类，由于是动态编译的，所以无法看到具体实现代码，不过可以通过编译后的<code>class</code>文件反编译。<br>
在<code>CalcitePrepare</code>中，调用动态生成的代码：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> Enumerable<span style="color:#ff79c6">&lt;</span>T<span style="color:#ff79c6">&gt;</span> <span style="color:#50fa7b">enumerable</span><span style="color:#ff79c6">(</span>DataContext dataContext<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>      Enumerable<span style="color:#ff79c6">&lt;</span>T<span style="color:#ff79c6">&gt;</span> enumerable <span style="color:#ff79c6">=</span> bindable<span style="color:#ff79c6">.</span><span style="color:#50fa7b">bind</span><span style="color:#ff79c6">(</span>dataContext<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>maxRowCount <span style="color:#ff79c6">&gt;=</span> 0<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// Apply limit. In JDBC 0 means &#34;no limit&#34;. But for us, -1 means
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// &#34;no limit&#34;, and 0 is a valid limit.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        enumerable <span style="color:#ff79c6">=</span> EnumerableDefaults<span style="color:#ff79c6">.</span><span style="color:#50fa7b">take</span><span style="color:#ff79c6">(</span>enumerable<span style="color:#ff79c6">,</span> maxRowCount<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> enumerable<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>最终会调用到<code>SlimDataContext</code>，进而返回<code>null</code>，导致程序执行出错：<br>

        <a data-fancybox="gallery" href="https://woquhaha.gitee.io/pic_tech_1/post/2021/12/%E7%BB%9F%E4%B8%80%E6%9F%A5%E8%AF%A2%E9%A1%B9%E7%9B%AE%E6%95%B4%E5%90%88Calcite/7.png">
            <img class="mx-auto" alt="" src="https://woquhaha.gitee.io/pic_tech_1/post/2021/12/%E7%BB%9F%E4%B8%80%E6%9F%A5%E8%AF%A2%E9%A1%B9%E7%9B%AE%E6%95%B4%E5%90%88Calcite/7.png" />
        </a>
    </p>
<h2 id="一个可以测试的demo例子">一个可以测试的demo例子</h2>
<p>这个例子可以执行，但没有没法做数<strong>据源拆分</strong>，单数据源可以这么用，但跨数据源就不行了。</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>       Properties properties <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Properties<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        properties<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setProperty</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;spark&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;true&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        CalciteConnection calciteConnection <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        Class<span style="color:#ff79c6">.</span><span style="color:#50fa7b">forName</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;org.apache.calcite.jdbc.Driver&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        Connection aConnection <span style="color:#ff79c6">=</span> DriverManager<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getConnection</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;jdbc:calcite:&#34;</span><span style="color:#ff79c6">,</span> properties<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        DatabaseMetaData metaData <span style="color:#ff79c6">=</span> aConnection<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getMetaData</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;productName=&#34;</span><span style="color:#ff79c6">+</span>metaData<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getDatabaseProductName</span><span style="color:#ff79c6">());</span>
</span></span><span style="display:flex;"><span>        calciteConnection <span style="color:#ff79c6">=</span> aConnection<span style="color:#ff79c6">.</span><span style="color:#50fa7b">unwrap</span><span style="color:#ff79c6">(</span>CalciteConnection<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">//      必须是CalciteConnection继承关系一条链中的才可相互强制转换，如果是自定义的类，就不是那条链上的，会报错
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">//        calciteConnection = aConnection.unwrap(MyCalciteConnection.class);  这么写会报错的
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        CalcitePrepare<span style="color:#ff79c6">.</span><span style="color:#50fa7b">Context</span> context <span style="color:#ff79c6">=</span> calciteConnection<span style="color:#ff79c6">.</span><span style="color:#50fa7b">createPrepareContext</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        CalcitePrepare<span style="color:#ff79c6">.</span><span style="color:#50fa7b">SparkHandler</span> sparkHandler <span style="color:#ff79c6">=</span> context<span style="color:#ff79c6">.</span><span style="color:#50fa7b">spark</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        JavaSparkContext sparkcontext <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>JavaSparkContext<span style="color:#ff79c6">)</span> sparkHandler<span style="color:#ff79c6">.</span><span style="color:#50fa7b">sparkContext</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        JavaRDD<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">&gt;</span> input <span style="color:#ff79c6">=</span> sparkcontext<span style="color:#ff79c6">.</span><span style="color:#50fa7b">parallelize</span><span style="color:#ff79c6">(</span>Arrays<span style="color:#ff79c6">.</span><span style="color:#50fa7b">asList</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;abc,1&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;test,2&#34;</span><span style="color:#ff79c6">));</span>
</span></span><span style="display:flex;"><span>        JavaRDD<span style="color:#ff79c6">&lt;</span>Person<span style="color:#ff79c6">&gt;</span> persons <span style="color:#ff79c6">=</span> input<span style="color:#ff79c6">.</span><span style="color:#50fa7b">map</span><span style="color:#ff79c6">(</span>s <span style="color:#ff79c6">-&gt;</span> s<span style="color:#ff79c6">.</span><span style="color:#50fa7b">split</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;,&#34;</span><span style="color:#ff79c6">)).</span><span style="color:#50fa7b">map</span><span style="color:#ff79c6">(</span>s <span style="color:#ff79c6">-&gt;</span> <span style="color:#ff79c6">new</span> Person<span style="color:#ff79c6">(</span>s<span style="color:#ff79c6">[</span>0<span style="color:#ff79c6">],</span> Integer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">parseInt</span><span style="color:#ff79c6">(</span>s<span style="color:#ff79c6">[</span>1<span style="color:#ff79c6">])));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>persons<span style="color:#ff79c6">.</span><span style="color:#50fa7b">collect</span><span style="color:#ff79c6">());</span>
</span></span><span style="display:flex;"><span>        SparkSession spark <span style="color:#ff79c6">=</span> SparkSession<span style="color:#ff79c6">.</span><span style="color:#50fa7b">builder</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">appName</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;Test&#34;</span><span style="color:#ff79c6">).</span><span style="color:#50fa7b">getOrCreate</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        Dataset<span style="color:#ff79c6">&lt;</span>Row<span style="color:#ff79c6">&gt;</span> df <span style="color:#ff79c6">=</span> spark<span style="color:#ff79c6">.</span><span style="color:#50fa7b">createDataFrame</span><span style="color:#ff79c6">(</span>persons<span style="color:#ff79c6">,</span> Person<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        df<span style="color:#ff79c6">.</span><span style="color:#50fa7b">show</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        df<span style="color:#ff79c6">.</span><span style="color:#50fa7b">printSchema</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        SQLContext sqls <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> SQLContext<span style="color:#ff79c6">(</span>spark<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        sqls<span style="color:#ff79c6">.</span><span style="color:#50fa7b">registerDataFrameAsTable</span><span style="color:#ff79c6">(</span>df<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;person&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        sqls<span style="color:#ff79c6">.</span><span style="color:#50fa7b">sql</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;SELECT * FROM person WHERE age&gt;1&#34;</span><span style="color:#ff79c6">).</span><span style="color:#50fa7b">show</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        sparkcontext<span style="color:#ff79c6">.</span><span style="color:#50fa7b">close</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">Person</span> <span style="color:#8be9fd;font-style:italic">implements</span> Serializable <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">long</span> serialVersionUID <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">-</span>6259413972682177507L<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">private</span> String name<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd">int</span> age<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#50fa7b">Person</span><span style="color:#ff79c6">(</span>String name<span style="color:#ff79c6">,</span> <span style="color:#8be9fd">int</span> age<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">name</span> <span style="color:#ff79c6">=</span> name<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">age</span> <span style="color:#ff79c6">=</span> age<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">public</span> String <span style="color:#50fa7b">toString</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> name <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;: &#34;</span> <span style="color:#ff79c6">+</span> age<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">public</span> String <span style="color:#50fa7b">getName</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> name<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">setName</span><span style="color:#ff79c6">(</span>String name<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">name</span> <span style="color:#ff79c6">=</span> name<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">int</span> <span style="color:#50fa7b">getAge</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> age<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">setAge</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> age<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">age</span> <span style="color:#ff79c6">=</span> age<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="总结">总结</h2>
<p><code>Calcite</code>虽然内部有对<code>Spark</code>的支持，但实现的不完善。</p>
<ul>
<li><code>Calcite</code>从<code>connection</code>逻辑到内部的数据源拆分，整个逻辑绑定的比较紧</li>
<li>生成的代码会用到<code>SlimDataContext</code>，而这个类完全不可用</li>
<li>从调用链看，想用<code>Spark</code>但不好扩展</li>
<li>只支持<code>Spark</code>，不支持其他引擎</li>
</ul>
<h1 id="elasticsearch解析问题分析">ElasticSearch解析问题分析</h1>
<h2 id="问题描述">问题描述</h2>
<p>通过 Calcite 查询 ES，只能做 SELECT 查询，加一个 WHERE条件都会报错。<br>
注册到 Calcite 的model.json如下：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>inline:{
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;version&#34;</span>: <span style="color:#f1fa8c">&#34;1.0&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;defaultSchema&#34;</span>: <span style="color:#f1fa8c">&#34;TEST_CSV&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&#34;schemas&#34;</span>: [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&#34;type&#34;</span>: <span style="color:#f1fa8c">&#34;custom&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&#34;name&#34;</span>: <span style="color:#f1fa8c">&#34;esTest&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&#34;factory&#34;</span>: <span style="color:#f1fa8c">&#34;io.myproject.schema.elasticsearch.ElasticsearchSchemaFactory&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&#34;operand&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&#34;coordinates&#34;</span>: <span style="color:#f1fa8c">&#34;{&#39;localhost&#39;: 9025}&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&#34;userConfig&#34;</span>: <span style="color:#f1fa8c">&#34;{&#39;bulk.flush.max.actions&#39;: 10, &#39;bulk.flush.max.size.mb&#39;: 1,&#39;esUser&#39;:&#39;username&#39;,&#39;esPass&#39;:&#39;password&#39;}&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&#34;index&#34;</span>: <span style="color:#f1fa8c">&#34;student&#34;</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  ]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>服务端是本地启动的 ES，查询的SQL如下：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> esTest.student
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果改成下面这样就报错了：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> esTest.student  <span style="color:#ff79c6">WHERE</span> city <span style="color:#ff79c6">in</span> (<span style="color:#f1fa8c">&#39;FRAMINGHAM&#39;</span>, <span style="color:#f1fa8c">&#39;BROCKTON&#39;</span>, <span style="color:#f1fa8c">&#39;CONCORD&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> esTest.student <span style="color:#ff79c6">AS</span> t <span style="color:#ff79c6">WHERE</span> t.city <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;FRAMINGHAM&#39;</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><p>报错原因是在校验的时候，找不到<code>city</code>这个字段。</p>
<h2 id="解析问题">解析问题</h2>
<p>首先看下 ES包下的整体结构，类图如下：

        <a data-fancybox="gallery" href="https://woquhaha.gitee.io/pic_tech_1/post/2021/12/%E7%BB%9F%E4%B8%80%E6%9F%A5%E8%AF%A2%E9%A1%B9%E7%9B%AE%E6%95%B4%E5%90%88Calcite/8.jpg">
            <img class="mx-auto" alt="" src="https://woquhaha.gitee.io/pic_tech_1/post/2021/12/%E7%BB%9F%E4%B8%80%E6%9F%A5%E8%AF%A2%E9%A1%B9%E7%9B%AE%E6%95%B4%E5%90%88Calcite/8.jpg" />
        </a>
    </p>
<p>Calcite 在校验的时，会根据注册的<code>RelDataType</code>做校验，<code>RelDataType</code>是在查询元数据信息时生成的。<br>
比如，查询MySql时，会返回当前库下所有的表信息，然后拿到这个表的所有字段信息，并生成<code>RelDataType</code>对象，注册到Calcite中。<br>
具体是在<code>ElasticsearchTable#getRowType</code>中实现的，正确的 RelDataType 大致是这样的：</p>
<pre tabindex="0"><code>RecordType(VARCHAR stu_id, VARCHAR province, VARCHAR city, BIGINT digest, VARCHAR type) NOT NULL
</code></pre><p>未修改前，错误的RelDataType是这样的：</p>
<pre tabindex="0"><code>RecordType((VARCHAR NOT NULL, ANY) MAP NOT NULL _MAP) NOT NULL
</code></pre><p>代码中，这段生成的逻辑是固定的，根本不管表中的类型是啥，字段名叫啥，每次都返回这么一个固定的RelDataType。</p>
<p>后面<code>SqlValidatorImpl</code>在做校验的时候，会判断 SELECT 中的每个字段，以及 WHERE 中的字段信息，这会触发到<code>DelegatingScope#fullyQualify</code>这个函数。<br>
这个函数很长，出错的原因是，拿一个具体的字段比如<code>city</code>去<code>RelDataType</code>中查询，这当然找不到了，于是报错。</p>
<p>解决办法： <br>
在创建<code>ElasticsearchSchema</code>时，会生成一个HTTP请求，去 ES 那边拿到<strong>索引</strong>下的所有字段和类型，也就是说字段名、类型这些都是可以拿到的，他们就保存在<code>ElasticsearchTransport</code>中。<br>
在<code>ElasticsearchTable#getRowType</code>中，根据已经拿到的具体字段名、字段类型再创建对应的 <code>RelDataType</code>就可以了。<br>
具体修改内容参考：<code>ElasticsearchTable#getRowType</code></p>
<h2 id="生成json问题">生成JSON问题</h2>
<p>经过上面一通修改后，校验就可以通过了。但后面还是会报错，比如这个 SQL:</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#ff79c6">SELECT</span> <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">FROM</span> esTest.student <span style="color:#ff79c6">AS</span> t <span style="color:#ff79c6">WHERE</span> t.city <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;FRAMINGHAM&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在生成物理表达式时，会将 一个 SQL 节点，转换为对应的 JSON，具体是在<code>PredicateAnalyzer</code>中完成的。<br>
而执行到</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> Expression <span style="color:#50fa7b">visitCall</span><span style="color:#ff79c6">(</span>RexCall call<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>这句时，上述的 SQL 的节点类型是：<code>INTERNAL</code>，由不认这个类型，所以报错了。<br>
这个简单，直接在 switch 中把这个类型加上即可。</p>
<p>在执行，会发现虽然执行是<strong>成功</strong>了，但是没结果。这是因为在<code>ElasticsearchFilter</code>中，生成的 JSON 内容不对。  <br>
具体是在<code>ElasticsearchFilter#implement</code>中出问题的，而这个函数 是通过访问者模式，一层一层的被调用下来的。<br>
在<code>ElasticsearchFilter#translateMatch</code>中，返回的 JSON如下：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">&#34;query&#34;</span>: {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">&#34;constant_score&#34;</span>: {
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">&#34;filter&#34;</span>: {
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;term&#34;</span>: {
</span></span><span style="display:flex;"><span>					<span style="color:#ff79c6">&#34;$0&#34;</span>: <span style="color:#f1fa8c">&#34;FRAMINGHAM&#34;</span>
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>term</code>中有一个<code>$0</code>，这个生成的不对，如果改成<code>city</code>，这个 FILTER 条件就对了，最后就能查询出结果了。</p>
<h2 id="es-查询语句">ES 查询语句：</h2>
<p>查询索引<br>
POST /[索引名]/_search?scroll=1m HTTP/1.1</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">&#34;query&#34;</span>: {
</span></span><span style="display:flex;"><span>		<span style="color:#ff79c6">&#34;constant_score&#34;</span>: {
</span></span><span style="display:flex;"><span>			<span style="color:#ff79c6">&#34;filter&#34;</span>: {
</span></span><span style="display:flex;"><span>				<span style="color:#ff79c6">&#34;term&#34;</span>: {
</span></span><span style="display:flex;"><span>					<span style="color:#ff79c6">&#34;city&#34;</span>: <span style="color:#f1fa8c">&#34;FRAMINGHAM&#34;</span>
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">&#34;size&#34;</span>: <span style="color:#bd93f9">5196</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>一个 MySql -&gt; ES 的在线转换工具：
<a href="http://www.ischoolbar.com/EsParser/">http://www.ischoolbar.com/EsParser/</a></p>
<h2 id="目前-es-的问题">目前 ES 的问题</h2>
<p>ES 不支持 JOIN、不支持子查询，CASE-WHEN等，只能做单表(索引)查询<br>
支持的函数有限，包括：</p>
<ul>
<li>max</li>
<li>min</li>
<li>avg</li>
<li>sum</li>
<li>count</li>
</ul>
<p>经过测试和修改，已支持的功能：<br>
1、四个比较  &gt;=、&gt;、&lt;=、&lt; <br>
2、SELECT *、SELECT 某些字段   <br>
3、ORDER BY、ORDER BY DESC <br>
4、GROUP BY <br>
5、LIKE <br>
6、BETWEEN<br>
7、IN<br>
8、NOT AND OR</p>
<p>目前发现的问题：<br>
1、HAVING<br>
这个功能还没实现<br>
2、range<br>
BETWEEN、IN 都会被优化为 Sarg类型，这是一个范围集合，类似List<!-- raw HTML omitted -->、List<!-- raw HTML omitted -->这样。<br>
整数类型 和 字符串类型 所处理的方式不同<br>
具体修改参见：   <code>PredicateAnalyzer$SimpleQueryExpression#range</code></p>
<h1 id="测试中发现的bug记录">测试中发现的bug记录</h1>
<p>非BUG</p>
<ul>
<li>表中是数据值不合法</li>
<li>无符号的整数超过范围了</li>
<li>查询语句缺少库名</li>
</ul>
<p>通用问题</p>
<ul>
<li>SqlNode解析错误</li>
<li>SqlNode没解析出库</li>
<li>返回的数据类型不支持</li>
<li>客户端查询出发了assert错误</li>
<li>服务端返回的逻辑有问题，不支持批量查询</li>
</ul>
<p>MySql 问题</p>
<ul>
<li>SqlNode转换成具体的方言有问题</li>
<li>方言转换时，缺少转义符号</li>
<li>非内置函数，转换成方言有问题</li>
</ul>
<p>Oracle 问题</p>
<ul>
<li>BETWEEN带中文报错</li>
<li>返回的数据类型不支持</li>
<li>双引号问题</li>
<li>WITH 语法不支持</li>
<li>关键字冲突</li>
<li>二进制类型不支持</li>
<li>一些保留字支持</li>
</ul>
<p>跨数据源问题RelNode做校验时报错</p>
<h1 id="精简client驱动依赖">精简client驱动依赖</h1>
<h2 id="依赖包">依赖包</h2>
<p>目前 client 驱动依赖包太多，主要依赖如下：</p>
<ul>
<li>my-project自身的 core、common依赖</li>
<li>avatica-metrics 1.17.0</li>
<li>avatica-core 1.17.0
<ul>
<li>commons-dbutils 1.7</li>
</ul>
</li>
<li>httpclient 4.5.9</li>
<li>httpcore 4.4.11
<ul>
<li>commons-codec 1.11</li>
<li>commons.logging 1.2</li>
</ul>
</li>
<li>jackson-annotations 2.6.5</li>
<li>jackson-core 2.10.0</li>
<li>jackson-databind 2.6.5</li>
<li>protobuf 3.6.1</li>
<li>slf4j-api 1.7.25</li>
</ul>
<p>httpclient 4.5.9<br>
httpcore 4.4.11<br>
这两个jar引用了commons-logging，我在导入源码的时候，将commons-logging改为了slf4j</p>
<h2 id="发现的问题">发现的问题</h2>
<h3 id="protobuf">protobuf</h3>
<p>需要下载  3.6.1 的linux-64.zip 包，然后在 linux环境下 用<code>protoc</code>命令编译三个 .proc 文件<br>
再将编译后的 .java  文件拷贝回工程中</p>
<h3 id="slf4j">slf4j</h3>
<p>slf4j只是一个日志门面类，需要具体的日志实现，如 log4j，logback等 <br>
slf4j在源码中有三个实现类 <code>StaticLoggerBinder</code> 、 <code>StaticMarkerBinder</code>、 <code>StaticMDCBinder</code>。<br>
以第一个为例：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">StaticLoggerBinder</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">/**
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">     * The unique instance of this class.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> StaticLoggerBinder SINGLETON <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> StaticLoggerBinder<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">/**
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">     * Return the singleton of this class.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">     *
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">     * @return the StaticLoggerBinder singleton
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> StaticLoggerBinder <span style="color:#50fa7b">getSingleton</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> SINGLETON<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">/**
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">     * Declare the version of the SLF4J API this implementation is compiled against.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">     * The value of this field is modified with each major release.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// to avoid constant folding by the compiler, this field must *not* be final
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> String REQUESTED_API_VERSION <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;1.6.99&#34;</span><span style="color:#ff79c6">;</span> <span style="color:#6272a4">// !final
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#50fa7b">StaticLoggerBinder</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">throw</span> <span style="color:#ff79c6">new</span> UnsupportedOperationException<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;This code should have never made it into slf4j-api.jar&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> ILoggerFactory <span style="color:#50fa7b">getLoggerFactory</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">throw</span> <span style="color:#ff79c6">new</span> UnsupportedOperationException<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;This code should never make it into slf4j-api.jar&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> String <span style="color:#50fa7b">getLoggerFactoryClassStr</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">throw</span> <span style="color:#ff79c6">new</span> UnsupportedOperationException<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;This code should never make it into slf4j-api.jar&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>直接就抛出异常了，这里的集成方式很奇怪。 <br>
门面类在打包的时候，将这三个 impl 类不打入jar包中(但是源码提供了) <br>
然后某个具体日志实现类，比如 nop、或者 log4j 提供一个 同名的 StaticLoggerBinder 类，完成扩展。</p>

			<script type="text/javascript"
        async
        src="https://cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$'], ['\[\[','\]\]']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});

MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<style>
code.has-jax {
    font: inherit;
    font-size: 100%;
    background: inherit;
    border: inherit;
    color: #515151;
}
</style>
        </div>

        


        

<div class="post-archive">
    <h2>相关文章</h2>
    <ul class="listing">
        
        <li><a href="/post/2021/12/%E7%BB%9F%E4%B8%80%E6%9F%A5%E8%AF%A2%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D/">统一查询项目介绍</a></li>
        
        <li><a href="/post/2021/12/quicksql%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B/">QuickSQL执行过程</a></li>
        
        <li><a href="/post/2021/11/hana%E5%92%8Cteradata%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%81%E7%A7%BB%E8%B0%83%E7%A0%94/">HANA和TeraData数据库迁移调研</a></li>
        
        <li><a href="/post/2021/12/td-sql-pg%E7%89%88%E6%80%BB%E7%BB%93/">TD-SQL-PG版总结</a></li>
        
        <li><a href="/post/2021/12/td-sql%E6%80%BB%E7%BB%93/">TD-SQL总结-MySQL版</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='/tags/calcite'>calcite</a></li>
                
                <li><a href='/tags/%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95'>工作记录</a></li>
                
            </ul>
            
        </div>
    </article>
    
    

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "himichael/hugoblogtalks"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
</div>


                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='https://code0xff.org/search/' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://code0xff.org/">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://code0xff.org/post/2023/09/lvalue_rvalue/" title="左值右值">左值右值</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2023/09/xsimd/" title="xsimd">xsimd</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2023/09/ambari/" title="Ambari架构">Ambari架构</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2023/08/gluten%E5%92%8C%E7%9B%B8%E5%85%B3%E4%BE%9D%E8%B5%96/" title="Gluten和相关依赖">Gluten和相关依赖</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2023/07/%E6%95%B0%E6%8D%AE%E9%87%87%E9%9B%86/" title="大数据采集">大数据采集</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2023/07/jvm-gc/" title="JVM GC 介绍">JVM GC 介绍</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2023/07/presto%E5%9C%A8%E5%90%84%E5%A4%A7%E5%85%AC%E5%8F%B8%E7%9A%84%E5%BA%94%E7%94%A8/" title="Presto在各大公司的应用">Presto在各大公司的应用</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2023/06/bitweaving/" title="BitWeaving: Fast Scans for Main Memory Data Processing">BitWeaving: Fast Scans for Main Memory Data Processing</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2023/05/cache_conscious/" title="Cache Conscious Indexing for Decision-Support in Main Memory">Cache Conscious Indexing for Decision-Support in Main Memory</a>
    </li>
    
    <li>
        <a href="https://code0xff.org/post/2023/05/column_imprints/" title="Column Imprints: A Secondary Index Structure">Column Imprints: A Secondary Index Structure</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories/'>分类</a></h3>
<ul class="widget-list">
    
    <li><a href="https://code0xff.org/categories/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式 (6)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/">原理分析 (13)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E5%95%86%E4%B8%9A/">商业 (3)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据 (32)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库 (38)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E6%96%87%E5%AD%A6%E5%92%8C%E8%89%BA%E6%9C%AF/">文学和艺术 (2)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E6%97%85%E8%A1%8C/">旅行 (10)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E6%9E%B6%E6%9E%84/">架构 (2)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E7%AE%97%E6%B3%95/">算法 (8)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E7%B3%BB%E7%BB%9F/">系统 (6)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/">编程语言 (4)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E8%A1%8C%E4%B8%9A%E8%A7%82%E5%AF%9F/">行业观察 (1)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">读书笔记 (12)</a></li>
    
    <li><a href="https://code0xff.org/categories/%E9%9A%8F%E4%BE%BF%E5%86%99%E5%86%99/">随便写写 (3)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title">归档</a></h3>
<ul class="widget-list">
    
    <li><a href="https://code0xff.org/years/2021%E5%B9%B4/">2021年 (37)</a></li>
    
    <li><a href="https://code0xff.org/years/2022%E5%B9%B4/">2022年 (55)</a></li>
    
    <li><a href="https://code0xff.org/years/2023%E5%B9%B4/">2023年 (48)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags/'>标签</a></h3>
<div class="tagcloud">
    
    <a href="https://code0xff.org/tags/ambari/">Ambari </a>
    
    <a href="https://code0xff.org/tags/b%E6%A0%91/">B树 </a>
    
    <a href="https://code0xff.org/tags/c&#43;&#43;/">C&#43;&#43; </a>
    
    <a href="https://code0xff.org/tags/calcite/">calcite </a>
    
    <a href="https://code0xff.org/tags/cmu-database/">CMU-Database </a>
    
    <a href="https://code0xff.org/tags/flink/">flink </a>
    
    <a href="https://code0xff.org/tags/flume/">flume </a>
    
    <a href="https://code0xff.org/tags/gc/">GC </a>
    
    <a href="https://code0xff.org/tags/gluten/">Gluten </a>
    
    <a href="https://code0xff.org/tags/hana/">HANA </a>
    
    <a href="https://code0xff.org/tags/hive/">Hive </a>
    
    <a href="https://code0xff.org/tags/k8s/">k8s </a>
    
    <a href="https://code0xff.org/tags/kudu/">kudu </a>
    
    <a href="https://code0xff.org/tags/kyuubi/">Kyuubi </a>
    
    <a href="https://code0xff.org/tags/lakehouse/">Lakehouse </a>
    
    <a href="https://code0xff.org/tags/leveldb/">LevelDB </a>
    
    <a href="https://code0xff.org/tags/llvm/">LLVM </a>
    
    <a href="https://code0xff.org/tags/manacher/">Manacher </a>
    
    <a href="https://code0xff.org/tags/mapreduce/">MapReduce </a>
    
    <a href="https://code0xff.org/tags/mysql/">MySQL </a>
    
    <a href="https://code0xff.org/tags/newsql/">NewSQL </a>
    
    <a href="https://code0xff.org/tags/oceanbase/">OceanBase </a>
    
    <a href="https://code0xff.org/tags/paxos/">paxos </a>
    
    <a href="https://code0xff.org/tags/presto/">Presto </a>
    
    <a href="https://code0xff.org/tags/quick-sql/">quick-sql </a>
    
    <a href="https://code0xff.org/tags/raft/">raft </a>
    
    <a href="https://code0xff.org/tags/scala/">scala </a>
    
    <a href="https://code0xff.org/tags/simd/">SIMD </a>
    
    <a href="https://code0xff.org/tags/snowflake/">snowflake </a>
    
    <a href="https://code0xff.org/tags/spark/">spark </a>
    
    <a href="https://code0xff.org/tags/teradata/">TeraData </a>
    
    <a href="https://code0xff.org/tags/unix/">unix </a>
    
    <a href="https://code0xff.org/tags/%E4%BA%8C%E5%88%86%E6%9F%A5%E6%89%BE/">二分查找 </a>
    
    <a href="https://code0xff.org/tags/%E4%BA%8C%E5%8F%89%E6%A0%91%E9%81%8D%E5%8E%86/">二叉树遍历 </a>
    
    <a href="https://code0xff.org/tags/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式 </a>
    
    <a href="https://code0xff.org/tags/%E5%88%97%E5%AD%98/">列存 </a>
    
    <a href="https://code0xff.org/tags/%E5%8A%A8%E6%80%81%E6%B3%A8%E5%85%A5/">动态注入 </a>
    
    <a href="https://code0xff.org/tags/%E5%8E%86%E5%8F%B2/">历史 </a>
    
    <a href="https://code0xff.org/tags/%E5%90%91%E9%87%8F%E5%8C%96/">向量化 </a>
    
    <a href="https://code0xff.org/tags/%E5%9B%9E%E6%BA%AF/">回溯 </a>
    
    <a href="https://code0xff.org/tags/%E5%9B%BD%E5%86%85%E6%97%85%E8%A1%8C/">国内旅行 </a>
    
    <a href="https://code0xff.org/tags/%E5%9B%BD%E5%A4%96%E6%97%85%E8%A1%8C/">国外旅行 </a>
    
    <a href="https://code0xff.org/tags/%E5%A4%9A%E7%A7%9F%E6%88%B7/">多租户 </a>
    
    <a href="https://code0xff.org/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据 </a>
    
    <a href="https://code0xff.org/tags/%E5%AD%98%E5%82%A8/">存储 </a>
    
    <a href="https://code0xff.org/tags/%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95/">工作记录 </a>
    
    <a href="https://code0xff.org/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务 </a>
    
    <a href="https://code0xff.org/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库 </a>
    
    <a href="https://code0xff.org/tags/%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B/">数据模型 </a>
    
    <a href="https://code0xff.org/tags/%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB/">数据迁移 </a>
    
    <a href="https://code0xff.org/tags/%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96/">查询优化 </a>
    
    <a href="https://code0xff.org/tags/%E6%9F%A5%E8%AF%A2%E7%BC%96%E8%AF%91/">查询编译 </a>
    
    <a href="https://code0xff.org/tags/%E6%B1%87%E7%BC%96/">汇编 </a>
    
    <a href="https://code0xff.org/tags/%E6%B5%8B%E8%AF%95/">测试 </a>
    
    <a href="https://code0xff.org/tags/%E6%B9%96%E4%BB%93%E4%B8%80%E4%BD%93/">湖仓一体 </a>
    
    <a href="https://code0xff.org/tags/%E7%94%9F%E6%B4%BB/">生活 </a>
    
    <a href="https://code0xff.org/tags/%E7%94%B5%E5%BD%B1/">电影 </a>
    
    <a href="https://code0xff.org/tags/%E7%AE%97%E6%B3%95/">算法 </a>
    
    <a href="https://code0xff.org/tags/%E7%B4%A2%E5%BC%95/">索引 </a>
    
    <a href="https://code0xff.org/tags/%E7%BB%8F%E6%B5%8E/">经济 </a>
    
    <a href="https://code0xff.org/tags/%E7%BC%93%E5%AD%98/">缓存 </a>
    
    <a href="https://code0xff.org/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/">编译原理 </a>
    
    <a href="https://code0xff.org/tags/%E7%BD%91%E7%BB%9C/">网络 </a>
    
    <a href="https://code0xff.org/tags/%E8%AE%A1%E7%AE%97%E6%A1%86%E6%9E%B6/">计算框架 </a>
    
    <a href="https://code0xff.org/tags/%E8%AE%BA%E6%96%87/">论文 </a>
    
    <a href="https://code0xff.org/tags/%E8%AF%BB%E4%B9%A6/">读书 </a>
    
    <a href="https://code0xff.org/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">读书笔记 </a>
    
</div>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">RSS</h3>
        <ul class="widget-list">
            <li><a href="https://code0xff.org/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
    <footer id="footer">
    <div>
        &copy; 2023 <a href="https://code0xff.org/">记录每个瞬间 By 老王</a>
        
    </div>
    <br />
    <div>
        <div class="github-badge">
            <a href="https://gohugo.io/" target="_black" rel="nofollow"><span class="badge-subject">Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
        </div>
        <div class="github-badge">
            <a href="https://github.com/flysnow-org/maupassant-hugo" target="_black"><span class="badge-subject">Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
        </div>
    </div>
</footer>


    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script><script src="https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'GA ID', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



    <script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>




</body>

</html>